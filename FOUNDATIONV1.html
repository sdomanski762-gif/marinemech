<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarineMech - Podr�czny Mechanik �eglarski</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Ciemny motyw �eglarski */
            --primary-dark: #0A1128;
            --secondary-dark: #1A3A5F;
            --accent-blue: #00B4d8;
            --accent-teal: #1BE7FF;
            --background: #121212;
            --surface: #1E1E1E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --error: #CF6679;
            --success: #4CAF50;
            --warning: #FF9800;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        /* G��wne kontenery */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        /* Nag��wki */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--accent-blue) 0%, transparent 70%);
            opacity: 0.1;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--accent-teal), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .app-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Karty system�w */
        .systems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .system-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
        }

        .system-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            box-shadow: 0 8px 25px rgba(0, 180, 216, 0.2);
        }

        .system-card.active {
            border-color: var(--accent-teal);
            background: linear-gradient(135deg, var(--surface), rgba(27, 231, 255, 0.1));
        }

        .system-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--accent-blue);
        }

        .system-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        /* Lista symptom�w */
        .symptoms-list {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .symptom-category-header {
            color: var(--accent-teal);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .symptom-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .symptom-item:last-child {
            border-bottom: none;
        }

        .symptom-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .symptom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--accent-blue);
            border-radius: 6px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .symptom-checkbox.checked {
            background: var(--accent-blue);
        }

        .symptom-checkbox.checked::after {
            content: '?';
            color: white;
            font-weight: bold;
        }

        .symptom-text {
            flex: 1;
            font-size: 16px;
        }

        /* Modal doprecyzowania */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-blue);
        }

        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--accent-teal);
        }

        .specificity-option {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .specificity-option:hover {
            background: rgba(0, 180, 216, 0.1);
            border-color: var(--accent-blue);
        }

        .specificity-option.selected {
            background: rgba(0, 180, 216, 0.2);
            border-color: var(--accent-teal);
        }

        /* Pytania diagnostyczne */
        .question-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .answers-grid {
            display: grid;
            gap: 12px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 16px;
            color: var(--text-primary);
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .answer-btn:hover {
            background: rgba(0, 180, 216, 0.1);
            border-color: var(--accent-blue);
        }

        .answer-btn.selected {
            background: rgba(0, 180, 216, 0.2);
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        /* wyniki diagnozy */
        .results-container {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
        }

        .probability-badge {
            display: inline-block;
            background: linear-gradient(90deg, var(--error), var(--warning), var(--success));
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .issue-card {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid var(--accent-blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .issue-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-teal);
        }

        .step-list {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .step-item {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
        }

        .step-number {
            background: var(--accent-blue);
            color: var(--primary-dark);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }

        /* Przyciski */
        .btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 180, 216, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
        }

        .btn-secondary:hover {
            background: rgba(0, 180, 216, 0.1);
        }

        .btn-danger {
            background: var(--error);
        }

        /* Pasek post�pu */
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Footer */
        .app-footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animacje */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsywno�� */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            .systems-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .system-card {
                min-height: 120px;
                padding: 15px;
            }
            
            .system-icon {
                font-size: 28px;
            }
        }

        @media (max-width: 480px) {
            .systems-grid {
                grid-template-columns: 1fr;
            }
            
            .app-title {
                font-size: 24px;
            }
            
            .question-text {
                font-size: 16px;
            }
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--warning);
            color: var(--primary-dark);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: none;
            z-index: 1000;
        }

        .offline .offline-indicator {
            display: block;
        }
    </style>
</head>
<body>
    <div class="offline-indicator">
        <i class="fas fa-wifi-slash"></i> Tryb offline
    </div>

    <!-- Modal wyboru typu silnika -->
    <div id="engine-choice-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <h3 class="modal-title">wybierz rodzaj silnika</h3>
            <p style="margin-bottom: 30px; color: var(--text-secondary);">To pozwoli dobra� odpowiednie procedury naprawcze.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <button class="btn" onclick="selectEnginecontext('inboard')" style="flex-direction: column; padding: 30px;">
                    <i class="fas fa-ship" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <span>Stacjonarny<br><small>(diesel / Inboard)</small></span>
                </button>
                
                <button class="btn btn-secondary" onclick="selectEnginecontext('outboard')" style="flex-direction: column; padding: 30px; border-width: 2px;">
                    <i class="fas fa-anchor" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <span>Zaburtowy<br><small>(Benzyna / Outboard)</small></span>
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Ekran 1: wyb�r systemu -->
        <div id="screen-home" class="screen active">
            <div class="app-header">
                <h1 class="app-title">MarineMech</h1>
                <p class="app-subtitle">Podr�czny mechanik �eglarski</p>
            </div>

            <div class="systems-grid" id="systems-grid">
                <!-- Systemy b�d� dodane przez JavaScript -->
            </div>

            <!-- Tree diagnostics Section REMOVEd -->

            <!-- Expert Mode Toggle -->


            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 20px;">
                <!-- Amateur Mode Toggle -->
                <div style="display: flex; align-items: center;">
                    <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 28px; margin-right: 10px;">
                        <input type="checkbox" id="amateur-mode-toggle" onchange="toggleAmateurMode()">
                        <span class="slider round"></span>
                    </label>
                    <span style="color: var(--text-secondary); font-size: 14px;">Tryb Amatorski</span>
                </div>

                <!-- Expert Mode Toggle -->
                <div style="display: flex; align-items: center;">
                    <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 28px; margin-right: 10px;">
                        <input type="checkbox" id="expert-mode-toggle" onchange="toggleExpertMode()">
                        <span class="slider round"></span>
                    </label>
                    <span style="color: var(--text-secondary); font-size: 14px;">Tryb Ekspercki</span>
                </div>
            </div>
            <style>
                /* Expert Mode Switch Styles */
                .switch input { 
                    opacity: 0;
                    width: 0;
                    height: 0;
                }
                
                .slider {
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: #ccc;
                    transition: .4s;
                    border-radius: 34px;
                }
                
                .slider:before {
                    position: absolute;
                    content: "";
                    height: 20px;
                    width: 20px;
                    left: 4px;
                    bottom: 4px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }
                
                input:checked + .slider {
                    background-color: var(--accent-teal);
                }
                
                input:focus + .slider {
                    box-shadow: 0 0 1px var(--accent-teal);
                }
                
                input:checked + .slider:before {
                    transform: translateX(22px);
                }
            </style>

            <button class="btn" onclick="startdiagnosis()" id="start-btn" disabled>
                <i class="fas fa-play"></i> Rozpocznij diagnostyk�
            </button>
            <button class="btn btn-secondary" onclick="openBuilderModal()" id="builder-btn" style="margin-top: 12px;">
                <i class="fas fa-tools"></i> Builder
            </button>

            <div class="app-footer">
                <p>wybierz system do diagnostyki. Aplikacja dzia�a offline.</p>
            </div>
        </div>

        <!-- Ekran 2: wyb�r symptom�w -->
        <div id="screen-symptoms" class="screen">
            <div class="app-header">
                <h2 id="current-system">System: silnik</h2>
                <p class="app-subtitle">Zaznacz wyst�puj�ce symptomy</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-step1" style="width: 33%"></div>
            </div>

            <div class="symptoms-list" id="symptoms-list">
                <!-- Symptomy b�d� dodane przez JavaScript -->
            </div>

            <button class="btn" onclick="nextToQuestions()" id="next-to-questions-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                <i class="fas fa-arrow-right"></i> dalej (wybrano: <span id="selected-count">0</span>)
            </button>

            <button class="btn btn-secondary" onclick="goBackToSystems()">
                <i class="fas fa-arrow-left"></i> Powr�t do system�w
            </button>
        </div>

        <!-- Ekran 3: Pytania diagnostyczne -->
        <div id="screen-questions" class="screen">
            <div class="app-header">
                <h2 id="current-system-name">diagnostyka</h2>
                <p class="app-subtitle" id="current-question-counter">Pytanie 1/3</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-step2" style="width: 66%"></div>
            </div>

            <div id="question-container">
                <!-- Pytania b�d� dodane przez JavaScript -->
            </div>

            <button class="btn" onclick="nextQuestion()" id="next-question-btn" style="display: none;">
                <i class="fas fa-arrow-right"></i> Nast�pne pytanie
            </button>

            <button class="btn btn-secondary" onclick="goBackToSymptoms()">
                <i class="fas fa-arrow-left"></i> Powr�t do symptom�w
            </button>
        </div>

        <!-- Ekran 4: wyniki diagnozy -->
        <div id="screen-results" class="screen">
            <div class="app-header">
                <h2>wyniki diagnozy</h2>
                <p class="app-subtitle">Najbardziej prawdopodobne przyczyny</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-step3" style="width: 100%"></div>
            </div>

            <div id="results-container">
                <!-- wyniki b�d� dodane przez JavaScript -->
            </div>

            <button class="btn" onclick="startNewdiagnosis()">
                <i class="fas fa-redo"></i> Nowa diagnoza
            </button>

            <button class="btn btn-secondary" onclick="showEmergencyTips()">
                <i class="fas fa-first-aid"></i> wskaz�wki awaryjne
            </button>
        </div>
    </div>

    <script>
// ==========================================
// GLOBAL SETTINGS SYSTEM
// ==========================================
const SettingsManager = (function() {
    const STORAGE_KEY = 'marine_mech_settings_v1';
    
    // 1. Settings Schema
    const SCHEMA = {
        language: {
            type: 'string',
            default: 'auto',
            options: ['auto', 'pl', 'en']
        },
        mode: {
            type: 'string',
            default: 'standard',
            options: ['standard', 'expert', 'offshore']
        },
        verbosity: {
            type: 'string',
            default: 'normal',
            options: ['short', 'normal', 'detailed']
        }
    };

    let currentSettings = {};

    function getdefaults() {
        const defaults = {};
        for (const [key, config] of Object.entries(SCHEMA)) {
            defaults[key] = config.default;
        }
        return defaults;
    }

    function load() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                currentSettings = { ...getdefaults(), ...parsed };
            } else {
                currentSettings = getdefaults();
            }
        } catch (e) {
            console.error('Settings load failed:', e);
            currentSettings = getdefaults();
        }
        
        if (currentSettings.language === 'auto') {
            const browserLang = navigator.language || navigator.userLanguage;
            currentSettings.detectedLanguage = browserLang.startswith('pl') ? 'pl' : 'en';
        }
        
        console.log('Settings loaded:', currentSettings);
        return currentSettings;
    }

    function save() {
        try {
            const toSave = {};
            for (const key of Object.keys(SCHEMA)) {
                toSave[key] = currentSettings[key];
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            console.log('Settings saved');
        } catch (e) {
            console.error('Settings save failed:', e);
        }
    }

    return {
        init: function() { return load(); },
        get: function(key) {
            if (key === 'language' && currentSettings.language === 'auto') {
                return currentSettings.detectedLanguage || 'en';
            }
            return currentSettings[key];
        },
        getAll: function() { return { ...currentSettings }; },
        set: function(key, value) {
            if (SCHEMA[key]) {
                if (SCHEMA[key].options && !SCHEMA[key].options.includes(value)) {
                    console.warn(`Invalid value '${value}' for setting '${key}'`);
                    return false;
                }
                currentSettings[key] = value;
                save();
                return true;
            }
            return false;
        },
        getSchema: function() { return SCHEMA; }
    };
})();

// Initialize settings immediately
SettingsManager.init();

// ==========================================
// BAZA wIEdZY SPECYFICZNA dLA MAREK (ENGINE SPECIFICS)
// ==========================================

const marineSpecifics = {
    // === YANMAR (GM / YM / JH Series) ===
    yanmar: {
        id: 'yanmar',
        name: 'Yanmar diesel (GM/YM/JH)',
        common_issues: {
            // Yanmar Specific: Mixing Elbow
            mixing_elbow_clog: {
                id: 'yan_mixing_elbow',
                name_pl: 'Zatkana kolanko wydechowe (Mixing Elbow)',
                base_probability: 0.35, 
                symptoms: ['vis_smoke_black', 'vis_smoke_white', 'eng_stalls_load'],
                verification_questions: [
                    {
                        id: 'q_yan_elbow_age',
                        question_pl: 'Kiedy ostatnio Wymieniano kolanko wydechowe (Mixing Elbow)?',
                        question_amateur_pl: 'Czy silnik dymi na czarno i nie ma si�y p�yn�� pod wiatr?',
                        question_expert_pl: 'Jaki jest przebieg na obecnym kolanku wydechowym (Mixing Elbow)?',
                        answers: [
                            { text_pl: 'Ponad 500h / 3 lata temu', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Jest nowe (<100h)', probability_change: -0.9, type: 'reject' }
                        ],
                        answers_amateur: [
                            { text_pl: 'Tak, dymi i s�abnie', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Nie, dzia�a normalnie', probability_change: -0.5, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Yanmar zaleca wymian� co 500h. Sprawd� zw�enie przekroju (nagarem).'
            },
            // Yanmar Specific: Lift Pump
            lift_pump_diaphragm: {
                id: 'yan_lift_pump',
                name_pl: 'P�kni�ta membrana pompki paliwa',
                base_probability: 0.2,
                symptoms: ['eng_stalls_load', 'vis_leak_oil'], 
                verification_questions: [
                    {
                        id: 'q_yan_oil_level_rise',
                        question_pl: 'Czy poziom oleju w silniku si� POdNI�S�?',
                        question_amateur_pl: 'Sprawd� bagnet oleju. Czy oleju jest ZA dU�O (powy�ej MAX)?',
                        question_expert_pl: 'Czy wyst�puje zjawisko przybywania oleju (rozrzedzenie rop�)?',
                        answers: [
                            { text_pl: 'Tak, oleju jest wi�cej i �mierdzi rop�', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie, poziom w normie', probability_change: -0.6, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Wymie� mechaniczn� pompk� paliwa (lift pump). Nie naprawiaj membrany.'
            }
        }
    },

    // === VOLVO PENTA (2000 Series / Md / d1-d2) ===
    volvo: {
        id: 'volvo',
        name: 'Volvo Penta (Md/2000/d-Series)',
        common_issues: {
            // Volvo d1/d2 Specific: MdI Box
            mdi_failure: {
                id: 'vp_mdi_box',
                name_pl: 'Awaria modu�u MdI (Czarna skrzynka)',
                base_probability: 0.35, // Bardzo cz�ste w serii d
                symptoms: ['eng_no_crank', 'elec_flicker', 'ins_volt_low'],
                verification_questions: [
                    {
                        id: 'q_vp_mdi_button',
                        question_pl: 'Czy przycisk startu w og�le nie reaguje?',
                        question_amateur_pl: 'Znajd� czarn� skrzynk� na silniku. Czy jest tam ma�y guzik bezpiecznika?',
                        question_expert_pl: 'Czy MdI zg�asza b��dy? Czy bezpiecznik bimetaliczny na MdI wybi�?',
                        answers: [
                            { text_pl: 'Tak, wcisn��em go i odpali�!', probability_change: 0.99, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Guzik jest wci�ni�ty / Brak guzika', probability_change: -0.2, type: 'neutral' }
                        ]
                    }
                ],
                repair_tip: 'wci�nij bezpiecznik na module MdI (na g�rze silnika). Je�li wraca - Wymie� MdI.'
            },
            // Volvo Specific: cold Start
            cold_start_procedure: {
                id: 'vp_cold_start',
                name_pl: 'B��dna procedura startu (Zimny start)',
                base_probability: 0.4, 
                symptoms: ['eng_cranks_no_start', 'vis_smoke_white'],
                verification_questions: [
                    {
                        id: 'q_vp_glow_time',
                        question_pl: 'Czy grza�e� �wiece przez 10-15 sekund?',
                        question_amateur_pl: 'Czy trzyma�e� kluczyk/guzik w pozycji "Glow" (Grzanie) przez 15 sekund?',
                        question_expert_pl: 'weryfikacja czasu grzania �wiec �arowych.',
                        answers: [
                            { text_pl: 'Nie, kr�ci�em od razu', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Tak, grza�em d�ugo', probability_change: -0.4, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Volvo d1/d2 wymagaj� d�ugiego grzania �wiec, nawet w ciep�e dni.'
            }
        }
    },

    // === OUTBOARd ENGINES (GENERIC & SPECIFIC) ===
    yamaha: {
        id: 'yamaha',
        name: 'Yamaha Outboard (F Series)',
        common_issues: {
            // Yamaha Specific: Transport Leak
            yam_transport_leak: {
                id: 'yam_transport_leak',
                name_pl: 'wyciek oleju po transporcie',
                base_probability: 0.6,
                symptoms: ['vis_leak_oil', 'eng_cranks_no_start', 'vis_smoke_white'],
                verification_questions: [
                    {
                        id: 'q_yam_side',
                        question_pl: 'Na kt�rym boku le�a� silnik podczas transportu?',
                        question_amateur_pl: 'Czy silnik le�a� na boku z r�czk� (rumplem)?',
                        answers: [
                            { text_pl: 'Na stronie rumpla (dobrze)', probability_change: -0.5, type: 'reject' },
                            { text_pl: 'Na drugim boku / Na �rubie', probability_change: 0.9, knockout: 'others', type: 'confirm' }
                        ]
                    }
                ],
                repair_tip: 'Yamaha 4-suw musi le�e� na stronie rumpla. Olej zala� cylinder/ga�nik. wykr�� �wiec�, wydmuchaj cylinder.'
            },
            // Yamaha: Old Fuel
            yam_carb_clog: {
                id: 'yam_carb_clog',
                name_pl: 'Zatkanie dyszy ga�nika (Stare paliwo)',
                base_probability: 0.4,
                symptoms: ['eng_stalls_idle', 'eng_cranks_no_start'],
                verification_questions: [
                    {
                        id: 'q_yam_storage',
                        question_pl: 'Czy paliwo zosta�o wypalone przed zim�/postojem?',
                        answers: [
                            { text_pl: 'Nie, zosta�o w ga�niku', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Tak, wypalone do zera', probability_change: -0.6, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Spu�� paliwo z komory p�ywakowej (�rubka na dole ga�nika). Nalej �wie�ego.'
            }
        }
    },

    mercury: {
        id: 'mercury',
        name: 'Mercury Outboard (4/5/6hp)',
        common_issues: {
            // Mercury: Tank Selection
            merc_tank_select: {
                id: 'merc_tank_select',
                name_pl: 'Z�y wyb�r zbiornika (Int/Ext)',
                base_probability: 0.5,
                symptoms: ['eng_stalls_load', 'eng_stalls_idle'],
                verification_questions: [
                    {
                        id: 'q_merc_valve',
                        question_pl: 'Jak ustawiony jest prze��cznik paliwa (na g�rze obudowy)?',
                        question_amateur_pl: 'Czy pokr�t�o na g�rze silnika wskazuje na w�a�ciwy zbiornik?',
                        answers: [
                            { text_pl: 'Na wewn�trzny (a u�ywam zewn�trznego)', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Jest OK', probability_change: -0.3, type: 'neutral' }
                        ]
                    }
                ],
                repair_tip: 'Mercury 4/5/6hp ma zaw�r 2-dro�ny. Ustaw zgodnie ze �r�d�em paliwa.'
            },
             // Mercury: Fuel Pump
            merc_fuel_pump: {
                id: 'merc_fuel_pump',
                name_pl: 'Awaria membrany pompy paliwa',
                base_probability: 0.3,
                symptoms: ['eng_stalls_load', 'eng_stalls_idle'],
                verification_questions: [
                    {
                        id: 'q_merc_bulb',
                        question_pl: 'Czy pompowanie gruszk� utrzymuje silnik przy �yciu?',
                        answers: [
                            { text_pl: 'Tak, jak pompuj� to dzia�a', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie pomaga', probability_change: -0.3, type: 'neutral' }
                        ]
                    }
                ],
                repair_tip: 'Wymie� zestaw naprawczy pompy paliwa (membrany).'
            }
        }
    },

    honda: {
        id: 'honda',
        name: 'Honda Outboard (BF 2.3 Air cooled)',
        common_issues: {
            // Honda Specific: Air cooled (No water Stream!)
            honda_air_cooled_confusion: {
                id: 'honda_no_water',
                name_pl: 'Brak wody ch�odz�cej (To normalne!)',
                base_probability: 0.9, // Bardzo cz�sta pomy�ka amator�w
                symptoms: ['ins_temp_high', 'vis_smoke_white'], // U�ytkownik my�li �e dymi/grzeje si� bo nie ma wody
                verification_questions: [
                    {
                        id: 'q_honda_model',
                        question_pl: 'Czy to model Honda 2.3 (z czarn� kratk� na g�rze)?',
                        answers: [
                            { text_pl: 'Tak, BF 2.3', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie, wi�kszy (ch�odzony wod�)', probability_change: -1.0, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Honda BF 2.3 jest ch�odzona POwIETRZEM. Nie ma "sikawki" wody. To nie awaria.'
            },
            // Honda: Centrifugal Clutch
            honda_prop_idle: {
                id: 'honda_prop_idle',
                name_pl: '�ruba nie kr�ci si� na wolnych (Sprz�g�o)',
                base_probability: 0.8,
                symptoms: ['eng_stalls_load'], // U�ytkownik my�li �e co� nie tak z nap�dem
                verification_questions: [
                    {
                        id: 'q_honda_gas',
                        question_pl: 'Czy �ruba zaczyna si� kr�ci� dopiero po dodaniu gazu?',
                        answers: [
                            { text_pl: 'Tak, na wolnych stoi', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie kr�ci si� wcale', probability_change: -0.5, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Ten silnik ma sprz�g�o od�rodkowe. �ruba stoi na wolnych obrotach - to funkcja bezpiecze�stwa.'
            }
        }
    }
};

// ==========================================
// dRZEwa dECYZYJNE (dIAGNOSTIC TREES)
// ==========================================
const diagnosticTrees = {
    // === ELECTRICAL coRE LOGIC ===
    // (Moved to marine_specifics.js)

    // === JABSco TOILET TREE ===
    "plumbing_core": {
        tree_id: "plumbing_core",
        metadata: {
            title: { en: "Plumbing & water Systems", pl: "Instalacje wodne i sanitarne" },
            version: "1.0.0",
            engine_type: "auxiliary"
        },
        start_node: "plumbing_main_symptom",
        nodes: {
            "plumbing_main_symptom": {
                question: {
                    en: "what part of the water system is failing?",
                    pl: "Kt�ra cz�� instalacji wodnej sprawia problemy?"
                },
                answers: [
                    {
                        text: { en: "Marine Toilet (wC)", pl: "Toaleta morska (wC)" },
                        type: "confirm",
                        next: { type: "tree", id: "jabsco_toilet" }
                    },
                    {
                        text: { en: "Fresh water Pump / Taps", pl: "pompa wody s�odkiej / Kran" },
                        type: "confirm",
                        next: { type: "solution", id: "expert_required" }
                    },
                    {
                        text: { en: "Bilge Pumps", pl: "pompy z�zowe" },
                        type: "confirm",
                        next: { type: "tree", id: "electrical_core" }
                    },
                    {
                        text: { en: "Leaking Pipe / Hose", pl: "wyciek z rury / w�a" },
                        type: "confirm",
                        next: { type: "solution", id: "expert_required" }
                    }
                ]
            }
        },
        solutions: {
            "expert_required": {
                title: { en: "Expert Required", pl: "wymagana pomoc eksperta" },
                description: { en: "detailed diagnostic for this plumbing component is not yet implemented.", pl: "Szczeg�owa diagnostyka dla tego elementu instalacji nie jest jeszcze w pe�ni zaimplementowana." },
                steps: [
                    { en: "Check for leaks or loose connections.", pl: "Sprawd� wycieki i lu�ne po��czenia." },
                    { en: "Verify pump power supply.", pl: "Sprawd� zasilanie pompy." }
                ]
            }
        }
    },
    "jabsco_toilet": {
        tree_id: "jabsco_toilet",
        metadata: {
            title: { en: "Jabsco Manual Toilet diagnostic", pl: "diagnostyka Toalety Jabsco (Manualna)" },
            version: "1.0.1",
            engine_type: "auxiliary"
        },
        start_node: "toilet_main_symptom",
        nodes: {
            "toilet_main_symptom": {
                question: {
                    en: "what is the primary problem with the Jabsco toilet?",
                    pl: "Jaki jest g��wny problem z toalet� Jabsco?"
                },
                answers: [
                    {
                        text: { en: "water leaking from pump handle/top", pl: "woda wycieka z r�czki pompy / g�ry" },
                        type: "confirm",
                        next: { type: "solution", id: "sol_jabsco_seal_replacement" }
                    },
                    {
                        text: { en: "Toilet won't flush (waste stays)", pl: "Toaleta nie sp�ukuje (nieczysto�ci zostaj�)" },
                        type: "confirm",
                        next: { type: "node", id: "flush_blockage_check" }
                    },
                    {
                        text: { en: "No water coming in (dry bowl)", pl: "Brak dop�ywu wody (sucha muszla)" },
                        type: "confirm",
                        next: { type: "node", id: "intake_seacock_check" }
                    },
                    {
                        text: { en: "waste flows back into bowl", pl: "Nieczysto�ci wracaj� do muszli" },
                        type: "confirm",
                        next: { type: "solution", id: "sol_jabsco_joker_valve" }
                    }
                ]
            },
            "flush_blockage_check": {
                question: {
                    en: "Is the pump handle very hard to push down?",
                    pl: "Czy r�czka pompy stawia bardzo du�y op�r przy pchaniu?"
                },
                answers: [
                    {
                        text: { en: "Yes, very hard", pl: "Tak, bardzo ci�ko" },
                        type: "confirm",
                        next: { type: "solution", id: "sol_jabsco_discharge_blockage" }
                    },
                    {
                        text: { en: "No, moves freely but no suction", pl: "Nie, rusza si� lekko ale brak ssania" },
                        type: "confirm",
                        next: { type: "solution", id: "sol_jabsco_internal_valves" }
                    },
                    {
                        text: { en: "I don't know", pl: "Nie wiem" },
                        type: "cant_check",
                        next: { type: "solution", id: "expert_required" }
                    }
                ]
            },
            "intake_seacock_check": {
                question: {
                    en: "Is the intake seacock (valve) fully open?",
                    pl: "Czy zaw�r denny dolotowy jest w pe�ni otwarty?"
                },
                answers: [
                    {
                        text: { en: "Yes, it is open", pl: "Tak, jest otwarty" },
                        type: "confirm",
                        next: { type: "node", id: "intake_air_leak" }
                    },
                    {
                        text: { en: "No, it was closed", pl: "Nie, by� zamkni�ty" },
                        type: "confirm",
                        next: { type: "solution", id: "sol_open_seacock" }
                    }
                ]
            },
            "intake_air_leak": {
                question: {
                    en: "Is there air in the intake line or a loose hose clamp?",
                    pl: "Czy w linii dolotowej jest powietrze lub lu�na opaska?"
                },
                answers: [
                    {
                        text: { en: "Yes, suspect air leak", pl: "Tak, podejrzewam Nieszczelno��" },
                        type: "confirm",
                        next: { type: "solution", id: "sol_tighten_clamps" }
                    },
                    {
                        text: { en: "No air, but still dry", pl: "Brak powietrza, ale wci�� sucho" },
                        type: "confirm",
                        next: { type: "solution", id: "sol_jabsco_pump_rebuild" }
                    }
                ]
            }
        },
        solutions: {
            "sol_jabsco_seal_replacement": {
                title: { en: "Replace Pump Rod Seal", pl: "Wymie� uszczelnienie t�oczyska" },
                description: { en: "The top seal is worn. water leaks out when pumping.", pl: "G�rna uszczelka jest zu�yta. woda wycieka podczas pompowania." },
                steps: [
                    { en: "Buy Jabsco Service Kit A.", pl: "Kup zestaw serwisowy Jabsco A." },
                    { en: "Unscrew top housing and replace the O-ring and seal.", pl: "Odkr�� g�rn� obudow� i Wymie� O-ring oraz uszczelk�." }
                ]
            },
            "sol_jabsco_joker_valve": {
                title: { en: "Replace Joker Valve", pl: "Wymie� zaw�r Joker" },
                description: { en: "The one-way valve at the discharge is failing.", pl: "Zaw�r zwrotny na wylocie (Joker) jest uszkodzony." },
                steps: [
                    { en: "Close discharge seacock.", pl: "Zamknij zaw�r wylotowy." },
                    { en: "Remove discharge elbow and replace the black rubber Joker valve.", pl: "Zdejmij kolanko wylotowe i Wymie� czarny gumowy zaw�r Joker." }
                ]
            },
            "sol_jabsco_discharge_blockage": {
                title: { en: "Clear discharge Blockage", pl: "Udro�nij wylot" },
                description: { en: "Blockage in the hose or holding tank vent.", pl: "Zator w w�u lub odpowietrzniku zbiornika." },
                steps: [
                    { en: "Check if holding tank is full.", pl: "Sprawd� czy zbiornik nie jest pe�ny." },
                    { en: "Inspect discharge hose for kinks or scale buildup.", pl: "Sprawd� w�� wylotowy pod k�tem zagi�� lub kamienia." }
                ]
            },
            "sol_jabsco_internal_valves": {
                title: { en: "Service Internal Valves", pl: "Serwisuj zawory wewn�trzne" },
                description: { en: "The flap valves inside the pump are stuck or dirty.", pl: "Zawory klapowe wewn�trz pompy s� zablokowane lub brudne." },
                steps: [
                    { en: "disassemble pump housing.", pl: "Zdemontuj obudow� pompy." },
                    { en: "Clean or replace the internal base valve gasket.", pl: "Wyczy�� lub Wymie� uszczelk� zaworu podstawy." }
                ]
            },
            "sol_open_seacock": {
                title: { en: "Open Seacock", pl: "Otw�rz zaw�r denny" },
                description: { en: "The toilet cannot draw water if the valve is closed.", pl: "Toaleta nie zassie wody, je�li zaw�r jest zamkni�ty." },
                steps: [
                    { en: "Locate the intake seacock and open it fully.", pl: "Zlokalizuj zaw�r dolotowy i otw�rz go ca�kowicie." }
                ]
            },
            "sol_tighten_clamps": {
                title: { en: "Tighten Hose Clamps", pl: "Dokr�� opaski" },
                description: { en: "Air is entering the system, preventing prime.", pl: "Powietrze dostaje si� do uk�adu, uniemo�liwiaj�c zassanie." },
                steps: [
                    { en: "Check all intake hose connections.", pl: "Sprawd� wszystkie po��czenia dolotowe." },
                    { en: "Tighten any loose clamps.", pl: "Dokr�� lu�ne opaski." }
                ]
            },
            "sol_jabsco_pump_rebuild": {
                title: { en: "Rebuild or Lubricate Pump", pl: "Regeneracja lub smarowanie pompy" },
                description: { en: "The pump cylinder is dry or seals are failing.", pl: "Cylinder pompy jest suchy lub uszczelki zawodz�." },
                steps: [
                    { en: "Apply Jabsco toilet grease to the pump rod.", pl: "Na�� smar do toalet Jabsco na t�oczysko." },
                    { en: "If performance doesn't improve, install a full rebuild kit.", pl: "Je�li wydajno�� si� nie poprawi, zainstaluj pe�ny zestaw naprawczy." }
                ]
            },
            "expert_required": {
                title: { en: "Expert Help Required", pl: "wymagana pomoc eksperta" },
                description: { en: "The issue might be related to complex plumbing or tank issues.", pl: "Problem mo�e dotyczy� z�o�onej instalacji lub zbiornika." },
                steps: [
                    { en: "consult a marine plumber or technician.", pl: "Skonsultuj si� z hydraulikiem morskim lub technikiem." }
                ]
            }
        }
    },
    // === GASOLINE coRE LOGIC ===
    "gasoline_core": {
        id: "gasoline_core",
        title_pl: "silnik Benzynowy (Gasoline) - Pe�na diagnostyka",
        title_en: "Marine Gasoline Engine diagnostic Tree",
        start_node: "safety_check",
        nodes: {
            // ETAP 0
            "safety_check": {
                question_pl: "Czy czujesz zapach benzyny lub widzisz wyciek paliwa?",
                question_en: "Smell of gasoline / visible fuel leak?",
                answers: [
                    { text_pl: "TAK - wyciek/Zapach", text_en: "YES", solution_id: "gas_leak_danger" },
                    { text_pl: "NIE - Bezpiecznie", text_en: "NO", next_node: "main_symptom" }
                ]
            },
            // ETAP 1
            "main_symptom": {
                question_pl: "co si� dzieje przy pr�bie startu?",
                question_en: "what happens when you try to start?",
                answers: [
                    { text_pl: "Nic si� nie dzieje (Cisza/Op�r)", text_en: "Nothing happens", next_node: "nothing_happens_check" },
                    { text_pl: "Kr�ci, ale nie odpala", text_en: "Cranks but won't start", next_node: "cranks_no_start_spark" },
                    { text_pl: "Odpala i ga�nie", text_en: "Starts then stalls", next_node: "starts_stalls_check" },
                    { text_pl: "Pracuje nier�wno / brak mocy", text_en: "Runs rough / no power", next_node: "runs_rough_check" },
                    { text_pl: "Przegrzewa si�", text_en: "Overheats", next_node: "overheat_check" },
                    { text_pl: "Ga�nie losowo", text_en: "Random shutdown", next_node: "random_shutdown_check" }
                ]
            },

            // A. NOTHING HAPPENS
            "nothing_happens_check": {
                question_pl: "Jaki to typ rozruchu?",
                question_en: "Start type?",
                answers: [
                    { text_pl: "R�czny (Szarpanka)", text_en: "Manual Pull", next_node: "manual_start_neutral" },
                    { text_pl: "Elektryczny (Kluczyk)", text_en: "Electric Start", next_node: "electric_start_battery" }
                ]
            },
            // A1 Manual
            "manual_start_neutral": {
                question_pl: "Czy silnik jest na luzie (Neutral)?",
                question_en: "Is engine in Neutral?",
                answers: [
                    { text_pl: "NIE / Nie wiem", text_en: "NO", solution_id: "gas_neutral_safety" },
                    { text_pl: "TAK", text_en: "YES", next_node: "manual_kill_switch" }
                ]
            },
            "manual_kill_switch": {
                question_pl: "Czy zrywka (kill switch) jest wpi�ta?",
                question_en: "Kill switch / lanyard installed?",
                answers: [
                    { text_pl: "NIE", text_en: "NO", solution_id: "gas_kill_switch_missing" },
                    { text_pl: "TAK", text_en: "YES", next_node: "manual_rope_pull" }
                ]
            },
            "manual_rope_pull": {
                question_pl: "Czy linka wyci�ga si� swobodnie?",
                question_en: "Rope pulls freely?",
                answers: [
                    { text_pl: "NIE - Zablokowana", text_en: "NO", solution_id: "gas_hydrolock_jam" },
                    { text_pl: "TAK", text_en: "YES", next_node: "cranks_no_start_spark" }
                ]
            },

             // A2 Electric
            "electric_start_battery": {
                question_pl: "Czy akumulator jest na�adowany?",
                question_en: "Battery OK?",
                answers: [
                    { text_pl: "NIE / S�aby", text_en: "NO", solution_id: "gas_dead_battery" },
                    { text_pl: "TAK", text_en: "YES", next_node: "electric_click_check" }
                ]
            },
            "electric_click_check": {
                question_pl: "co s�ycha� przy przekr�caniu kluczyka?",
                question_en: "Click / silence?",
                answers: [
                    { text_pl: "Klikni�cie", text_en: "Click", solution_id: "gas_solenoid_fail" },
                    { text_pl: "Cisza", text_en: "silence", solution_id: "gas_key_switch_fail" }
                ]
            },

            // B. CRANKS BUT wON'T START
            "cranks_no_start_spark": {
                question_pl: "wykr�� �wiec�, przy�� do masy i szarpnij. Jest iskra?",
                question_en: "Remove plug, ground it, crank � spark?",
                answers: [
                    { text_pl: "NIE - Brak iskry", text_en: "NO", solution_id: "gas_ignition_failure" },
                    { text_pl: "TAK - Jest iskra", text_en: "YES", next_node: "cranks_fuel_check" }
                ]
            },
            "cranks_fuel_check": {
                question_pl: "Czy �wieca jest mokra od paliwa?",
                question_en: "Spark plug wet?",
                answers: [
                    { text_pl: "NIE - Sucha", text_en: "NO", solution_id: "gas_no_fuel" },
                    { text_pl: "TAK - Mokra", text_en: "YES", solution_id: "gas_flooded" }
                ]
            },

            // C. STARTS THEN STALLS
            "starts_stalls_check": {
                question_pl: "Czy ga�nie natychmiast po odpaleniu?",
                question_en: "Stalls immediately?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_idle_circuit" },
                    { text_pl: "NIE - Chodzi chwil�", text_en: "NO", next_node: "starts_stalls_choke" }
                ]
            },
            "starts_stalls_choke": {
                question_pl: "Czy wymaga ssania (choke) �eby pracowa�?",
                question_en: "Needs choke to run?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_lean_condition" },
                    { text_pl: "NIE", text_en: "NO", solution_id: "gas_fuel_supply_intermittent" }
                ]
            },

            // d. RUNS ROUGH / NO POwER
            "runs_rough_check": {
                question_pl: "Czy pracuje dobrze na luzie (Neutral)?",
                question_en: "Runs fine in neutral?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_load_issue" },
                    { text_pl: "NIE", text_en: "NO", next_node: "runs_rough_backfire" }
                ]
            },
            "runs_rough_backfire": {
                question_pl: "Czy silnik strzela w ga�nik/wydech (Backfiring)?",
                question_en: "Backfiring?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_lean_timing" },
                    { text_pl: "NIE", text_en: "NO", next_node: "runs_rough_rpm" }
                ]
            },
            "runs_rough_rpm": {
                question_pl: "Czy problem jest tylko na wysokich obrotach?",
                question_en: "Only at high RPM?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_main_jet_flow" },
                    { text_pl: "NIE - Ca�y czas", text_en: "NO", solution_id: "gas_general_rough" }
                ]
            },

            // E. OVERHEATING
            "overheat_check": {
                question_pl: "Czy woda leci z kontrolki (tell-tale)?",
                question_en: "water from tell-tale?",
                answers: [
                    { text_pl: "NIE - Sucho", text_en: "NO", solution_id: "gas_cooling_failure" },
                    { text_pl: "TAK - Leci", text_en: "YES", solution_id: "gas_overheat_other" }
                ]
            },

            // F. RANdOM SHUTdOwN
            "random_shutdown_check": {
                question_pl: "Czy ga�nie gdy jest gor�cy?",
                question_en: "Happens when hot?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", next_node: "random_shutdown_restart" },
                    { text_pl: "NIE - Zimny/Losowo", text_en: "NO", solution_id: "gas_loose_wire_fuel" }
                ]
            },
            "random_shutdown_restart": {
                question_pl: "Czy odpala ponownie po ostygni�ciu?",
                question_en: "Restarts after cooling?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_thermal_failure" },
                    { text_pl: "NIE", text_en: "NO", solution_id: "gas_coil_failure_permanent" }
                ]
            }
        }
    },

    // === dIESEL EXPERT LOGIC (UPLOAdEd) ===
    "diesel_engine_core": {
        id: "diesel_engine_core",
        title_pl: "silnik diesel (Ekspert) - diagnostyka",
        title_en: "Marine diesel Engine � Expert diagnostic Logic Tree",
        start_node: "engine_problem",
        nodes: {
            "engine_problem": {
                question_pl: "Jaki jest g��wny objaw pracy silnika?",
                question_en: "what is the main engine symptom?",
                answers: [
                    { text_pl: "silnik nie odpala", text_en: "Engine does not start", next_node: "no_start" },
                    { text_pl: "Odpala i ga�nie", text_en: "Starts and stalls", next_node: "starts_stalls" },
                    { text_pl: "Brak mocy lub nier�wna praca", text_en: "Low power or rough running", next_node: "low_power" },
                    { text_pl: "Nietypowy dym z wydechu", text_en: "UnUsual exhaust smoke", next_node: "smoke_type" }
                ]
            },
            "no_start": {
                question_pl: "Czy rozrusznik kr�ci silnikiem?",
                question_en: "does the starter crank the engine?",
                answers: [
                    { text_pl: "Nie", text_en: "No", solution_id: "no_crank_power" },
                    { text_pl: "Tak", text_en: "Yes", next_node: "cranks_no_start" },
                    { text_pl: "Nie wiem / nie mog� Sprawdzi�", text_en: "I don't know / can't check", next_node: "electrical_assumption" }
                ]
            },
            "electrical_assumption": {
                question_pl: "Czy po przekr�ceniu kluczyka gasn� kontrolki lub s�ycha� klikni�cie?",
                question_en: "do warning lights dim or do you hear a click when turning the key?",
                answers: [
                    { text_pl: "Tak", text_en: "Yes", solution_id: "no_crank_power" },
                    { text_pl: "Nie", text_en: "No", solution_id: "no_crank_power" },
                    { text_pl: "Nie wiem / nie mog� Sprawdzi�", text_en: "I don't know / can't check", solution_id: "no_crank_power" }
                ]
            },
            "cranks_no_start": {
                question_pl: "Czy silnik wykazuje pr�b� zap�onu?",
                question_en: "does the engine attempt to fire?",
                answers: [
                    { text_pl: "Nie, kr�ci �na pusto�", text_en: "No, cranks freely", solution_id: "no_fuel_or_air" },
                    { text_pl: "Tak, pr�buje odpali�", text_en: "Yes, tries to start", solution_id: "poor_combustion_conditions" },
                    { text_pl: "Nie wiem / nie mog� oceni�", text_en: "I don't know / can't tell", solution_id: "no_fuel_or_air" }
                ]
            },
            "starts_stalls": {
                question_pl: "Po jakim czasie silnik ga�nie?",
                question_en: "How quickly does the engine stall?",
                answers: [
                    { text_pl: "Po kilku sekundach", text_en: "After a few seconds", solution_id: "restricted_fuel_flow" },
                    { text_pl: "Po rozgrzaniu", text_en: "After warming up", solution_id: "fuel_vent_or_overheat" },
                    { text_pl: "Nie wiem / r�nie", text_en: "I don't know / varies", solution_id: "restricted_fuel_flow" }
                ]
            },
            "low_power": {
                question_pl: "Czy problem narasta stopniowo?",
                question_en: "does the problem worsen gradually?",
                answers: [
                    { text_pl: "Tak", text_en: "Yes", solution_id: "air_or_fuel_restriction" },
                    { text_pl: "Nie, nagle", text_en: "No, suddenly", solution_id: "turbo_or_injector_issue" },
                    { text_pl: "Nie wiem / trudno oceni�", text_en: "I don't know / hard to tell", solution_id: "air_or_fuel_restriction" }
                ]
            },
            "smoke_type": {
                question_pl: "Jaki jest kolor dymu?",
                question_en: "what is the color of the smoke?",
                answers: [
                    { text_pl: "Czarny", text_en: "Black", solution_id: "black_smoke" },
                    { text_pl: "Bia�y", text_en: "white", solution_id: "white_smoke" },
                    { text_pl: "Niebieski", text_en: "Blue", solution_id: "blue_smoke" },
                    { text_pl: "Nie wiem / s�aba widoczno��", text_en: "I don't know / poor visibility", solution_id: "poor_combustion_conditions" }
                ]
            }
        }
    },
    // === dIESEL coRE LOGIC ===
    "diesel_core": {
        id: "diesel_core",
        title_pl: "silnik diesel (Inboard) - Pe�na diagnostyka",
        title_en: "core diesel diagnostic Tree",
        start_node: "safety_check",
        nodes: {
            // ETAP 0 - BEZPIECZE�STwO
            "safety_check": {
                question_pl: "Czy silnik zatrzyma� si� nagle z g�o�nym metalicznym stukiem (HARd STOP)?",
                question_en: "did the engine stop suddenly with a loud metallic knock or hard stop?",
                answers: [
                    { text_pl: "TAK - Gwa�towne zatrzymanie", text_en: "YES - Hard stop", solution_id: "hydrolock_crit" },
                    { text_pl: "NIE - Inne objawy", text_en: "NO - Other symptoms", next_node: "main_symptom" }
                ]
            },

            // ETAP 1 - G��wNY SYMPTOM
            "main_symptom": {
                question_pl: "co najlepiej opisuje obecne zachowanie silnika?",
                question_en: "what best describes the engine now?",
                answers: [
                    { text_pl: "Cisza - Rozrusznik nie kr�ci", text_en: "No crank at all (silence)", next_node: "no_crank_lights" },
                    { text_pl: "Kr�ci wolno / s�abo", text_en: "Cranks slowly / weakly", next_node: "slow_crank_lights" },
                    { text_pl: "Kr�ci normalnie, nie odpala", text_en: "Cranks normally but does not start", next_node: "crank_smoke_check" },
                    { text_pl: "Odpala i ga�nie", text_en: "Starts then stops", next_node: "starts_stops_duration" },
                    { text_pl: "Pracuje, ale s�abo / bez mocy", text_en: "Runs but poorly", next_node: "runs_poorly_neutral" },
                    { text_pl: "Przegrzewa si�", text_en: "Overheats", next_node: "overheat_water" },
                    { text_pl: "Alarm ci�nienia oleju", text_en: "Low oil pressure alarm", next: { type: "tree", id: "low_oil_pressure_diagnostic" } }
                ]
            },

            // A. NO CRANK
            "no_crank_lights": {
                question_pl: "Czy dzia�aj� �wiat�a lub wska�niki na panelu?",
                question_en: "Are any lights/instruments on?",
                answers: [
                    { text_pl: "NIE - Ciemno��", text_en: "NO", next: { type: "tree", id: "electrical_core" } },
                    { text_pl: "TAK - �wiec�", text_en: "YES", next_node: "neutral_check" }
                ]
            },
            "neutral_check": {
                question_pl: "Czy manetka jest IdEALNIE w pozycji neutralnej (pionowo)?",
                question_en: "Is the throttle/gear lever EXACTLY in neutral?",
                answers: [
                    { text_pl: "NIE / Nie jestem pewien", text_en: "NO / UNSURE", solution_id: "neutral_safety" },
                    { text_pl: "TAK - Sprawdzone", text_en: "YES", next_node: "starter_click" }
                ]
            },
            "starter_click": {
                question_pl: "Czy s�yszysz 'klikni�cie' przy przekr�caniu kluczyka?",
                question_en: "do you hear a click when turning key?",
                answers: [
                    { text_pl: "TAK - S�ycha� klik", text_en: "YES", solution_id: "starter_solenoid" },
                    { text_pl: "NIE - Absolutna cisza", text_en: "NO", solution_id: "ignition_switch" }
                ]
            },

            // B. SLOw CRANK
            "slow_crank_lights": {
                question_pl: "Czy �wiat�a w kabinie przygasaj� podczas pr�by kr�cenia?",
                question_en: "do cabin lights dim heavily during cranking?",
                answers: [
                    { text_pl: "TAK - Przygasaj� mocno", text_en: "YES", next: { type: "tree", id: "electrical_core" } },
                    { text_pl: "NIE - �wiec� jasno", text_en: "NO", next: { type: "solution", id: "mech_drag" } }
                ]
            },

            // C. CRANK NO START
            "crank_smoke_check": {
                question_pl: "Sp�jrz na wydech podczas kr�cenia. Czy leci dym?",
                question_en: "Is there exhaust smoke while cranking?",
                answers: [
                    { text_pl: "Brak dymu (Czyste powietrze)", text_en: "No smoke", next_node: "fuel_supply_check" },
                    { text_pl: "Bia�y dym", text_en: "white smoke", next: { type: "tree", id: "white_smoke_diagnostic" } },
                    { text_pl: "Czarny dym", text_en: "Black smoke", next: { type: "solution", id: "air_exhaust_block" } }
                ]
            },
            // C1A No Smoke
            "fuel_supply_check": {
                question_pl: "Odkr�� lekko nakr�tk� wtryskiwacza. Czy podczas kr�cenia sika paliwo?",
                question_en: "Is fuel visible at injector lines while cranking?",
                answers: [
                    { text_pl: "NIE - Sucho", text_en: "NO", next: { type: "solution", id: "fuel_supply_fail" } },
                    { text_pl: "TAK - Paliwo tryska (z b�blami)", text_en: "YES, briefly/bubbles", next: { type: "tree", id: "fuel_air_ingress_diagnostic" } }
                ]
            },
            // C1B white Smoke
            "white_smoke_check": {
                question_pl: "Czy silnik pr�buje 'zaskoczy�' (kaszle)?",
                question_en: "does engine attempt to fire?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "decompression_timing" },
                    { text_pl: "NIE - Tylko kr�ci", text_en: "NO", solution_id: "glow_plugs_comp" }
                ]
            },

            // d. STARTS THEN STOPS
            "starts_stops_duration": {
                question_pl: "Czy r�czne pompowanie paliwa (pompk� na silniku) pozwala mu pracowa� d�u�ej?",
                question_en: "does manual fuel pumping keep it running longer?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "fuel_starvation" },
                    { text_pl: "NIE", text_en: "NO", solution_id: "safety_shutdown" }
                ]
            },

            // E. RUNS POORLY
            "runs_poorly_neutral": {
                question_pl: "wrzu� luz (Neutral). Czy silnik wchodzi na obroty normalnie?",
                question_en: "In neutral, does engine rev freely?",
                answers: [
                    { text_pl: "TAK - Na luzie jest OK", text_en: "YES", solution_id: "prop_fouling" },
                    { text_pl: "NIE - dusi si� te� na luzie", text_en: "NO", next_node: "load_smoke_check" }
                ]
            },
            "load_smoke_check": {
                question_pl: "Jaki dym wida� przy dodawaniu gazu?",
                question_en: "Smoke under load?",
                answers: [
                    { text_pl: "Czarny dym", text_en: "BLACK", next: { type: "solution", id: "overfuel_block" } },
                    { text_pl: "Bia�y dym", text_en: "wHITE", next: { type: "tree", id: "white_smoke_diagnostic" } },
                    { text_pl: "Brak dymu", text_en: "NONE", next: { type: "tree", id: "fuel_contamination_diagnostic" } }
                ]
            },

            // F. OVERHEATING
            "overheat_water": {
                question_pl: "Sp�jrz na wydech. Jak wygl�da wylot wody i spalin?",
                question_en: "Look at the exhaust. what is the water and smoke status?",
                answers: [
                    { text_pl: "BRAK wOdY - Suchy wydech / para", text_en: "NO waTER - dry exhaust / steam", next: { type: "tree", id: "overheating_master" } },
                    { text_pl: "wOdA LECI - Ale silnik si� grzeje", text_en: "waTER FLOwING - But engine overheats", next: { type: "tree", id: "overheating_master" } },
                    { text_pl: "NIEBIESKA PARA - Zapach s�odki", text_en: "BLUE STEAM - Sweet smell", next: { type: "solution", id: "coolant_ingress" } }
                ]
            }
        }
    },

    // === dRIVE BELT LOGIC ===
    "drive_belt_core": {
        id: "drive_belt_core",
        title_pl: "Paski Nap�dowe (drive Belts)",
        title_en: "Engine drive Belts diagnostic Tree",
        start_node: "belt_symptom",
        nodes: {
            "belt_symptom": {
                question_pl: "co najlepiej opisuje problem z paskiem?",
                question_en: "what best describes the belt issue?",
                answers: [
                    { text_pl: "Piszczenie / Ha�as", text_en: "Squeal / Noise", next_node: "belt_tension_check" },
                    { text_pl: "Pasek zerwany / brak go", text_en: "Belt snapped / missing", next_node: "belt_snapped_check" },
                    { text_pl: "widoczny py� / strz�pienie", text_en: "Visible dust / fraying", next_node: "belt_alignment_check" },
                    { text_pl: "Brak �adowania / ch�odzenia", text_en: "No charging / cooling", next_node: "belt_tension_check" }
                ]
            },
            "belt_tension_check": {
                question_pl: "Czy pasek jest lu�ny? (daje si� ugi�� >1cm lub obr�ci� o >90st?)",
                question_en: "Is the belt loose? (deflection >1cm or twist >90deg?)",
                answers: [
                    { text_pl: "TAK - Jest lu�ny", text_en: "YES - Loose", solution_id: "belt_loose_adjustment" },
                    { text_pl: "NIE - Naci�g OK", text_en: "NO - Tension OK", next_node: "belt_glazing_check" }
                ]
            },
            "belt_glazing_check": {
                question_pl: "Czy powierzchnia paska jest b�yszcz�ca/zeszkolona (glazed)?",
                question_en: "Is the belt surface shiny or glazed?",
                answers: [
                    { text_pl: "TAK - Zeszkolony", text_en: "YES - Glazed", solution_id: "belt_glazed_replace" },
                    { text_pl: "NIE - wygl�da OK", text_en: "NO", next_node: "belt_alignment_check" }
                ]
            },
            "belt_alignment_check": {
                question_pl: "Czy ko�a pasowe s� w jednej linii? (Sprawd� czy pasek nie 'ucieka' na bok)",
                question_en: "Are pulleys aligned? (Check if belt rides to one side)",
                answers: [
                    { text_pl: "NIE - Brak osiowo�ci", text_en: "NO - Misaligned", solution_id: "belt_alignment_fix" },
                    { text_pl: "TAK - Prosto", text_en: "YES", next_node: "pulley_damage_check" }
                ]
            },
            "pulley_damage_check": {
                question_pl: "Czy na rowkach k� pasowych wida� rdz�, wyszczerbienia lub ostre kraw�dzie?",
                question_en: "Are there nicks, rust, or sharp edges in pulley grooves?",
                answers: [
                    { text_pl: "TAK - Uszkodzone", text_en: "YES - damaged", solution_id: "pulley_replace" },
                    { text_pl: "NIE - G�adkie", text_en: "NO", next_node: "belt_bearing_check" }
                ]
            },
            "belt_bearing_check": {
                question_pl: "Zdejmij pasek. Czy ko�o alternatora/pompy kr�ci si� z oporem lub ha�asuje?",
                question_en: "Remove belt. does pulley spin with resistance or noise?",
                answers: [
                    { text_pl: "TAK - Ha�as / Luz", text_en: "YES - Noise / Play", solution_id: "bearing_failure_replace" },
                    { text_pl: "NIE - Kr�ci g�adko", text_en: "NO", solution_id: "belt_unknown_noise" }
                ]
            },
            "belt_snapped_check": {
                question_pl: "Czy zerwany pasek uszkodzi� co� wok�? (Kable, w�e, os�ony)",
                question_en: "did the snapped belt damage anything nearby? (wires, hoses, covers)",
                answers: [
                    { text_pl: "TAK - wida� uszkodzenia", text_en: "YES - damage found", solution_id: "belt_secondary_damage" },
                    { text_pl: "NIE - Tylko pasek", text_en: "NO", solution_id: "belt_replace_only" }
                ]
            }
        }
    },

    // === EXHAUST MIXING ELBOw LOGIC ===
    "exhaust_elbow_core": {
        id: "exhaust_elbow_core",
        title_pl: "Kolanko wydechowe (Mixing Elbow)",
        title_en: "Exhaust Mixing Elbow diagnostic Tree",
        start_node: "elbow_symptom",
        nodes: {
            "elbow_symptom": {
                question_pl: "Jaki jest g��wny objaw problemu z wydechem?",
                question_en: "Main exhaust issue symptom?",
                answers: [
                    { text_pl: "Spadek mocy / Czarny dym", text_en: "Loss of power / Black smoke", next_node: "elbow_blockage_check" },
                    { text_pl: "Przegrzewanie silnika", text_en: "Engine overheating", next_node: "elbow_water_flow_check" },
                    { text_pl: "wyciek / rdza na kolanku", text_en: "Leak / Rust on elbow", next_node: "elbow_corrosion_check" }
                ]
            },
            "elbow_blockage_check": {
                question_pl: "Czy silnik dusi si� pod obci��eniem, ale na luzie kr�ci normalnie?",
                question_en: "does engine struggle under load but rev fine in neutral?",
                answers: [
                    { text_pl: "TAK - dusi si�", text_en: "YES", next_node: "elbow_carbon_inspect" },
                    { text_pl: "NIE - Inny problem", text_en: "NO", next_node: "elbow_corrosion_check" }
                ]
            },
            "elbow_carbon_inspect": {
                question_pl: "Zdejmij w�� wydechowy. Czy przelot kolanka jest mocno zw�ony przez nagar/sadz�?",
                question_en: "Remove exhaust hose. Is the passage narrowed by carbon/soot?",
                answers: [
                    { text_pl: "TAK - Zatkane", text_en: "YES - Clogged", solution_id: "elbow_carbon_clean" },
                    { text_pl: "NIE - Czysto", text_en: "NO", next_node: "elbow_corrosion_check" }
                ]
            },
            "elbow_corrosion_check": {
                question_pl: "Czy na obudowie kolanka wida� dziurki, s�l lub zaciekki rdzy?",
                question_en: "Are there pinholes, salt crystals, or rust bleeding on the elbow?",
                answers: [
                    { text_pl: "TAK - Przerdzewia�e", text_en: "YES - corroded", solution_id: "elbow_replace_corroded" },
                    { text_pl: "NIE - wygl�da solidnie", text_en: "NO", next_node: "elbow_water_flow_check" }
                ]
            },
            "elbow_water_flow_check": {
                question_pl: "Czy ilo�� wody wylatuj�cej z wydechu jest wyra�nie mniejsza ni� zwykle?",
                question_en: "Is exhaust water flow significantly less than Usual?",
                answers: [
                    { text_pl: "TAK - Ma�o wody", text_en: "YES - Low flow", next_node: "elbow_water_injection_inspect" },
                    { text_pl: "NIE - woda leci OK", text_en: "NO", solution_id: "exhaust_other_issue" }
                ]
            },
            "elbow_water_injection_inspect": {
                question_pl: "Sprawd� ma�e otwory wtrysku wody wewn�trz kolanka. Czy s� zatkane kamieniem/sol�?",
                question_en: "Check water injection holes inside elbow. Clogged with scale/salt?",
                answers: [
                    { text_pl: "TAK - Zatkane otwory", text_en: "YES - Clogged ports", next: { type: "solution", id: "elbow_water_ports_clean" } },
                    { text_pl: "NIE - Otwory czyste", text_en: "NO", next: { type: "tree", id: "overheating_master" } }
                ]
            }
        }
    }
};

// Rozwi�zania (Solutions) dla drzew
const treeSolutions = {
    "expert_required": {
        title: { en: "Expert Required", pl: "wymagana Pomoc Eksperta" },
        description: {
            en: "Cannot determine safely with available information.",
            pl: "Nie mo�na bezpiecznie ustali� przyczyny na podstawie dost�pnych informacji."
        },
        steps: [
            { en: "Stop attempts and call mechanic.", pl: "Przerwij pr�by i wezwij mechanika." }
        ],
        is_temporary: false
    },
    // === GASOLINE SOLUTIONS ===
    "gas_leak_danger": {
        title_pl: "wYCIEK PALIwa - NIEBEZPIECZE�STwO",
        title_en: "FUEL LEAK - dANGER",
        description_pl: "Opary benzyny s� wybuchowe. NIE URUCHAMIAJ siLNIKA.",
        description_en: "Gasoline vapors are explosive. dO NOT START ENGINE.",
        steps: ["STOP - wy��cz zasilanie", "Przewietrz komor� silnika / z�z�", "Zlokalizuj i Usu� wyciek"]
    },
    "gas_neutral_safety": {
        title_pl: "Blokada Rozruchu (Bieg)",
        title_en: "NEUTRAL SAFETY SwITCH",
        description_pl: "silnik nie odpali na biegu (zabezpieczenie).",
        description_en: "Engine won't start in gear (safety).",
        steps: ["wrzu� luz (Neutral)", "Poruszaj manetk�", "Sprawd� w��cznik neutrala"]
    },
    "gas_kill_switch_missing": {
        title_pl: "Brak Zrywki (Kill Switch)",
        title_en: "KILL SwITCH / LANYARd MISsiNG",
        description_pl: "Zap�on jest odci�ty przez brak zrywki.",
        description_en: "Ignition cut off due to missing lanyard.",
        steps: ["wepnij zrywk�", "Sprawd� czy guzik zrywki nie zaci�� si�"]
    },
    "gas_hydrolock_jam": {
        title_pl: "Blokada Mechaniczna / Hydrolock",
        title_en: "MECHANICAL JAM / HYdROLOCK",
        description_pl: "silnik zablokowany (woda w cylindrze lub awaria mechaniczna).",
        description_en: "Engine locked (water in cylinder or mechanical failure).",
        steps: ["STOP - Nie szarp na si��", "wykr�� �wiec�", "Poci�gnij powoli by wydmucha� wod�"]
    },
    "gas_unknown_no_start": {
        title_pl: "Nieznany Problem Rozruchu",
        title_en: "UNKNOwN START ISSUE",
        description_pl: "silnik kr�ci si� swobodnie ale nie odpala. Przejd� do Sprawdzania iskry.",
        description_en: "Engine turns freely but won't start. Check spark.",
        steps: ["Przejd� do sekcji: Kr�ci ale nie odpala", "Sprawd� Iskr�", "Sprawd� Paliwo"]
    },
    "gas_dead_battery": {
        title_pl: "Roz�adowany Akumulator",
        title_en: "dEAd BATTERY",
        description_pl: "Za ma�o pr�du do rozruchu.",
        description_en: "Not enough power to crank.",
        steps: ["Odpal z szarpanki (je�li jest)", "Po��cz akumulatory (Emergency)", "Na�aduj akumulator"]
    },
    "gas_solenoid_fail": {
        title_pl: "Awaria Solenoidu / Rozrusznika",
        title_en: "SOLENOId / STARTER FAILURE",
        description_pl: "S�ycha� klikni�cie, ale rozrusznik nie kr�ci.",
        description_en: "Click heard, but starter won't turn.",
        steps: ["Opukaj rozrusznik", "Sprawd� kable (korozja)", "Expert: Zmostkuj solenoid"]
    },
    "gas_key_switch_fail": {
        title_pl: "Awaria Stacyjki / Neutrala",
        title_en: "KEY SwITCH / NEUTRAL SwITCH",
        description_pl: "Brak reakcji na kluczyk.",
        description_en: "No response to key.",
        steps: ["Sprawd� czy jest na luzie", "Poruszaj manetk�", "Sprawd� bezpiecznik zap�onu"]
    },
    "gas_ignition_failure": {
        title_pl: "Brak Iskry (Ignition Failure)",
        title_en: "IGNITION FAILURE",
        description_pl: "Uk�ad zap�onowy nie generuje iskry.",
        description_en: "Ignition system not generating spark.",
        steps: ["Sprawd� czy zrywka nie masuje", "Od��cz kabel gaszenia (Kill wire) od modu�u", "Sprawd� cewk� i modu� CdI"]
    },
    "gas_no_fuel": {
        title_pl: "Brak Paliwa w Cylindrze",
        title_en: "NO FUEL",
        description_pl: "Sucha �wieca oznacza, �e paliwo nie dochodzi.",
        description_en: "dry plug means fuel is not reaching cylinder.",
        steps: ["Sprawd� czy kranik otwarty", "Wyczy�� ga�nik (dysze)", "Sprawd� czy p�ywak si� nie zawiesi�"]
    },
    "gas_flooded": {
        title_pl: "Zalany silnik (Flooded)",
        title_en: "FLOOdEd ENGINE",
        description_pl: "Za du�o paliwa w cylindrze (mokra �wieca).",
        description_en: "Too much fuel in cylinder (wet plug).",
        steps: ["Otw�rz przepustnic� na MAX (Full Throttle)", "Kr�� silnikiem by przedmucha�", "Wyczy�� i osusz �wiec�"]
    },
    "gas_idle_circuit": {
        title_pl: "Zatkany Uk�ad wolnych Obrot�w",
        title_en: "CLOGGEd IdLE CIRCUIT",
        description_pl: "silnik ga�nie jak tylko pu�cisz gaz.",
        description_en: "Engine dies as soon as you let off throttle.",
        steps: ["Wyczy�� dysz� wolnych obrot�w (Pilot Jet)", "Podkr�� �rub� obrot�w (Idle Screw)", "U�ywaj ssania na wolnych"]
    },
    "gas_lean_condition": {
        title_pl: "Uboga Mieszanka (Lean)",
        title_en: "LEAN coNdITION",
        description_pl: "Za du�o powietrza, za ma�o paliwa.",
        description_en: "Too much air, not enough fuel.",
        steps: ["Sprawd� czy nie �apie 'lewego' powietrza", "Wyczy�� ga�nik", "Przymknij lekko ssanie (p�-ssanie)"]
    },
    "gas_fuel_supply_intermittent": {
        title_pl: "Przerywany dop�yw Paliwa",
        title_en: "INTERMITTENT FUEL SUPPLY",
        description_pl: "Paliwo dochodzi nieregularnie.",
        description_en: "Fuel supply is irregular.",
        steps: ["Sprawd� odpowietrzenie zbiornika", "Wymie� filtr paliwa", "Sprawd� lini� paliwow�"]
    },
    "gas_load_issue": {
        title_pl: "Problem z Obci��eniem (�ruba)",
        title_en: "LOAd ISSUE / PROP",
        description_pl: "silnik sprawny, ale nap�d stawia op�r.",
        description_en: "Engine fine, but drive train resists.",
        steps: ["Sprawd� czy co� nie wkr�ci�o si� w �rub�", "Sprawd� czy piasta �ruby (hub) si� nie obr�ci�a"]
    },
    "gas_lean_timing": {
        title_pl: "Strzelanie (Lean / Timing)",
        title_en: "BACKFIRING (LEAN / TIMING)",
        description_pl: "Strza�y w ga�nik lub wydech.",
        description_en: "Popping in carb or exhaust.",
        steps: ["Zbyt uboga mieszanka (Wyczy�� ga�nik)", "Przestawiony zap�on (rzadkie - zerwany klin ko�a magnesowego)"]
    },
    "gas_main_jet_flow": {
        title_pl: "Zatkany dysza G��wna",
        title_en: "CLOGGEd MAIN JET",
        description_pl: "Brak mocy na wysokich obrotach.",
        description_en: "No power at high RPM.",
        steps: ["Wyczy�� dysz� g��wn� (Main Jet)", "Sprawd� filtr paliwa (za ma�y przep�yw)", "Sprawd� pomp� paliwa"]
    },
    "gas_general_rough": {
        title_pl: "Nier�wna Praca",
        title_en: "ROUGH RUNNING",
        description_pl: "silnik pracuje, ale trz�sie/przerywa.",
        description_en: "Engine runs but shakes/misses.",
        steps: ["Wymie� �wiec� zap�onow�", "Sprawd� jako�� paliwa (woda?)", "wyreguluj ga�nik"]
    },
    "gas_cooling_failure": {
        title_pl: "Awaria Ch�odzenia",
        title_en: "coOLING FAILURE",
        description_pl: "Brak wody ch�odz�cej.",
        description_en: "No cooling water.",
        steps: ["Sprawd� wlot wody (torebka foliowa?)", "Wymie� wirnik pompy (Impeller)", "Przeczy�� otw�r kontrolny (Tell-tale) drutem"]
    },
    "gas_overheat_other": {
        title_pl: "Przegrzewanie (Inne)",
        title_en: "OVERHEATING (OTHER)",
        description_pl: "woda leci, ale silnik gor�cy.",
        description_en: "water flows but engine hot.",
        steps: ["Uszkodzony termostat", "Zakamienione kana�y wodne", "Zbyt uboga mieszanka (powoduje grzanie)"]
    },
    "gas_loose_wire_fuel": {
        title_pl: "Lu�ny Kabel / Paliwo",
        title_en: "LOOSE wIRE / FUEL",
        description_pl: "Losowe ga�ni�cie.",
        description_en: "Random shutdown.",
        steps: ["Sprawd� wszystkie z��czki elektryczne", "Sprawd� wod� w paliwie", "Sprawd� odpowietrzenie zbiornika"]
    },
    "gas_thermal_failure": {
        title_pl: "Awaria Termiczna (Cewka/Modu�)",
        title_en: "THERMAL FAILURE (coIL/CdI)",
        description_pl: "Elementy elektroniki psuj� si� po nagrzaniu.",
        description_en: "Electronics fail when hot.",
        steps: ["Sch�od� cewk�/modu� mokr� szmat� - jak odpali to masz winowajc�", "Wymie� cewk� zap�onow�", "Wymie� modu� zap�onowy"]
    },
    "gas_coil_failure_permanent": {
        title_pl: "Trwa�a Awaria Zap�onu",
        title_en: "PERMANENT IGNITION FAILURE",
        description_pl: "silnik zgas� i nie odpala.",
        description_en: "Engine died and won't restart.",
        steps: ["Sprawd� iskr�", "Wymie� �wiec�", "Szukaj usterki w uk�adzie zap�onowym"]
    },
    // A. NO CRANK
    "hydrolock_crit": {
        title_pl: "HYdROLOCK (woda w cylindrze) - KRYTYCZNE",
        title_en: "HYdROLOCK / MECHANICAL FAILURE",
        description_pl: "silnik zablokowany mechanicznie wod�. dalsze kr�cenie zniszczy korbowody.",
        description_en: "Engine locked by water. Cranking will bend connecting rods.",
        steps: ["STOP IMMEdIATELY - dO NOT CRANK", "Zamknij wlot wody", "Je�li na morzu: Holowanie", "Expert: wykr�� wtryskiwacze by wydmucha� wod�"]
    },
    "main_power_fail": {
        title_pl: "Awaria G��wnego Zasilania",
        title_en: "MAIN POwER FAILURE",
        description_pl: "Brak pr�du w systemie.",
        steps: ["Sprawd� g��wny hebel (Battery Selector)", "Sprawd� g��wny bezpiecznik", "Prze��cz na akumulator awaryjny (Emergency/House)"]
    },
    "neutral_safety": {
        title_pl: "Blokada Rozruchu (Bieg)",
        title_en: "NEUTRAL SAFETY SwITCH",
        description_pl: "Rozrusznik odci�ty bo silnik jest na biegu.",
        steps: ["Poruszaj manetk� (wiggle lever)", "wci�nij przycisk wysprz�glenia (declutch button)", "Spr�buj odpali� w pozycji Neutral"]
    },
    "starter_solenoid": {
        title_pl: "zaci�ty Solenoid Rozrusznika",
        title_en: "STARTER SOLENOId",
        description_pl: "Pr�d dochodzi, ale automat nie wyrzuca.",
        steps: ["Opukaj rozrusznik m�otkiem (Tap starter)", "Sprawd� kable przy rozruszniku", "Expert: Zmostkuj �rubokr�tem (Bridge solenoid)"]
    },
    "ignition_switch": {
        title_pl: "Uszkodzona Stacyjka / Obw�d",
        title_en: "IGNITION CIRCUIT / KEY SwITCH",
        description_pl: "Sygna� ze stacyjki nie dociera do rozrusznika.",
        steps: ["Sprawd� kable za stacyjk�", "Sprawd� bezpiecznik zap�onu", "U�yj przycisku awaryjnego (je�li jest)"]
    },

    // B. SLOw CRANK
    "battery_fail": {
        title_pl: "Roz�adowany Akumulator / Z�e Po��czenie",
        title_en: "BATTERY / coNNECTION ISSUE",
        description_pl: "Spadek napi�cia pod obci��eniem.",
        steps: ["Prze��cz na HOUSE bank", "Wyczy�� klemy (no�em/papierem)", "Z��cz akumulatory (Parallel switch)"]
    },
    "mech_drag": {
        title_pl: "Op�r Mechaniczny (Zatarcie?)",
        title_en: "MECHANICAL dRAG",
        description_pl: "Rozrusznik ma pr�d, ale nie ma si�y kr�ci�.",
        steps: ["Sprawd� czy alternator nie zatarty (zdejmij pasek)", "Mo�liwy cz�ciowy Hydrolock - STOP", "Sprawd� olej"]
    },

    // C. CRANK NO START
    "fuel_supply_fail": {
        title_pl: "Brak Paliwa (Supply Failure)",
        title_en: "SUPPLY FAILURE",
        description_pl: "Paliwo nie dociera do pompy wtryskowej.",
        steps: ["Sprawd� zaw�r paliwa na zbiorniku", "Sprawd� filtr wst�pny (Primary)", "Omi� filtr (bypass) i podaj paliwo z kanistra grawitacyjnie"]
    },
    "air_lock": {
        title_pl: "Zapowietrzenie (Air Lock)",
        title_en: "AIR LOCK",
        description_pl: "Powietrze w przewodach wysokiego ci�nienia.",
        steps: ["Poluzuj nakr�tki wtryskiwaczy", "Kr�� a� poleci czyste paliwo bez b�bli", "Dokr�� i odpal"]
    },
    "decompression_timing": {
        title_pl: "dekompresja / Timing",
        title_en: "dEcoMPRESsiON / TIMING",
        description_pl: "silnik pr�buje �apa�, ale nie ma kompresji.",
        steps: ["Sprawd� d�wigni� dekompresatora", "Ustaw w pozycji 'Run'", "Sprawd� czy linka stopu nie jest naci�gni�ta"]
    },
    "glow_plugs_comp": {
        title_pl: "�wiece �arowe / Kompresja",
        title_en: "LOw coMPRESsiON / coLd",
        description_pl: "Zimny silnik lub s�aba kompresja.",
        steps: ["Grzej �wiece przez 30-60 sekund", "Kr�� cyklami po 10 sekund", "U�yj 'Start Pilot' (ostateczno��!)"]
    },
    "air_exhaust_block": {
        title_pl: "Zablokowany dolot / wydech",
        title_en: "INTAKE / EXHAUST BLOCKAGE",
        description_pl: "silnik dusi si� w�asnymi spalinami lub brakiem powietrza.",
        steps: ["Otw�rz komor� silnika (wi�cej powietrza)", "Sprawd� filtr powietrza", "Sprawd� czy w�� wydechowy si� nie zapad�"]
    },

    // d. STARTS STOPS
    "fuel_starvation": {
        title_pl: "G��d Paliwowy (Starvation)",
        title_en: "FUEL STARVATION",
        description_pl: "Paliwo dociera, ale za wolno.",
        steps: ["Odkr�� korek wlewu paliwa (Odpowietrzenie)", "Sprawd� czy w�e nie s� zagi�te", "Wymie� filtr paliwa"]
    },
    "safety_shutdown": {
        title_pl: "Automatyczne wy��czenie (Safety Shutdown)",
        title_en: "OVERHEAT / SAFETY SHUTdOwN",
        description_pl: "System bezpiecze�stwa gasi silnik.",
        steps: ["Sprawd� poziom oleju", "Sprawd� czy jest ch�odzenie", "Sprawd� czujniki ci�nienia/temperatury"]
    },

    // E. RUNS POORLY
    "prop_fouling": {
        title_pl: "Lina w �rubie (Prop Fouling)",
        title_en: "LOAd sidE PROBLEM",
        description_pl: "silnik sprawny, ale co� blokuje wa�.",
        steps: ["Zanurkuj i oczy�� �rub�", "wrzu� luz i Sprawd� czy wibracje ustaj�", "Sprawd� hamulec wa�u"]
    },
    "overfuel_block": {
        title_pl: "Przelanie / wydech",
        title_en: "OVERFUEL / BLOCKEd EXHAUST",
        description_pl: "Za du�o paliwa lub zablokowany wylot.",
        steps: ["Sprawd� wtryskiwacze", "Sprawd� kolanko wydechowe", "Sprawd� czy �ruba nie jest za du�a (over-propped)"]
    },
    "injector_comp": {
        title_pl: "wtryskiwacz / Kompresja",
        title_en: "INJECTOR / coMPRESsiON",
        description_pl: "Bia�y dym pod obci��eniem = niespalone paliwo.",
        steps: ["Sprawd� wtryskiwacze (Lanie)", "Zmierz kompresj�", "Sprawd� uszczelk� pod g�owic�"]
    },
    "fuel_restrict_engine": {
        title_pl: "Ograniczenie Paliwa",
        title_en: "FUEL RESTRICTION",
        description_pl: "Brak mocy bez dymu = za ma�o paliwa.",
        steps: ["Wymie� filtry paliwa", "Sprawd� sitko w zbiorniku", "Sprawd� pompk� zasilaj�c� (Lift pump)"]
    },

    // F. OVERHEAT
    "raw_water_fail": {
        title_pl: "Brak wody Zaburtowej",
        title_en: "RAw waTER FAILURE",
        is_temporary: true,
        description_pl: "Uk�ad ch�odzenia nie pobiera wody.",
        steps: ["Wyczy�� filtr wody (Sea Strainer)", "Wymie� wirnik pompy (Impeller)", "Awaryjnie: wiadro wody do filtra (Expert)"]
    },
    "mixing_elbow_hot": {
        title_pl: "Zatkane Kolanko wydechowe",
        title_en: "EXHAUST / MIXING ELBOw",
        description_pl: "woda leci, ale przep�yw jest d�awiony.",
        steps: ["Sprawd� temperatur� kolanka (R�k� - ostro�nie!)", "Zredukuj obroty", "P�y� do portu na wolnych obrotach"]
    },
    // === ELECTRICAL SOLUTIONS ===
    "windlass_needs_engine": {
        title_pl: "w��cz silnik",
        title_en: "START ENGINE",
        description_pl: "winda pobiera ogromny pr�d. Musi pracowa� na w��czonym silniku.",
        steps: ["Uruchom silnik", "Zwi�ksz obroty (RPM)", "Spr�buj ponownie"]
    },
    "windlass_breaker_reset": {
        title_pl: "Zresetuj Bezpiecznik windy",
        title_en: "RESET wINdLASS BREAKER",
        description_pl: "Bezpiecznik zadzia�a� z przeci��enia.",
        steps: ["Znajd� bezpiecznik (du�y hebel/przycisk, cz�sto w kabinie dziobowej lub przy akumulatorach).", "wci�nij go z powrotem."]
    },
    "windlass_remote_battery": {
        title_pl: "Bateria Pilota / Solenoid",
        title_en: "REMOTE BATTERY / SOLENOId",
        description_pl: "Pilot nie wysy�a sygna�u lub cewka stycznika pad�a.",
        steps: ["Wymie� bateri� w pilocie.", "Spr�buj u�y� przycisk�w no�nych (je�li s�).", "Sprawd� 'control Box' (cykanie)."]
    },
    "windlass_low_voltage": {
        title_pl: "Niskie Napi�cie",
        title_en: "LOw VOLTAGE",
        description_pl: "winda dzia�a wolno bo ma za ma�o pr�du.",
        steps: ["Uruchom silnik!", "Sprawd� skorodowane kable przy windzie (du�y spadek napi�cia)."]
    },
    "windlass_clutch_tightened": {
        title_pl: "Sprz�g�o Dokr�cone",
        title_en: "CLUTCH TIGHTENEd",
        description_pl: "Sprz�g�o by�o poluzowane.",
        steps: ["U�ywaj wajchy windy do mocnego Dokr�cania sprz�g�a przed u�yciem."]
    },
    "windlass_stripped_gypsy": {
        title_pl: "Uszkodzona Cyga�ska (Gypsy)",
        title_en: "STRIPPEd GYPSY / coNE",
        description_pl: "Sto�ki sprz�g�a s� zu�yte.",
        steps: ["wymaga serwisu / wymiany elementu.", "wyci�gaj kotwic� r�cznie (wspomagaj wind�)."]
    },
    "winch_service_req": {
        title_pl: "wymagany Serwis Kabestanu",
        title_en: "wINCH SERVICE REQUIREd",
        description_pl: "Z�batki lub zapadki s� zatarte.",
        steps: ["Rozbierz kabestan.", "Wyczy�� stary smar.", "Nasmaruj (Olej na zapadki, Smar na z�batki)."]
    },
    "winch_solenoid_fail": {
        title_pl: "Awaria Solenoidu / Stycznika",
        title_en: "SOLENOId FAILURE",
        description_pl: "silnik jest sprawny, ale nie dostaje pr�du z 'puszki'.",
        steps: ["Opukaj skrzynk� z solenoidami (czasem si� wieszaj�).", "Sprawd� cienkie kable steruj�ce przy solenoidzie.", "Wymie� solenoid (cz�� zamienna)."]
    },
    "winch_internal_open": {
        title_pl: "Przerwa wewn�trz silnika",
        title_en: "INTERNAL MOTOR OPEN",
        description_pl: "silnik nie reaguje nawet na bezpo�rednie podanie pr�du.",
        steps: ["silnik do wymiany lub przewini�cia.", "Sprawd� szczotki silnika (je�li dost�p)."]
    },
    "winch_mechanical_jam": {
        title_pl: "Zablokowanie Mechaniczne",
        title_en: "MECHANICAL JAM",
        description_pl: "silnik buczy, bo nie mo�e obr�ci� b�bna.",
        steps: ["Zdejmij obci��enie (lin�).", "Spr�buj obr�ci� korb�.", "Rozbierz b�ben i Sprawd� czy co� nie wpad�o w tryby."]
    },
    "winch_clutch_fixed": {
        title_pl: "Sprz�g�o Dokr�cone",
        title_en: "CLUTCH FIXEd",
        description_pl: "Problem rozwi�zany - lu�ne gniazdo korby.",
        steps: ["Pami�taj, by zawsze dociska�/przekr�ca� gniazdo korby do ko�ca przed u�yciem elektrycznym."]
    },
    "winch_gear_disconnect": {
        title_pl: "Roz��czenie Przek�adni",
        title_en: "GEAR dIScoNNECT",
        description_pl: "silnik pracuje, ale nie nap�dza b�bna.",
        steps: ["Zerwany klin na wale silnika.", "Uszkodzona przek�adnia planetarna wewn�trz.", "wymagany serwis warsztatowy."]
    },
    "winch_stripped_gears": {
        title_pl: "Zmielone Z�batki",
        title_en: "STRIPPEd GEARS",
        description_pl: "Charakterystyczny d�wi�k zgrzytania.",
        steps: ["NIE U�YwaJ wI�CEJ - zniszczysz reszt�.", "U�yj kabestanu r�cznie (korb�) lub innego.", "wymiana z�batek."]
    },
    "winch_pendant_fail": {
        title_pl: "Awaria Pilota / Kabla",
        title_en: "REMOTE coNTROL FAIL",
        description_pl: "winny jest sterownik, nie kabestan.",
        steps: ["Sprawd� ci�g�o�� kabla pilota.", "Wyczy�� wtyczk� pilota (cz�sto koroduje).", "U�yj przycisk�w na pok�adzie (je�li s�)."]
    },
    "winch_voltage_drop": {
        title_pl: "Spadek Napi�cia",
        title_en: "VOLTAGE dROP",
        description_pl: "Kabestan pobiera pr�d, ale kable stawiaj� op�r.",
        steps: ["Wyczy�� wszystkie po��czenia kabli grubych (Plus i Minus).", "Sprawd� czy kable nie s� gor�ce (Wymie� przegrzane).", "Uruchom silnik by podbi� napi�cie."]
    },
    "winch_internal_friction": {
        title_pl: "Tarcie wewn�trzne",
        title_en: "INTERNAL FRICTION",
        description_pl: "Stary smar stawia op�r.",
        steps: ["Kabestan wymaga czyszczenia i smarowania.", "Zdejmij b�ben, wymyj w benzynie, nasmaruj."]
    },
    "winch_low_battery": {
        title_pl: "Roz�adowany Akumulator",
        title_en: "LOw BATTERY",
        description_pl: "Za ma�o pr�du by utrzyma� solenoid.",
        steps: ["Na�aduj akumulator.", "w��cz silnik.", "Po��cz banki (Parallel)."]
    },
    "winch_bad_ground": {
        title_pl: "S�aba Masa",
        title_en: "BAd GROUNd",
        description_pl: "Solenoid 'cyka' bo masa ucieka pod obci��eniem.",
        steps: ["Odkr�� i Wyczy�� kabel masowy przy silniku kabestanu.", "Sprawd� mas� przy akumulatorze."]
    },
    "winch_wireless_battery": {
        title_pl: "Bateria w Pilocie",
        title_en: "REMOTE BATTERY",
        description_pl: "Pilot bezprzewodowy nie dzia�a.",
        steps: ["Wymie� bateri� w pilocie.", "Sparuj pilot ponownie (zgodnie z instrukcj�)."]
    },
    "winch_deck_switch_water": {
        title_pl: "Zalany Przycisk Pok�adowy",
        title_en: "wET dECK SwITCH",
        description_pl: "woda w przycisku no�nym.",
        steps: ["Rozkr�� przycisk i wysusz.", "Zewrzyj kable pod przyciskiem by Sprawdzi� czy kabestan ruszy (Ostro�nie!)."]
    },
    "winch_button_fail": {
        title_pl: "Awaria Przycisku Kabestanu",
        title_en: "wINCH BUTTON FAIL",
        description_pl: "Przycisk no�ny/r�czny skorodowa�.",
        steps: ["Zewrzyj kable pod przyciskiem (ostro�nie!).", "Wymie� przycisk."]
    },
    "emergency_bypass_wire": {
        title_pl: "Obej�cie Awaryjne (bypass)",
        title_en: "EMERGENCY byPASS",
        is_temporary: true,
        description_pl: "Omini�cie uszkodzonego odcinka instalacji.",
        steps: ["U�yj kabla rozruchowego aby po��czy� PLUS akumulatora z szyn� PLUS.", "Je�li zadzia�a - masz uszkodzony kabel g��wny lub hebel.", "Ostro�nie! Kabel nie ma bezpiecznika - nie dotykaj masy!"]
    },
    "battery_low_critical": {
        title_pl: "Akumulator Krytycznie S�aby",
        title_en: "BATTERY CRITICAL LOw",
        description_pl: "Napi�cie jest, ale za ma�e by cokolwiek uruchomi�.",
        steps: ["wy��cz wszystkie zb�dne odbiorniki.", "Po��cz banki (Parallel Switch).", "Uruchom silnik (je�li mo�liwe) i �aduj min. 1h."]
    },
    "panel_feeder_fail": {
        title_pl: "Awaria Zasilania Sekcji",
        title_en: "SECTION FEEdER FAIL",
        description_pl: "Pad�a ca�a sekcja (np. ca�a tablica dC).",
        steps: ["Sprawd� bezpiecznik g��wny tej sekcji (cz�sto przy akumulatorze).", "Sprawd� czy kabel zasilaj�cy tablic� nie wypi�� si� z ty�u."]
    },
    "fuse_replaced_ok": {
        title_pl: "wymiana Bezpiecznika Pomog�a",
        title_en: "FUSE REPLACEMENT OK",
        description_pl: "System dzia�a na nowym bezpieczniku.",
        steps: ["Obserwuj przez 15 minut.", "Je�li znowu spali - masz zwarcie (Short Circuit).", "Je�li dzia�a - by� to jednorazowy skok (Old Fuse)."]
    },
    "wire_repair_basic": {
        title_pl: "Naprawa Przewodu",
        title_en: "BAsiC wIRE REPAIR",
        is_temporary: true,
        description_pl: "Uszkodzenie fizyczne przewodu.",
        steps: ["Oczy�� ko�c�wki no�em do b�ysku.", "Skr�� mocno i zaizoluj ta�m�.", "docelowo: Wymie� kabel i zar�b ko�c�wki."]
    },
    "moisture_corrosion": {
        title_pl: "wilgo� w Instalacji",
        title_en: "MOISTURE ISSUE",
        description_pl: "woda powoduje zwarcia lub brak styku.",
        steps: ["wydmuchaj wod� spr�onym powietrzem (lub ustami).", "Spryskaj wd-40 lub contact Cleanerem.", "Osusz suszark� je�li dost�pna."]
    },
    "thermal_expansion_fail": {
        title_pl: "Usterka Termiczna",
        title_en: "THERMAL EXPANsiON FAIL",
        description_pl: "Styk puszcza gdy metal si� nagrzewa.",
        steps: ["To gro�ne! Oznacza iskrzenie.", "Dokr�� wszystkie �ruby w torze pr�dowym.", "Sprawd� czy kable nie s� czarne od gor�ca."]
    },
    "alternator_wire_fix": {
        title_pl: "Urwany Kabel Alternatora",
        title_en: "ALTERNATOR wIRE BROKEN",
        is_temporary: true,
        description_pl: "wibracje urwa�y kabel wzbudzenia lub wyj�cia.",
        steps: ["Zar�b now� ko�c�wk� (lub owi� drut wok� �ruby).", "Zabezpiecz kabel trytytk�, �eby nie wibrowa�."]
    },
    "regulator_failure_bypass": {
        title_pl: "Awaria Regulatora (Obej�cie)",
        title_en: "REGULATOR FAIL (byPASS)",
        is_temporary: true,
        description_pl: "Regulator pad�, ale alternator jest sprawny.",
        steps: ["Mo�esz p�yn��, ale monitoruj napi�cie!", "Je�li wzro�nie powy�ej 15V - wy��cz silnik lub w��cz wszystkie �wiat�a �eby zbi� napi�cie."]
    },
    "battery_end_of_life": {
        title_pl: "Koniec �ycia Akumulatora",
        title_en: "BATTERY ENd OF LIFE",
        description_pl: "Akumulator nie trzyma pojemno�ci (zasiarczony).",
        steps: ["Nic nie zrobisz na morzu.", "U�ywaj tylko jednego banku, drugi oszcz�dzaj na rozruch.", "wymiana w porcie."]
    },
    "parasitic_draw_found": {
        title_pl: "Znaleziono Z�odzieja Pr�du",
        title_en: "PARAsiTIC dRAw FOUNd",
        description_pl: "Urz�dzenie pobiera pr�d mimo wy��czenia.",
        steps: ["wyjmij bezpiecznik tego urz�dzenia na sta�e.", "wk�adaj bezpiecznik tylko gdy u�ywasz urz�dzenia."]
    },
    "battery_self_discharge": {
        title_pl: "Samoroz�adowanie",
        title_en: "SELF dISCHARGE",
        description_pl: "wewn�trzne zwarcie w akumulatorze.",
        steps: ["Akumulator jest gor�cy mimo braku obci��enia?", "Od��CZ GO NATYCHMIAST - Ryzyko wybuchu!", "P�y� na pozosta�ych."]
    },
    "bilge_impeller_clog": {
        title_pl: "Zablokowany wirnik Z�zy",
        title_en: "BILGE IMPELLER CLOGGEd",
        description_pl: "co� wpad�o do pompy (w�osy, �mieci).",
        steps: ["Otw�rz kosz pompy.", "wyjmij �mieci z wirnika.", "Sprawd� czy wirnik si� kr�ci palcem."]
    },
    "bilge_switch_fail": {
        title_pl: "Awaria w��cznika/P�ywaka",
        title_en: "FLOAT SwITCH FAIL",
        is_temporary: true,
        description_pl: "pompa sprawna, automatyka pad�a.",
        steps: ["Zmostkuj kable w��cznika na sta�e (pompa b�dzie chodzi� ci�gle - musisz ni� sterowa� r�cznie z hebla).", "Lub pod��cz 'na kr�tko' do baterii gdy trzeba wypompowa�."]
    },
    "bilge_motor_burnout": {
        title_pl: "Spalona pompa Z�zowa",
        title_en: "BILGE PUMP BURNOUT",
        description_pl: "silnik pompy nie �yje.",
        steps: ["U�yj pompy r�cznej.", "U�yj wiadra.", "Prze�� pomp� prysznicow� do z�zy (je�li kable si�gn�)."]
    },
    "nav_light_fuse_switch": {
        title_pl: "Awaria Zasilania �wiate�",
        title_en: "NAV LIGHTS POwER FAIL",
        description_pl: "Brak pr�du na w��czniku �wiate�.",
        steps: ["Sprawd� bezpiecznik panelu.", "Sprawd� czy masa panelu nie odpad�a."]
    },
    "bulb_replacement": {
        title_pl: "wymiana �ar�wki",
        title_en: "BULB REPLACEMENT",
        description_pl: "Standardowa procedura.",
        steps: ["Odkr�� klosz.", "Oczy�� styki (cz�sto �niedziej�!).", "w�� now� �ar�wk�.", "Posmaruj wazelin� uszczelk�."]
    },
    "corroded_socket_nav": {
        title_pl: "Skorodowane Gniazdo �ar�wki",
        title_en: "coRROdEd SOCKET",
        is_temporary: true,
        description_pl: "Pr�d jest w kablu, ale nie przechodzi na �ar�wk�.",
        steps: ["wyskrob styki no�em/papierem �ciernym.", "Podegnij blaszki stykowe.", "AwaRYJNIE: Przylutuj kable bezpo�rednio do �ar�wki (je�li masz lutownic� gazow�)."]
    },
    "lightning_procedure": {
        title_pl: "Procedura po Piorunie",
        title_en: "LIGHTNING STRIKE PROTOcoL",
        description_pl: "Uderzenie pioruna mog�o zniszczy� wszystko.",
        steps: ["Sprawd� czy nie ma przeciek�w (piorun m�g� wybi� dziur� w dnie!).", "Sprawd� czy dzia�a radio VHF (wezwij pomoc je�li nie).", "Kompas magnetyczny mo�e k�ama�!", "U�yj r�cznego GPS/telefonu do nawigacji."]
    },
    "saltwater_procedure": {
        title_pl: "Procedura po Zalaniu",
        title_en: "SALTwaTER REcoVERY",
        description_pl: "Elektronika wpad�a do wody / fala zala�a panel.",
        steps: ["NATYCHMIAST Od��CZ ZAsiLANIE.", "Przep�ucz obficie S�OdK� wOd� (wyp�ucz s�l).", "wymocz w spirytusie (je�li masz).", "Susz na s�o�cu przez 24h min.", "Spryskaj contact Cleanerem przed w��czeniem."]
    },
    "electronics_hard_reset": {
        title_pl: "Twardy Reset Elektroniki",
        title_en: "HARd RESET",
        description_pl: "Plotter si� zawiesi�.",
        steps: ["Od��cz zasilanie (bezpiecznik) na 60 sekund.", "w��cz trzymaj�c przycisk Power (czasem uruchamia tryb serwisowy).", "Sprawd� kart� mapy (czy nie wyskoczy�a)."]
    },
    "electronics_internal_fail": {
        title_pl: "Awaria wewn�trzna",
        title_en: "INTERNAL FAILURE",
        description_pl: "Urz�dzenie uszkodzone.",
        steps: ["Nic nie zrobisz.", "U�yj zapasowych metod nawigacji (Papierowa mapa, Telefon, Tablet)."]
    },
    "fire_hazard": {
        title_pl: "ZAGRO�ENIE PO�AROwE",
        title_en: "FIRE HAZARd",
        description_pl: "Ryzyko po�aru instalacji elektrycznej.",
        steps: [
            "STOP - wy��cz G��wny Hebel (MAIN SwITCH OFF)",
            "Je�li AC: Od��cz zasilanie l�dowe / Inwerter",
            "Ga�nica w pogotowiu (klasa ABC)",
            "Odczekaj 15 minut a� ostygnie",
            "Nie w��czaj ponownie bez znalezienia przyczyny"
        ]
    },
    "operator_error_battery": {
        title_pl: "B��d Operatora - Prze��cznik",
        title_en: "OPERATOR ERROR",
        description_pl: "Niew�a�ciwa pozycja prze��cznika akumulator�w.",
        steps: ["Ustaw prze��cznik na w�a�ciwy bank (1, 2 lub BOTH)", "Sprawd� czy kluczyk nie jest wyj�ty"]
    },
    "battery_dead": {
        title_pl: "Roz�adowany / Uszkodzony Akumulator",
        title_en: "BATTERY EMPTY / FAILEd",
        description_pl: "Brak napi�cia na �r�dle.",
        steps: ["Po��cz banki (Parallel / Emergency)", "Odpal z innego �r�d�a (Jump start)", "Na�aduj akumulatory"]
    },
    "main_fuse_switch": {
        title_pl: "G��wny Bezpiecznik / Hebel",
        title_en: "MAIN FUSE / MAIN SwITCH",
        description_pl: "Przerwa na g��wnej linii zasilania.",
        steps: ["Sprawd� g��wny bezpiecznik (Mega Fuse)", "Sprawd� korozj� na g��wnym heblu", "Awaryjnie: Omi� bezpiecznik (Monitoruj temperatur�!)"]
    },
    "main_ground_failure": {
        title_pl: "Awaria G��wnej Masy",
        title_en: "MAIN GROUNd FAILURE",
        description_pl: "Brak po��czenia z minusem akumulatora.",
        steps: ["Sprawd� g��wny przew�d masowy", "Oczy�� po��czenie z blokiem silnika", "Awaryjnie: dodatkowy kabel masowy (np. z kabla rozruchowego)"]
    },
    "unknown_major_failure": {
        title_pl: "Niezidentyfikowana Awaria Zasilania",
        title_en: "UNKNOwN POwER FAILURE",
        description_pl: "Napi�cie jest na szynach, ale system nie dzia�a.",
        steps: ["Sprawd� czy nie ma spadk�w napi�cia pod obci��eniem", "wezwij elektryka"]
    },
    "short_overload": {
        title_pl: "Zwarcie / Przeci��enie",
        title_en: "SHORT / OVERLOAd",
        description_pl: "Zadzia�a�o zabezpieczenie obwodu.",
        steps: ["Wymie� bezpiecznik na TAKI SAM (nie wi�kszy!)", "Od��cz zb�dne odbiorniki", "Sprawd� czy kable si� nie grzej�"]
    },
    "broken_feed": {
        title_pl: "Przerwa w Obwodzie",
        title_en: "BROKEN FEEd",
        description_pl: "Napi�cie wychodzi z bezpiecznika, ale nie dociera do urz�dzenia.",
        steps: ["Szukaj przerwanego przewodu", "Sprawd� z��czki i konektory po drodze", "Awaryjnie: Poci�gnij tymczasowy 'plus' z pobliskiego urz�dzenia"]
    },
    "device_failure": {
        title_pl: "Awaria Urz�dzenia",
        title_en: "dEVICE FAILURE",
        description_pl: "Pr�d dochodzi, ale urz�dzenie nie dzia�a.",
        steps: ["Sprawd� styki w samym urz�dzeniu", "Urz�dzenie do wymiany/naprawy"]
    },
    "loose_connection": {
        title_pl: "Lu�ne Po��czenie",
        title_en: "LOOSE coNNECTION",
        description_pl: "Styk przerywa pod wp�ywem wibracji.",
        steps: ["Dokr�� klemy akumulatora", "Sprawd� ty� panelu bezpiecznik�w", "Zaklinuj lu�ne wtyczki"]
    },
    "ground_problem": {
        title_pl: "Problem z Mas� (Ground)",
        title_en: "GROUNd PROBLEM",
        description_pl: "wsp�lny problem dla wielu urz�dze� sugeruje awari� wsp�lnej masy.",
        steps: ["Sprawd� szyn� zbiorcz� masy", "Oczy�� punkty styku masy", "Awaryjnie: Poprowad� now� mas� do szyny"]
    },
    "mechanical_failure_belt": {
        title_pl: "Zerwany / Lu�ny Pasek",
        title_en: "MECHANICAL FAILURE (BELT)",
        is_temporary: true,
        description_pl: "Alternator nie jest nap�dzany.",
        steps: ["Naci�gnij pasek", "Wymie� pasek", "Awaryjnie: Pasek z rajstopy/linki (na kr�tko)"]
    },
    "excitation_circuit": {
        title_pl: "Obw�d wzbudzenia",
        title_en: "EXCITATION CIRCUIT",
        description_pl: "Alternator nie dostaje sygna�u startu.",
        steps: ["Przygazuj silnik (mo�e si� wzbudzi� sam)", "Sprawd� �ar�wk� kontrolki �adowania", "Sprawd� cienki kabel przy alternatorze"]
    },
    "regulator_short": {
        title_pl: "Zwarcie Regulatora",
        title_en: "REGULATOR / SHORT",
        description_pl: "Alternator przegrzewa si�, ryzyko po�aru.",
        steps: ["STOP CHARGING - wy��cz silnik", "Od��cz alternator", "P�y� na akumulatorach"]
    },
    "alternator_internal_fail": {
        title_pl: "Awaria Alternatora",
        title_en: "ALTERNATOR FAILURE",
        description_pl: "Alternator kr�ci si�, ale nie �aduje.",
        steps: ["Sprawd� szczotki (je�li dost�pne)", "wymiana alternatora"]
    },
    "charging_ok": {
        title_pl: "�adowanie OK",
        title_en: "CHARGING OK",
        description_pl: "Napi�cie �adowania jest prawid�owe.",
        steps: ["Szukaj problemu gdzie indziej (np. stary akumulator nie trzyma pr�du)"]
    },
    "shore_power_fault": {
        title_pl: "Awaria Zasilania L�dowego",
        title_en: "SHORE POwER FAULT",
        description_pl: "Brak napi�cia w s�upku lub kablu.",
        steps: ["Sprawd� bezpiecznik na kei", "Sprawd� inny kabel", "Sprawd� wtyczki (przypalone?)"]
    },
    "charger_failure": {
        title_pl: "Awaria �adowarki",
        title_en: "CHARGER FAILURE",
        description_pl: "�adowarka ma zasilanie, ale nie �aduje.",
        steps: ["Zresetuj �adowark� (wy��cz/w��cz)", "Sprawd� bezpieczniki wyj�ciowe na �adowarce", "�aduj silnikiem"]
    },
    "controller_dead": {
        title_pl: "Awaria Regulatora Solarnego",
        title_en: "coNTROLLER dEAd",
        description_pl: "Regulator nie daje oznak �ycia.",
        steps: ["Sprawd� bezpiecznik mi�dzy panelem a regulatorem", "Wymie� regulator"]
    },
    "solar_input_side": {
        title_pl: "Problem po stronie Paneli",
        title_en: "SOLAR INPUT ISSUE",
        is_temporary: true,
        description_pl: "Regulator dzia�a, ale nie �aduje.",
        steps: ["Sprawd� czy panele nie s� w cieniu", "Sprawd� z��cza MC4 na dachu", "Awaryjnie (Monitorowane): Pod��cz panel bezpo�rednio do aku (tylko w dzie�!)"]
    },
    "parasitic_draw": {
        title_pl: "Pob�r Paso�ytniczy (Z�odziej Pr�du)",
        title_en: "PARAsiTIC dRAw",
        description_pl: "co� zjada pr�d na postoju.",
        steps: ["wyci�gaj bezpieczniki po kolei patrz�c na iskrzenie/miernik", "Sprawd�: Radio, Bilge Pump, Inverter Standby", "Roz��czaj klemy na noc"]
    },
    "normal_discharge": {
        title_pl: "Normalne Zu�ycie",
        title_en: "NORMAL dISCHARGE",
        description_pl: "Brak ewidentnej usterki.",
        steps: ["Akumulatory mog� by� stare i straci�y pojemno��", "Bilans energetyczny ujemny (za du�o odbiornik�w)"]
    },
    "instrument_ground_issue": {
        title_pl: "wariuj�ce wska�niki (Masa)",
        title_en: "INSTRUMENT GROUNd ISSUE",
        description_pl: "wska�niki skacz�, alarmy piszcz� losowo.",
        steps: ["To na 90% s�aba masa", "Poci�gnij osobny kabel masowy od wska�nika do szyny", "Odizoluj 'szumi�ce' odbiorniki (Inverter, Lod�wka)"]
    },

    // === dIESEL EXPERT SOLUTIONS ===
    "no_crank_power": {
        title_pl: "Brak zasilania rozrusznika",
        title_en: "No starter power",
        description_pl: "Najbardziej prawdopodobna przyczyna (?75%). w warunkach marine brak kr�cenia niemal zawsze oznacza problem elektryczny.",
        description_en: "Most likely cause (~75%). In marine conditions, no cranking almost always indicates an electrical issue.",
        steps: ["Sprawd� napi�cie akumulatora.", "Sprawd� mas� i klemy.", "Sprawd� g��wny wy��cznik baterii."]
    },
    "no_fuel_or_air": {
        title_pl: "Brak paliwa lub zapowietrzenie uk�adu",
        title_en: "No fuel or air in the system",
        description_pl: "domy�lna przyczyna przy kr�ceniu bez zap�onu (?80%). Przy braku pewno�ci zawsze zak�ada si� problem z paliwem.",
        description_en: "default cause when cranking without firing (~80%). when uncertain, fuel issues are assumed.",
        steps: ["Sprawd� zawory paliwa.", "Sprawd� filtr paliwa.", "Odpowietrz uk�ad."]
    },
    "poor_combustion_conditions": {
        title_pl: "Niew�a�ciwe warunki spalania",
        title_en: "Poor combustion conditions",
        description_pl: "U�ywane jako fallback (?65%), gdy nie da si� jednoznacznie oceni� objaw�w.",
        description_en: "Used as a fallback (~65%) when symptoms cannot be clearly assessed.",
        steps: ["Sprawd� jako�� paliwa.", "Sprawd� wtryski.", "Uwzgl�dnij temperatur� i kompresj�."]
    },
    "restricted_fuel_flow": {
        title_pl: "Ograniczony przep�yw paliwa",
        title_en: "Restricted fuel flow",
        description_pl: "Najcz�stsza przyczyna ga�ni�cia bez danych pomiarowych (?70%).",
        description_en: "Most common cause of stalling without measurements (~70%).",
        steps: ["Wymie� filtr paliwa.", "Sprawd� przewody.", "Sprawd� odpowietrzenie zbiornika."]
    },
    "fuel_vent_or_overheat": {
        title_pl: "Odpowietrzenie zbiornika lub przegrzewanie",
        title_en: "Tank venting or overheating issue",
        description_pl: "Stosowane gdy brak danych, ale objaw zale�ny od czasu (?60%).",
        description_en: "Used when time-dependent symptoms exist but data is limited (~60%).",
        steps: ["Sprawd� odpowietrzenie zbiornika.", "Sprawd� uk�ad ch�odzenia."]
    },
    "air_or_fuel_restriction": {
        title_pl: "Ograniczony dop�yw powietrza lub paliwa",
        title_en: "Restricted air or fuel supply",
        description_pl: "Bezpieczne zaw�enie przy braku wiedzy u�ytkownika (?60%).",
        description_en: "Safe narrowing when user knowledge is limited (~60%).",
        steps: ["Sprawd� filtry.", "Sprawd� dolot."]
    },
    "turbo_or_injector_issue": {
        title_pl: "Awaria turbiny lub wtryskiwacza",
        title_en: "Turbocharger or injector failure",
        description_pl: "Mniej prawdopodobne, ale istotne przy nag�ej utracie mocy (?55%).",
        description_en: "Less likely but relevant for sudden power loss (~55%).",
        steps: ["Sprawd� do�adowanie.", "Sprawd� wtryski."]
    },
    "black_smoke": {
        title_pl: "Zbyt bogata mieszanka (Czarny dym)",
        title_en: "Over-fuelling (Black smoke)",
        description_pl: "Czarny dym nawet bez pewno�ci u�ytkownika (?75%).",
        description_en: "Black smoke even without user certainty (~75%).",
        steps: ["Sprawd� dolot.", "Sprawd� wtryski."]
    },
    "white_smoke": {
        title_pl: "Niespalone paliwo (Bia�y dym)",
        title_en: "Unburnt fuel (white smoke)",
        description_pl: "Cz�ste przy zimnym silniku i niepewnych obserwacjach (?65%).",
        description_en: "common on cold engines and uncertain observations (~65%).",
        steps: ["Sprawd� temperatur�.", "Sprawd� kompresj�."]
    },
    "blue_smoke": {
        title_pl: "Spalanie oleju (Niebieski dym)",
        title_en: "Oil burning (Blue smoke)",
        description_pl: "Rzadkie, ale jednoznaczne nawet przy ograniczonej obserwacji (?70%).",
        description_en: "Rare but clear even with limited observation (~70%).",
        steps: ["Sprawd� pier�cienie.", "Sprawd� prowadnice zawor�w."]
    },
    "unknown_voltage_device": {
        title_pl: "Nieznany Stan Zasilania (Prawdopodobie�stwo)",
        title_en: "UNKNOwN POwER STATE (Probability)",
        description_pl: "Bez pomiaru miernikiem nie mo�na wykluczy� awarii kabla.",
        description_en: "without multimeter test, cable failure cannot be ruled out.",
        steps: [
            "Szansa na awari� urz�dzenia: 60%",
            "Szansa na przerwany kabel: 40%",
        ]
    },

    // === dRIVE BELT SOLUTIONS ===
    "belt_loose_adjustment": {
        title_pl: "Lu�ny Pasek - wymagana Regulacja",
        title_en: "LOOSE BELT - AdJUSTMENT REQUIREd",
        description_pl: "Pasek jest zbyt lu�ny, co powoduje �lizganie i brak �adowania/ch�odzenia.",
        description_en: "Belt is too loose, causing slippage and failure to charge/cool.",
        steps: ["Poluzuj �rub� napinacza/alternatora", "U�yj d�wigni (np. trzonek m�otka) by naci�gn�� pasek", "Dokr�� �ruby i Sprawd� naci�g (ugi�cie ok. 1cm)"]
    },
    "belt_glazed_replace": {
        title_pl: "Zeszkolony Pasek - wymiana",
        title_en: "GLAZEd BELT - REPLACE",
        description_pl: "Powierzchnia paska jest spalona/zeszkolona od �lizgania. Nie b�dzie trzyma� przyczepno�ci.",
        description_en: "Belt surface is glazed/burnt from slipping. It will not maintain grip.",
        steps: ["Wymie� pasek na nowy", "Sprawd� czy ko�a pasowe nie s� t�uste od oleju", "Wyczy�� ko�a pasowe zmywaczem przed monta�em"]
    },
    "belt_alignment_fix": {
        title_pl: "Brak Osiowo�ci K� Pasowych",
        title_en: "PULLEY MISALIGNMENT",
        description_pl: "Ko�a pasowe nie s� w jednej linii, co powoduje szybkie zu�ycie paska.",
        description_en: "Pulleys are not aligned, causing rapid belt wear and fraying.",
        steps: ["Sprawd� czy alternator/pompa nie s� poluzowane", "Sprawd� stan tulejek gumowych (silentblock�w) mocowania", "Skoryguj ustawienie podk�adkami lub Dokr�ceniem mocowa�"]
    },
    "pulley_replace": {
        title_pl: "Uszkodzone Ko�o Pasowe",
        title_en: "dAMAGEd PULLEY",
        description_pl: "Rowki ko�a pasowego s� skorodowane lub uszkodzone, niszcz�c pasek.",
        description_en: "Pulley grooves are corroded or damaged, shredding the belt.",
        steps: ["Oczy�� rdz� papierem �ciernym (tymczasowo)", "Wymie� uszkodzone ko�o pasowe na nowe", "Sprawd� czy nie ma bicia osiowego"]
    },
    "bearing_failure_replace": {
        title_pl: "Awaria �o�yska (Alternator/pompa)",
        title_en: "BEARING FAILURE",
        description_pl: "�o�ysko urz�dzenia stawia op�r lub ha�asuje. Ryzyko zatarcia i zerwania paska.",
        description_en: "device bearing has failed. Risk of seizure and belt snap.",
        steps: ["Wymie� alternator lub pomp� wody", "w niekt�rych modelach mo�liwa wymiana samego �o�yska", "Nie p�y� na silniku je�li pompa wody jest zablokowana!"]
    },
    "belt_secondary_damage": {
        title_pl: "wt�rne Uszkodzenia po Zerwaniu",
        title_en: "SEcoNdARY BELT dAMAGE",
        description_pl: "Zerwany pasek uderzy� i uszkodzi� inne elementy.",
        description_en: "The snapped belt struck and damaged nearby components.",
        steps: ["Sprawd� kable przy alternatorze", "Sprawd� w�e wodne pod k�tem przeci��", "Napraw uszkodzone elementy przed startem silnika"]
    },
    "belt_replace_only": {
        title_pl: "wymiana Paska",
        title_en: "REPLACE BELT",
        description_pl: "Pasek uleg� zu�yciu lub p�k� bez innych uszkodze�.",
        description_en: "Belt wore out or snapped without additional damage.",
        steps: ["Za�� nowy pasek o identycznym rozmiarze", "Ustaw prawid�owy naci�g", "Uruchom silnik i Sprawd� czy nie piszczy pod obci��eniem"]
    },
    "belt_unknown_noise": {
        title_pl: "Nieustalony Ha�as Paska",
        title_en: "UNKNOwN BELT NOISE",
        description_pl: "Pasek i ko�a wygl�daj� OK, ale ha�as nadal wyst�puje.",
        description_en: "Belt and pulleys look OK but noise persists.",
        steps: ["U�yj sprayu do pask�w (tymczasowo)", "Sprawd� inne ko�a (np. napinacz automatyczny je�li jest)", "Obserwuj czy ha�as narasta pod obci��eniem elektrycznym"]
    },

    // === EXHAUST ELBOw SOLUTIONS ===
    "elbow_carbon_clean": {
        title_pl: "Zablokowany wydech (Nagar)",
        title_en: "EXHAUST CLOGGEd (CARBON)",
        description_pl: "Nagromadzenie nagaru zw�zi�o przelot spalin, dusz�c silnik.",
        description_en: "Carbon buildup has narrowed the exhaust passage, choking the engine.",
        steps: ["Zdemontuj kolanko wydechowe", "wyskrob nagar mechanicznie", "Namocz w chemii do czyszczenia EGR/Turbo je�li mo�liwe", "Wymie� uszczelk� pod kolankiem"]
    },
    "elbow_replace_corroded": {
        title_pl: "Przerdzewia�e Kolanko wydechowe",
        title_en: "coRROdEd MIXING ELBOw",
        description_pl: "Korozja prze�ar�a �cianki kolanka. Ryzyko zalania silnika wod� zaburtow�!",
        description_en: "corrosion has eaten through the elbow walls. Risk of water entering engine!",
        steps: ["Wymie� KOLANKO NA NOwE", "Nie pr�buj spawa� �eliwnego kolanka (nietrwa�e)", "Sprawd� czy woda nie dosta�a si� do cylindr�w"]
    },
    "elbow_water_ports_clean": {
        title_pl: "Zatkane Kana�y wodne Kolanka",
        title_en: "CLOGGEd waTER INJECTION PORTS",
        description_pl: "woda nie mo�e sch�odzi� spalin, co prowadzi do przegrzewania i topienia w�y.",
        description_en: "water cannot cool exhaust gases, leading to overheating and melted hoses.",
        steps: ["Zdejmij w�� wodny z kolanka", "Przepchaj kr�ciec i otwory wewn�trz drutem/wiert�em", "Odkamie� kolanko kwasem (np. octowym lub dedykowanym)"]
    },
    "check_raw_water_system": {
        title_pl: "Sprawd� Uk�ad wody Surowej",
        title_en: "CHECK RAw waTER SYSTEM",
        description_pl: "Kolanko jest czyste, problem le�y wcze�niej w uk�adzie ch�odzenia.",
        description_en: "Elbow is clear, issue is further upstream in the cooling system.",
        steps: ["Sprawd� wirnik pompy (impeller)", "Sprawd� dro�no�� smoka/filtra zaburtowego", "Sprawd� Wymiennik ciep�a"]
    },
    "exhaust_other_issue": {
        title_pl: "Inny Problem z wydechem",
        title_en: "OTHER EXHAUST ISSUE",
        description_pl: "Kolanko i wtrysk wody wydaj� si� sprawne.",
        description_en: "Elbow and water injection seem functional.",
        steps: ["Sprawd� czy w�� wydechowy nie jest za�amany", "Sprawd� t�umik (waterlock) czy nie jest zablokowany", "Sprawd� wylot za burt�"]
    },

    "white_smoke_diagnostic": {
        tree_id: "white_smoke_diagnostic",
        start_node: "smoke_persistence",
        metadata: {
            title: { en: "white Smoke diagnostic", pl: "diagnostyka Bia�ego dymu" },
            version: "1.1",
            engine_type: "diesel"
        },
        nodes: {
            "smoke_persistence": {
                question: { 
                    en: "does the white smoke persist after the engine has reached operating temperature (warmed up)?", 
                    pl: "Czy bia�y dym utrzymuje si� po rozgrzaniu silnika do temperatury roboczej?" 
                },
                answers: [
                    { text: { en: "Yes, it continues to smoke", pl: "Tak, dymi nadal" }, type: "standard", next: { type: "node", id: "smell_check" } },
                    { text: { en: "No, it disappears when warm", pl: "Nie, znika po rozgrzaniu" }, type: "standard", next: { type: "solution", id: "cold_combustion" } },
                    { text: { en: "I can't check", pl: "Nie mog� Sprawdzi�" }, type: "cant_check", next: { type: "solution", id: "expert_required" } }
                ]
            },
            "smell_check": {
                question: { 
                    en: "what does the smoke smell like?", 
                    pl: "Jaki zapach ma ten dym?" 
                },
                answers: [
                    { text: { en: "Strong smell of raw diesel", pl: "silny zapach surowej ropy" }, type: "standard", next: { type: "node", id: "engine_behavior" } },
                    { text: { en: "Sweet smell or odorless (steam)", pl: "S�odkawy zapach lub bezwonny (para)" }, type: "standard", next: { type: "node", id: "coolant_level_check" } },
                    { text: { en: "I don't know", pl: "Nie wiem" }, type: "cant_check", next: { type: "solution", id: "expert_required" } }
                ]
            },
            "coolant_level_check": {
                question: { 
                    en: "Is the coolant level dropping, or are there bubbles in the header tank?", 
                    pl: "Czy ubywa p�ynu ch�odniczego lub w zbiorniku wyr�wnawczym wida� b�belki powietrza?" 
                },
                answers: [
                    { text: { en: "Yes, level is low / bubbles visible", pl: "Tak, ubywa p�ynu / s� b�belki" }, type: "standard", next: { type: "solution", id: "coolant_ingress" } },
                    { text: { en: "No, level is stable", pl: "Nie, poziom jest stabilny" }, type: "standard", next: { type: "node", id: "engine_behavior" } },
                    { text: { en: "I can't check", pl: "Nie mog� Sprawdzi�" }, type: "cant_check", next: { type: "solution", id: "coolant_ingress_suspected" } }
                ]
            },
            "engine_behavior": {
                question: { 
                    en: "How is the engine running at idle?", 
                    pl: "Jak silnik pracuje na wolnych obrotach?" 
                },
                answers: [
                    { text: { en: "Roughly, shaking, or missing", pl: "Nier�wno, trz�sie si�, przerywa" }, type: "standard", next: { type: "node", id: "compression_check_intro" } },
                    { text: { en: "Smoothly, but still smoking", pl: "R�wno, ale nadal dymi" }, type: "standard", next: { type: "solution", id: "unburned_fuel_timing" } },
                    { text: { en: "I don't know", pl: "Nie wiem" }, type: "cant_check", next: { type: "solution", id: "expert_required" } }
                ]
            },
            "compression_check_intro": {
                question: { 
                    en: "Is there a rhythmic 'hissing' or 'puffing' sound from the air intake or crankcase?", 
                    pl: "Czy s�ycha� rytmiczne syczenie lub 'pufanie' z dolotu powietrza lub odmy?" 
                },
                answers: [
                    { text: { en: "Yes, rhythmic puffing", pl: "Tak, rytmiczne pufanie" }, type: "standard", next: { type: "solution", id: "low_compression" } },
                    { text: { en: "No such sound", pl: "Brak takich d�wi�k�w" }, type: "standard", next: { type: "solution", id: "injector_failure" } },
                    { text: { en: "I can't tell", pl: "Nie potrafi� stwierdzi�" }, type: "cant_check", next: { type: "solution", id: "compression_test_required" } }
                ]
            }
        },
        solutions: {
            "cold_combustion": {
                title: { en: "cold combustion / Glow Plug Issue", pl: "Zimne Spalanie / Problemy ze �wiecami" },
                description: { 
                    en: "white smoke during a cold start that clears up is often just unburned fuel due to low cylinder temperature.", 
                    pl: "Bia�y dym przy zimnym starcie, kt�ry znika, to cz�sto po prostu niespalone paliwo wynikaj�ce z niskiej temperatury w cylindrach." 
                },
                steps: [
                    { en: "Check glow plug operation.", pl: "Sprawd� dzia�anie �wiec �arowych." },
                    { en: "Allow more time for pre-heating.", pl: "daj wi�cej czasu na grzanie �wiec." },
                    { en: "If it takes a long time to clear, check compression.", pl: "Je�li dymienie trwa d�ugo, Sprawd� kompresj�." }
                ]
            },
            "coolant_ingress": {
                title: { en: "coolant Ingress (Internal Leak)", pl: "Przedostawanie si� P�ynu (Przeciek)" },
                description: { 
                    en: "white 'smoke' that is actually steam. Usually caused by coolant entering the combustion chamber.", 
                    pl: "Bia�y 'dym', kt�ry jest w rzeczywisto�ci par� wodn�. Zazwyczaj spowodowany dostawaniem si� p�ynu do komory spalania." 
                },
                steps: [
                    { en: "STOP ENGINE IMMEdIATELY if overheating.", pl: "NATYCHMIAST ZATRZYMAJ siLNIK je�li si� przegrzewa." },
                    { en: "Check for head gasket failure.", pl: "Sprawd� uszczelk� pod g�owic�." },
                    { en: "Inspect cylinder head for cracks.", pl: "Sprawd� g�owic� pod k�tem p�kni��." },
                    { en: "Check exhaust manifold/mixing elbow for internal leaks.", pl: "Sprawd� kolektor wydechowy/kolanko pod k�tem przeciek�w." }
                ]
            },
            "coolant_ingress_suspected": {
                title: { en: "Suspected coolant Ingress", pl: "Podejrzenie Przecieku P�ynu" },
                description: { 
                    en: "Symptoms suggest steam from coolant, but cannot be confirmed without checking levels.", 
                    pl: "Objawy sugeruj� par� z p�ynu ch�odniczego, ale nie mo�na tego potwierdzi� bez Sprawdzenia poziom�w." 
                },
                steps: [
                    { en: "wait for engine to cool before opening header tank.", pl: "Poczekaj a� silnik ostygnie przed otwarciem zbiornika." },
                    { en: "Check coolant level and look for oil in coolant.", pl: "Sprawd� poziom p�ynu i czy nie ma w nim oleju." }
                ]
            },
            "low_compression": {
                title: { en: "Low compression", pl: "Niska Kompresja" },
                description: { 
                    en: "Incomplete combustion because the air is not getting hot enough to ignite the fuel properly.", 
                    pl: "Niepe�ne spalanie, poniewa� powietrze nie nagrzewa si� wystarczaj�co, by poprawnie zapali� paliwo." 
                },
                steps: [
                    { en: "Perform a compression test on all cylinders.", pl: "Przeprowad� test kompresji na wszystkich cylindrach." },
                    { en: "Check valve clearances.", pl: "Sprawd� luzy zaworowe." },
                    { en: "Inspect for worn piston rings or cylinder liners.", pl: "Sprawd� pier�cienie t�okowe lub g�adzie cylindr�w." }
                ]
            },
            "unburned_fuel_timing": {
                title: { en: "Injection Timing / Fuel Quality", pl: "K�t wtrysku / Jako�� Paliwa" },
                description: { 
                    en: "Fuel is being injected but not at the right time or is of poor quality, leading to partial combustion.", 
                    pl: "Paliwo jest wtryskiwane, ale w z�ym momencie lub jest s�abej jako�ci, co prowadzi do cz�ciowego spalania." 
                },
                steps: [
                    { en: "Check fuel injection timing.", pl: "Sprawd� k�t wyprzedzenia wtrysku." },
                    { en: "Verify fuel quality (check for water in fuel).", pl: "Sprawd� jako�� paliwa (czy nie ma w nim wody)." },
                    { en: "Inspect injection pump settings.", pl: "Sprawd� ustawienia pompy wtryskowej." }
                ]
            },
            "injector_failure": {
                title: { en: "Faulty Injector (Fuel Pissing)", pl: "Awaria wtryskiwacza (Lej�cy wtrysk)" },
                description: { 
                    en: "An injector may be 'streaming' or 'dripping' instead of atomizing the fuel.", 
                    pl: "wtryskiwacz mo�e 'la�' lub kapa� zamiast poprawnie rozpyla� paliwo." 
                },
                steps: [
                    { en: "Perform a 'crack test' (loosen fuel lines) to identify the faulty cylinder.", pl: "Przeprowad� test poluzowania przewod�w wtryskowych, by znale�� wadliwy cylinder." },
                    { en: "Remove and test injectors at a specialized shop.", pl: "Zdemontuj i oddaj wtryskiwacze do Sprawdzenia w serwisie." }
                ]
            },
            "compression_test_required": {
                title: { en: "compression Test Required", pl: "wymagany Test Kompresji" },
                description: { 
                    en: "Cannot distinguish between injector and compression issues by sound alone.", 
                    pl: "Nie mo�na odr�ni� problem�w z wtryskami od kompresji tylko po d�wi�ku." 
                },
                steps: [
                    { en: "contact a mechanic for a professional compression test.", pl: "Skontaktuj si� z mechanikiem w celu profesjonalnego pomiaru kompresji." }
                ]
            },
            "expert_required": {
                 title: { en: "Expert Required", pl: "wymagana Pomoc Eksperta" },
                 description: { en: "Cannot determine issue safely.", pl: "Nie mo�na bezpiecznie ustali� przyczyny." },
                 steps: [{ en: "Call a mechanic.", pl: "wezwij mechanika." }]
             }
         }
     },
     // === OVERHEATING MASTER TREE ===
    "overheating_master": {
        tree_id: "overheating_master",
        metadata: {
            title: { en: "Master Overheating Diagnostic", pl: "Pełna diagnostyka Przegrzewania" },
            version: "1.2.1",
            engine_type: "diesel"
        },
        start_node: "exhaust_observation",
        nodes: {
            "exhaust_observation": {
                question: {
                    en: "Mechanic's first check: Is water coming out of the exhaust with the gases?",
                    pl: "Pierwszy krok mechanika: Czy z wydechu wylatuje woda razem ze spalinami?"
                },
                answers: [
                    { text: { en: "No water / Only steam", pl: "Brak wody / Sama para" }, type: "standard", next: { type: "node", id: "intake_side_start" } },
                    { text: { en: "water is flowing normally", pl: "woda leci normalnie" }, type: "standard", next: { type: "node", id: "internal_cooling_start" } },
                    { text: { en: "water is spitting / intermittent", pl: "woda pryska / leci przerywanie" }, type: "standard", next: { type: "node", id: "impeller_inspection" } },
                    { text: { en: "I can't see the exhaust", pl: "Nie widz� wydechu" }, type: "cant_check", next: { type: "node", id: "intake_side_start" } }
                ]
            },

            // --- PATH A: NO/LOw waTER (INTAKE sidE) ---
            "intake_side_start": {
                question: {
                    en: "Is the intake seacock (valve) fully open and the strainer clear?",
                    pl: "Czy zaw�r denny jest otwarty, a filtr wody czysty?"
                },
                answers: [
                    { text: { en: "Yes, both OK", pl: "Tak, oba OK" }, type: "standard", next: { type: "node", id: "pump_belt_check" } },
                    { text: { en: "No, found a blockage/closed valve", pl: "Nie, znalaz�em zator/zamkni�ty zaw�r" }, type: "standard", next: { type: "solution", id: "clear_intake_restriction" } },
                    { text: { en: "Strainer is empty/dry", pl: "Filtr jest pusty/suchy" }, type: "standard", next: { type: "solution", id: "air_leak_intake" } }
                ]
            },
            "pump_belt_check": {
                question: {
                    en: "Is the raw water pump belt intact and tight? Is the pump pulley spinning?",
                    pl: "Czy pasek pompy wody jest ca�y i napi�ty? Czy ko�o pompy si� obraca?"
                },
                answers: [
                    { text: { en: "Yes, spinning fine", pl: "Tak, kr�ci si�" }, type: "standard", next: { type: "node", id: "impeller_inspection" } },
                    { text: { en: "No, belt issues", pl: "Nie, problem z paskiem" }, type: "standard", next: { type: "tree", id: "drive_belt_core" } }
                ]
            },
            "impeller_inspection": {
                question: {
                    en: "Open the pump. Is the rubber impeller intact with all blades present?",
                    pl: "Otw�rz pomp�. Czy wirnik (impeller) jest ca�y i ma wszystkie �opatki?"
                },
                answers: [
                    { text: { en: "Yes, perfect condition", pl: "Tak, stan idealny" }, type: "standard", next: { type: "node", id: "heat_exchanger_inlet_check" } },
                    { text: { en: "No, damaged/missing blades", pl: "Nie, uszkodzony/brak �opatek" }, type: "standard", next: { type: "solution", id: "replace_impeller_find_bits" } },
                    { text: { en: "I can't open the pump", pl: "Nie mog� otworzy� pompy" }, type: "cant_check", next: { type: "solution", id: "expert_required" } }
                ]
            },
            "heat_exchanger_inlet_check": {
                question: {
                    en: "Check the inlet to the heat exchanger. Are there old impeller bits or debris blocking the tube stack?",
                    pl: "Sprawd� wlot do Wymiennika ciep�a. Czy kawa�ki starego wirnika lub �mieci blokuj� rurki?"
                },
                answers: [
                    { text: { en: "Yes, found debris", pl: "Tak, znalaz�em �mieci" }, type: "standard", next: { type: "solution", id: "clean_heat_exchanger_inlet" } },
                    { text: { en: "No, inlet is clear", pl: "Nie, wlot jest czysty" }, type: "standard", next: { type: "node", id: "external_intake_blockage" } }
                ]
            },

            // --- PATH B: waTER FLOwING (INTERNAL/EFFICIENCY) ---
            "internal_cooling_start": {
                question: {
                    en: "Check the fresh water (coolant) level in the header tank. Is it full?",
                    pl: "Sprawd� poziom p�ynu ch�odniczego w zbiorniku. Czy jest pe�ny?"
                },
                answers: [
                    { text: { en: "Yes, level is OK", pl: "Tak, poziom OK" }, type: "standard", next: { type: "node", id: "thermostat_check" } },
                    { text: { en: "No, it's low", pl: "Nie, jest ma�o" }, type: "standard", next: { type: "solution", id: "coolant_loss_check" } },
                    { text: { en: "It's boiling over", pl: "wyrzuca p�yn/gotuje si�" }, type: "standard", next: { type: "solution", id: "head_gasket_suspected" } }
                ]
            },
            "thermostat_check": {
                question: {
                    en: "Is the top radiator hose getting hot, or does it stay cold while the engine overheats?",
                    pl: "Czy g�rny w�� ch�odnicy robi si� gor�cy, czy pozostaje zimny mimo przegrzania silnika?"
                },
                answers: [
                    { text: { en: "Stays cold (Thermostat stuck closed)", pl: "Pozostaje zimny (Termostat zamkni�ty)" }, type: "standard", next: { type: "solution", id: "replace_thermostat" } },
                    { text: { en: "Gets hot (Thermostat is opening)", pl: "Robi si� gor�cy (Termostat si� otwiera)" }, type: "standard", next: { type: "node", id: "heat_exchanger_efficiency" } }
                ]
            },
            "heat_exchanger_efficiency": {
                question: {
                    en: "Is the heat exchanger scale-free? when was it last descaled?",
                    pl: "Czy Wymiennik jest wolny od kamienia? Kiedy by� ostatnio odkamieniany?"
                },
                answers: [
                    { text: { en: "Likely scaled up / Years ago", pl: "Prawdopodobnie zakamieniony / dawno temu" }, type: "standard", next: { type: "solution", id: "descale_heat_exchanger" } },
                    { text: { en: "Clean / Recently serviced", pl: "Czysty / Niedawno serwisowany" }, type: "standard", next: { type: "node", id: "exhaust_elbow_deep_check" } }
                ]
            },
            "exhaust_elbow_deep_check": {
                question: {
                    en: "Check the mixing elbow. Is the water injection port restricted by rust or carbon?",
                    pl: "Sprawd� kolanko wydechowe. Czy kr�ciec wtrysku wody jest zw�ony przez rdz� lub nagar?"
                },
                answers: [
                    { text: { en: "Yes, looks restricted", pl: "Tak, wygl�da na zapchany" }, type: "standard", next: { type: "tree", id: "exhaust_elbow_core" } },
                    { text: { en: "No, looks clear", pl: "Nie, wygl�da na czysty" }, type: "standard", next: { type: "node", id: "high_load_factors" } }
                ]
            },

            // --- EXTERNAL / HIGH LOAd ---
            "high_load_factors": {
                question: {
                    en: "Is the propeller fouled or the boat heavily overloaded? does it only overheat at high RPM?",
                    pl: "Czy �ruba jest obro�ni�ta lub ��d� prze�adowana? Czy grzeje si� tylko na wysokich obrotach?"
                },
                answers: [
                    { text: { en: "Yes, suspect prop fouling", pl: "Tak, podejrzewam brudn� �rub�" }, type: "standard", next: { type: "tree", id: "drivetrain_overload_diagnostic" } },
                    { text: { en: "No, happens even at low RPM", pl: "Nie, grzeje si� nawet na ma�ych obrotach" }, type: "standard", next: { type: "solution", id: "expert_required" } }
                ]
            },
            "external_intake_blockage": {
                question: {
                    en: "Is there something blocking the intake grate outside the hull (plastic bag, barnacles)?",
                    pl: "Czy co� blokuje kratk� wlotow� na zewn�trz kad�uba (folia, p�kle)?"
                },
                answers: [
                    { text: { en: "Yes/Maybe (Need to check)", pl: "Tak/Mo�liwe (Trzeba Sprawdzi�)" }, type: "standard", next: { type: "solution", id: "clear_hull_intake" } },
                    { text: { en: "No, definitely clear", pl: "Nie, na pewno czysto" }, type: "standard", next: { type: "solution", id: "expert_required" } }
                ]
            }
        },
        solutions: {
            "replace_impeller_find_bits": {
                title: { en: "Replace Impeller & Recover Fragments", pl: "Wymie� wirnik i Odzyskaj Kawa�ki" },
                description: { en: "Broken blades will travel downstream and clog the heat exchanger.", pl: "Urwane �opatki pop�yn� dalej i zapchaj� Wymiennik ciep�a." },
                steps: [
                    { en: "Remove pump cover and old impeller.", pl: "Zdejmij pokryw� pompy i stary wirnik." },
                    { en: "count the missing blades.", pl: "Policz ile �opatek brakuje." },
                    { en: "Open the heat exchanger end cap and remove ALL fragments.", pl: "Otw�rz pokryw� Wymiennika i Usu� wSZYSTKIE kawa�ki." },
                    { en: "Install new impeller with glycerin/soap.", pl: "Zainstaluj nowy wirnik u�ywaj�c gliceryny/myd�a." }
                ]
            },
            "clean_heat_exchanger_inlet": {
                title: { en: "Clean Heat Exchanger Inlet", pl: "Wyczy�� wlot Wymiennika" },
                description: { en: "debris at the entrance of the tube stack is restricting flow.", pl: "�mieci na wej�ciu do rurek ograniczaj� przep�yw." },
                steps: [
                    { en: "Remove the raw water hose from the heat exchanger.", pl: "Zdejmij w�� wody zaburtowej z Wymiennika." },
                    { en: "Use a vacuum or long pliers to remove debris.", pl: "U�yj odkurzacza lub d�ugich szczypiec, by Usun�� �mieci." },
                    { en: "Flush with fresh water if possible.", pl: "Przep�ucz s�odk� wod� je�li to mo�liwe." }
                ]
            },
            "replace_thermostat": {
                title: { en: "Replace Thermostat", pl: "Wymie� Termostat" },
                description: { en: "The thermostat is stuck closed, preventing coolant from reaching the heat exchanger.", pl: "Termostat zaci�� si� w pozycji zamkni�tej, blokuj�c przep�yw do Wymiennika." },
                steps: [
                    { en: "Allow engine to cool.", pl: "Poczekaj a� silnik ostygnie." },
                    { en: "Remove thermostat housing.", pl: "Zdejmij obudow� termostatu." },
                    { en: "Test old thermostat in boiling water if unsure.", pl: "Je�li nie masz pewno�ci, przetestuj stary termostat w gotuj�cej si� wodzie." },
                    { en: "Install new thermostat with a new gasket.", pl: "Zainstaluj nowy termostat z now� uszczelk�." }
                ]
            },
            "descale_heat_exchanger": {
                title: { en: "descale Heat Exchanger", pl: "Odkamie� Wymiennik Ciep�a" },
                description: { en: "Calcium buildup inside the tubes is reducing heat transfer.", pl: "Osad wapienny wewn�trz rurek pogarsza oddawanie ciep�a." },
                steps: [
                    { en: "Use a commercial descaling agent or white vinegar.", pl: "U�yj profesjonalnego odkamieniacza lub octu." },
                    { en: "Circulate the agent through the raw water side for several hours.", pl: "Cyrkuluj �rodek przez stron� zaburtow� przez kilka godzin." },
                    { en: "Rinse thoroughly with fresh water.", pl: "Przep�ucz dok�adnie s�odk� wod�." }
                ]
            },
            "clear_hull_intake": {
                title: { en: "Clear Hull Intake", pl: "Udro�nij wlot w Kad�ubie" },
                description: { en: "Something is blocking the water before it even reaches the seacock.", pl: "co� blokuje wod� zanim dotrze do zaworu dennego." },
                steps: [
                    { en: "dive under the boat or use a brush on a pole to clear the intake grate.", pl: "Zanurkuj pod ��d� lub u�yj szczotki na tyczce, by oczy�ci� kratk�." },
                    { en: "Try blowing compressed air backwards from the strainer (with seacock open).", pl: "Spr�buj 'dmuchn��' powietrzem wstecz od filtra (przy otwartym zaworze)." }
                ]
            },
            "coolant_loss_check": {
                title: { en: "coolant Loss / Leak", pl: "Ubytek P�ynu / wyciek" },
                description: { en: "The fresh water cooling circuit is losing fluid.", pl: "Uk�ad ch�odzenia s�odk� wod� traci p�yn." },
                steps: [
                    { en: "Check for green/blue stains on the engine block.", pl: "Szukaj zielonych/niebieskich zaciekk�w na bloku silnika." },
                    { en: "Inspect the water pump weep hole for leaks.", pl: "Sprawd� otw�r kontrolny pompy wody pod k�tem wyciek�w." },
                    { en: "Check the oil level (rising oil = internal coolant leak).", pl: "Sprawd� poziom oleju (przybywanie oleju = wewn�trzny wyciek p�ynu)." }
                ]
            },
            "head_gasket_suspected": {
                title: { en: "Suspected Head Gasket Failure", pl: "Podejrzenie Uszczelki pod G�owic�" },
                description: { en: "combustion gases are entering the cooling system, causing it to boil over.", pl: "Gazy spalinowe dostaj� si� do uk�adu ch�odzenia, powoduj�c 'wyrzucanie' p�ynu." },
                steps: [
                    { en: "dO NOT OPEN CAP wHILE HOT.", pl: "NIE otwieraJ KORKA GdY siLNIK JEST GOR�CY." },
                    { en: "Look for 'mayonnaise' under the oil filler cap.", pl: "Szukaj 'majonezu' pod korkiem wlewu oleju." },
                    { en: "Check if coolant smells like exhaust gases.", pl: "Sprawd� czy p�yn ch�odniczy �mierdzi spalinami." }
                ]
            },
            "air_leak_intake": {
                title: { en: "Air Leak in Intake / Lost Prime", pl: "Nieszczelno�� dolotu / Zapowietrzenie pompy" },
                description: { en: "The pump is sucking air instead of water, Usually through the strainer lid.", pl: "pompa zasysa powietrze zamiast wody, zazwyczaj przez nieszczeln� pokryw� filtra." },
                steps: [
                    { en: "Check the O-ring/gasket on the water strainer lid.", pl: "Sprawd� uszczelk� pod pokryw� filtra wody." },
                    { en: "Grease the lid seal with silicone grease.", pl: "Posmaruj uszczelk� smarem silikonowym." },
                    { en: "Tighten all hose clamps on the intake side.", pl: "Dokr�� wszystkie opaski na w�ach dolotowych." }
                ]
            },
            "clear_intake_restriction": {
                title: { en: "Clear Intake Restriction", pl: "Usu� Zator w dolocie" },
                description: { en: "The seacock or strainer is physically blocked.", pl: "Zaw�r denny lub filtr s� fizycznie zablokowane." },
                steps: [
                    { en: "Ensure seacock handle is fully open (parallel to hose).", pl: "Upewnij si�, �e r�czka zaworu jest w pe�ni otwarta (r�wnolegle do w�a)." },
                    { en: "Remove seaweed or plastic from the strainer basket.", pl: "Usu� traw� lub foli� z koszyka filtra." }
                ]
            },
            "expert_required": {
                title: { en: "Expert Required", pl: "wymagana Pomoc Eksperta" },
                description: { en: "Mechanical overheating issues can be complex.", pl: "Mechaniczne przyczyny przegrzewania mog� by� z�o�one." },
                steps: [{ en: "Call a professional mechanic.", pl: "wezwij profesjonalnego mechanika." }]
            }
        }
    },
    "overheating_master_legacy": {
         tree_id: "overheating_master",
         start_node: "seacock_check",
         metadata: {
             title: { en: "Raw water discharge diagnostic", pl: "diagnostyka Ch�odzenia Zaburtowego" },
             version: "1.0",
             engine_type: "diesel"
         },
         nodes: {
             "seacock_check": {
                 question: { 
                     en: "Is the raw water intake seacock (valve) fully open?", 
                     pl: "Czy zaw�r denny (seacock) poboru wody zaburtowej jest w pe�ni otwarty?" 
                 },
                 answers: [
                     { text: { en: "Yes, it is open", pl: "Tak, jest otwarty" }, type: "standard", next: { type: "node", id: "strainer_visual_check" } },
                     { text: { en: "No, it was closed", pl: "Nie, by� zamkni�ty" }, type: "standard", next: { type: "solution", id: "open_seacock" } },
                     { text: { en: "I can't find it", pl: "Nie mog� go znale��" }, type: "cant_check", next: { type: "solution", id: "locate_seacock" } }
                 ]
             },
             "strainer_visual_check": {
                 question: { 
                     en: "Look at the raw water strainer. Is it clogged with debris (seaweed, plastic) or is the water level unUsually low?", 
                     pl: "Sp�jrz na filtr wody zaburtowej. Czy jest zapchany (trawa, plastik) lub czy poziom wody jest nienaturalnie niski?" 
                 },
                 answers: [
                     { text: { en: "Yes, it's clogged / low water", pl: "Tak, jest zapchany / ma�o wody" }, type: "standard", next: { type: "solution", id: "clean_strainer" } },
                     { text: { en: "No, it looks clear and full", pl: "Nie, wygl�da na czysty i pe�ny" }, type: "standard", next: { type: "node", id: "pump_operation_check" } },
                     { text: { en: "I can't see inside", pl: "Nie widz� �rodka" }, type: "cant_check", next: { type: "node", id: "pump_operation_check" } }
                 ]
             },
             "pump_operation_check": {
                 question: { 
                     en: "Is the raw water pump turning? Check if the belt is intact and the pump pulley is spinning.", 
                     pl: "Czy pompa wody zaburtowej si� kr�ci? Sprawd� czy pasek jest ca�y i czy ko�o pasowe pompy wiruje." 
                 },
                 answers: [
                     { text: { en: "Yes, it's spinning", pl: "Tak, kr�ci si�" }, type: "standard", next: { type: "node", id: "impeller_inspection" } },
                     { text: { en: "No, the belt is broken/loose", pl: "Nie, pasek jest zerwany/lu�ny" }, type: "standard", next: { type: "tree", id: "drive_belt_core" } },
                     { text: { en: "I can't check the belt", pl: "Nie mog� Sprawdzi� paska" }, type: "cant_check", next: { type: "solution", id: "expert_required" } }
                 ]
             },
             "impeller_inspection": {
                 question: { 
                     en: "If you remove the pump cover, is the rubber impeller intact with all its blades?", 
                     pl: "Je�li zdejmiesz pokryw� pompy, czy gumowy wirnik (impeller) jest ca�y i ma wszystkie �opatki?" 
                 },
                 answers: [
                     { text: { en: "Yes, impeller is perfect", pl: "Tak, wirnik jest idealny" }, type: "standard", next: { type: "node", id: "exhaust_elbow_check" } },
                     { text: { en: "No, blades are missing/damaged", pl: "Nie, brakuje �opatek / jest zniszczony" }, type: "standard", next: { type: "solution", id: "replace_impeller" } },
                     { text: { en: "I can't open the pump", pl: "Nie mog� otworzy� pompy" }, type: "cant_check", next: { type: "solution", id: "impeller_fail_suspected" } }
                 ]
             },
             "exhaust_elbow_check": {
                 question: { 
                     en: "Is the mixing elbow or exhaust hose blocked? Check if the hose feels unUsually hot or pressurized.", 
                     pl: "Czy kolanko wydechowe lub w�� s� zatkane? Sprawd� czy w�� jest nienaturalnie gor�cy lub twardy od ci�nienia." 
                 },
                 answers: [
                     { text: { en: "Yes, it's very hot/blocked", pl: "Tak, jest bardzo gor�cy/zatkany" }, type: "standard", next: { type: "tree", id: "exhaust_elbow_core" } },
                     { text: { en: "No, feels normal", pl: "Nie, wydaje si� w normie" }, type: "standard", next: { type: "solution", id: "expert_required" } },
                     { text: { en: "I don't know", pl: "Nie wiem" }, type: "cant_check", next: { type: "solution", id: "expert_required" } }
                 ]
             }
         },
         solutions: {
             "open_seacock": {
                 title: { en: "Open Seacock", pl: "Otw�rz Zaw�r denny" },
                 description: { en: "The water supply was cut off at the source.", pl: "dop�yw wody by� odci�ty u �r�d�a." },
                 steps: [
                     { en: "Locate the raw water intake seacock.", pl: "Znajd� zaw�r poboru wody zaburtowej." },
                     { en: "Turn the handle so it is parallel to the hose.", pl: "Ustaw r�czk� r�wnolegle do w�a." },
                     { en: "Check for water flow at exhaust.", pl: "Sprawd� czy woda leci z wydechu." }
                 ]
             },
             "locate_seacock": {
                 title: { en: "Locate Intake Seacock", pl: "Znajd� Zaw�r Poboru" },
                 description: { en: "Every marine engine has an intake valve below the waterline.", pl: "Ka�dy silnik morski ma zaw�r poboru poni�ej linii wodnej." },
                 steps: [
                     { en: "Follow the hose from the strainer backwards to the hull.", pl: "Id� po w�u od filtra w stron� kad�uba." },
                     { en: "The valve is Usually located in the engine compartment or under floorboards nearby.", pl: "Zaw�r jest zazwyczaj w komorze silnika lub pod pod�og� w pobli�u." }
                 ]
             },
             "clean_strainer": {
                 title: { en: "Clean Strainer & Check Seal", pl: "Wyczy�� Filtr i Sprawd� Uszczelk�" },
                 description: { en: "debris is blocking flow or air is leaking in, breaking the prime.", pl: "Zanieczyszczenia blokuj� przep�yw lub lewe powietrze zrywa cyrkulacj�." },
                 steps: [
                     { en: "Close the seacock first!", pl: "Najpierw zamknij zaw�r denny!" },
                     { en: "Open strainer lid and remove debris.", pl: "Otw�rz pokryw� filtra i Usu� �mieci." },
                     { en: "Check the lid O-ring/gasket for cracks.", pl: "Sprawd� uszczelk� pokrywy pod k�tem p�kni��." },
                     { en: "Grease the gasket with silicone grease if available.", pl: "Posmaruj uszczelk� smarem silikonowym je�li go masz." },
                     { en: "Tighten lid firmly and OPEN SEAcoCK.", pl: "Dokr�� mocno pokryw� i OTw�RZ ZAw�R dENNY." }
                 ]
             },
             "fix_belt": {
                 title: { en: "Repair/Tighten Pump Belt", pl: "Napraw/Naci�gnij Pasek pompy" },
                 description: { en: "The pump is not being driven by the engine.", pl: "pompa nie jest nap�dzana przez silnik." },
                 steps: [
                     { en: "Inspect belt for damage or glazing.", pl: "Sprawd� pasek pod k�tem uszkodze� lub �lizgania." },
                     { en: "Adjust tension or replace with a spare belt.", pl: "wyreguluj naci�g lub Wymie� na zapasowy pasek." }
                 ]
             },
             "replace_impeller": {
                 title: { en: "Replace Impeller & Find Blades", pl: "Wymie� wirnik i Znajd� �opatki" },
                 description: { en: "The rubber impeller has failed and cannot pump water.", pl: "Gumowy wirnik uleg� awarii i nie mo�e pompowa� wody." },
                 steps: [
                     { en: "Close seacock.", pl: "Zamknij zaw�r denny." },
                     { en: "Remove pump cover and extract old impeller.", pl: "Zdejmij pokryw� pompy i wyjmij stary wirnik." },
                     { en: "CRITICAL: If blades are missing, you MUST find them in the heat exchanger intake.", pl: "wa�NE: Je�li brakuje �opatek, MUsiSZ je znale�� w dolocie Wymiennika ciep�a." },
                     { en: "Install new impeller with a bit of dish soap or glycerin.", pl: "Zainstaluj nowy wirnik u�ywaj�c odrobiny myd�a lub gliceryny." },
                     { en: "Open seacock and test.", pl: "Otw�rz zaw�r denny i przetestuj." }
                 ]
             },
             "impeller_fail_suspected": {
                 title: { en: "Suspected Impeller Failure", pl: "Podejrzenie Awarii wirnika" },
                 description: { en: "Symptoms point to the impeller, but it hasn't been visually confirmed.", pl: "Objawy wskazuj� na wirnik, ale nie zosta�o to potwierdzone wzrokowo." },
                 steps: [
                     { en: "Try to prime the system by pouring water into the strainer.", pl: "Spr�buj 'zala�' uk�ad wlewaj�c wod� do filtra." },
                     { en: "If it still doesn't pump, you must open the pump.", pl: "Je�li nadal nie pompuje, musisz otworzy� pomp�." }
                 ]
             },
             "exhaust_blockage": {
                 title: { en: "Exhaust / Mixing Elbow Blockage", pl: "Zatkana Rura / Kolanko wydechowe" },
                 description: { en: "water is reaching the engine but cannot exit through the exhaust.", pl: "woda dociera do silnika, ale nie mo�e wydosta� si� przez wydech." },
                 steps: [
                     { en: "Check the mixing elbow for carbon or salt buildup.", pl: "Sprawd� kolanko wydechowe pod k�tem nagaru lub soli." },
                     { en: "Inspect the exhaust hose for internal collapse.", pl: "Sprawd� w�� wydechowy pod k�tem wewn�trznego rozwarstwienia." },
                     { en: "Verify the water injection nipple is not clogged.", pl: "Sprawd� czy kr�ciec wtrysku wody nie jest zatkany." }
                 ]
             },
             "expert_required": {
                 title: { en: "Expert Required", pl: "wymagana Pomoc Eksperta" },
                 description: { en: "Cannot determine issue safely.", pl: "Nie mo�na bezpiecznie ustali� przyczyny." },
                 steps: [{ en: "Call a mechanic.", pl: "wezwij mechanika." }]
             }
         }
     }
 };

function mergeSpecificKnowledge(generaldB, context) {
    if (!context) return generaldB;

    console.log(`Loading specifics for context: ${context}`);
    
    const mergedIssues = { ...generaldB.issues };
    
    const merge = (specifics) => {
        Object.values(specifics.common_issues).forEach(issue => {
            issue.isSpecific = true;
            issue.probability = (issue.base_probability || 0.1) + 0.1; 
            
            if (!issue.required_symptoms) issue.required_symptoms = issue.symptoms;
            if (!issue.conflicting_symptoms) issue.conflicting_symptoms = [];
            
            mergedIssues[issue.id] = issue;
        });
    };

    // 1. Check if context is a defined Engine Type with subtypes (data-driven)
    const engineTypeconfig = generaldB.engine_types && generaldB.engine_types[context];

    if (engineTypeconfig && engineTypeconfig.subtypes) {
        engineTypeconfig.subtypes.forEach(subtype => {
            if (marineSpecifics[subtype]) {
                merge(marineSpecifics[subtype]);
            }
        });
    } 
    // 2. Check if context is a direct match in marineSpecifics
    else if (marineSpecifics[context]) {
        merge(marineSpecifics[context]);
    }

    return {
        ...generaldB,
        issues: mergedIssues
    };
}

</script>
    <script>
        // ====================
        // BAZA dANYCH OFFLINE
        // ====================

        // Baza podstawowa (General)
        const baseMarinedatabase = {
            // definicje Kategorii Symptom�w (Symptom Categories)
            symptom_categories: {
                behavior: { name_pl: 'Zachowanie (Behavior)', name_en: 'Behavior' },
                auditory_tactile: { name_pl: 'S�uchowe / dotykowe', name_en: 'Auditory / Tactile' },
                visual: { name_pl: 'wizualne (Visual)', name_en: 'Visual' },
                visual_instrument: { name_pl: 'wska�niki (Instruments)', name_en: 'Instruments' },
                olfactory: { name_pl: 'Zapachowe (Olfactory)', name_en: 'Olfactory' },
                other: { name_pl: 'Inne', name_en: 'Other' }
            },

            // Konfiguracja Typ�w silnik�w (Engine Types)
            engine_types: {
                inboard: { 
                    id: 'inboard', 
                    tree_id: 'diesel_core', 
                    name_pl: 'Stacjonarny (diesel)', 
                    name_en: 'Inboard (diesel)',
                    subtypes: ['yanmar', 'volvo']
                },
                diesel_expert: { 
                    id: 'diesel_expert', 
                    tree_id: 'diesel_engine_core', 
                    name_pl: 'Stacjonarny (diesel - Ekspert)', 
                    name_en: 'Inboard (diesel - Expert)',
                    subtypes: ['yanmar', 'volvo']
                },
                outboard: { 
                    id: 'outboard', 
                    tree_id: 'gasoline_core', 
                    name_pl: 'Zaburtowy (Benzyna)', 
                    name_en: 'Outboard (Gasoline)',
                    subtypes: ['yamaha', 'mercury', 'honda']
                },
                overheating: {
                    id: 'overheating',
                    tree_id: 'overheating_master',
                    name_pl: 'Przegrzewanie (Pe�na)',
                    name_en: 'Overheating (Full)',
                    subtypes: ['yanmar', 'volvo']
                }
            },

            // Systemy �odzi
            systems: [
                {
                    id: 'engine',
                    name_pl: 'silnik',
                    name_en: 'Engine',
                    icon: 'fas fa-engine',
                    color: '#00B4d8',
                    diagnosis_mode: 'context_choice', // wymaga wyboru kontekstu (inboard/outboard)
                    symptoms: [
                        // Zachowanie (Behavior)
                        'eng_cranks_no_start', 'eng_no_crank', 'eng_stalls_idle', 'eng_stalls_load',
                        // S�uchowe/dotykowe (Auditory/Tactile)
                        'snd_click_start', 'snd_grinding', 'vib_idle', 'vib_running',
                        // wizualne (Visual)
                        'vis_smoke_black', 'vis_smoke_blue', 'vis_smoke_white', 'vis_leak_oil', 'vis_leak_water',
                        // wska�niki (Instruments)
                        'ins_temp_high', 'ins_oil_low', 'ins_volt_low'
                    ]
                },
                {
                    id: 'electrical',
                    name_pl: 'Elektryka',
                    name_en: 'Electrical',
                    icon: 'fas fa-bolt',
                    color: '#FF9800',
                    diagnosis_mode: 'tree',
                    default_tree_id: 'electrical_core',
                    symptoms: ['elec_total_loss', 'elec_dim_lights', 'elec_flicker']
                },
                {
                    id: 'dinghy',
                    name_pl: 'Ponton / silnik',
                    name_en: 'dinghy / Outboard',
                    icon: 'fas fa-ship',
                    color: '#607d8B',
                    symptoms: ['ob_wont_start', 'ob_stops_run', 'ob_no_water']
                },
                /* MOVEd TO ELECTRICAL
                {
                    id: 'anchor',
                    name_pl: 'Kotwica',
                    name_en: 'Anchor / windlass',
                    icon: 'fas fa-anchor',
                    color: '#795548',
                    symptoms: ['anc_wont_up', 'anc_silent', 'anc_stuck']
                },
                */
                {
                    id: 'generator',
                    name_pl: 'Generator (Agregat)',
                    name_en: 'Generator / Genset',
                    icon: 'fas fa-bolt',
                    color: '#FFC107',
                    symptoms: ['gen_stops', 'gen_wont_start', 'gen_no_power', 'gen_blink_code']
                },
                {
                    id: 'sails',
                    name_pl: '�agle',
                    name_en: 'Sails',
                    icon: 'fas fa-sailboat',
                    color: '#4CAF50',
                    symptoms: []
                },
                {
                    id: 'plumbing',
                    name_pl: 'Instalacje',
                    name_en: 'Plumbing',
                    icon: 'fas fa-faucet',
                    color: '#2196F3',
                    diagnosis_mode: 'tree',
                    default_tree_id: 'plumbing_core',
                    symptoms: ['wc_blocked_pump', 'wc_wont_flush', 'wc_bad_smell', 'wc_bowl_full']
                },
                {
                    id: 'steering',
                    name_pl: 'Sterowanie',
                    name_en: 'Steering',
                    icon: 'fas fa-wheel',
                    color: '#9C27B0',
                    symptoms: []
                },
                {
                    id: 'hull',
                    name_pl: 'Kad�ub',
                    name_en: 'Hull',
                    icon: 'fas fa-ship',
                    color: '#795548',
                    symptoms: []
                }
            ],

            // Symptomy
            symptoms: {
                // === TOALETA (CHARTER CLASsiC) ===
                wc_blocked_pump: {
                    id: 'wc_blocked_pump',
                    name_pl: 'pompa zablokowana (wajcha ani drgnie)',
                    category: 'behavior',
                    issues: ['wc_valve_shut', 'wc_clogged_paper']
                },
                wc_wont_flush: {
                    id: 'wc_wont_flush',
                    name_pl: 'woda nie wp�ywa do muszli',
                    category: 'behavior',
                    issues: ['wc_seacock_in_closed', 'wc_pump_dry']
                },
                wc_bowl_full: {
                    id: 'wc_bowl_full',
                    name_pl: 'woda nie odp�ywa (Muszla pe�na)',
                    category: 'visual',
                    issues: ['wc_seacock_out_closed', 'wc_tank_full', 'wc_clogged_pipe']
                },

                // === PONTON / siLNIK ZABURTOwY ===
                ob_wont_start: {
                    id: 'ob_wont_start',
                    name_pl: 'silnik nie odpala (Szarpiesz i nic)',
                    category: 'behavior',
                    issues: ['ob_kill_cord', 'ob_fuel_tap', 'ob_tank_vent', 'ob_fuel_empty']
                },
                ob_stops_run: {
                    id: 'ob_stops_run',
                    name_pl: 'Odpala i ga�nie po chwili',
                    category: 'behavior',
                    issues: ['ob_tank_vent', 'ob_fuel_tap']
                },

                // === KOTwICA ===
                anc_silent: {
                    id: 'anc_silent',
                    name_pl: 'winda milczy (Brak reakcji)',
                    category: 'behavior',
                    issues: ['anc_breaker', 'anc_engine_off', 'anc_remote_bat']
                },
                anc_wont_up: {
                    id: 'anc_wont_up',
                    name_pl: 'winda kr�ci ale nie ci�gnie (�lizga si�)',
                    category: 'behavior',
                    issues: ['anc_clutch_loose', 'anc_chain_jam']
                },

                // === GENERATOR (AGREGAT) ===
                gen_stops: {
                    id: 'gen_stops',
                    name_pl: 'Ga�nie po chwili (lub pod obci��eniem)',
                    category: 'behavior',
                    issues: ['gen_overheat', 'gen_overload', 'gen_fuel_block']
                },
                gen_wont_start: {
                    id: 'gen_wont_start',
                    name_pl: 'Kr�ci ale nie odpala',
                    category: 'behavior',
                    issues: ['gen_fuel_pump', 'gen_glow_plugs']
                },
                gen_no_power: {
                    id: 'gen_no_power',
                    name_pl: 'silnik pracuje, ale nie ma pr�du (230V)',
                    category: 'visual_instrument',
                    issues: ['gen_breaker_trip', 'gen_capacitor']
                },
                gen_blink_code: {
                    id: 'gen_blink_code',
                    name_pl: 'Miga dioda na przycisku start',
                    category: 'visual',
                    requires_specificity: true,
                    specificity_options: [
                        { id: 'onan_3_blink', label: '3 Migni�cia (Serwis)', issues: ['gen_raw_water_loss', 'gen_overheat'] },
                        { id: 'onan_2_blink', label: '2 Migni�cia (Low Oil)', issues: ['gen_oil_low'] },
                        { id: 'kohler_loc', label: 'Kod "LOC" na ekranie', issues: ['gen_raw_water_loss'] },
                        { id: 'kohler_uu', label: 'Kod "UU" na ekranie', issues: ['gen_capacitor'] }
                    ],
                    issues: []
                },

                // === ZACHOwaNIE (BEHAVIOR) ===
                eng_cranks_no_start: {
                    id: 'eng_cranks_no_start',
                    name_pl: 'Rozrusznik kr�ci, ale silnik nie zapala',
                    category: 'behavior',
                    issues: ['fuel_empty', 'fuel_filter', 'safety_switch']
                },
                eng_no_crank: {
                    id: 'eng_no_crank',
                    name_pl: 'Rozrusznik NIE kr�ci (cisza lub klikni�cie)',
                    category: 'behavior',
                    issues: ['battery_dead', 'starter_failed', 'ground_fault']
                },
                eng_stalls_idle: {
                    id: 'eng_stalls_idle',
                    name_pl: 'Ga�nie na wolnych obrotach',
                    category: 'behavior',
                    issues: ['idle_valve', 'fuel_filter', 'air_filter']
                },
                eng_stalls_load: {
                    id: 'eng_stalls_load',
                    name_pl: 'Ga�nie pod obci��eniem',
                    category: 'behavior',
                    issues: ['fuel_filter', 'propeller_fouled', 'turbo_failed']
                },

                // === S�UCHOwE/dOTYKOwE (AUdITORY/TACTILE) ===
                snd_click_start: {
                    id: 'snd_click_start',
                    name_pl: 'Pojedyncze klikni�cie przy starcie',
                    category: 'auditory_tactile',
                    issues: ['battery_dead', 'starter_failed']
                },
                snd_grinding: {
                    id: 'snd_grinding',
                    name_pl: 'Zgrzytanie przy starcie',
                    category: 'auditory_tactile',
                    issues: ['starter_failed']
                },
                vib_idle: {
                    id: 'vib_idle',
                    name_pl: 'wibracje na wolnych obrotach',
                    category: 'auditory_tactile',
                    issues: ['engine_mount_loose', 'injector_fault']
                },
                vib_running: {
                    id: 'vib_running',
                    name_pl: 'wibracje podczas p�yni�cia',
                    category: 'auditory_tactile',
                    issues: ['propeller_fouling', 'shaft_bent', 'engine_mount_loose', 'injector_fault']
                },

                // === wIZUALNE (VISUAL) ===
                vis_smoke_black: {
                    id: 'vis_smoke_black',
                    name_pl: 'Czarny dym',
                    category: 'visual',
                    issues: ['air_filter', 'injectors_dirty', 'overload']
                },
                vis_smoke_blue: {
                    id: 'vis_smoke_blue',
                    name_pl: 'Niebieski dym',
                    category: 'visual',
                    issues: ['oil_burning', 'piston_rings']
                },
                vis_smoke_white: {
                    id: 'vis_smoke_white',
                    name_pl: 'Bia�y dym (para)',
                    category: 'visual',
                    issues: ['head_gasket', 'coolant_leak']
                },
                vis_leak_oil: {
                    id: 'vis_leak_oil',
                    name_pl: 'wyciek oleju (czarna ma�)',
                    category: 'visual',
                    issues: ['gasket_leak', 'filter_loose']
                },
                vis_leak_water: {
                    id: 'vis_leak_water',
                    name_pl: 'woda w z�zie (s�odka/s�ona)',
                    category: 'visual',
                    requires_specificity: true,
                    specificity_options: [
                        { id: 'vis_leak_fresh', label: 'S�odka woda (ze zbiornika)', issues: ['tank_leak', 'pump_leak'] },
                        { id: 'vis_leak_salt', label: 'S�ona woda (z zewn�trz)', issues: ['hull_leak', 'raw_water_leak'] }
                    ],
                    issues: [] // Generic placeholder
                },

                // === wSKA�NIKI (INSTRUMENTS) ===
                ins_temp_high: {
                    id: 'ins_temp_high',
                    name_pl: 'wysoka temperatura (>90�C)',
                    category: 'visual_instrument',
                    issues: ['coolant_low', 'raw_water_clogged', 'impeller_failed']
                },
                ins_oil_low: {
                    id: 'ins_oil_low',
                    name_pl: 'Niskie ci�nienie oleju',
                    category: 'visual_instrument',
                    issues: ['oil_low', 'pump_failed']
                },
                ins_volt_low: {
                    id: 'ins_volt_low',
                    name_pl: 'Niskie napi�cie (<12V)',
                    category: 'visual_instrument',
                    issues: ['alternator_failed', 'belt_loose']
                },

                // === ELEKTRYKA (JACHTOwa) ===
                elec_panel_switch: {
                    id: 'elec_panel_switch',
                    name_pl: 'wy��czony obw�d na panelu (domestic/Service)',
                    probability: 0.7,
                    difficulty: 1,
                    required_symptoms: ['elec_total_loss', 'wc_wont_flush'], // Elektryczne wC
                    verification_questions: [
                        {
                            id: 'q_panel_led',
                            question_pl: 'Czy na panelu sterowania (nad stolikiem nawigacyjnym) �wieci si� dioda "12V" lub "Service"?',
                            question_amateur_pl: 'Czy w��czy�e� g��wny przycisk na panelu z guzikami?',
                            answers: [
                                { text_pl: 'Ciemno, nic nie �wieci', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Tak, �wieci si�', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'w��cz obw�d Service', description_pl: 'Cz�sto osobny guzik obok woltomierza.' },
                        { step: 2, title_pl: 'Sprawd� g��wny hebel', description_pl: 'Czerwony klucz pod siedzeniem/w kabinie rufowej.' }
                    ]
                },
                elec_total_loss: {
                    id: 'elec_total_loss',
                    name_pl: 'G��wny wy��cznik pr�du (Battery Switch)',
                    category: 'visual',
                    issues: ['main_breaker', 'battery_switch', 'elec_panel_switch']
                },
                elec_dim_lights: {
                    id: 'elec_dim_lights',
                    name_pl: 'Przygasaj�ce �wiat�a',
                    category: 'visual',
                    issues: ['battery_weak', 'corrosion']
                },
                elec_flicker: {
                    id: 'elec_flicker',
                    name_pl: 'Mruganie �wiate�',
                    category: 'visual',
                    issues: ['loose_connection']
                }
            },

            // Usterki
            issues: {
                // === TOALETA ===
                wc_valve_shut: {
                    id: 'wc_valve_shut',
                    name_pl: 'Zamkni�ty zaw�r (wet/dry)',
                    probability: 0.6,
                    difficulty: 1,
                    required_symptoms: ['wc_blocked_pump'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_wc_lever',
                            question_pl: 'Czy ma�a wajcha (wet/dry) jest ustawiona na "Flush" (wypompowywanie)?',
                            answers: [
                                { text_pl: 'Nie, jest na dry / Zamkni�ta', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, jest otwarta', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Prze��cz na dry/Empty', description_pl: 'Aby opr�ni� muszl�, zaw�r musi by� otwarty.' }
                    ]
                },
                wc_seacock_out_closed: {
                    id: 'wc_seacock_out_closed',
                    name_pl: 'Zamkni�ty zaw�r odp�ywowy (Seacock)',
                    probability: 0.4,
                    difficulty: 2,
                    required_symptoms: ['wc_bowl_full', 'wc_blocked_pump'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_seacock_pos',
                            question_pl: 'Sp�jrz pod zlew w �azience. Czy du�y zaw�r jest wzd�u� rury?',
                            answers: [
                                { text_pl: 'Jest w poprzek (Zamkni�ty)', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest wzd�u� (Otwarty)', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Otw�rz zaw�r', description_pl: 'd�wignia musi by� r�wnolegle do rury.' }
                    ]
                },
                wc_tank_full: {
                    id: 'wc_tank_full',
                    name_pl: 'Pe�ny zbiornik na fekalia',
                    probability: 0.3,
                    difficulty: 1,
                    required_symptoms: ['wc_bowl_full', 'wc_bad_smell'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_tank_level',
                            question_pl: 'Czy wska�nik zbiornika pokazuje FULL?',
                            answers: [
                                { text_pl: 'Tak, �wieci na czerwono', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Pusto / Zielono', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Otw�rz zaw�r zrzutowy', description_pl: 'Je�li jeste� na pe�nym morzu (>12 mil).' },
                        { step: 2, title_pl: 'U�yj pompy maceratora', description_pl: 'Je�li jacht j� posiada.' }
                    ]
                },

                // === siLNIK ZABURTOwY (dINGHY) ===
                ob_kill_cord: {
                    id: 'ob_kill_cord',
                    name_pl: 'Zrywka bezpiecze�stwa (Kill cord)',
                    probability: 0.8, // Najcz�stszy b��d
                    difficulty: 1,
                    required_symptoms: ['ob_wont_start'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_kill_cord',
                            question_pl: 'Czy czerwona zrywka jest wpi�ta w przycisk STOP?',
                            answers: [
                                { text_pl: 'Nie / wisi lu�no', probability_change: 0.99, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, jest wpi�ta', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'wepnij zrywk�', description_pl: 'Musi wej�� pod przycisk, aby go podnie��.' }
                    ]
                },
                ob_tank_vent: {
                    id: 'ob_tank_vent',
                    name_pl: 'Zamkni�ty odpowietrznik paliwa',
                    probability: 0.5,
                    difficulty: 1,
                    required_symptoms: ['ob_stops_run', 'ob_wont_start'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_vent_screw',
                            question_pl: 'Czy ma�a �rubka na korku paliwa jest odkr�cona?',
                            answers: [
                                { text_pl: 'Jest zakr�cona', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest lu�na / odkr�cona', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Odkr�� �rubk� na korku', description_pl: 'dzi�ki temu paliwo mo�e sp�ywa� do silnika.' }
                    ]
                },
                ob_fuel_tap: {
                    id: 'ob_fuel_tap',
                    name_pl: 'Zamkni�ty kranik paliwa',
                    probability: 0.4,
                    difficulty: 1,
                    required_symptoms: ['ob_wont_start', 'ob_stops_run'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_fuel_tap_pos',
                            question_pl: 'Czy kranik paliwa (z boku silnika) jest pionowo/otwarty?',
                            answers: [
                                { text_pl: 'Jest poziomo (OFF)', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest pionowo (ON)', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Otw�rz kranik', description_pl: 'Zazwyczaj d�wignia w d� lub wzd�u� w�yka.' }
                    ]
                },

                // === KOTwICA ===
                anc_breaker: {
                    id: 'anc_breaker',
                    name_pl: 'wybity bezpiecznik windy',
                    probability: 0.6,
                    difficulty: 1,
                    required_symptoms: ['anc_silent'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_anchor_breaker',
                            question_pl: 'Sp�jrz na panel bezpiecznik�w. Czy bezpiecznik windy (windlass) wyskoczy�?',
                            answers: [
                                { text_pl: 'Tak, d�wigienka wisi', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'wygl�da OK / �wieci', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'wci�nij/w��cz bezpiecznik', description_pl: 'Cz�sto du�y automat obok g��wnego panelu.' }
                    ]
                },
                anc_engine_off: {
                    id: 'anc_engine_off',
                    name_pl: 'silnik wy��czony (Brak pr�du)',
                    probability: 0.5,
                    difficulty: 1,
                    required_symptoms: ['anc_silent'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_engine_running_anc',
                            question_pl: 'Czy g��wny silnik jachtu pracuje?',
                            answers: [
                                { text_pl: 'Nie, jest zgaszony', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, pracuje', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Uruchom silnik', description_pl: 'winda pobiera du�o pr�du i cz�sto dzia�a tylko przy w��czonym silniku.' }
                    ]
                },

                // === GENERATOR ===
                gen_raw_water_loss: {
                    id: 'gen_raw_water_loss',
                    name_pl: 'Brak ch�odzenia (LOC / Overheat)',
                    probability: 0.6,
                    difficulty: 2,
                    required_symptoms: ['gen_stops', 'onan_3_blink', 'kohler_loc'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_gen_water_flow',
                            question_pl: 'Czy z wydechu generatora (cz�sto z boku kad�uba) leci woda?',
                            answers: [
                                { text_pl: 'Tylko powietrze / para', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'woda leci mocno', probability_change: -0.7, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wyczy�� filtr wody', description_pl: 'Sprawd� Sea Strainer generatora.' },
                        { step: 2, title_pl: 'Sprawd� wirnik (Impeller)', description_pl: 'Wymie� je�li filtr by� czysty.' }
                    ]
                },
                gen_breaker_trip: {
                    id: 'gen_breaker_trip',
                    name_pl: 'wybity bezpiecznik na pr�dnicy',
                    probability: 0.7,
                    difficulty: 1,
                    required_symptoms: ['gen_no_power'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_gen_breaker',
                            question_pl: 'Otw�rz obudow� generatora. Czy widzisz prze��cznik "Main Breaker"?',
                            answers: [
                                { text_pl: 'Tak, jest w pozycji OFF/d�', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest w��czony (ON)', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'w��cz bezpiecznik', description_pl: 'Znajduje si� bezpo�rednio na generatorze (nie na panelu).' },
                        { step: 2, title_pl: 'Zmniejsz obci��enie', description_pl: 'wy��cz klimatyzacj� przed ponownym w��czeniem.' }
                    ]
                },
                gen_oil_low: {
                    id: 'gen_oil_low',
                    name_pl: 'Niski poziom oleju (Oil Pressure)',
                    probability: 0.4,
                    difficulty: 1,
                    required_symptoms: ['gen_stops', 'onan_2_blink'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_gen_oil_stick',
                            question_pl: 'Sprawd� bagnet oleju. Jaki jest poziom?',
                            answers: [
                                { text_pl: 'Poni�ej minimum', probability_change: 0.99, knockout: 'others', type: 'confirm' },
                                { text_pl: 'w normie', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'dolej oleju', description_pl: 'Typowo 15w40 (jak do silnika).' }
                    ]
                },

                // === PALIwO (FUEL) ===
                fuel_empty: {
                    id: 'fuel_empty',
                    name_pl: 'Brak paliwa / B��dny wska�nik',
                    name_en: 'Out of fuel / Gauge error',
                    probability: 0.15,
                    difficulty: 1,
                    required_symptoms: ['eng_cranks_no_start', 'eng_stalls_idle', 'eng_stalls_load'],
                    conflicting_symptoms: ['vis_smoke_black', 'vis_smoke_blue'], 
                    verification_questions: [
                        {
                            id: 'q_fuel_gauge_verify',
                            question_pl: 'co wskazuje wska�nik paliwa?',
                            question_expert_pl: 'Jaki jest poziom paliwa? Czy by� weryfikowany "na patyk"?',
                            answers: [
                                { text_pl: 'Rezerwa / Pusto', probability_change: 0.7, type: 'confirm' },
                                { text_pl: 'Pe�ny / Jest paliwo', probability_change: -0.5, type: 'reject' }
                            ],
                            answers_expert: [
                                { text_pl: 'Potwierdzony brak paliwa', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Paliwo zweryfikowane fizycznie', probability_change: -1.0, knockout: 'self', type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawd� fizycznie poziom', description_pl: 'Nie ufaj wska�nikom elektrycznym.' },
                        { step: 2, title_pl: 'dolej paliwa', description_pl: 'Minimum 20 litr�w.' },
                        { step: 3, title_pl: 'Odpowietrz uk�ad', description_pl: 'Kluczowe po wyczerpaniu paliwa.' }
                    ]
                },

                fuel_air_lock: {
                    id: 'fuel_air_lock',
                    name_pl: 'Zapowietrzenie uk�adu paliwowego',
                    name_en: 'Air lock in fuel system',
                    probability: 0.25,
                    difficulty: 3,
                    required_symptoms: ['eng_cranks_no_start', 'eng_stalls_idle'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_recent_service',
                            question_pl: 'Czy Wymieniano ostatnio filtry paliwa?',
                            question_expert_pl: 'Czy uk�ad paliwowy by� otwierany w ci�gu ostatnich 50h?',
                            answers: [
                                { text_pl: 'Tak, niedawno', probability_change: 0.6, type: 'confirm' },
                                { text_pl: 'Nie', probability_change: -0.2, type: 'neutral' }
                            ]
                        },
                        {
                            id: 'q_bleed_screw',
                            question_pl: 'Czy po odkr�ceniu odpowietrznika leci samo paliwo?',
                            question_expert_pl: 'Test odpowietrznika na pompie wtryskowej: paliwo czy b�belki?',
                            answers: [
                                { text_pl: 'Lec� b�belki powietrza', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Czyste paliwo bez b�bli', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zlokalizuj �rub� odpowietrzaj�c�', description_pl: 'Zazwyczaj na g�rze filtra lub pompie wtryskowej.' },
                        { step: 2, title_pl: 'pompuj pompk� r�czn�', description_pl: 'A� przestan� lecie� b�belki.' }
                    ]
                },

                diesel_bug: {
                    id: 'diesel_bug',
                    name_pl: 'Ska�enie paliwa ("diesel Bug")',
                    name_en: 'diesel Bug / contamination',
                    probability: 0.2,
                    difficulty: 3,
                    required_symptoms: ['eng_stalls_load', 'eng_stalls_idle', 'eng_cranks_no_start'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_filter_slime',
                            question_pl: 'Sp�jrz na filtr wst�pny (szklanka). co widzisz?',
                            question_expert_pl: 'Inspekcja separatora wody: obecno�� czarnego szlamu?',
                            answers: [
                                { text_pl: 'Czarna/br�zowa ma�', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Czyste paliwo', probability_change: -0.8, knockout: 'self', type: 'reject' },
                                { text_pl: 'woda na dnie', probability_change: 0.4, type: 'support' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wymie� filtry', description_pl: 'Miej zapasowe!' },
                        { step: 2, title_pl: 'Wyczy�� zbiornik', description_pl: 'd�ugoterminowo konieczne czyszczenie i biocyd.' }
                    ]
                },

                // === ELEKTRYKA / ROZRUCH (STARTING) ===
                neutral_safety_switch: {
                    id: 'neutral_safety_switch',
                    name_pl: 'Bieg nie jest w neutralu',
                    name_en: 'Gear in gear (Neutral Safety Switch)',
                    probability: 0.3,
                    difficulty: 1,
                    required_symptoms: ['eng_no_crank'],
                    conflicting_symptoms: ['eng_cranks_no_start', 'snd_grinding'],
                    verification_questions: [
                        {
                            id: 'q_gear_check',
                            question_pl: 'Czy manetka jest idealnie w pionie (luz)?',
                            question_expert_pl: 'weryfikacja pozycji neutralnej i przycisku wysprz�glenia.',
                            answers: [
                                { text_pl: 'Nie, jest na biegu', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, jest na luzie', probability_change: -0.4, type: 'reject' }
                            ],
                            answers_expert: [
                                { text_pl: 'by�a na biegu (Skorygowano)', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest w Neutral (Sprawdzone)', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'wrzu� luz (Neutral)', description_pl: 'Poruszaj manetk� prz�d-ty� i ustaw pionowo.' },
                        { step: 2, title_pl: 'Sprawd� przycisk wysprz�glenia', description_pl: 'Czasem si� zacina.' }
                    ]
                },

                battery_dead: {
                    id: 'battery_dead',
                    name_pl: 'Roz�adowany akumulator',
                    name_en: 'dead battery',
                    probability: 0.35,
                    difficulty: 2,
                    required_symptoms: ['eng_no_crank', 'snd_click_start', 'elec_dim_lights', 'ins_volt_low'],
                    conflicting_symptoms: ['eng_cranks_no_start'],
                    verification_questions: [
                        {
                            id: 'q_volts_load',
                            question_pl: 'Czy �wiat�a przygasaj� gdy pr�bujesz odpali�?',
                            question_expert_pl: 'Spadek napi�cia (Voltage drop) podczas pr�by rozruchu?',
                            answers: [
                                { text_pl: 'Tak, gasn� ca�kowicie', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Nie przygasaj�', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Po��cz akumulatory (BOTH)', description_pl: 'Je�li masz prze��cznik 1-2-Both.' },
                        { step: 2, title_pl: 'Sprawd� klemy', description_pl: 'Czy s� Dokr�cone i czyste?' }
                    ]
                },

                hydrolock: {
                    id: 'hydrolock',
                    name_pl: 'Hydrolock (woda w cylindrze)',
                    name_en: 'Hydrolock',
                    probability: 0.05,
                    difficulty: 5,
                    required_symptoms: ['eng_no_crank', 'snd_click_start'],
                    conflicting_symptoms: ['eng_cranks_no_start'],
                    verification_questions: [
                        {
                            id: 'q_engine_turn_hand',
                            question_pl: 'Czy silnik da si� obr�ci� r�cznie (kluczem na kole pasowym)?',
                            question_expert_pl: 'Pr�ba obrotu wa�em korbowym r�cznie (Barring over).',
                            answers: [
                                { text_pl: 'Ani drgnie (Zablokowany)', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, obraca si�', probability_change: -1.0, knockout: 'self', type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'NIE PR�BUJ KR�CI� ROZRUSZNIKIEM', description_pl: 'Grozi zgi�ciem korbowodu.' },
                        { step: 2, title_pl: 'Zamknij wod� zaburtow�', description_pl: 'Natychmiast.' },
                        { step: 3, title_pl: 'wykr�� wtryskiwacze/�wiece', description_pl: 'Aby wypu�ci� wod� przy obrocie.' }
                    ],
                    emergency_tip_pl: 'KRYTYCZNE: Je�li podejrzewasz wod� w cylindrze, dalsze pr�by rozruchu zniszcz� silnik.'
                },

                starter_solenoid: {
                    id: 'starter_solenoid',
                    name_pl: 'Awaria solenoidu rozrusznika',
                    name_en: 'Starter solenoid failure',
                    probability: 0.15,
                    difficulty: 3,
                    required_symptoms: ['eng_no_crank', 'snd_click_start'],
                    conflicting_symptoms: ['eng_cranks_no_start', 'elec_dim_lights'], // dim lights sugeruje aku, nie solenoid
                    verification_questions: [
                        {
                            id: 'q_bridge_starter',
                            question_pl: 'Czy zmostkowanie rozrusznika �rubokr�tem uruchamia go?',
                            question_expert_pl: 'Test "na kr�tko" (bypass solenoid).',
                            answers: [
                                { text_pl: 'Tak, kr�ci', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Tylko iskrzy, nie kr�ci', probability_change: -0.3, type: 'neutral' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawd� kabel steruj�cy', description_pl: 'Cienki kabel id�cy do rozrusznika.' },
                        { step: 2, title_pl: 'Ostukaj rozrusznik', description_pl: 'delikatnie m�otkiem.' }
                    ]
                },

                // === CH�OdZENIE / wYdECH ===
                impeller_failed: {
                    id: 'impeller_failed',
                    name_pl: 'Uszkodzony wirnik pompy (Impeller)',
                    name_en: 'Impeller failure',
                    probability: 0.4,
                    difficulty: 3,
                    required_symptoms: ['ins_temp_high', 'vis_smoke_white'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_water_flow',
                            question_pl: 'Czy z wydechu leci woda ch�odz�ca?',
                            question_expert_pl: 'Obserwacja wylotu wody (wet exhaust flow).',
                            answers: [
                                { text_pl: 'Sucho / Tylko para', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Leci normalnie', probability_change: -0.8, knockout: 'self', type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawd� wirnik pompy', description_pl: 'Odkr�� dekiel pompy wody zaburtowej.' },
                        { step: 2, title_pl: 'Poszukaj brakuj�cych �opatek', description_pl: 'mog� zablokowa� Wymiennik ciep�a.' }
                    ]
                },

                raw_water_clogged: {
                    id: 'raw_water_clogged',
                    name_pl: 'Zablokowany wlot wody',
                    name_en: 'Blocked raw water intake',
                    probability: 0.3,
                    difficulty: 2,
                    required_symptoms: ['ins_temp_high', 'vis_smoke_white'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_strainer',
                            question_pl: 'Czy filtr wody zaburtowej jest czysty?',
                            question_expert_pl: 'Inspekcja kosza filtra (Sea strainer).',
                            answers: [
                                { text_pl: 'Pe�no wodorost�w/�mieci', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Czysty', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wyczy�� filtr', description_pl: 'Zakr�� zaw�r denny przed otwarciem!' },
                        { step: 2, title_pl: 'Sprawd� "grzybek" pod dnem', description_pl: 'Mo�e reklam�wka przyklei�a si� do wlotu.' }
                    ]
                },

                exhaust_elbow: {
                    id: 'exhaust_elbow',
                    name_pl: 'Zatkana kolanko wydechowe',
                    name_en: 'Clogged exhaust elbow',
                    probability: 0.15,
                    difficulty: 4,
                    required_symptoms: ['ins_temp_high', 'vis_smoke_black', 'vis_smoke_white'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_elbow_temp',
                            question_pl: 'Czy kolanko wydechu (mixing elbow) jest bardzo gor�ce?',
                            question_expert_pl: 'Temp. kolanka wydechowego (powinno da� si� dotkn�� r�k�).',
                            answers: [
                                { text_pl: 'Parzy, nie da si� dotkn��', probability_change: 0.7, type: 'confirm' },
                                { text_pl: 'Ciep�e, ale OK', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zdemontuj kolanko', description_pl: 'Sprawd� dro�no�� kana��w wodnych.' },
                        { step: 2, title_pl: 'Wyczy�� kwasem lub Wymie�', description_pl: 'Nagary zatykaj� przep�yw wody.' }
                    ]
                },

                // === UK�Ad NAP�dOwY ===
                propeller_fouling: {
                    id: 'propeller_fouling',
                    name_pl: 'Lina/sie� w �rubie',
                    name_en: 'Propeller fouling',
                    probability: 0.3,
                    difficulty: 5,
                    required_symptoms: ['eng_stalls_load', 'vib_running', 'vis_smoke_black'],
                    conflicting_symptoms: ['eng_stalls_idle'], // Na luzie zazwyczaj chodzi OK
                    verification_questions: [
                        {
                            id: 'q_neutral_rev',
                            question_pl: 'Czy na luzie (Neutral) silnik wchodzi na obroty?',
                            question_expert_pl: 'Test wysokich obrot�w bez obci��enia (No load wOT test).',
                            answers: [
                                { text_pl: 'Tak, wkr�ca si� idealnie', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Nie, dusi si� te� na luzie', probability_change: -0.8, type: 'reject' }
                            ]
                        },
                        {
                            id: 'q_diving',
                            question_pl: 'Czy nurkowa�e� Sprawdzi� �rub�?',
                            answers: [
                                { text_pl: 'Tak, jest czysta', probability_change: -1.0, knockout: 'self', type: 'reject' },
                                { text_pl: 'Nie', probability_change: 0, type: 'neutral' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zanurkuj i Sprawd�', description_pl: 'Tylko przy wy��czonym silniku i wyj�tym kluczyku!' },
                        { step: 2, title_pl: 'U�yj no�a do odci�cia liny', description_pl: 'Uwa�aj na uszczelniacz wa�u.' }
                    ]
                },

                alternator_belt: {
                    id: 'alternator_belt',
                    name_pl: 'Lu�ny pasek klinowy',
                    name_en: 'Loose alternator belt',
                    probability: 0.2,
                    difficulty: 1,
                    required_symptoms: ['ins_volt_low', 'ins_temp_high'], // Pasek nap�dza te� cz�sto pomp� wody
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_squeal',
                            question_pl: 'Czy s�ycha� pisk przy dodawaniu gazu?',
                            answers: [
                                { text_pl: 'Tak, piszczy', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Cisza', probability_change: -0.3, type: 'neutral' }
                            ]
                        },
                        {
                            id: 'q_belt_deflection',
                            question_pl: 'Czy pasek ugina si� wi�cej ni� 1cm?',
                            question_expert_pl: 'Ugi�cie paska pod naciskiem kciuka.',
                            answers: [
                                { text_pl: 'Tak, bardzo lu�ny', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Sztywny', probability_change: -0.7, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Naci�gnij pasek', description_pl: 'Poluzuj �rub� alternatora i naci�gnij.' },
                        { step: 2, title_pl: 'Sprawd� stan paska', description_pl: 'Je�li sparcia�y lub czarny py� - Wymie�.' }
                    ]
                },

                // === wIBRACJE I MOcowaNIA ===
                engine_mount_loose: {
                    id: 'engine_mount_loose',
                    name_pl: 'Zerwana poduszka silnika',
                    name_en: 'Broken Engine Mount',
                    probability: 0.25,
                    difficulty: 2,
                    required_symptoms: ['vib_idle', 'vib_running'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_neutral_vib',
                            question_pl: 'Czy silnik wpada w silne wibracje na luzie (Neutral)?',
                            question_expert_pl: 'Inspekcja poduszek silnika - czy guma jest zerwana?',
                            answers: [
                                { text_pl: 'Tak, trz�sie ca�� ��dk�', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Nie, na luzie jest g�adko', probability_change: -0.8, type: 'reject' }
                            ]
                        },
                        {
                            id: 'q_mount_visual',
                            question_pl: 'Otw�rz klap� silnika. Czy silnik "skacze" na boki przy dodawaniu gazu?',
                            answers: [
                                { text_pl: 'Tak, rusza si� mocno', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'siedzi sztywno', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zidentyfikuj zerwan� poduszk�', description_pl: 'U�yj �omu, aby unie�� silnik w miejscach mocowania.' },
                        { step: 2, title_pl: 'Wymie� poduszk�', description_pl: 'Konieczne podniesienie silnika.' }
                    ]
                },

                injector_fault: {
                    id: 'injector_fault',
                    name_pl: 'Awaria wtryskiwacza (Misfire)',
                    name_en: 'Injector Fault / Misfire',
                    probability: 0.2,
                    difficulty: 3,
                    required_symptoms: ['vib_idle', 'vib_running', 'vis_smoke_white', 'vis_smoke_black', 'eng_stalls_idle'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_cyl_crack',
                            question_pl: 'Poluzuj nakr�tki wtryskiwaczy po kolei (na pracuj�cym silniku). Czy praca silnika si� zmienia?',
                            question_expert_pl: 'Test "Cylinder Balance Test" (odcinanie cylindr�w).',
                            answers: [
                                { text_pl: 'Przy jednym NIE MA zmiany (To ten cylinder!)', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Przy ka�dym silnik przygasa (wtryski OK)', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'wykr�� wadliwy wtryskiwacz', description_pl: 'daj do Sprawdzenia w serwisie.' },
                        { step: 2, title_pl: 'Sprawd� kompresj�', description_pl: 'Brak reakcji cylindra mo�e te� oznacza� brak kompresji.' }
                    ]
                },

                shaft_bent: {
                    id: 'shaft_bent',
                    name_pl: 'Skrzywiony wa� nap�dowy',
                    name_en: 'Bent Prop Shaft',
                    probability: 0.1,
                    difficulty: 4,
                    required_symptoms: ['vib_running'],
                    conflicting_symptoms: ['vib_idle'], // wa� nie kr�ci si� na luzie
                    verification_questions: [
                        {
                            id: 'q_shaft_wobble',
                            question_pl: 'Sp�jrz na d�awic� wa�u (w �rodku �odzi). Czy wa� "bije" na boki?',
                            answers: [
                                { text_pl: 'Tak, wida� bicie', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'wygl�da prosto', probability_change: -0.3, type: 'neutral' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawd� bicie czujnikiem zegarowym', description_pl: 'Na l�dzie.' },
                        { step: 2, title_pl: 'wyprostuj lub Wymie� wa�', description_pl: 'wymaga wyci�gni�cia wa�u.' }
                    ]
                }
            }
        };

        // Zmienna globalna trzymaj�ca aktualn� (po��czon�) baz�
        let marinedatabase = JSON.parse(JSON.stringify(baseMarinedatabase));

        // ====================
        // STAN APLIKACJI
        // ====================

        let appState = {
            currentScreen: 'home',
            selectedSystem: null,
            selectedEngineType: 'general', // 'general', 'yanmar', 'volvo'
            selectedSymptoms: [],
            currentQuestions: [],
            currentQuestionIndex: 0,
            questionAnswers: {},
            diagnosisResults: [],
            language: 'pl',
            isOffline: !navigator.onLine,
            expertMode: false,
            amateurMode: false
        };

        // ====================
        // dIAGNOSTIC ENGINE (Separation of Logic)
        // ====================
        const diagnosticEngine = {
            // Faza 1: Znajdowanie pasuj�cych usterek na podstawie symptom�w
            findRelevantIssues: function(selectedSymptoms, database) {
                if (!selectedSymptoms || selectedSymptoms.length === 0) return [];
                
                const selectedSet = new Set(selectedSymptoms);
                const possibleIssues = [];
                
                Object.values(database.issues).forEach(issue => {
                    // 1. Sprawd� wymagane symptomy (Symptom Support)
                    const hasSupport = issue.required_symptoms.some(reqSym => selectedSet.has(reqSym));
                    
                    // 2. Sprawd� konflikty (conflicting Symptoms)
                    const hasconflict = issue.conflicting_symptoms.some(confSym => selectedSet.has(confSym));
                    
                    if (hasSupport && !hasconflict) {
                        possibleIssues.push(issue);
                    }
                });
                
                return possibleIssues;
            },

            // Faza 2: Obliczanie diagnozy (Bayesian-lite inference)
            calculatediagnosis: function(selectedSymptoms, questionAnswers, questionsList, database, expertMode) {
                const selectedSet = new Set(selectedSymptoms);
                let candidates = [];
                const eliminated = [];
                
                // 1. wst�pna ocena i zbieranie kandydat�w
                Object.values(database.issues).forEach(issue => {
                    const hasSupport = issue.required_symptoms.some(reqSym => selectedSet.has(reqSym));
                    const hasconflict = issue.conflicting_symptoms.some(confSym => selectedSet.has(confSym));
                    
                    if (hasconflict) {
                        eliminated.push({ issue, reason: 'Konflikt symptom�w' });
                        return;
                    }
                    
                    if (hasSupport) {
                        let confidence = issue.probability;
                        let justification = [`Bazowe prawdopodobie�stwo: ${Math.round(confidence * 100)}%`];
                        let isKnockedOutSelf = false;
                        let isKnockoutOthers = false; // Branch Killer
                        
                        // Analiza odpowiedzi
                        if (issue.verification_questions) {
                            issue.verification_questions.forEach(question => {
                                const key = `${issue.id}_${question.id}`;
                                if (questionAnswers.hasOwnProperty(key)) {
                                    const answerIdx = questionAnswers[key];
                                    if (answerIdx === 'unsure') {
                                        justification.push(`Odp: "Nie wiem" (Brak danych)`);
                                    } else {
                                        const answersList = (expertMode && question.answers_expert) 
                                            ? question.answers_expert 
                                            : question.answers;
                                            
                                        const answer = answersList[answerIdx];
                                        
                                        if (answer) {
                                            confidence += answer.probability_change;
                                            const sign = answer.probability_change > 0 ? '+' : '';
                                            justification.push(`Odp: "${answer.text_pl}" (${sign}${Math.round(answer.probability_change * 100)}%)`);
                                            
                                            if (answer.knockout === 'self') isKnockedOutSelf = true;
                                            if (answer.knockout === 'others') isKnockoutOthers = true;
                                        }
                                    }
                                }
                            });
                        }
                        
                        candidates.push({ 
                            issue, 
                            confidence, 
                            justification, 
                            isKnockedOutSelf, 
                            isKnockoutOthers 
                        });
                    }
                });
                
                // 2. Logika "Branch Killer" (Knockout)
                const killers = candidates.filter(c => c.isKnockoutOthers);
                
                if (killers.length > 0) {
                    candidates.forEach(c => {
                        if (!c.isKnockoutOthers) {
                            c.confidence = 0;
                            c.justification.push("wykluczone przez inn� pewn� diagnoz� (Branch Killer).");
                            c.isKnockedOutSelf = true; 
                        } else {
                            c.confidence = 0.99;
                            c.justification.push("POTwIErdzONE dEFINITYwNIE (Kluczowy objaw).");
                        }
                    });
                }
                
                // 3. Finalizacja wynik�w
                const results = [];
                
                candidates.forEach(c => {
                    if (c.isKnockedOutSelf) {
                        eliminated.push({ issue: c.issue, reason: 'wykluczone przez odpowied� (Knockout)' });
                    } else {
                        c.confidence = Math.max(0, Math.min(0.99, c.confidence));
                        results.push(c);
                    }
                });
                
                results.sort((a, b) => b.confidence - a.confidence);
                
                // Generowanie raportu z test�w
                const testsPerformed = questionsList.map((q) => {
                     const key = `${q.issueId}_${q.id}`;
                     const ansidx = questionAnswers[key];
                     const issue = database.issues[q.issueId];
                     const question = issue ? issue.verification_questions.find(vq => vq.id === q.id) : null;
                     let ansText = "Pomini�to";
                     
                     if (question && ansidx !== undefined) {
                         if (ansidx === 'unsure') {
                            ansText = "Nie wiem / Nie jestem pewien";
                         } else {
                            const answersList = (expertMode && question.answers_expert) 
                                       ? question.answers_expert 
                                       : question.answers;
                            ansText = answersList[ansidx] ? answersList[ansidx].text_pl : "B��d";
                         }
                     }
                     
                     return { question: q.question_pl, answer: ansText };
                });

                return {
                    primary: results.filter(r => r.confidence >= 0.6),
                    secondary: results.filter(r => r.confidence < 0.6 && r.confidence > 0.15),
                    eliminated,
                    testsPerformed
                };
            },

            // Sprawdzanie sprzeczno�ci (Sanity Check)
            checkcontradiction: function(question, answer, database) {
                // Przyk�ad logiki sprzeczno�ci
                // Je�li pytanie dotyczy "dymu" a wybrano "brak dymu", ale symptom to "czarny dym"
                
                const issue = database.issues[question.issueId];
                if (issue && issue.required_symptoms) {
                    // Je�li odpowied� "wyklucza" usterk�, kt�ra jest silnie sugerowana przez symptomy
                    // To mo�e by� sprzeczno��, ale mo�e te� by� po prostu eliminacja.
                }
                
                return false; // Placeholder
            }
        };

        // ====================
        // FUNKCJE SYSTEMU
        // ====================

        function initApp() {
            // Merge production trees from marine_specifics.js if available
            if (typeof productionTrees !== 'undefined') {
                Object.assign(diagnosticTrees, productionTrees);
            }
            
            renderSystems();
            renderTrees();
            setupOfflinedetection();
            loadLanguage();
            // Restore modes
            const savedExpert = localStorage.getItem('marineMechExpert');
            if (savedExpert === 'true') {
                appState.expertMode = true;
                document.getElementbyId('expert-mode-toggle').checked = true;
            }
            
            const savedAmateur = localStorage.getItem('marineMechAmateur');
            if (savedAmateur === 'true') {
                appState.amateurMode = true;
                document.getElementbyId('amateur-mode-toggle').checked = true;
            }
        }
        
        // function renderEngineSelect() removed
        // function changeEngineType(type) removed
        
        function toggleExpertMode() {
            appState.expertMode = !appState.expertMode;
            localStorage.setItem('marineMechExpert', appState.expertMode);
            
            // Expert and Amateur are mutually exclusive for UX clarity
            if (appState.expertMode && appState.amateurMode) {
                toggleAmateurMode(); // Turn off amateur
                document.getElementbyId('amateur-mode-toggle').checked = false;
            }
            
            if (appState.currentScreen === 'questions') renderCurrentQuestion();
        }

        function toggleAmateurMode() {
            appState.amateurMode = !appState.amateurMode;
            localStorage.setItem('marineMechAmateur', appState.amateurMode);
            
            // Expert and Amateur are mutually exclusive
            if (appState.amateurMode && appState.expertMode) {
                toggleExpertMode(); // Turn off expert
                document.getElementbyId('expert-mode-toggle').checked = false;
            }
            
            if (appState.currentScreen === 'questions') renderCurrentQuestion();
        }

        function renderSystems() {
            const grid = document.getElementbyId('systems-grid');
            grid.innerHTML = '';
            
            marinedatabase.systems.forEach(system => {
                const card = document.createElement('div');
                card.className = 'system-card';
                card.innerHTML = `
                    <div class="system-icon">
                        <i class="${system.icon}"></i>
                    </div>
                    <div class="system-name">${system.name_pl}</div>
                `;
                
                card.addEventListener('click', () => selectSystem(system));
                grid.appendChild(card);
            });
        }

        function selectSystem(system) {
            // Resetuj wszystkie karty
            document.querySelectorAll('.system-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Aktywuj wybran� kart�
            event.currentTarget.classList.add('active');
            
            appState.selectedSystem = system;
            document.getElementbyId('start-btn').disabled = false;
            
            // Aktualizuj tekst przycisku
            document.getElementbyId('start-btn').innerHTML = 
                `<i class="fas fa-play"></i> diagnozuj: ${system.name_pl}`;
        }

        function startdiagnosis() {
            if (!appState.selectedSystem) return;
            
            // 1. Sprawd� tryb diagnostyki zdefiniowany w danych
            if (appState.selectedSystem.diagnosis_mode === 'context_choice') {
                document.getElementbyId('engine-choice-modal').classList.add('active');
                return;
            }

            // 2. Sprawd� czy system ma przypisane drzewo diagnostyczne
            if (appState.selectedSystem.diagnosis_mode === 'tree' && appState.selectedSystem.default_tree_id) {
                const treeId = appState.selectedSystem.default_tree_id;
                if (typeof diagnosticTrees !== 'undefined' && diagnosticTrees[treeId]) {
                    startTreediagnosis(treeId);
                    return;
                }
            }
            
            // 3. Fallback do standardowej listy symptom�w
            proceedToSymptoms();
        }

        function selectEnginecontext(type) {
            try {
                document.getElementbyId('engine-choice-modal').classList.remove('active');

                // NEw LOGIC: data-driven routing based on engine_types configuration
                const engineconfig = marinedatabase.engine_types && marinedatabase.engine_types[type];
                
                if (engineconfig && engineconfig.tree_id && typeof diagnosticTrees !== 'undefined' && diagnosticTrees[engineconfig.tree_id]) {
                    startTreediagnosis(engineconfig.tree_id);
                    return;
                }

                // Fallback to Expert System (Probability) - Old Logic
                // Safety check for external library
                if (typeof mergeSpecificKnowledge === 'undefined') {
                    throw new Error("B��d �adowania marine_specifics.js. Funkcja mergeSpecificKnowledge jest niedost�pna.");
                }

                // �adujemy odpowiedni� baz� wiedzy
                marinedatabase = mergeSpecificKnowledge(JSON.parse(JSON.stringify(baseMarinedatabase)), type);
                
                // Poniewa� mergeSpecificKnowledge nadpisuje ca�� baz�, musimy od�wie�y� selectedSystem
                // aby wskazywa� na obiekt w NOwEJ bazie
                const newSystem = marinedatabase.systems.find(s => s.id === 'engine');
                if (!newSystem) {
                    throw new Error("Nie uda�o si� zaktualizowa� kontekstu silnika (System not found).");
                }
                appState.selectedSystem = newSystem;
                
                proceedToSymptoms();
            } catch (e) {
                console.error("Critical error in selectEnginecontext:", e);
                alert("wyst�pi� b��d krytyczny aplikacji:\n" + e.message + "\n\nSpr�buj od�wie�y� stron�.");
            }
        }

        function proceedToSymptoms() {
            // Przejd� do ekranu symptom�w
            switchScreen('symptoms');
            renderSymptoms();
            
            // Aktualizuj nag��wek
            document.getElementbyId('current-system').textcontent = 
                `System: ${appState.selectedSystem.name_pl}`;
        }

        function renderSymptoms() {
            const list = document.getElementbyId('symptoms-list');
            list.innerHTML = '';
            
            appState.selectedSymptoms = []; // Reset
            document.getElementbyId('next-to-questions-btn').disabled = true;
            document.getElementbyId('next-to-questions-btn').style.opacity = '0.5';
            document.getElementbyId('next-to-questions-btn').style.cursor = 'not-allowed';
            
            const systemSymptoms = appState.selectedSystem.symptoms;
            
            // Use categories from database
            const categoriesdB = marinedatabase.symptom_categories || {
                other: { name_pl: 'Inne', name_en: 'Other' }
            };
            
            const groupedSymptoms = {};
            
            systemSymptoms.forEach(symptomId => {
                const symptom = marinedatabase.symptoms[symptomId];
                if (!symptom) return;
                
                const category = symptom.category || 'other';
                if (!groupedSymptoms[category]) {
                    groupedSymptoms[category] = [];
                }
                groupedSymptoms[category].push(symptom);
            });
            
            // Render categories
            // we iterate over keys defined in dB to maintain order, then add any extras found
            const definedKeys = Object.keys(categoriesdB);
            const foundKeys = Object.keys(groupedSymptoms);
            const allKeys = [...new Set([...definedKeys, ...foundKeys])];

            allKeys.forEach(catKey => {
                if (groupedSymptoms[catKey] && groupedSymptoms[catKey].length > 0) {
                    // Get Category Name
                    const catdef = categoriesdB[catKey];
                    const catName = catdef ? (appState.language === 'pl' ? catdef.name_pl : catdef.name_en) : catKey;

                    // Header
                    const header = document.createElement('div');
                    header.className = 'symptom-category-header';
                    header.textcontent = catName;
                    list.appendChild(header);
                    
                    // Symptoms
                    groupedSymptoms[catKey].forEach(symptom => {
                        const item = document.createElement('div');
                        item.className = 'symptom-item';
                        item.id = `symptom-item-${symptom.id}`;
                        item.innerHTML = `
                            <div class="symptom-checkbox" id="checkbox-${symptom.id}"></div>
                            <div class="symptom-text">
                                ${appState.language === 'pl' ? symptom.name_pl : (symptom.name_en || symptom.name_pl)}
                                ${symptom.requires_specificity ? '<small style="display:block; color:var(--accent-teal); font-size:12px;">(wymaga doprecyzowania)</small>' : ''}
                            </div>
                        `;
                        
                        item.addEventListener('click', () => handleSymptomClick(symptom.id));
                        list.appendChild(item);
                    });
                }
            });
            
            updateSelectedcount();
        }

        function handleSymptomClick(symptomId) {
            const symptom = marinedatabase.symptoms[symptomId];
            
            // Je�li symptom jest ju� zaznaczony, odznacz go
            if (isSymptomSelected(symptomId)) {
                toggleSymptom(symptomId);
                return;
            }
            
            // Je�li wymaga doprecyzowania, otw�rz modal
            if (symptom.requires_specificity) {
                openSpecificityModal(symptom);
            } else {
                toggleSymptom(symptomId);
            }
        }

        function isSymptomSelected(symptomId) {
            return appState.selectedSymptoms.some(s => s === symptomId || s.startswith(symptomId + '_'));
        }

        function openSpecificityModal(symptom) {
            const modal = document.getElementbyId('specificity-modal');
            const optionscontainer = document.getElementbyId('specificity-options');
            
            optionscontainer.innerHTML = '';
            
            symptom.specificity_options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'specificity-option';
                div.textcontent = option.label;
                div.onclick = () => selectSpecificSymptom(symptom.id, option.id);
                optionscontainer.appendChild(div);
            });
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementbyId('specificity-modal').classList.remove('active');
        }

        function closeGuideModal() {
            document.getElementbyId('guide-modal').classList.remove('active');
        }

        function selectSpecificSymptom(parentId, specificId) {
            // Zapisz jako np. "vis_leak_water:vis_leak_fresh" lub po prostu specificId je�li unikalne
            // Tutaj u�yjemy specificId jako identyfikatora w selectedSymptoms, ale musimy wiedzie� �e to dziecko parentId
            
            // dla uproszczenia, dodajmy specificId do selectedSymptoms
            // Ale uwaga: musimy mapowa� specificId na issues w nextToQuestions
            
            // Zmodyfikujmy toggleSymptom �eby obs�ugiwa� to
            
            // Najpierw zamknij modal
            closeModal();
            
            // dodaj do stanu (r�cznie, bo to specyficzny przypadek)
            if (!appState.selectedSymptoms.includes(specificId)) {
                appState.selectedSymptoms.push(specificId);
                
                // Zaznacz wizualnie rodzica
                const parentCheckbox = document.getElementbyId(`checkbox-${parentId}`);
                if (parentCheckbox) parentCheckbox.classList.add('checked');
            }
            
            updateSelectedcount();
            
            // Check button state
            const btn = document.getElementbyId('next-to-questions-btn');
            if (appState.selectedSymptoms.length > 0) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        }

        function toggleSymptom(symptomId, element) {
            // Ta funkcja teraz obs�uguje tylko proste symptomy
            const checkbox = document.getElementbyId(`checkbox-${symptomId}`);
            const index = appState.selectedSymptoms.indexOf(symptomId);
            
            if (index === -1) {
                // dodaj symptom
                appState.selectedSymptoms.push(symptomId);
                if (checkbox) checkbox.classList.add('checked');
            } else {
                // Usu� symptom
                appState.selectedSymptoms.splice(index, 1);
                if (checkbox) checkbox.classList.remove('checked');
                
                // Je�li to by� rodzic specyficznych opcji, musieliby�my Usun�� te� dzieci
                // Ale w obecnej implementacji Id s� p�askie w selectedSymptoms
            }
            
            updateSelectedcount();
            
            // Check button state
            const btn = document.getElementbyId('next-to-questions-btn');
            if (appState.selectedSymptoms.length > 0) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        }

        function updateSelectedcount() {
            document.getElementbyId('selected-count').textcontent = 
                appState.selectedSymptoms.length;
        }

        function nextToQuestions() {
            if (appState.selectedSymptoms.length === 0) {
                alert('wybierz przynajmniej jeden symptom!');
                return;
            }
            
            // USE ENGINE: Find Relevant Issues
            const possibleIssues = diagnosticEngine.findRelevantIssues(appState.selectedSymptoms, marinedatabase);
            
            if (possibleIssues.length === 0) {
                // Fallback: Je�li nic nie pasuje (np. dziwna kombinacja), poka� komunikat lub wszystko
                alert("Nie znaleziono typowych usterek dla tej kombinacji symptom�w. Spr�buj zmieni� wyb�r.");
                return;
            }
            
            // Stw�rz list� pyta�
            appState.currentQuestions = [];
            appState.questionAnswers = {};
            appState.currentQuestionIndex = 0;
            
            // Zbierz pytania z pasuj�cych usterek
            // Unikaj duplikat�w pyta� (je�li to samo pytanie jest w kilku usterkach - tu zak�adamy unikalne Id)
            possibleIssues.forEach(issue => {
                if (issue.verification_questions) {
                    issue.verification_questions.forEach(q => {
                        if (!appState.currentQuestions.find(existing => existing.id === q.id)) {
                            appState.currentQuestions.push({
                                issueId: issue.id,
                                ...q
                            });
                        }
                    });
                }
            });
            
            // Sortowanie pyta� (Question Selection)
            // Na razie prosto: pytania eliminacyjne (elimination) pierwsze
            appState.currentQuestions.sort((a, b) => {
                if (a.metadata?.type === 'elimination' && b.metadata?.type !== 'elimination') return -1;
                if (a.metadata?.type !== 'elimination' && b.metadata?.type === 'elimination') return 1;
                return 0;
            });
            
            // Ogranicz liczb� pyta� (convergence control)
            if (appState.currentQuestions.length > 7) {
                appState.currentQuestions = appState.currentQuestions.slice(0, 7);
            }
            
            switchScreen('questions');
            renderCurrentQuestion();
        }

        function renderCurrentQuestion() {
            const container = document.getElementbyId('question-container');
            const question = appState.currentQuestions[appState.currentQuestionIndex];
            
            if (!question) {
                finishdiagnosis();
                return;
            }
            
            const issue = marinedatabase.issues[question.issueId];
            
            document.getElementbyId('current-system-name').textcontent = 
                `diagnostyka: ${issue ? issue.name_pl : 'B��d'}`;
            
            document.getElementbyId('current-question-counter').textcontent = 
                `Pytanie ${appState.currentQuestionIndex + 1}/${appState.currentQuestions.length}`;
            
            // --- MOdE SELECTION LOGIC ---
            let questionText = (appState.language === 'pl' ? question.question_pl : question.question_en);
            let answersToRender = question.answers;
            let modeBadge = '';

            if (appState.expertMode) {
                if (question.question_expert_pl) questionText = question.question_expert_pl;
                if (question.answers_expert) answersToRender = question.answers_expert;
                modeBadge = '<span class="mode-badge expert" style="background:var(--primary-dark); border:1px solid var(--accent-blue); padding:2px 6px; border-radius:4px; font-size:10px; margin-left:10px;">EXPERT</span>';
            } else if (appState.amateurMode) {
                if (question.question_amateur_pl) questionText = question.question_amateur_pl;
                if (question.answers_amateur) answersToRender = question.answers_amateur;
                modeBadge = '<span class="mode-badge amateur" style="background:var(--accent-teal); color:black; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:10px;">AMATOR</span>';
            }
            
            // --- RENdER ANSwERS ---
            let answersHtml = '';
            answersToRender.forEach((answer, index) => {
                answersHtml += `
                    <button class="answer-btn" onclick="selectAnswer(${index})" 
                            id="answer-${index}">
                        ${appState.language === 'pl' ? answer.text_pl : answer.text_en || answer.text_pl}
                    </button>
                `;
            });

            // Add "Not Sure" option
            answersHtml += `
                <button class="answer-btn" onclick="selectAnswer('unsure')" 
                        id="answer-unsure" style="border-style: dashed; color: var(--text-secondary);">
                    <i class="fas fa-question-circle"></i> ${appState.language === 'pl' ? 'Nie wiem / Nie jestem pewien' : 'Not sure / don\'t know'}
                </button>
            `;
            
            container.innerHTML = `
                <div class="question-card fade-in">
                    <div class="question-header" style="display:flex; align-items:center; margin-bottom:15px;">
                        <span class="question-badge" style="background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px; font-size:12px;">
                            Pytanie ${appState.currentQuestionIndex + 1}/${appState.currentQuestions.length}
                        </span>
                        ${modeBadge}
                    </div>
                    
                    <div class="question-text">
                        ${appState.expertMode ? '<i class="fas fa-user-graduate" style="color:var(--accent-teal); margin-right:8px;"></i>' : ''}
                        ${appState.amateurMode ? '<i class="fas fa-life-ring" style="color:var(--accent-teal); margin-right:8px;"></i>' : ''}
                        ${questionText}
                    </div>
                    
                    <div class="answers-grid">
                        ${answersHtml}
                    </div>
                    
                    ${(question.metadata && appState.expertMode) ? `
                        <div style="margin-top: 15px; font-size: 0.8em; color: #aaa; border-top: 1px solid #444; padding-top: 10px;">
                            <strong>Expert data:</strong><br>
                            Uncertainty: ${question.metadata.uncertainty || 'N/A'}<br>
                            Type: ${question.metadata.type || 'N/A'}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Ukryj przycisk "Nast�pne pytanie" na pocz�tku
            document.getElementbyId('next-question-btn').style.display = 'none';
            
            // Je�li ju� odpowiedzia� na to pytanie, pokaz zaznaczon� odpowied�
            const questionId = `${question.issueId}_${question.id}`;
            if (appState.questionAnswers[questionId] !== undefined) {
                selectAnswer(appState.questionAnswers[questionId]);
            }
        }

        function selectAnswer(answerIndex) {
            // Resetuj wszystkie przyciski
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Zaznacz wybrany
            const selectedBtn = document.getElementbyId(`answer-${answerIndex}`);
            if (selectedBtn) selectedBtn.classList.add('selected');
            
            // Zapisz odpowied�
            const question = appState.currentQuestions[appState.currentQuestionIndex];
            const questionId = `${question.issueId}_${question.id}`;
            
            if (answerIndex === 'unsure') {
                appState.questionAnswers[questionId] = 'unsure';
                // Nie robimy sanity check dla "nie wiem"
            } else {
                // SANITY CHECK LAYER
                const answer = (appState.expertMode && question.answers_expert) 
                    ? question.answers_expert[answerIndex] 
                    : question.answers[answerIndex];
                    
                if (diagnosticEngine.checkcontradiction(question, answer, marinedatabase)) {
                    alert("OSTRZE�ENIE: Ta odpowied� wydaje si� by� sprzeczna z wybranymi wcze�niej symptomami.");
                }
                
                appState.questionAnswers[questionId] = answerIndex;
            }
            
            // Poka� przycisk "Nast�pne pytanie"
            document.getElementbyId('next-question-btn').style.display = 'flex';

            // Restore Back Button for Normal Mode
            const backBtn = document.querySelector('#screen-questions .btn-secondary');
            if (backBtn) {
                backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${appState.language === 'pl' ? 'Powr�t do symptom�w' : 'Back to symptoms'}`;
                backBtn.onclick = goBackToSymptoms;
            }
        }

        function nextQuestion() {
            appState.currentQuestionIndex++;
            
            if (appState.currentQuestionIndex < appState.currentQuestions.length) {
                renderCurrentQuestion();
            } else {
                finishdiagnosis();
            }
        }

        function finishdiagnosis() {
            // Zbieramy symptomy dla raportu (UI Rendering logic)
            const observedSymptoms = appState.selectedSymptoms.map(id => {
                let name = id;
                const topSymptom = marinedatabase.symptoms[id];
                if (topSymptom) {
                    name = topSymptom.name_pl;
                } else {
                    Object.values(marinedatabase.symptoms).forEach(s => {
                        if (s.specificity_options) {
                            const opt = s.specificity_options.find(o => o.id === id);
                            if (opt) name = `${s.name_pl}: ${opt.label}`;
                        }
                    });
                }
                return name;
            });

            // USE ENGINE: Calculate diagnosis
            const results = diagnosticEngine.calculatediagnosis(
                appState.selectedSymptoms,
                appState.questionAnswers,
                appState.currentQuestions,
                marinedatabase,
                appState.expertMode
            );
            
            appState.diagnosisResults = {
                observedSymptoms,
                ...results
            };
            
            switchScreen('results');
            renderResults();
        }

        function renderResults() {
            const container = document.getElementbyId('results-container');
            const data = appState.diagnosisResults;
            
            if (!data || (!data.primary.length && !data.secondary.length)) {
                container.innerHTML = `
                    <div class="results-container">
                        <div class="probability-badge" style="background: var(--error)">B��d diagnozy</div>
                        <div class="issue-card">
                            <h3 class="issue-title">Nie znaleziono przyczyny</h3>
                            <p>System nie by� w stanie ustali� przyczyny na podstawie podanych symptom�w.</p>
                            <p>Mo�liwe przyczyny:</p>
                            <ul>
                                <li>B��dne dane wej�ciowe</li>
                                <li>Usterka spoza bazy wiedzy</li>
                                <li>Konfliktuj�ce informacje</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="startNewdiagnosis()" style="margin-top:15px">Spr�buj ponownie</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // --- 1. Observed Symptoms ---
            let html = `
                <div class="results-container">
                    <h3 style="color:var(--text-secondary); font-size:14px; text-transform:uppercase; margin-bottom:10px;">Raport Techniczny</h3>
                    
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--accent-blue); margin-bottom:10px;">1. Zaobserwowane Symptomy</h4>
                        <ul style="list-style-position: inside; color:var(--text-primary);">
                            ${data.observedSymptoms.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
            `;
            
            // --- 2. Tests Performed ---
            if (data.testsPerformed.length > 0) {
                html += `
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--accent-blue); margin-bottom:10px;">2. wykonane Testy</h4>
                        <ul style="list-style: none; padding:0;">
                            ${data.testsPerformed.map(t => `
                                <li style="margin-bottom:8px; border-left:2px solid var(--accent-teal); padding-left:10px;">
                                    <div style="font-size:12px; color:var(--text-secondary);">${t.question}</div>
                                    <div>${t.answer}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // --- 3. Eliminated Causes ---
            if (data.eliminated.length > 0) {
                html += `
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--text-secondary); margin-bottom:10px;">wykluczone Przyczyny</h4>
                        <ul style="list-style: none; padding:0; color:var(--text-secondary);">
                            ${data.eliminated.slice(0, 3).map(e => `<li><i class="fas fa-times" style="color:var(--error)"></i> ${e.issue.name_pl} (${e.reason})</li>`).join('')}
                            ${data.eliminated.length > 3 ? `<li>...i ${data.eliminated.length - 3} innych</li>` : ''}
                        </ul>
                    </div>
                `;
            }

            // --- 4. Primary diagnosis ---
            if (data.primary.length > 0) {
                html += `<h4 style="color:var(--success); margin-bottom:15px; font-size:18px;">G��wna diagnoza</h4>`;
                
                data.primary.forEach((result, idx) => {
                    const prob = Math.round(result.confidence * 100);
                    html += `
                        <div class="issue-card" style="border-left: 4px solid var(--success);">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 class="issue-title" style="color:var(--success); margin:0;">${idx + 1}. ${result.issue.name_pl}</h3>
                                <span class="probability-badge" style="margin:0; background:var(--success);">${prob}% Pewno�ci</span>
                            </div>
                            
                            <div style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <strong style="color:var(--text-secondary); font-size:12px;">UZASAdNIENIE:</strong>
                                <ul style="font-size:13px; margin-top:5px; padding-left:20px;">
                                    ${result.justification.map(j => `<li>${j}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div style="margin-top:15px;">
                                <strong style="color:var(--accent-blue);">Zalecane dzia�ania naprawcze:</strong>
                                <div class="step-list" style="margin-top:10px;">
                                    ${result.issue.repair_steps ? result.issue.repair_steps.map(step => `
                                        <div class="step-item">
                                            <div class="step-number">${step.step}</div>
                                            <div>
                                                <strong>${step.title_pl}</strong><br>
                                                <span style="font-size:14px; color:var(--text-secondary);">${step.description_pl}</span>
                                            </div>
                                        </div>
                                    `).join('') : 'Brak instrukcji naprawy.'}
                                </div>
                            </div>
                            
                            ${result.issue.emergency_tip_pl ? `
                                <div style="margin-top:15px; padding:10px; background:rgba(255,152,0,0.1); border-radius:6px; border:1px solid var(--warning);">
                                    <strong style="color:var(--warning);"><i class="fas fa-exclamation-triangle"></i> Bezpiecze�stwo:</strong>
                                    <p style="font-size:14px; margin-top:5px;">${result.issue.emergency_tip_pl}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:20px; text-align:center; border:1px dashed var(--warning); border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--warning);">Niska pewno�� diagnozy (<60%)</h4>
                        <p>System nie znalaz� jednoznacznej przyczyny. Sprawd� sekcj� "Mo�liwe przyczyny" poni�ej lub skonsultuj si� z mechanikiem.</p>
                    </div>
                `;
            }

            // --- 5. Secondary Possibilities ---
            if (data.secondary.length > 0) {
                html += `<h4 style="color:var(--text-secondary); margin:20px 0 10px 0;">Inne Mo�liwo�ci</h4>`;
                data.secondary.forEach(result => {
                    const prob = Math.round(result.confidence * 100);
                    html += `
                        <div class="issue-card" style="border-left: 4px solid var(--text-secondary); opacity: 0.8;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${result.issue.name_pl}</strong>
                                <span>${prob}%</span>
                            </div>
                        </div>
                    `;
                });
            }

            // --- 6. Explicit Limitations ---
            html += `
                <div style="margin-top:30px; padding:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:12px; color:var(--text-secondary); text-align:center;">
                    <strong>OGRANICZENIA SYSTEMU:</strong><br>
                    Ta diagnoza jest generowana automatycznie na podstawie wprowadzonych danych.
                    Nie zast�puje profesjonalnej oceny mechanika.
                    System zak�ada, �e wprowadzone obserwacje s� poprawne.
                    Nie podejmuj dzia�a�, kt�re mog� zagra�a� bezpiecze�stwu za�ogi lub jednostki.
                </div>
            `;
            
            html += `</div>`; // Close container
            container.innerHTML = html;
        }

        function showEmergencyTips() {
            const tips = [
                "1. ZAwSZE najpierw bezpiecze�stwo za�ogi",
                "2. Je�li jest wyciek paliwa: wy��cz wszystko elektryczne, nie w��czaj wentylator�w",
                "3. Przy przegrzaniu silnika: nie otwieraj gor�cego uk�adu ch�odzenia",
                "4. Miej zawsze dost�pne kamizelki ratunkowe",
                "5. Utrzymuj kontakt radiowy na kanale 16",
                "6. Je�li silnik zawiedzie: przygotuj �agle lub kotwic�",
                "7. w ciemno�ci u�ywaj latarek z czerwonym filtrem"
            ];
            
            alert("wSKAZ�wKI AwaRYJNE:\n\n" + tips.join("\n"));
        }

        function startNewdiagnosis() {
            // Resetuj stan
            appState.selectedSystem = null;
            appState.selectedSymptoms = [];
            appState.currentQuestions = [];
            appState.currentQuestionIndex = 0;
            appState.questionAnswers = {};
            appState.diagnosisResults = [];
            
            // Resetuj UI
            document.querySelectorAll('.system-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementbyId('start-btn').disabled = true;
            document.getElementbyId('start-btn').innerHTML = 
                '<i class="fas fa-play"></i> Rozpocznij diagnostyk�';
            
            switchScreen('home');
        }

        function switchScreen(screenName) {
            // Ukryj wszystkie ekrany
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Poka� wybrany ekran
            document.getElementbyId(`screen-${screenName}`).classList.add('active');
            appState.currentScreen = screenName;
            
            // Aktualizuj pasek post�pu
            const progressBars = {
                'home': 0,
                'symptoms': 33,
                'questions': 66,
                'results': 100
            };
            
            for (const [screen, progress] of Object.entries(progressBars)) {
                const bar = document.getElementbyId(`progress-${screen}`);
                if (bar) {
                    bar.style.width = `${progress}%`;
                }
            }
        }

        let builderValidationErrors = [];
        function openBuilderModal() {
            const modal = document.getElementbyId('builder-modal');
            const textarea = document.getElementbyId('builder-json');
            const saved = localStorage.getItem('customdiagnosticTree');
            textarea.value = saved || '';
            document.getElementbyId('builder-errors').innerHTML = '';
            modal.classList.add('active');
        }
        function closeBuilderModal() {
            document.getElementbyId('builder-modal').classList.remove('active');
        }
        function renderBuilderErrors(errors) {
            const container = document.getElementbyId('builder-errors');
            if (!errors || errors.length === 0) {
                container.innerHTML = `<div style="color: var(--success); font-weight: 600; margin-top: 10px;">${appState.language === 'pl' ? 'Brak b��d�w. Mo�na zapisa�.' : 'No errors. You can save.'}</div>`;
                return;
            }
            const items = errors.map(e => {
                const id = e.id ? `[${e.id}]` : '';
                const path = e.path ? ` | ${e.path}` : '';
                return `<li><strong>${e.type}</strong> ${id}${path}: ${e.message}</li>`;
            }).join('');
            container.innerHTML = `<div style="color: var(--error); font-weight: 600; margin: 10px 0;">${appState.language === 'pl' ? 'wykryto b��dy walidacji:' : 'Validation errors detected:'}</div><ul style="margin-left: 20px;">${items}</ul>`;
        }
        function validateBuilderJson() {
            const textarea = document.getElementbyId('builder-json');
            let tree;
            try {
                tree = JSON.parse(textarea.value);
            } catch (e) {
                renderBuilderErrors([{ type: 'CRITICAL', message: appState.language === 'pl' ? 'Nieprawid�owy JSON.' : 'Invalid JSON.' }]);
                builderValidationErrors = [{ type: 'CRITICAL', message: 'Invalid JSON.' }];
                return;
            }
            if (typeof validatediagnosticTree === 'function') {
                const errors = validatediagnosticTree(tree);
                builderValidationErrors = errors;
                renderBuilderErrors(errors);
            } else {
                renderBuilderErrors([{ type: 'CRITICAL', message: appState.language === 'pl' ? 'Brak funkcji walidatora.' : 'Validator function not available.' }]);
                builderValidationErrors = [{ type: 'CRITICAL', message: 'Validator missing.' }];
            }
        }
        function saveBuilderJson() {
            if (builderValidationErrors && builderValidationErrors.length > 0) {
                renderBuilderErrors(builderValidationErrors);
                return;
            }
            const textarea = document.getElementbyId('builder-json');
            let tree;
            try {
                tree = JSON.parse(textarea.value);
            } catch (e) {
                renderBuilderErrors([{ type: 'CRITICAL', message: appState.language === 'pl' ? 'Nieprawid�owy JSON.' : 'Invalid JSON.' }]);
                return;
            }
            if (typeof validatediagnosticTree === 'function') {
                const errors = validatediagnosticTree(tree);
                if (errors.length > 0) {
                    builderValidationErrors = errors;
                    renderBuilderErrors(errors);
                    return;
                }
            }
            localStorage.setItem('customdiagnosticTree', textarea.value);
            const okMsg = appState.language === 'pl' ? 'Zapisano poprawne drzewo.' : 'Valid tree saved.';
            document.getElementbyId('builder-errors').innerHTML = `<div style="color: var(--success); font-weight: 600; margin-top: 10px;">${okMsg}</div>`;
        }
        function validatediagnosticTree(tree) {
            const errors = [];
            const MAX_dEPTH = 6;
            if (!tree || typeof tree !== 'object') {
                return [{ type: 'CRITICAL', message: 'Tree must be a non-null object.' }];
            }
            const treeId = tree.tree_id || 'unknown_tree';
            if (!tree.tree_id) errors.push({ id: treeId, type: 'METAdATA', message: "Missing 'tree_id'." });
            if (!tree.metadata) {
                errors.push({ id: treeId, type: 'METAdATA', message: "Missing 'metadata' object." });
            } else {
                const meta = tree.metadata;
                if (!meta.title || !meta.title.en || !meta.title.pl) {
                    errors.push({ id: treeId, type: 'LOCALIZATION', message: 'Title must have en and pl.' });
                }
                if (!meta.version) errors.push({ id: treeId, type: 'METAdATA', message: "Missing 'version'." });
                if (!meta.engine_type) errors.push({ id: treeId, type: 'METAdATA', message: "Missing 'engine_type'." });
            }
            const nodes = tree.nodes || {};
            const solutions = tree.solutions || {};
            if (Object.keys(nodes).length === 0) {
                errors.push({ id: treeId, type: 'STRUCTURE', message: 'Tree has no nodes.' });
            }
            for (const [nodeId, node] of Object.entries(nodes)) {
                if (!node.question || !node.question.en || !node.question.pl) {
                    errors.push({ id: nodeId, type: 'LOCALIZATION', message: 'Missing en or pl question.' });
                }
                if (node.context) {
                    if (!node.context.en || !node.context.pl) {
                        errors.push({ id: nodeId, type: 'LOCALIZATION', message: 'context missing en or pl.' });
                    }
                }
                const answers = Array.isArray(node.answers) ? node.answers : [];
                if (answers.length === 0) {
                    errors.push({ id: nodeId, type: 'STRUCTURE', message: 'Must have at least one answer.' });
                }
                let hasCantCheck = false;
                answers.forEach((ans, idx) => {
                    const ansRef = `ANSwER [${idx}]`;
                    if (ans.type === 'cant_check') hasCantCheck = true;
                    if (!ans.text || !ans.text.en || !ans.text.pl) {
                        errors.push({ id: nodeId, path: ansRef, type: 'LOCALIZATION', message: 'Missing en or pl text.' });
                    }
                    if (ans.probability !== undefined) {
                        if (typeof ans.probability !== 'number' || ans.probability < 0 || ans.probability > 1) {
                            errors.push({ id: nodeId, path: ansRef, type: 'VALIdATION', message: 'Probability must be 0.0-1.0.' });
                        }
                    }
                    if (ans.next) {
                        const t = ans.next.type;
                        const id = ans.next.id;
                        if (t === 'node') {
                            if (!nodes[id]) {
                                errors.push({ id: nodeId, path: ansRef, type: 'REFERENCE', message: `References missing node '${id}'.` });
                            }
                        } else if (t === 'solution') {
                            if (!solutions[id]) {
                                errors.push({ id: nodeId, path: ansRef, type: 'REFERENCE', message: `References missing solution '${id}'.` });
                            }
                        } else {
                            errors.push({ id: nodeId, path: ansRef, type: 'VALIdATION', message: "Invalid target type." });
                        }
                    } else {
                        errors.push({ id: nodeId, path: ansRef, type: 'STRUCTURE', message: "Missing 'next' target." });
                    }
                });
                if (!hasCantCheck) {
                    errors.push({ id: nodeId, type: 'STRUCTURE', message: "Missing 'cant_check' answer." });
                }
            }
            for (const [solId, sol] of Object.entries(solutions)) {
                if (!sol.title || !sol.title.en || !sol.title.pl) {
                    errors.push({ id: solId, type: 'LOCALIZATION', message: 'Missing en or pl title.' });
                }
                if (!sol.description || !sol.description.en || !sol.description.pl) {
                    errors.push({ id: solId, type: 'LOCALIZATION', message: 'Missing en or pl description.' });
                }
                if (!Array.isArray(sol.steps) || sol.steps.length === 0) {
                    errors.push({ id: solId, type: 'STRUCTURE', message: "Missing 'steps'." });
                } else {
                    sol.steps.forEach((step, idx) => {
                        if (!step.en || !step.pl) {
                            errors.push({ id: solId, path: `STEP [${idx}]`, type: 'LOCALIZATION', message: 'Missing en or pl step.' });
                        }
                    });
                }
            }
            const startNodeId = tree.start_node || (Object.keys(nodes).length > 0 ? Object.keys(nodes)[0] : null);
            if (startNodeId && nodes[startNodeId]) {
                const flowErrors = [];
                function traverse(nodeId, path, depth) {
                    if (depth > MAX_dEPTH) {
                        flowErrors.push({ id: nodeId, type: 'FLOw', path: path.join(' -> '), message: `Max depth (${MAX_dEPTH}) exceeded.` });
                        return;
                    }
                    if (path.includes(nodeId)) {
                        flowErrors.push({ id: nodeId, type: 'FLOw', path: path.join(' -> '), message: 'Infinite loop detected.' });
                        return;
                    }
                    const node = nodes[nodeId];
                    if (!node) return;
                    const currentPath = [...path, nodeId];
                    (node.answers || []).forEach(ans => {
                        if (ans.next && ans.next.type === 'node') {
                            traverse(ans.next.id, currentPath, depth + 1);
                        }
                    });
                }
                traverse(startNodeId, [], 1);
                const seen = new Set();
                flowErrors.forEach(err => {
                    const key = JSON.stringify(err);
                    if (!seen.has(key)) {
                        seen.add(key);
                        errors.push(err);
                    }
                });
            } else if (Object.keys(nodes).length > 0) {
                errors.push({ id: treeId, type: 'STRUCTURE', message: 'could not determine start node.' });
            }
            return errors;
        }
        function goBackToSystems() {
            switchScreen('home');
        }

        function goBackToSymptoms() {
            switchScreen('symptoms');
        }

        function setupOfflinedetection() {
            function updateOnlineStatus() {
                appState.isOffline = !navigator.onLine;
                if (appState.isOffline) {
                    document.body.classList.add('offline');
                } else {
                    document.body.classList.remove('offline');
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        function loadLanguage() {
            // Mo�na doda� zapis/odczyt preferencji j�zykowych
            const savedLang = localStorage.getItem('marineMechLang');
            if (savedLang) {
                appState.language = savedLang;
            } else {
                // Automatyczne wykrywanie
                appState.language = navigator.language.startswith('pl') ? 'pl' : 'en';
            }
        }

        function toggleLanguage() {
            appState.language = appState.language === 'pl' ? 'en' : 'pl';
            localStorage.setItem('marineMechLang', appState.language);
            
            // Prze�aduj aktualny ekran
            switch(appState.currentScreen) {
                case 'home':
                    renderSystems();
                    renderTrees();
                    break;
                case 'symptoms':
                    renderSymptoms();
                    break;
                case 'questions':
                    if (appState.diagnosisMode === 'tree') {
                        renderTreeNode(appState.currentTreeNodeId);
                    } else {
                        renderCurrentQuestion();
                    }
                    break;
                case 'results':
                    if (appState.diagnosisMode === 'tree') {
                        // Re-render solution logic if needed
                    } else {
                        renderResults();
                    }
                    break;
            }
        }

        // ====================
        // TREE dIAGNOSTICS ENGINE
        // ====================

        function renderTrees() {
            const list = document.getElementbyId('trees-list');
            if (!list) return;
            list.innerHTML = '';

            if (typeof diagnosticTrees === 'undefined') return;

            Object.values(diagnosticTrees).forEach(tree => {
                const btn = document.createElement('div');
                btn.style.cssText = `
                    padding: 15px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    transition: all 0.2s;
                `;
                btn.innerHTML = `
                    <i class="fas fa-network-wired" style="margin-right: 15px; color: var(--accent-teal);"></i>
                    <div>
                        <div style="font-weight: 600;">${appState.language === 'pl' ? tree.title_pl : tree.title_en}</div>
                    </div>
                `;
                btn.onclick = () => startTreediagnosis(tree.id);
                btn.onmouseover = () => { btn.style.bordercolor = 'var(--accent-blue)'; btn.style.background = 'rgba(255, 255, 255, 0.1)'; };
                btn.onmouseout = () => { btn.style.bordercolor = 'rgba(255, 255, 255, 0.1)'; btn.style.background = 'rgba(255, 255, 255, 0.05)'; };
                
                list.appendChild(btn);
            });
        }

        function startTreediagnosis(treeId) {
            const tree = diagnosticTrees[treeId];
            if (!tree) return;

            appState.diagnosisMode = 'tree';
            appState.currentTree = tree;
            appState.currentTreeNodeId = tree.start_node;
            appState.treeHistory = []; // Stack for back button

            switchScreen('questions');
            renderTreeNode(tree.start_node);
        }

        function renderTreeNode(nodeId) {
            const node = appState.currentTree.nodes[nodeId];
            if (!node) {
                console.error("Node not found:", nodeId);
                alert(appState.language === 'pl' ? `B��d: Nie znaleziono w�z�a ${nodeId}` : `Error: Node ${nodeId} not found`);
                startNewdiagnosis();
                return;
            }

            // Update UI
            document.getElementbyId('current-system-name').textcontent = 
                appState.language === 'pl' ? (appState.currentTree.metadata?.title?.pl || appState.currentTree.title_pl) : (appState.currentTree.metadata?.title?.en || appState.currentTree.title_en);
            
            document.getElementbyId('current-question-counter').textcontent = 
                appState.language === 'pl' ? 'Krok diagnostyczny' : 'diagnostic Step';

            const container = document.getElementbyId('question-container');
            
            // Question Text (Standard or Production format)
            const qText = appState.language === 'pl' ? (node.question?.pl || node.question_pl) : (node.question?.en || node.question_en);
            
            // Answers
            let answersHtml = '';
            (node.answers || []).forEach((ans, idx) => {
                const ansText = appState.language === 'pl' ? (ans.text?.pl || ans.text_pl) : (ans.text?.en || ans.text_en);
                const btnClass = ans.type === 'cant_check' ? 'style="background: rgba(255, 193, 7, 0.15); border-color: var(--warning); color: var(--warning);"' : '';
                
                answersHtml += `
                    <button class="answer-btn" ${btnClass} onclick="handleTreeAnswer('${nodeId}', ${idx})">
                        ${ansText}
                    </button>
                `;
            });

            // Legacy Cant Check Button support
            if (node.cant_check && !node.answers.some(a => a.type === 'cant_check')) {
                const cantLabel = appState.language === 'pl' ? 
                    (node.cant_check.label_pl || "Nie wiem / Nie mog� Sprawdzi�") : 
                    (node.cant_check.label_en || "don't know / Can't check");
                
                answersHtml += `
                    <button class="answer-btn" onclick="handleCantCheck('${nodeId}')" style="background: rgba(255, 193, 7, 0.15); border-color: var(--warning); color: var(--warning);">
                        <i class="fas fa-question-circle"></i> ${cantLabel}
                    </button>
                `;
            }

            container.innerHTML = `
                <div class="question-card fade-in">
                    ${node.image ? `<img src="${node.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--accent-blue);">` : ''}
                    <div class="question-text">${qText}</div>
                    ${(node.note?.en || node.note?.pl) ? `<div style="font-size: 0.85em; opacity: 0.7; margin-bottom: 15px; font-style: italic;">
                        <i class="fas fa-info-circle"></i> ${appState.language === 'pl' ? (node.note.pl || node.note.en) : (node.note.en || node.note.pl)}
                    </div>` : ''}
                    <div class="answers-grid">
                        ${answersHtml}
                    </div>
                </div>
            `;

            // Hide "Next Question" button as trees are immediate
            document.getElementbyId('next-question-btn').style.display = 'none';

            // Update Back Button
            const backBtn = document.querySelector('#screen-questions .btn-secondary');
            if (backBtn) {
                backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${appState.language === 'pl' ? 'wstecz' : 'Back'}`;
                backBtn.onclick = () => {
                    if (appState.treeHistory.length > 0) {
                        const prevNode = appState.treeHistory.pop();
                        // Pop again because current node is not in history yet (pushed on answer), 
                        // actually history tracks PATH. 
                        // Let's change logic: history push happens on ANSwER.
                        // So popping gives us the node we came FROM.
                        // But wait, if I am at Node B (came from A), history is [A].
                        // Pop -> A. Render A.
                        // correct.
                        appState.currentTreeNodeId = prevNode;
                        renderTreeNode(prevNode);
                    } else {
                        // Exit tree
                        startNewdiagnosis();
                    }
                };
            }
        }

        function handleTreeAnswer(nodeId, answerIdx) {
            const node = appState.currentTree.nodes[nodeId];
            const answer = node.answers[answerIdx];

            if (!answer) {
                console.error("Answer missing for index:", answerIdx);
                return;
            }

            // Push to history
            appState.treeHistory.push(nodeId);

            // Handle "next" object (Production format) or direct Id (Legacy format)
            if (answer.next) {
                const { type, id } = answer.next;
                if (type === 'node') {
                    appState.currentTreeNodeId = id;
                    renderTreeNode(id);
                } else if (type === 'solution') {
                    showTreeSolution(id);
                } else if (type === 'tree') {
                    startTreediagnosis(id);
                }
            } else if (answer.solution_id) {
                showTreeSolution(answer.solution_id);
            } else if (answer.next_node) {
                appState.currentTreeNodeId = answer.next_node;
                renderTreeNode(answer.next_node);
            } else {
                console.error("dead end in tree at node:", nodeId);
                alert(appState.language === 'pl' ? "B��d: �lepy zau�ek w drzewie." : "Error: dead end in tree.");
            }
        }

        function showTreeSolution(solutionId) {
            const sol = (appState.currentTree.solutions && appState.currentTree.solutions[solutionId]) || treeSolutions[solutionId];
            if (!sol) {
                console.error("Solution missing:", solutionId);
                alert(appState.language === 'pl' ? "B��d: Brak rozwi�zania " + solutionId : "Error: Solution missing " + solutionId);
                return;
            }

            const container = document.getElementbyId('question-container');
            
            const title = appState.language === 'pl' ? (sol.title?.pl || sol.title_pl) : (sol.title?.en || sol.title_en);
            const desc = appState.language === 'pl' ? (sol.description?.pl || sol.description_pl) : (sol.description?.en || sol.description_en);
            
            let badgeHtml = '';
            if (sol.is_temporary) {
                const badgeText = appState.language === 'pl' ? 'ROZwI�ZANIE TYMCZASOwE' : 'TEMPORARY FIX';
                badgeHtml = `<div style="background: var(--warning); color: #000; padding: 4px 12px; border-radius: 4px; display: inline-block; font-weight: bold; font-size: 12px; margin-bottom: 8px;">
                    <i class="fas fa-exclamation-triangle"></i> ${badgeText}
                </div>`;
            }
            
            const steps = Array.isArray(sol.steps) ? sol.steps : [];
            const stepsHtml = steps.map((step, i) => {
                const stepText = typeof step === 'string' ? step : (appState.language === 'pl' ? step.pl : step.en);
                return `
                    <div class="step-item" style="margin-bottom: 12px; display: flex; gap: 15px;">
                        <div class="step-number" style="background: var(--accent-blue); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">${i+1}</div>
                        <div style="align-self: center;">${stepText}</div>
                    </div>
                `;
            }).join('');
            
            let html = `
                <div class="results-container fade-in" style="padding: 20px;">
                    <div class="issue-card" style="border-left: 4px solid var(--success); background: rgba(255, 255, 255, 0.08); padding: 20px; border-radius: 8px;">
                        ${badgeHtml}
                        ${sol.image ? `<img src="${sol.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--success);">` : ''}
                        <h2 class="issue-title" style="color: var(--success); font-size: 24px; margin-bottom: 10px;">${title}</h2>
                        <p style="font-size: 16px; margin-bottom: 20px; opacity: 0.9;">${desc}</p>
                        
                        <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                            <strong style="color: var(--accent-blue); display: block; margin-bottom: 15px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">
                                ${appState.language === 'pl' ? 'PROCEdURA NAPRAwCZA:' : 'REPAIR PROCEdURE:'}
                            </strong>
                            <div class="step-list">
                                ${stepsHtml}
                            </div>
                        </div>

                        ${(sol.expert_note?.en || sol.expert_note?.pl) ? `
                            <div style="margin-top: 20px; padding: 15px; background: rgba(0, 188, 212, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-blue);">
                                <small style="display: block; color: var(--accent-blue); margin-bottom: 5px; font-weight: bold; text-transform: uppercase; font-size: 10px;">Expert Note:</small>
                                <div style="font-size: 14px; font-style: italic; opacity: 0.8;">
                                    ${appState.language === 'pl' ? (sol.expert_note.pl || sol.expert_note.en) : (sol.expert_note.en || sol.expert_note.pl)}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="text-align: center; margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="startTreediagnosis('${appState.currentTree.tree_id || appState.currentTree.id}')">
                            <i class="fas fa-redo"></i> ${appState.language === 'pl' ? 'Zacznij od nowa' : 'Restart diagnosis'}
                        </button>
                        <button class="btn btn-secondary" onclick="startNewdiagnosis()">
                            <i class="fas fa-home"></i> ${appState.language === 'pl' ? 'Ekran G��wny' : 'Home'}
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ====================
        // BUILdER LOGIC
        // ====================

        function openBuilderModal() {
            const modal = document.getElementbyId('builder-modal');
            modal.classList.add('active');
            populateBuilderSelector();
        }

        function closeBuilderModal() {
            document.getElementbyId('builder-modal').classList.remove('active');
        }

        function populateBuilderSelector() {
            const selector = document.getElementbyId('builder-tree-selector');
            const currentValue = selector.value;
            
            selector.innerHTML = '<option value="">-- New Tree / Manual Entry --</option>';
            
            // 1. Add Production Trees (from diagnosticTrees constant)
            Object.keys(diagnosticTrees).forEach(id => {
                const tree = diagnosticTrees[id];
                const option = document.createElement('option');
                option.value = `prod:${id}`;
                option.textcontent = `[PROd] ${tree.title_en || id}`;
                selector.appendChild(option);
            });

            // 2. Add Saved Trees (from localStorage)
            const savedTreesJson = localStorage.getItem('customdiagnosticTrees');
            if (savedTreesJson) {
                try {
                    const savedTrees = JSON.parse(savedTreesJson);
                    Object.keys(savedTrees).forEach(id => {
                        const option = document.createElement('option');
                        option.value = `local:${id}`;
                        option.textcontent = `[SAVEd] ${savedTrees[id].metadata?.title?.en || id}`;
                        selector.appendChild(option);
                    });
                } catch (e) {
                    console.error("Failed to parse saved trees", e);
                }
            }
            
            selector.value = currentValue;
        }

        function loadTreeToEditor() {
            const selector = document.getElementbyId('builder-tree-selector');
            const editor = document.getElementbyId('builder-json');
            const val = selector.value;

            if (!val) {
                editor.value = '';
                validateBuilderJson();
                return;
            }

            const [type, id] = val.split(':');
            let treeToLoad = null;

            if (type === 'prod') {
                treeToLoad = diagnosticTrees[id];
            } else if (type === 'local') {
                const savedTrees = JSON.parse(localStorage.getItem('customdiagnosticTrees') || '{}');
                treeToLoad = savedTrees[id];
            }

            if (treeToLoad) {
                editor.value = JSON.stringify(treeToLoad, null, 4);
                validateBuilderJson();
            }
        }

        function validateBuilderJson() {
            const editor = document.getElementbyId('builder-json');
            const errorcontainer = document.getElementbyId('builder-errors');
            const saveBtn = document.getElementbyId('builder-save-btn');
            const jsonText = editor.value.trim();

            if (!jsonText) {
                errorcontainer.innerHTML = '<div style="color: var(--text-secondary);">Enter JSON to begin...</div>';
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
                return;
            }

            try {
                const tree = JSON.parse(jsonText);
                
                // Use the imported validator if available
                if (typeof validatediagnosticTree === 'function') {
                    const results = validatediagnosticTree(tree);
                    
                    if (results.length === 0) {
                        errorcontainer.innerHTML = '<div style="color: var(--success); font-weight: bold;"><i class="fas fa-check-circle"></i> Tree is valid!</div>';
                        saveBtn.disabled = false;
                        saveBtn.style.opacity = '1';
                    } else {
                        const errors = results.filter(r => r.severity !== 'coNTENT_waRNING');
                        const warnings = results.filter(r => r.severity === 'coNTENT_waRNING');
                        
                        let html = '';
                        
                        if (errors.length > 0) {
                            html += `<div style="color: var(--error); font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-times-circle"></i> ${errors.length} Errors:
                            </div>`;
                            errors.forEach(err => {
                                html += `<div style="background: rgba(207, 102, 121, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--error);">
                                    <strong>${err.type}:</strong> ${err.message}<br>
                                    <small style="opacity: 0.7;">Id: ${err.id}</small>
                                </div>`;
                            });
                        }

                        if (warnings.length > 0) {
                            html += `<div style="color: var(--warning); font-weight: bold; margin: 10px 0;">
                                <i class="fas fa-exclamation-triangle"></i> ${warnings.length} warnings:
                            </div>`;
                            warnings.forEach(warn => {
                                html += `<div style="background: rgba(255, 152, 0, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--warning);">
                                    <strong>${warn.type}:</strong> ${warn.message}
                                </div>`;
                            });
                        }

                        errorcontainer.innerHTML = html;
                        
                        // disable save only on errors, not warnings
                        if (errors.length > 0) {
                            saveBtn.disabled = true;
                            saveBtn.style.opacity = '0.5';
                        } else {
                            saveBtn.disabled = false;
                            saveBtn.style.opacity = '1';
                        }
                    }
                } else {
                    errorcontainer.innerHTML = '<div style="color: var(--warning);">Validator not found. Basic JSON check passed.</div>';
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                }
            } catch (e) {
                errorcontainer.innerHTML = `<div style="color: var(--error); font-weight: bold;">
                    <i class="fas fa-bug"></i> Invalid JSON Syntax:
                </div>
                <div style="background: rgba(207, 102, 121, 0.1); padding: 10px; border-radius: 4px; margin-top: 10px; font-family: monospace;">
                    ${e.message}
                </div>`;
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
        }

        function saveBuilderJson() {
            const editor = document.getElementbyId('builder-json');
            const jsonText = editor.value.trim();
            
            try {
                const tree = JSON.parse(jsonText);
                const treeId = tree.id || tree.tree_id;

                if (!treeId) {
                    alert("Tree must have an 'id' or 'tree_id' field.");
                    return;
                }

                // Save to localStorage
                const savedTrees = JSON.parse(localStorage.getItem('customdiagnosticTrees') || '{}');
                savedTrees[treeId] = tree;
                localStorage.setItem('customdiagnosticTrees', JSON.stringify(savedTrees));

                // Refresh selector
                populateBuilderSelector();
                
                alert(`Tree "${treeId}" saved to browser storage!`);
                
                // Optional: Automatically import/use this tree in the app
                // For now, just close modal
                closeBuilderModal();
            } catch (e) {
                alert("Failed to save: " + e.message);
            }
        }

        function exportBuilderJson() {
            const editor = document.getElementbyId('builder-json');
            const jsonText = editor.value.trim();
            
            if (!jsonText) {
                alert("Editor is empty. Nothing to export.");
                return;
            }

            try {
                const tree = JSON.parse(jsonText);
                const treeId = tree.id || tree.tree_id || "diagnostic_tree";
                const blob = new Blob([JSON.stringify(tree, null, 4)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${treeId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                alert("Invalid JSON. Please fix errors before exporting.");
            }
        }

        function triggerImport() {
            document.getElementbyId('builder-import-input').click();
        }

        function importBuilderJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const editor = document.getElementbyId('builder-json');
                editor.value = content;
                
                // Clear the selector since we're manually editing now
                document.getElementbyId('builder-tree-selector').value = "";
                
                // Trigger validation
                validateBuilderJson();
                
                // Reset input
                event.target.value = "";
            };
            reader.readAsText(file);
        }

        // ====================
        // INICJALIZACJA
        // ====================

        // Zapisz jako Pwa (Progressive web App)
        if ('serviceworker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceworker.register('./sw.js').catch(err => {
                    console.log('Serviceworker registration failed: ', err);
                });
            });
        }

        // dodaj do ekranu g��wnego
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventdefault();
            // Mo�na pokaza� przycisk "Zainstaluj"
        });

        // Start aplikacji
        document.addEventListener('dOMcontentLoaded', () => {
            initApp();
            
            // Auto-validate all trees on load
            if (typeof validatediagnosticTree === 'function') {
                Object.values(diagnosticTrees).forEach(tree => {
                    const errors = validatediagnosticTree(tree);
                    if (errors.length > 0) {
                        console.warn(`Validation failed for tree: ${tree.id || 'unknown'}`, errors);
                    } else {
                        console.log(`Validation passed for tree: ${tree.id || 'unknown'}`);
                    }
                });
            }
        });
    </script>
    <div id="builder-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px; width: 95%; height: 90vh; display: flex; flex-direction: column;">
            <h3 class="modal-title">Interactive Tree Editor</h3>
            
            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
                <div style="flex: 1;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Select Tree to Edit:</label>
                    <select id="builder-tree-selector" onchange="loadTreeToEditor()" style="width: 100%; background: rgba(0,0,0,0.3); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 4px; padding: 8px;">
                        <option value="">-- New Tree / Manual Entry --</option>
                    </select>
                </div>
                <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 20px;">
                    <i class="fas fa-info-circle"></i> 
                    <a href="SCHEMA.md" target="_blank" style="color: var(--accent-teal); text-decoration: underline;">Schema Rules</a>
                </div>
            </div>

            <div style="display: flex; gap: 20px; flex: 1; min-height: 0;">
                <div style="flex: 2; display: flex; flex-direction: column;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">JSON Editor (Real-time Validation):</label>
                    <textarea id="builder-json" oninput="validateBuilderJson()" placeholder='{"tree_id": "...", "metadata": {...}, "nodes": {...}, "solutions": {...}}' style="flex: 1; background: rgba(0,0,0,0.3); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 13px; resize: none;"></textarea>
                </div>
                
                <div style="flex: 1; display: flex; flex-direction: column; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Validation Results:</label>
                    <div id="builder-errors" style="flex: 1; overflow-y: auto; font-size: 13px;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" id="builder-save-btn" onclick="saveBuilderJson()" style="flex: 2; background: var(--accent-teal);">
                    <i class="fas fa-save"></i> Save to Browser
                </button>
                <button class="btn btn-secondary" onclick="exportBuilderJson()" style="flex: 1;">
                    <i class="fas fa-download"></i> Export
                </button>
                <button class="btn btn-secondary" onclick="triggerImport()" style="flex: 1;">
                    <i class="fas fa-upload"></i> Import
                </button>
                <input type="file" id="builder-import-input" onchange="importBuilderJson(event)" style="display: none;" accept=".json">
                <button class="btn btn-secondary" onclick="closeBuilderModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    <!-- Guide Modal -->
    <div id="guide-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="guide-title" class="modal-title">Poradnik</h3>
            <div id="guide-body" style="text-align: left; margin: 20px 0; font-size: 15px; line-height: 1.6;"></div>
            <button class="btn btn-secondary" onclick="closeGuideModal()" style="width: 100%;">
                Rozumiem, wracam do pytania
            </button>
        </div>
    </div>
</body>
</html>







