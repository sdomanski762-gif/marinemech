<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarineMech - Podręczny Mechanik Żeglarski</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Ciemny motyw żeglarski */
            --primary-dark: #0A1128;
            --secondary-dark: #1A3A5F;
            --accent-blue: #00B4D8;
            --accent-teal: #1BE7FF;
            --background: #121212;
            --surface: #1E1E1E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --error: #CF6679;
            --success: #4CAF50;
            --warning: #FF9800;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        /* Główne kontenery */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        /* Nagłówki */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--accent-blue) 0%, transparent 70%);
            opacity: 0.1;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--accent-teal), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .app-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Karty systemów */
        .systems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .system-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
        }

        .system-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            box-shadow: 0 8px 25px rgba(0, 180, 216, 0.2);
        }

        .system-card.active {
            border-color: var(--accent-teal);
            background: linear-gradient(135deg, var(--surface), rgba(27, 231, 255, 0.1));
        }

        .system-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--accent-blue);
        }

        .system-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        /* Lista symptomów */
        .symptoms-list {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .symptom-category-header {
            color: var(--accent-teal);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .symptom-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .symptom-item:last-child {
            border-bottom: none;
        }

        .symptom-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .symptom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--accent-blue);
            border-radius: 6px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .symptom-checkbox.checked {
            background: var(--accent-blue);
        }

        .symptom-checkbox.checked::after {
            content: '✓';
            color: white;
            font-weight: bold;
        }

        .symptom-text {
            flex: 1;
            font-size: 16px;
        }

        /* Modal doprecyzowania */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-blue);
        }

        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--accent-teal);
        }

        .specificity-option {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .specificity-option:hover {
            background: rgba(0, 180, 216, 0.1);
            border-color: var(--accent-blue);
        }

        .specificity-option.selected {
            background: rgba(0, 180, 216, 0.2);
            border-color: var(--accent-teal);
        }

        /* Pytania diagnostyczne */
        .question-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .answers-grid {
            display: grid;
            gap: 12px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 16px;
            color: var(--text-primary);
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .answer-btn:hover {
            background: rgba(0, 180, 216, 0.1);
            border-color: var(--accent-blue);
        }

        .answer-btn.selected {
            background: rgba(0, 180, 216, 0.2);
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        /* Wyniki diagnozy */
        .results-container {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
        }

        .probability-badge {
            display: inline-block;
            background: linear-gradient(90deg, var(--error), var(--warning), var(--success));
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .issue-card {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid var(--accent-blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .issue-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-teal);
        }

        .step-list {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .step-item {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
        }

        .step-number {
            background: var(--accent-blue);
            color: var(--primary-dark);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }

        /* Przyciski */
        .btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 180, 216, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
        }

        .btn-secondary:hover {
            background: rgba(0, 180, 216, 0.1);
        }

        .btn-danger {
            background: var(--error);
        }

        /* Pasek postępu */
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Footer */
        .app-footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animacje */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsywność */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            .systems-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .system-card {
                min-height: 120px;
                padding: 15px;
            }
            
            .system-icon {
                font-size: 28px;
            }
        }

        @media (max-width: 480px) {
            .systems-grid {
                grid-template-columns: 1fr;
            }
            
            .app-title {
                font-size: 24px;
            }
            
            .question-text {
                font-size: 16px;
            }
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--warning);
            color: var(--primary-dark);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: none;
            z-index: 1000;
        }

        .offline .offline-indicator {
            display: block;
        }
    </style>
</head>
<body>
    <div class="offline-indicator">
        <i class="fas fa-wifi-slash"></i> Tryb offline
    </div>

    <!-- Modal wyboru typu silnika -->
    <div id="engine-choice-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <h3 class="modal-title">Wybierz rodzaj silnika</h3>
            <p style="margin-bottom: 30px; color: var(--text-secondary);">To pozwoli dobrać odpowiednie procedury naprawcze.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <button class="btn" onclick="selectEngineContext('inboard')" style="flex-direction: column; padding: 30px;">
                    <i class="fas fa-ship" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <span>Stacjonarny<br><small>(Diesel / Inboard)</small></span>
                </button>
                
                <button class="btn btn-secondary" onclick="selectEngineContext('outboard')" style="flex-direction: column; padding: 30px; border-width: 2px;">
                    <i class="fas fa-anchor" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <span>Zaburtowy<br><small>(Benzyna / Outboard)</small></span>
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Ekran 1: Wybór systemu -->
        <div id="screen-home" class="screen active">
            <div class="app-header">
                <h1 class="app-title">MarineMech</h1>
                <p class="app-subtitle">Podręczny mechanik żeglarski</p>
            </div>

            <div class="systems-grid" id="systems-grid">
                <!-- Systemy będą dodane przez JavaScript -->
            </div>

            <!-- Tree Diagnostics Section REMOVED -->

            <!-- Expert Mode Toggle -->


            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 20px;">
                <!-- Amateur Mode Toggle -->
                <div style="display: flex; align-items: center;">
                    <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 28px; margin-right: 10px;">
                        <input type="checkbox" id="amateur-mode-toggle" onchange="toggleAmateurMode()">
                        <span class="slider round"></span>
                    </label>
                    <span style="color: var(--text-secondary); font-size: 14px;">Tryb Amatorski</span>
                </div>

                <!-- Expert Mode Toggle -->
                <div style="display: flex; align-items: center;">
                    <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 28px; margin-right: 10px;">
                        <input type="checkbox" id="expert-mode-toggle" onchange="toggleExpertMode()">
                        <span class="slider round"></span>
                    </label>
                    <span style="color: var(--text-secondary); font-size: 14px;">Tryb Ekspercki</span>
                </div>
            </div>
            <style>
                /* Expert Mode Switch Styles */
                .switch input { 
                    opacity: 0;
                    width: 0;
                    height: 0;
                }
                
                .slider {
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: #ccc;
                    transition: .4s;
                    border-radius: 34px;
                }
                
                .slider:before {
                    position: absolute;
                    content: "";
                    height: 20px;
                    width: 20px;
                    left: 4px;
                    bottom: 4px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }
                
                input:checked + .slider {
                    background-color: var(--accent-teal);
                }
                
                input:focus + .slider {
                    box-shadow: 0 0 1px var(--accent-teal);
                }
                
                input:checked + .slider:before {
                    transform: translateX(22px);
                }
            </style>

            <button class="btn" onclick="startDiagnosis()" id="start-btn" disabled>
                <i class="fas fa-play"></i> Rozpocznij diagnostykę
            </button>
            <button class="btn btn-secondary" onclick="openBuilderModal()" id="builder-btn" style="margin-top: 12px;">
                <i class="fas fa-tools"></i> Builder
            </button>

            <div class="app-footer">
                <p>Wybierz system do diagnostyki. Aplikacja działa offline.</p>
            </div>
        </div>

        <!-- Ekran 2: Wybór symptomów -->
        <div id="screen-symptoms" class="screen">
            <div class="app-header">
                <h2 id="current-system">System: Silnik</h2>
                <p class="app-subtitle">Zaznacz występujące symptomy</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-step1" style="width: 33%"></div>
            </div>

            <div class="symptoms-list" id="symptoms-list">
                <!-- Symptomy będą dodane przez JavaScript -->
            </div>

            <button class="btn" onclick="nextToQuestions()" id="next-to-questions-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                <i class="fas fa-arrow-right"></i> Dalej (wybrano: <span id="selected-count">0</span>)
            </button>

            <button class="btn btn-secondary" onclick="goBackToSystems()">
                <i class="fas fa-arrow-left"></i> Powrót do systemów
            </button>
        </div>

        <!-- Ekran 3: Pytania diagnostyczne -->
        <div id="screen-questions" class="screen">
            <div class="app-header">
                <h2 id="current-system-name">Diagnostyka</h2>
                <p class="app-subtitle" id="current-question-counter">Pytanie 1/3</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-step2" style="width: 66%"></div>
            </div>

            <div id="question-container">
                <!-- Pytania będą dodane przez JavaScript -->
            </div>

            <button class="btn" onclick="nextQuestion()" id="next-question-btn" style="display: none;">
                <i class="fas fa-arrow-right"></i> Następne pytanie
            </button>

            <button class="btn btn-secondary" onclick="goBackToSymptoms()">
                <i class="fas fa-arrow-left"></i> Powrót do symptomów
            </button>
        </div>

        <!-- Ekran 4: Wyniki diagnozy -->
        <div id="screen-results" class="screen">
            <div class="app-header">
                <h2>Wyniki diagnozy</h2>
                <p class="app-subtitle">Najbardziej prawdopodobne przyczyny</p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-step3" style="width: 100%"></div>
            </div>

            <div id="results-container">
                <!-- Wyniki będą dodane przez JavaScript -->
            </div>

            <button class="btn" onclick="startNewDiagnosis()">
                <i class="fas fa-redo"></i> Nowa diagnoza
            </button>

            <button class="btn btn-secondary" onclick="showEmergencyTips()">
                <i class="fas fa-first-aid"></i> Wskazówki awaryjne
            </button>
        </div>
    </div>

    <script>
// ==========================================
// GLOBAL SETTINGS SYSTEM
// ==========================================
const SettingsManager = (function() {
    const STORAGE_KEY = 'marine_mech_settings_v1';
    
    // 1. Settings Schema
    const SCHEMA = {
        language: {
            type: 'string',
            default: 'auto',
            options: ['auto', 'pl', 'en']
        },
        mode: {
            type: 'string',
            default: 'standard',
            options: ['standard', 'expert', 'offshore']
        },
        verbosity: {
            type: 'string',
            default: 'normal',
            options: ['short', 'normal', 'detailed']
        }
    };

    let currentSettings = {};

    function getDefaults() {
        const defaults = {};
        for (const [key, config] of Object.entries(SCHEMA)) {
            defaults[key] = config.default;
        }
        return defaults;
    }

    function load() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                currentSettings = { ...getDefaults(), ...parsed };
            } else {
                currentSettings = getDefaults();
            }
        } catch (e) {
            console.error('Settings load failed:', e);
            currentSettings = getDefaults();
        }
        
        if (currentSettings.language === 'auto') {
            const browserLang = navigator.language || navigator.userLanguage;
            currentSettings.detectedLanguage = browserLang.startsWith('pl') ? 'pl' : 'en';
        }
        
        console.log('Settings loaded:', currentSettings);
        return currentSettings;
    }

    function save() {
        try {
            const toSave = {};
            for (const key of Object.keys(SCHEMA)) {
                toSave[key] = currentSettings[key];
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            console.log('Settings saved');
        } catch (e) {
            console.error('Settings save failed:', e);
        }
    }

    return {
        init: function() { return load(); },
        get: function(key) {
            if (key === 'language' && currentSettings.language === 'auto') {
                return currentSettings.detectedLanguage || 'en';
            }
            return currentSettings[key];
        },
        getAll: function() { return { ...currentSettings }; },
        set: function(key, value) {
            if (SCHEMA[key]) {
                if (SCHEMA[key].options && !SCHEMA[key].options.includes(value)) {
                    console.warn(`Invalid value '${value}' for setting '${key}'`);
                    return false;
                }
                currentSettings[key] = value;
                save();
                return true;
            }
            return false;
        },
        getSchema: function() { return SCHEMA; }
    };
})();

// Initialize settings immediately
SettingsManager.init();

// ==========================================
// BAZA WIEDZY SPECYFICZNA DLA MAREK (ENGINE SPECIFICS)
// ==========================================

const marineSpecifics = {
    // === YANMAR (GM / YM / JH Series) ===
    yanmar: {
        id: 'yanmar',
        name: 'Yanmar Diesel (GM/YM/JH)',
        common_issues: {
            // Yanmar Specific: Mixing Elbow
            mixing_elbow_clog: {
                id: 'yan_mixing_elbow',
                name_pl: 'Zatkana kolanko wydechowe (Mixing Elbow)',
                base_probability: 0.35, 
                symptoms: ['vis_smoke_black', 'vis_smoke_white', 'eng_stalls_load'],
                verification_questions: [
                    {
                        id: 'q_yan_elbow_age',
                        question_pl: 'Kiedy ostatnio wymieniano kolanko wydechowe (Mixing Elbow)?',
                        question_amateur_pl: 'Czy silnik dymi na czarno i nie ma siły płynąć pod wiatr?',
                        question_expert_pl: 'Jaki jest przebieg na obecnym kolanku wydechowym (Mixing Elbow)?',
                        answers: [
                            { text_pl: 'Ponad 500h / 3 lata temu', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Jest nowe (<100h)', probability_change: -0.9, type: 'reject' }
                        ],
                        answers_amateur: [
                            { text_pl: 'Tak, dymi i słabnie', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Nie, działa normalnie', probability_change: -0.5, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Yanmar zaleca wymianę co 500h. Sprawdź zwężenie przekroju (nagarem).'
            },
            // Yanmar Specific: Lift Pump
            lift_pump_diaphragm: {
                id: 'yan_lift_pump',
                name_pl: 'Pęknięta membrana pompki paliwa',
                base_probability: 0.2,
                symptoms: ['eng_stalls_load', 'vis_leak_oil'], 
                verification_questions: [
                    {
                        id: 'q_yan_oil_level_rise',
                        question_pl: 'Czy poziom oleju w silniku się PODNIÓSŁ?',
                        question_amateur_pl: 'Sprawdź bagnet oleju. Czy oleju jest ZA DUŻO (powyżej MAX)?',
                        question_expert_pl: 'Czy występuje zjawisko przybywania oleju (rozrzedzenie ropą)?',
                        answers: [
                            { text_pl: 'Tak, oleju jest więcej i śmierdzi ropą', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie, poziom w normie', probability_change: -0.6, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Wymień mechaniczną pompkę paliwa (lift pump). Nie naprawiaj membrany.'
            }
        }
    },

    // === VOLVO PENTA (2000 Series / MD / D1-D2) ===
    volvo: {
        id: 'volvo',
        name: 'Volvo Penta (MD/2000/D-Series)',
        common_issues: {
            // Volvo D1/D2 Specific: MDI Box
            mdi_failure: {
                id: 'vp_mdi_box',
                name_pl: 'Awaria modułu MDI (Czarna skrzynka)',
                base_probability: 0.35, // Bardzo częste w serii D
                symptoms: ['eng_no_crank', 'elec_flicker', 'ins_volt_low'],
                verification_questions: [
                    {
                        id: 'q_vp_mdi_button',
                        question_pl: 'Czy przycisk startu w ogóle nie reaguje?',
                        question_amateur_pl: 'Znajdź czarną skrzynkę na silniku. Czy jest tam mały guzik bezpiecznika?',
                        question_expert_pl: 'Czy MDI zgłasza błędy? Czy bezpiecznik bimetaliczny na MDI wybił?',
                        answers: [
                            { text_pl: 'Tak, wcisnąłem go i odpalił!', probability_change: 0.99, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Guzik jest wciśnięty / Brak guzika', probability_change: -0.2, type: 'neutral' }
                        ]
                    }
                ],
                repair_tip: 'Wciśnij bezpiecznik na module MDI (na górze silnika). Jeśli wraca - wymień MDI.'
            },
            // Volvo Specific: Cold Start
            cold_start_procedure: {
                id: 'vp_cold_start',
                name_pl: 'Błędna procedura startu (Zimny start)',
                base_probability: 0.4, 
                symptoms: ['eng_cranks_no_start', 'vis_smoke_white'],
                verification_questions: [
                    {
                        id: 'q_vp_glow_time',
                        question_pl: 'Czy grzałeś świece przez 10-15 sekund?',
                        question_amateur_pl: 'Czy trzymałeś kluczyk/guzik w pozycji "Glow" (Grzanie) przez 15 sekund?',
                        question_expert_pl: 'Weryfikacja czasu grzania świec żarowych.',
                        answers: [
                            { text_pl: 'Nie, kręciłem od razu', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Tak, grzałem długo', probability_change: -0.4, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Volvo D1/D2 wymagają długiego grzania świec, nawet w ciepłe dni.'
            }
        }
    },

    // === OUTBOARD ENGINES (GENERIC & SPECIFIC) ===
    yamaha: {
        id: 'yamaha',
        name: 'Yamaha Outboard (F Series)',
        common_issues: {
            // Yamaha Specific: Transport Leak
            yam_transport_leak: {
                id: 'yam_transport_leak',
                name_pl: 'Wyciek oleju po transporcie',
                base_probability: 0.6,
                symptoms: ['vis_leak_oil', 'eng_cranks_no_start', 'vis_smoke_white'],
                verification_questions: [
                    {
                        id: 'q_yam_side',
                        question_pl: 'Na którym boku leżał silnik podczas transportu?',
                        question_amateur_pl: 'Czy silnik leżał na boku z rączką (rumplem)?',
                        answers: [
                            { text_pl: 'Na stronie rumpla (Dobrze)', probability_change: -0.5, type: 'reject' },
                            { text_pl: 'Na drugim boku / Na śrubie', probability_change: 0.9, knockout: 'others', type: 'confirm' }
                        ]
                    }
                ],
                repair_tip: 'Yamaha 4-suw musi leżeć na stronie rumpla. Olej zalał cylinder/gaźnik. Wykręć świecę, wydmuchaj cylinder.'
            },
            // Yamaha: Old Fuel
            yam_carb_clog: {
                id: 'yam_carb_clog',
                name_pl: 'Zatkanie dyszy gaźnika (Stare paliwo)',
                base_probability: 0.4,
                symptoms: ['eng_stalls_idle', 'eng_cranks_no_start'],
                verification_questions: [
                    {
                        id: 'q_yam_storage',
                        question_pl: 'Czy paliwo zostało wypalone przed zimą/postojem?',
                        answers: [
                            { text_pl: 'Nie, zostało w gaźniku', probability_change: 0.8, type: 'confirm' },
                            { text_pl: 'Tak, wypalone do zera', probability_change: -0.6, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Spuść paliwo z komory pływakowej (śrubka na dole gaźnika). Nalej świeżego.'
            }
        }
    },

    mercury: {
        id: 'mercury',
        name: 'Mercury Outboard (4/5/6hp)',
        common_issues: {
            // Mercury: Tank Selection
            merc_tank_select: {
                id: 'merc_tank_select',
                name_pl: 'Zły wybór zbiornika (Int/Ext)',
                base_probability: 0.5,
                symptoms: ['eng_stalls_load', 'eng_stalls_idle'],
                verification_questions: [
                    {
                        id: 'q_merc_valve',
                        question_pl: 'Jak ustawiony jest przełącznik paliwa (na górze obudowy)?',
                        question_amateur_pl: 'Czy pokrętło na górze silnika wskazuje na właściwy zbiornik?',
                        answers: [
                            { text_pl: 'Na wewnętrzny (a używam zewnętrznego)', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Jest OK', probability_change: -0.3, type: 'neutral' }
                        ]
                    }
                ],
                repair_tip: 'Mercury 4/5/6hp ma zawór 2-drożny. Ustaw zgodnie ze źródłem paliwa.'
            },
             // Mercury: Fuel Pump
            merc_fuel_pump: {
                id: 'merc_fuel_pump',
                name_pl: 'Awaria membrany pompy paliwa',
                base_probability: 0.3,
                symptoms: ['eng_stalls_load', 'eng_stalls_idle'],
                verification_questions: [
                    {
                        id: 'q_merc_bulb',
                        question_pl: 'Czy pompowanie gruszką utrzymuje silnik przy życiu?',
                        answers: [
                            { text_pl: 'Tak, jak pompuję to działa', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie pomaga', probability_change: -0.3, type: 'neutral' }
                        ]
                    }
                ],
                repair_tip: 'Wymień zestaw naprawczy pompy paliwa (membrany).'
            }
        }
    },

    honda: {
        id: 'honda',
        name: 'Honda Outboard (BF 2.3 Air Cooled)',
        common_issues: {
            // Honda Specific: Air Cooled (No Water Stream!)
            honda_air_cooled_confusion: {
                id: 'honda_no_water',
                name_pl: 'Brak wody chłodzącej (To normalne!)',
                base_probability: 0.9, // Bardzo częsta pomyłka amatorów
                symptoms: ['ins_temp_high', 'vis_smoke_white'], // Użytkownik myśli że dymi/grzeje się bo nie ma wody
                verification_questions: [
                    {
                        id: 'q_honda_model',
                        question_pl: 'Czy to model Honda 2.3 (z czarną kratką na górze)?',
                        answers: [
                            { text_pl: 'Tak, BF 2.3', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie, większy (chłodzony wodą)', probability_change: -1.0, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Honda BF 2.3 jest chłodzona POWIETRZEM. Nie ma "sikawki" wody. To nie awaria.'
            },
            // Honda: Centrifugal Clutch
            honda_prop_idle: {
                id: 'honda_prop_idle',
                name_pl: 'Śruba nie kręci się na wolnych (Sprzęgło)',
                base_probability: 0.8,
                symptoms: ['eng_stalls_load'], // Użytkownik myśli że coś nie tak z napędem
                verification_questions: [
                    {
                        id: 'q_honda_gas',
                        question_pl: 'Czy śruba zaczyna się kręcić dopiero po dodaniu gazu?',
                        answers: [
                            { text_pl: 'Tak, na wolnych stoi', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                            { text_pl: 'Nie kręci się wcale', probability_change: -0.5, type: 'reject' }
                        ]
                    }
                ],
                repair_tip: 'Ten silnik ma sprzęgło odśrodkowe. Śruba stoi na wolnych obrotach - to funkcja bezpieczeństwa.'
            }
        }
    }
};

// ==========================================
// DRZEWA DECYZYJNE (DIAGNOSTIC TREES)
// ==========================================
const diagnosticTrees = {
    // === ELECTRICAL CORE LOGIC ===
    "electrical_core": {
        id: "electrical_core",
        title_pl: "System Elektryczny (Electrical System)",
        title_en: "Marine Electrical System Diagnostic Tree",
        start_node: "electrical_system_select",
        nodes: {
            // NEW START NODE: SYSTEM SELECTION
            "electrical_system_select": {
                question_pl: "Wybierz system, z którym masz problem:",
                question_en: "Select the system you have trouble with:",
                answers: [
                    { text_pl: "⚠️ DYM / OGIEŃ / ISKRY", text_en: "⚠️ SMOKE / FIRE / SPARKS", solution_id: "fire_hazard" },
                    { text_pl: "Winda Kotwiczna (Windlass)", text_en: "Anchor Windlass", next_node: "windlass_check" },
                    { text_pl: "Kabestany Elektryczne", text_en: "Electric Winches", next_node: "winch_check" },
                    { text_pl: "Światła Nawigacyjne", text_en: "Navigation Lights", next_node: "nav_lights_check" },
                    { text_pl: "Panel Główny / Bezpieczniki", text_en: "Main Panel / Fuses", next_node: "one_system_dead_check" },
                    { text_pl: "Akumulatory / Ładowanie", text_en: "Batteries / Charging", next_node: "charging_check" },
                    { text_pl: "Pompa Zęzowa (Bilge)", text_en: "Bilge Pump", next_node: "bilge_pump_check" },
                    { text_pl: "Inne / Ogólne Problemy", text_en: "Other / General Issues", next_node: "safety_check" }
                ]
            },

            // ETAP 0 - BEZPIECZEŃSTWO
            "safety_check": {
                question_pl: "Czy czujesz zapach spalenizny, widzisz dym, iskry lub gorące przewody?",
                question_en: "Smell smoke/burning, see sparks, or feel heat on wires?",
                answers: [
                    { text_pl: "TAK - Dym/Iskry/Gorąco", text_en: "YES - Smoke/Sparks/Heat", solution_id: "fire_hazard" },
                    { text_pl: "NIE - Bezpiecznie", text_en: "NO - Safe", next_node: "main_symptom" }
                ]
            },
            // ETAP 1 - GŁÓWNY SYMPTOM
            "main_symptom": {
                question_pl: "Co najlepiej opisuje problem?",
                question_en: "What is affected?",
                answers: [
                    { text_pl: "Wszystko nie działa (Ciemność)", text_en: "Everything is dead", next_node: "everything_dead_check" },
                    { text_pl: "Jeden system nie działa", text_en: "One system is dead", next_node: "one_system_dead_check" },
                    { text_pl: "Przerywa / mruga / wariuje", text_en: "Intermittent / flickering", next_node: "intermittent_check" },
                    { text_pl: "Akumulatory nie ładują się", text_en: "Batteries won't charge", next_node: "charging_check" },
                    { text_pl: "Szybkie rozładowanie (Drain)", text_en: "Battery drains fast", next_node: "battery_drain_check" },
                    { text_pl: "Wariujące wskaźniki", text_en: "Instruments act crazy", solution_id: "instrument_ground_issue" },
                    { text_pl: "Pompa zęzowa nie działa", text_en: "Bilge pump failure", next_node: "bilge_pump_check" },
                    { text_pl: "Światła nawigacyjne nie działają", text_en: "Nav lights failure", next_node: "nav_lights_check" },
                    { text_pl: "Uderzenie pioruna / Zalanie wodą", text_en: "Lightning / Saltwater", next_node: "catastrophe_check" },
                    { text_pl: "Elektronika / Plotter nie działa", text_en: "Instruments Dead", next_node: "electronics_dead_check" }
                ]
            },
            
            // A. EVERYTHING DEAD
            "everything_dead_check": {
                question_pl: "Sprawdź pozycję przełącznika akumulatorów (Battery Selector).",
                question_en: "Check battery selector position.",
                answers: [
                    { text_pl: "Wyłączony (OFF)", text_en: "OFF", solution_id: "operator_error_battery" },
                    { text_pl: "Włączony (ON) - ale nic nie działa", text_en: "ON - but dead", next_node: "physical_damage_check" }
                ]
            },
            "physical_damage_check": {
                question_pl: "Sprawdź uszkodzenia fizyczne przy przełączniku/akumulatorze.",
                question_en: "Check for physical damage at switch/battery.",
                answers: [
                    { text_pl: "Urwany kabel / Spalony bezpiecznik", text_en: "Broken wire / Burnt fuse", solution_id: "main_fuse_switch" },
                    { text_pl: "Wygląda OK", text_en: "Looks OK", next_node: "battery_connections_check" }
                ]
            },
            "battery_connections_check": {
                question_pl: "Poruszaj klemami akumulatora. Są luźne lub skorodowane?",
                question_en: "Wiggle battery terminals. Loose/corroded?",
                answers: [
                    { text_pl: "TAK - Luźne/Brudne", text_en: "YES - Loose/Dirty", solution_id: "loose_connection" },
                    { text_pl: "NIE - Sztywne i czyste", text_en: "NO - Tight/Clean", next_node: "emergency_bypass_check" }
                ]
            },
            "emergency_bypass_check": {
                question_pl: "Czy masz kable rozruchowe (Jumper Cables)?",
                question_en: "Do you have jumper cables?",
                answers: [
                    { text_pl: "TAK - Spróbuj obejścia (Bypass)", text_en: "YES - Try bypass", solution_id: "emergency_bypass_wire" },
                    { text_pl: "NIE - Tylko miernik/nic", text_en: "NO", next_node: "voltage_at_battery" }
                ]
            },
            "voltage_at_battery": {
                question_pl: "Czy jest napięcie bezpośrednio na klemach akumulatora?",
                question_en: "Is there voltage at battery terminals?",
                cant_check: {
                    label_pl: "Brak miernika / Nie wiem",
                    label_en: "No multimeter / Don't know",
                    guide_pl: "<h5>Test bez miernika:</h5><ul><li>Włącz oświetlenie kabiny.</li><li>Spróbuj włączyć inny duży odbiornik (np. pompę wody).</li><li>Jeśli światło <strong>przygaśnie mocno</strong> = Słaba bateria lub luźne klemy.</li><li>Jeśli światło <strong>nie przygaśnie</strong>, a sprzęt nie działa = Awaria sprzętu (lub bezpiecznika).</li></ul>",
                    guide_en: "<h5>Test without multimeter:</h5><ul><li>Turn on cabin lights.</li><li>Try running another heavy load (water pump).</li><li>If lights <strong>dim heavily</strong> = Weak battery or loose terminals.</li><li>If lights <strong>stay bright</strong> = Equipment failure.</li></ul>"
                },
                answers: [
                    { text_pl: "NIE (<10V) - Trup", text_en: "NO (<10V)", solution_id: "battery_dead" },
                    { text_pl: "Słabe (10-12V)", text_en: "Weak (10-12V)", solution_id: "battery_low_critical" },
                    { text_pl: "TAK (>12V) - Jest napięcie", text_en: "YES (>12V)", next_node: "voltage_at_main_bus" }
                ]
            },
            "voltage_at_main_bus": {
                question_pl: "Czy jest napięcie na głównej szynie / tablicy (Main Bus)?",
                question_en: "Is there voltage at main bus?",
                answers: [
                    { text_pl: "NIE - Znika po drodze", text_en: "NO - Lost on the way", solution_id: "main_fuse_switch" },
                    { text_pl: "TAK - Jest na szynie", text_en: "YES", next_node: "negative_bus_check" }
                ]
            },
            "negative_bus_check": {
                question_pl: "Czy szyna minusowa (Negative Bus) i jej połączenie są całe?",
                question_en: "Is negative bus intact?",
                answers: [
                    { text_pl: "NIE - Luźna / skorodowana", text_en: "NO", solution_id: "main_ground_failure" },
                    { text_pl: "TAK - Wygląda OK", text_en: "YES", solution_id: "unknown_major_failure" }
                ]
            },

            // B. ONE SYSTEM DEAD / PARTIAL
            "one_system_dead_check": {
                question_pl: "Czy problem dotyczy jednej strony jachtu czy konkretnego urządzenia?",
                question_en: "One side of boat or specific device?",
                answers: [
                    { text_pl: "Cała strona / sekcja", text_en: "Whole side / section", solution_id: "panel_feeder_fail" },
                    { text_pl: "Konkretne urządzenie", text_en: "Specific device", next_node: "fuse_swap_check" }
                ]
            },
            "fuse_swap_check": {
                question_pl: "Zamień bezpiecznik z działającym obwodem. Czy ruszyło?",
                question_en: "Swap fuse with working circuit. Works now?",
                answers: [
                    { text_pl: "TAK - To był bezpiecznik", text_en: "YES - Was the fuse", solution_id: "fuse_replaced_ok" },
                    { text_pl: "NIE - Dalej martwe", text_en: "NO - Still dead", next_node: "visual_wiring_check" }
                ]
            },
            "visual_wiring_check": {
                question_pl: "Spójrz na kable przy panelu i urządzeniu. Widzisz uszkodzenia?",
                question_en: "Check wires at panel/device. Damage visible?",
                answers: [
                    { text_pl: "TAK - Luźne/Korozja", text_en: "YES", solution_id: "wire_repair_basic" },
                    { text_pl: "NIE - Wygląda OK", text_en: "NO", next_node: "voltage_at_device" }
                ]
            },
            "voltage_at_device": {
                question_pl: "Czy napięcie dochodzi do samego urządzenia?",
                question_en: "Voltage at device?",
                cant_check: {
                    label_pl: "Brak miernika (Pomiń)",
                    label_en: "No multimeter (Skip)",
                    solution_id: "unknown_voltage_device"
                },
                answers: [
                    { text_pl: "NIE - Przerwa w kablu", text_en: "NO - Broken wire", solution_id: "broken_feed" },
                    { text_pl: "TAK - Jest napięcie", text_en: "YES", solution_id: "device_failure" }
                ]
            },

            // C. INTERMITTENT
            "intermittent_check": {
                question_pl: "Kiedy problem występuje?",
                question_en: "When does it fail?",
                answers: [
                    { text_pl: "Wibracje / Fale", text_en: "Vibration / Waves", solution_id: "loose_connection" },
                    { text_pl: "Po deszczu / Wilgoć", text_en: "Rain / Damp", solution_id: "moisture_corrosion" },
                    { text_pl: "Gdy jest gorąco", text_en: "When hot", solution_id: "thermal_expansion_fail" }
                ]
            },

            // D. CHARGING ISSUES
            "charging_check": {
                question_pl: "Jakie jest źródło ładowania?",
                question_en: "Charging source?",
                answers: [
                    { text_pl: "Alternator silnika", text_en: "Alternator", next_node: "alternator_visual_check" },
                    { text_pl: "Zasilanie lądowe (Shore Power)", text_en: "Shore Power", next_node: "shore_ac_present" },
                    { text_pl: "Solar / Wiatr", text_en: "Solar / Wind", next_node: "solar_status_lights" }
                ]
            },
            // D1. Alternator
            "alternator_visual_check": {
                question_pl: "Sprawdź pasek i kable przy alternatorze.",
                question_en: "Check alternator belt and wires.",
                answers: [
                    { text_pl: "Pasek luźny/zerwany", text_en: "Belt loose/broken", solution_id: "mechanical_failure_belt" },
                    { text_pl: "Kable urwane", text_en: "Wires broken", solution_id: "alternator_wire_fix" },
                    { text_pl: "Wygląda OK", text_en: "Looks OK", next_node: "alternator_voltage_rpm" }
                ]
            },
            "alternator_voltage_rpm": {
                question_pl: "Zwiększ obroty do 1500 RPM. Czy światła jaśnieją?",
                question_en: "Rev to 1500 RPM. Do lights get brighter?",
                answers: [
                    { text_pl: "TAK - Jaśnieją (Ładuje)", text_en: "YES - Brighter (Charging)", solution_id: "charging_ok" },
                    { text_pl: "NIE - Bez zmian", text_en: "NO - No change", next_node: "alternator_field_test" }
                ]
            },
            "alternator_field_test": {
                question_pl: "AWARYJNIE: Wzbudź alternator kablem (złącz + i styk 'F' na sekundę).",
                question_en: "EMERGENCY: Excite field (touch + to 'F' terminal momentarily).",
                answers: [
                    { text_pl: "Ruszył! (Słychać obciążenie)", text_en: "Started! (Load heard)", solution_id: "regulator_failure_bypass" },
                    { text_pl: "Dalej nic", text_en: "Still nothing", solution_id: "alternator_internal_fail" }
                ]
            },

            // E. BATTERY DRAIN
            "battery_drain_check": {
                question_pl: "Jak szybko spadają baterie?",
                question_en: "How fast do they drain?",
                answers: [
                    { text_pl: "Natychmiast po włączeniu świateł", text_en: "Instantly with load", solution_id: "battery_end_of_life" },
                    { text_pl: "Po nocy (gdy wszystko wyłączone)", text_en: "Overnight (everything OFF)", next_node: "parasitic_draw_test" }
                ]
            },
            "parasitic_draw_test": {
                question_pl: "Wyłącz WSZYSTKO. Czy słyszysz przekaźniki lub czujesz ciepłe kable?",
                question_en: "Turn ALL OFF. Hear relays or feel warm wires?",
                answers: [
                    { text_pl: "TAK - Coś 'cyka'/grzeje", text_en: "YES - Clicking/Heat", solution_id: "parasitic_draw_found" },
                    { text_pl: "NIE - Cisza i chłód", text_en: "NO - Silence/Cold", solution_id: "battery_self_discharge" }
                ]
            },

            // F. SUB-SYSTEM SPECIFICS (Windlass, Bilge, Lights)
            "bilge_pump_check": {
                question_pl: "Użyj włącznika manualnego na panelu. Czy pompa buczy/wibruje?",
                question_en: "Use manual switch. Does pump hum/vibrate?",
                answers: [
                    { text_pl: "TAK - Buczy ale nie pompuje", text_en: "YES - Hums no pump", solution_id: "bilge_impeller_clog" },
                    { text_pl: "NIE - Cisza", text_en: "NO - Silence", next_node: "bilge_direct_power" }
                ]
            },
            "bilge_direct_power": {
                question_pl: "Podłącz pompę bezpośrednio do akumulatora (omiń włącznik/pływak).",
                question_en: "Connect pump directly to battery (bypass switch/float).",
                answers: [
                    { text_pl: "Ruszyła!", text_en: "Runs!", solution_id: "bilge_switch_fail" },
                    { text_pl: "Dalej martwa", text_en: "Still dead", solution_id: "bilge_motor_burnout" }
                ]
            },

            "nav_lights_check": {
                question_pl: "Które światła nie działają?",
                question_en: "Which lights are out?",
                answers: [
                    { text_pl: "Wszystkie (Dziób + Rufa)", text_en: "All (Bow + Stern)", solution_id: "nav_light_fuse_switch" },
                    { text_pl: "Tylko jedno", text_en: "Only one", next_node: "nav_bulb_swap" }
                ]
            },
            "nav_bulb_swap": {
                question_pl: "Zamień żarówkę na dobrą (np. z kabiny). Działa?",
                question_en: "Swap with good bulb. Works?",
                answers: [
                    { text_pl: "TAK - Spalona żarówka", text_en: "YES - Burnt bulb", solution_id: "bulb_replacement" },
                    { text_pl: "NIE - Gniazdo/Kabel", text_en: "NO - Socket/Wire", solution_id: "corroded_socket_nav" }
                ]
            },

            // NEW: WINDLASS & WINCH
            "windlass_check": {
                question_pl: "Jaki jest objaw windy kotwicznej?",
                question_en: "What is the windlass symptom?",
                answers: [
                    { text_pl: "Cisza - Brak reakcji", text_en: "Silence - No reaction", next_node: "windlass_silent_check" },
                    { text_pl: "Silnik kręci, ale nie ciągnie", text_en: "Motor runs but won't pull", next_node: "windlass_clutch_check" },
                    { text_pl: "Działa bardzo wolno", text_en: "Runs very slow", solution_id: "windlass_low_voltage" }
                ]
            },
            "windlass_silent_check": {
                question_pl: "Czy silnik główny jachtu jest włączony?",
                question_en: "Is the main yacht engine running?",
                answers: [
                    { text_pl: "NIE - Zgaszony", text_en: "NO - Engine OFF", solution_id: "windlass_needs_engine" },
                    { text_pl: "TAK - Pracuje", text_en: "YES - Running", next_node: "windlass_breaker_check" }
                ]
            },
            "windlass_breaker_check": {
                question_pl: "Sprawdź bezpiecznik windy (często osobny, duży 'hebel'). Wybił?",
                question_en: "Check windlass breaker (big lever). Tripped?",
                answers: [
                    { text_pl: "TAK - Wyskoczył", text_en: "YES - Tripped", solution_id: "windlass_breaker_reset" },
                    { text_pl: "NIE - Jest włączony", text_en: "NO - ON", solution_id: "windlass_remote_battery" }
                ]
            },
            "windlass_clutch_check": {
                question_pl: "Spróbuj dokręcić sprzęgło (gwiazda na górze windy). Pomogło?",
                question_en: "Tighten clutch (star socket on top). Helps?",
                answers: [
                    { text_pl: "TAK - Teraz ciągnie", text_en: "YES - Pulls now", solution_id: "windlass_clutch_tightened" },
                    { text_pl: "NIE - Dalej się ślizga", text_en: "NO - Still slips", solution_id: "windlass_stripped_gypsy" }
                ]
            },

            "winch_check": {
                question_pl: "Co się dzieje z kabestanem?",
                question_en: "What is happening with the winch?",
                answers: [
                    { text_pl: "Cisza - Brak reakcji", text_en: "Silence - No reaction", next_node: "winch_no_sound" },
                    { text_pl: "Silnik buczy/kręci, bęben stoi", text_en: "Motor runs, drum stops", next_node: "winch_motor_runs_no_turn" },
                    { text_pl: "Działa tylko w jedną stronę", text_en: "One direction only", next_node: "winch_one_direction" },
                    { text_pl: "Słaby / Wolny", text_en: "Weak / Slow", next_node: "winch_low_power" },
                    { text_pl: "Szybkie cykanie (Rapid clicking)", text_en: "Rapid clicking", next_node: "winch_rapid_clicking" },
                    { text_pl: "Pilot/Przycisk nie działa", text_en: "Remote/Switch fail", next_node: "winch_remote_fail" }
                ]
            },
            "winch_no_sound": {
                question_pl: "Czy inne urządzenia 12V działają (światła, radio)?",
                question_en: "Do other 12V devices work?",
                answers: [
                    { text_pl: "NIE - Wszystko martwe", text_en: "NO - Everything dead", next_node: "everything_dead_check" },
                    { text_pl: "TAK - Inne działają", text_en: "YES - Others work", next_node: "winch_jumper_test" }
                ]
            },
            "winch_jumper_test": {
                question_pl: "Ostrożnie dotknij kablem plusowym bezpośrednio do zacisku silnika (pomiń solenoid). Czy iskrzy/kręci?",
                question_en: "Touch positive wire directly to motor terminal. Sparks/runs?",
                cant_check: {
                    label_pl: "Nie mam narzędzi / Boję się",
                    label_en: "No tools / Unsafe",
                    guide_pl: "<h5>Test na słuch:</h5><ul><li>Poproś kogoś o naciskanie przycisku.</li><li>Przyłóż ucho blisko skrzynki z kablami (solenoid).</li><li>Czy słyszysz wyraźne 'KLIK'?</li><li>Brak kliknięcia = Awaria sterowania.</li><li>Kliknięcie = Awaria silnika.</li></ul>"
                },
                answers: [
                    { text_pl: "Iskrzy / Kręci (Silnik OK)", text_en: "Sparks/Runs", solution_id: "winch_solenoid_fail" },
                    { text_pl: "Brak reakcji (Cisza)", text_en: "No reaction", solution_id: "winch_internal_open" }
                ]
            },
            "winch_motor_runs_no_turn": {
                question_pl: "Jaki dźwięk słyszysz?",
                question_en: "What sound do you hear?",
                answers: [
                    { text_pl: "Głośne buczenie (zablokowany)", text_en: "Loud buzzing", solution_id: "winch_mechanical_jam" },
                    { text_pl: "Normalna praca silnika", text_en: "Normal running sound", next_node: "winch_clutch_check" },
                    { text_pl: "Zgrzytanie (Grinding)", text_en: "Grinding noise", solution_id: "winch_stripped_gears" }
                ]
            },
            "winch_clutch_check": {
                question_pl: "Sprawdź sprzęgło (gniazdo korby). Czy jest wpięte?",
                question_en: "Check clutch/handle socket. Engaged?",
                answers: [
                    { text_pl: "Luźne - Dokręciłem i działa", text_en: "Was loose - Fixed", solution_id: "winch_clutch_fixed" },
                    { text_pl: "Wpięte, ale bęben stoi", text_en: "Engaged but stops", solution_id: "winch_gear_disconnect" }
                ]
            },
            "winch_one_direction": {
                question_pl: "Zamień kable sterowania (lub kierunek na pilocie). Czy problem przeniósł się na drugą stronę?",
                question_en: "Swap control wires. Does problem move?",
                answers: [
                    { text_pl: "Tak - wina pilota/kabla", text_en: "YES - Remote fault", solution_id: "winch_pendant_fail" },
                    { text_pl: "Nie - wina solenoidu", text_en: "NO - Solenoid fault", solution_id: "winch_solenoid_fail" }
                ]
            },
            "winch_low_power": {
                question_pl: "Czy światła przygasają mocno podczas pracy?",
                question_en: "Do lights dim heavily?",
                answers: [
                    { text_pl: "Tak - mocno przygasają", text_en: "YES - Heavy dim", solution_id: "winch_voltage_drop" },
                    { text_pl: "Nie - świecą normalnie", text_en: "NO - Normal light", solution_id: "winch_internal_friction" }
                ]
            },
            "winch_rapid_clicking": {
                question_pl: "Sprawdź napięcie akumulatora.",
                question_en: "Check battery voltage.",
                answers: [
                    { text_pl: "Niskie (<12V)", text_en: "Low (<12V)", solution_id: "winch_low_battery" },
                    { text_pl: "Dobre (>12.5V)", text_en: "Good (>12.5V)", solution_id: "winch_bad_ground" }
                ]
            },
            "winch_remote_fail": {
                question_pl: "Jaki to typ sterowania?",
                question_en: "Control type?",
                answers: [
                    { text_pl: "Pilot na kablu", text_en: "Wired Remote", solution_id: "winch_pendant_fail" },
                    { text_pl: "Bezprzewodowy", text_en: "Wireless", solution_id: "winch_wireless_battery" },
                    { text_pl: "Przycisk w pokładzie", text_en: "Deck Switch", solution_id: "winch_deck_switch_water" }
                ]
            },

            "catastrophe_check": {
                question_pl: "Co się stało?",
                question_en: "What happened?",
                answers: [
                    { text_pl: "Piorun", text_en: "Lightning", solution_id: "lightning_procedure" },
                    { text_pl: "Zalanie wodą morską", text_en: "Saltwater splash", solution_id: "saltwater_procedure" }
                ]
            },

            "electronics_dead_check": {
                question_pl: "Czy urządzenie ma zasilanie (dioda LED)?",
                question_en: "Does unit have power (LED)?",
                answers: [
                    { text_pl: "NIE - Ciemne", text_en: "NO - Dark", next_node: "electronics_fuse_check" },
                    { text_pl: "TAK - Świeci ale nie działa", text_en: "YES - LED on", solution_id: "electronics_hard_reset" }
                ]
            },
            "electronics_fuse_check": {
                question_pl: "Sprawdź bezpiecznik na kablu zasilającym (często ukryty).",
                question_en: "Check inline fuse on power cable.",
                answers: [
                    { text_pl: "Spalony", text_en: "Blown", solution_id: "fuse_replaced_ok" },
                    { text_pl: "Dobry", text_en: "Good", solution_id: "electronics_internal_fail" }
                ]
            }
        }
    },
    // === GASOLINE CORE LOGIC ===
    "gasoline_core": {
        id: "gasoline_core",
        title_pl: "Silnik Benzynowy (Gasoline) - Pełna Diagnostyka",
        title_en: "Marine Gasoline Engine Diagnostic Tree",
        start_node: "safety_check",
        nodes: {
            // ETAP 0
            "safety_check": {
                question_pl: "Czy czujesz zapach benzyny lub widzisz wyciek paliwa?",
                question_en: "Smell of gasoline / visible fuel leak?",
                answers: [
                    { text_pl: "TAK - Wyciek/Zapach", text_en: "YES", solution_id: "gas_leak_danger" },
                    { text_pl: "NIE - Bezpiecznie", text_en: "NO", next_node: "main_symptom" }
                ]
            },
            // ETAP 1
            "main_symptom": {
                question_pl: "Co się dzieje przy próbie startu?",
                question_en: "What happens when you try to start?",
                answers: [
                    { text_pl: "Nic się nie dzieje (Cisza/Opór)", text_en: "Nothing happens", next_node: "nothing_happens_check" },
                    { text_pl: "Kręci, ale nie odpala", text_en: "Cranks but won't start", next_node: "cranks_no_start_spark" },
                    { text_pl: "Odpala i gaśnie", text_en: "Starts then stalls", next_node: "starts_stalls_check" },
                    { text_pl: "Pracuje nierówno / brak mocy", text_en: "Runs rough / no power", next_node: "runs_rough_check" },
                    { text_pl: "Przegrzewa się", text_en: "Overheats", next_node: "overheat_check" },
                    { text_pl: "Gaśnie losowo", text_en: "Random shutdown", next_node: "random_shutdown_check" }
                ]
            },

            // A. NOTHING HAPPENS
            "nothing_happens_check": {
                question_pl: "Jaki to typ rozruchu?",
                question_en: "Start type?",
                answers: [
                    { text_pl: "Ręczny (Szarpanka)", text_en: "Manual Pull", next_node: "manual_start_neutral" },
                    { text_pl: "Elektryczny (Kluczyk)", text_en: "Electric Start", next_node: "electric_start_battery" }
                ]
            },
            // A1 Manual
            "manual_start_neutral": {
                question_pl: "Czy silnik jest na luzie (Neutral)?",
                question_en: "Is engine in Neutral?",
                answers: [
                    { text_pl: "NIE / Nie wiem", text_en: "NO", solution_id: "gas_neutral_safety" },
                    { text_pl: "TAK", text_en: "YES", next_node: "manual_kill_switch" }
                ]
            },
            "manual_kill_switch": {
                question_pl: "Czy zrywka (kill switch) jest wpięta?",
                question_en: "Kill switch / lanyard installed?",
                answers: [
                    { text_pl: "NIE", text_en: "NO", solution_id: "gas_kill_switch_missing" },
                    { text_pl: "TAK", text_en: "YES", next_node: "manual_rope_pull" }
                ]
            },
            "manual_rope_pull": {
                question_pl: "Czy linka wyciąga się swobodnie?",
                question_en: "Rope pulls freely?",
                answers: [
                    { text_pl: "NIE - Zablokowana", text_en: "NO", solution_id: "gas_hydrolock_jam" },
                    { text_pl: "TAK", text_en: "YES", next_node: "cranks_no_start_spark" }
                ]
            },

             // A2 Electric
            "electric_start_battery": {
                question_pl: "Czy akumulator jest naładowany?",
                question_en: "Battery OK?",
                answers: [
                    { text_pl: "NIE / Słaby", text_en: "NO", solution_id: "gas_dead_battery" },
                    { text_pl: "TAK", text_en: "YES", next_node: "electric_click_check" }
                ]
            },
            "electric_click_check": {
                question_pl: "Co słychać przy przekręcaniu kluczyka?",
                question_en: "Click / silence?",
                answers: [
                    { text_pl: "Kliknięcie", text_en: "Click", solution_id: "gas_solenoid_fail" },
                    { text_pl: "Cisza", text_en: "Silence", solution_id: "gas_key_switch_fail" }
                ]
            },

            // B. CRANKS BUT WON'T START
            "cranks_no_start_spark": {
                question_pl: "Wykręć świecę, przyłóż do masy i szarpnij. Jest iskra?",
                question_en: "Remove plug, ground it, crank – spark?",
                answers: [
                    { text_pl: "NIE - Brak iskry", text_en: "NO", solution_id: "gas_ignition_failure" },
                    { text_pl: "TAK - Jest iskra", text_en: "YES", next_node: "cranks_fuel_check" }
                ]
            },
            "cranks_fuel_check": {
                question_pl: "Czy świeca jest mokra od paliwa?",
                question_en: "Spark plug wet?",
                answers: [
                    { text_pl: "NIE - Sucha", text_en: "NO", solution_id: "gas_no_fuel" },
                    { text_pl: "TAK - Mokra", text_en: "YES", solution_id: "gas_flooded" }
                ]
            },

            // C. STARTS THEN STALLS
            "starts_stalls_check": {
                question_pl: "Czy gaśnie natychmiast po odpaleniu?",
                question_en: "Stalls immediately?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_idle_circuit" },
                    { text_pl: "NIE - Chodzi chwilę", text_en: "NO", next_node: "starts_stalls_choke" }
                ]
            },
            "starts_stalls_choke": {
                question_pl: "Czy wymaga ssania (choke) żeby pracować?",
                question_en: "Needs choke to run?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_lean_condition" },
                    { text_pl: "NIE", text_en: "NO", solution_id: "gas_fuel_supply_intermittent" }
                ]
            },

            // D. RUNS ROUGH / NO POWER
            "runs_rough_check": {
                question_pl: "Czy pracuje dobrze na luzie (Neutral)?",
                question_en: "Runs fine in neutral?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_load_issue" },
                    { text_pl: "NIE", text_en: "NO", next_node: "runs_rough_backfire" }
                ]
            },
            "runs_rough_backfire": {
                question_pl: "Czy silnik strzela w gaźnik/wydech (Backfiring)?",
                question_en: "Backfiring?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_lean_timing" },
                    { text_pl: "NIE", text_en: "NO", next_node: "runs_rough_rpm" }
                ]
            },
            "runs_rough_rpm": {
                question_pl: "Czy problem jest tylko na wysokich obrotach?",
                question_en: "Only at high RPM?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_main_jet_flow" },
                    { text_pl: "NIE - Cały czas", text_en: "NO", solution_id: "gas_general_rough" }
                ]
            },

            // E. OVERHEATING
            "overheat_check": {
                question_pl: "Czy woda leci z kontrolki (tell-tale)?",
                question_en: "Water from tell-tale?",
                answers: [
                    { text_pl: "NIE - Sucho", text_en: "NO", solution_id: "gas_cooling_failure" },
                    { text_pl: "TAK - Leci", text_en: "YES", solution_id: "gas_overheat_other" }
                ]
            },

            // F. RANDOM SHUTDOWN
            "random_shutdown_check": {
                question_pl: "Czy gaśnie gdy jest gorący?",
                question_en: "Happens when hot?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", next_node: "random_shutdown_restart" },
                    { text_pl: "NIE - Zimny/Losowo", text_en: "NO", solution_id: "gas_loose_wire_fuel" }
                ]
            },
            "random_shutdown_restart": {
                question_pl: "Czy odpala ponownie po ostygnięciu?",
                question_en: "Restarts after cooling?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "gas_thermal_failure" },
                    { text_pl: "NIE", text_en: "NO", solution_id: "gas_coil_failure_permanent" }
                ]
            }
        }
    },

    // === DIESEL EXPERT LOGIC (UPLOADED) ===
    "diesel_engine_core": {
        id: "diesel_engine_core",
        title_pl: "Silnik Diesel (Ekspert) - Diagnostyka",
        title_en: "Marine Diesel Engine – Expert Diagnostic Logic Tree",
        start_node: "engine_problem",
        nodes: {
            "engine_problem": {
                question_pl: "Jaki jest główny objaw pracy silnika?",
                question_en: "What is the main engine symptom?",
                answers: [
                    { text_pl: "Silnik nie odpala", text_en: "Engine does not start", next_node: "no_start" },
                    { text_pl: "Odpala i gaśnie", text_en: "Starts and stalls", next_node: "starts_stalls" },
                    { text_pl: "Brak mocy lub nierówna praca", text_en: "Low power or rough running", next_node: "low_power" },
                    { text_pl: "Nietypowy dym z wydechu", text_en: "Unusual exhaust smoke", next_node: "smoke_type" }
                ]
            },
            "no_start": {
                question_pl: "Czy rozrusznik kręci silnikiem?",
                question_en: "Does the starter crank the engine?",
                answers: [
                    { text_pl: "Nie", text_en: "No", solution_id: "no_crank_power" },
                    { text_pl: "Tak", text_en: "Yes", next_node: "cranks_no_start" },
                    { text_pl: "Nie wiem / nie mogę sprawdzić", text_en: "I don't know / can't check", next_node: "electrical_assumption" }
                ]
            },
            "electrical_assumption": {
                question_pl: "Czy po przekręceniu kluczyka gasną kontrolki lub słychać kliknięcie?",
                question_en: "Do warning lights dim or do you hear a click when turning the key?",
                answers: [
                    { text_pl: "Tak", text_en: "Yes", solution_id: "no_crank_power" },
                    { text_pl: "Nie", text_en: "No", solution_id: "no_crank_power" },
                    { text_pl: "Nie wiem / nie mogę sprawdzić", text_en: "I don't know / can't check", solution_id: "no_crank_power" }
                ]
            },
            "cranks_no_start": {
                question_pl: "Czy silnik wykazuje próbę zapłonu?",
                question_en: "Does the engine attempt to fire?",
                answers: [
                    { text_pl: "Nie, kręci „na pusto”", text_en: "No, cranks freely", solution_id: "no_fuel_or_air" },
                    { text_pl: "Tak, próbuje odpalić", text_en: "Yes, tries to start", solution_id: "poor_combustion_conditions" },
                    { text_pl: "Nie wiem / nie mogę ocenić", text_en: "I don't know / can't tell", solution_id: "no_fuel_or_air" }
                ]
            },
            "starts_stalls": {
                question_pl: "Po jakim czasie silnik gaśnie?",
                question_en: "How quickly does the engine stall?",
                answers: [
                    { text_pl: "Po kilku sekundach", text_en: "After a few seconds", solution_id: "restricted_fuel_flow" },
                    { text_pl: "Po rozgrzaniu", text_en: "After warming up", solution_id: "fuel_vent_or_overheat" },
                    { text_pl: "Nie wiem / różnie", text_en: "I don't know / varies", solution_id: "restricted_fuel_flow" }
                ]
            },
            "low_power": {
                question_pl: "Czy problem narasta stopniowo?",
                question_en: "Does the problem worsen gradually?",
                answers: [
                    { text_pl: "Tak", text_en: "Yes", solution_id: "air_or_fuel_restriction" },
                    { text_pl: "Nie, nagle", text_en: "No, suddenly", solution_id: "turbo_or_injector_issue" },
                    { text_pl: "Nie wiem / trudno ocenić", text_en: "I don't know / hard to tell", solution_id: "air_or_fuel_restriction" }
                ]
            },
            "smoke_type": {
                question_pl: "Jaki jest kolor dymu?",
                question_en: "What is the color of the smoke?",
                answers: [
                    { text_pl: "Czarny", text_en: "Black", solution_id: "black_smoke" },
                    { text_pl: "Biały", text_en: "White", solution_id: "white_smoke" },
                    { text_pl: "Niebieski", text_en: "Blue", solution_id: "blue_smoke" },
                    { text_pl: "Nie wiem / słaba widoczność", text_en: "I don't know / poor visibility", solution_id: "poor_combustion_conditions" }
                ]
            }
        }
    },
    // === DIESEL CORE LOGIC ===
    "diesel_core": {
        id: "diesel_core",
        title_pl: "Silnik Diesel (Inboard) - Pełna Diagnostyka",
        title_en: "Core Diesel Diagnostic Tree",
        start_node: "safety_check",
        nodes: {
            // ETAP 0 - BEZPIECZEŃSTWO
            "safety_check": {
                question_pl: "Czy silnik zatrzymał się nagle z głośnym metalicznym stukiem (HARD STOP)?",
                question_en: "Did the engine stop suddenly with a loud metallic knock or hard stop?",
                answers: [
                    { text_pl: "TAK - Gwałtowne zatrzymanie", text_en: "YES - Hard stop", solution_id: "hydrolock_crit" },
                    { text_pl: "NIE - Inne objawy", text_en: "NO - Other symptoms", next_node: "main_symptom" }
                ]
            },

            // ETAP 1 - GŁÓWNY SYMPTOM
            "main_symptom": {
                question_pl: "Co najlepiej opisuje obecne zachowanie silnika?",
                question_en: "What best describes the engine now?",
                answers: [
                    { text_pl: "Cisza - Rozrusznik nie kręci", text_en: "No crank at all (silence)", next_node: "no_crank_lights" },
                    { text_pl: "Kręci wolno / słabo", text_en: "Cranks slowly / weakly", next_node: "slow_crank_lights" },
                    { text_pl: "Kręci normalnie, nie odpala", text_en: "Cranks normally but does not start", next_node: "crank_smoke_check" },
                    { text_pl: "Odpala i gaśnie", text_en: "Starts then stops", next_node: "starts_stops_duration" },
                    { text_pl: "Pracuje, ale słabo / bez mocy", text_en: "Runs but poorly", next_node: "runs_poorly_neutral" },
                    { text_pl: "Przegrzewa się", text_en: "Overheats", next_node: "overheat_water" }
                ]
            },

            // A. NO CRANK
            "no_crank_lights": {
                question_pl: "Czy działają światła lub wskaźniki na panelu?",
                question_en: "Are any lights/instruments on?",
                answers: [
                    { text_pl: "NIE - Ciemność", text_en: "NO", solution_id: "main_power_fail" },
                    { text_pl: "TAK - Świecą", text_en: "YES", next_node: "neutral_check" }
                ]
            },
            "neutral_check": {
                question_pl: "Czy manetka jest IDEALNIE w pozycji neutralnej (pionowo)?",
                question_en: "Is the throttle/gear lever EXACTLY in neutral?",
                answers: [
                    { text_pl: "NIE / Nie jestem pewien", text_en: "NO / UNSURE", solution_id: "neutral_safety" },
                    { text_pl: "TAK - Sprawdzone", text_en: "YES", next_node: "starter_click" }
                ]
            },
            "starter_click": {
                question_pl: "Czy słyszysz 'kliknięcie' przy przekręcaniu kluczyka?",
                question_en: "Do you hear a click when turning key?",
                answers: [
                    { text_pl: "TAK - Słychać klik", text_en: "YES", solution_id: "starter_solenoid" },
                    { text_pl: "NIE - Absolutna cisza", text_en: "NO", solution_id: "ignition_switch" }
                ]
            },

            // B. SLOW CRANK
            "slow_crank_lights": {
                question_pl: "Czy światła w kabinie przygasają podczas próby kręcenia?",
                question_en: "Do cabin lights dim heavily during cranking?",
                answers: [
                    { text_pl: "TAK - Przygasają mocno", text_en: "YES", solution_id: "battery_fail" },
                    { text_pl: "NIE - Świecą jasno", text_en: "NO", solution_id: "mech_drag" }
                ]
            },

            // C. CRANK NO START
            "crank_smoke_check": {
                question_pl: "Spójrz na wydech podczas kręcenia. Czy leci dym?",
                question_en: "Is there exhaust smoke while cranking?",
                answers: [
                    { text_pl: "Brak dymu (Czyste powietrze)", text_en: "No smoke", next_node: "fuel_supply_check" },
                    { text_pl: "Biały dym", text_en: "White smoke", next_node: "white_smoke_check" },
                    { text_pl: "Czarny dym", text_en: "Black smoke", solution_id: "air_exhaust_block" }
                ]
            },
            // C1A No Smoke
            "fuel_supply_check": {
                question_pl: "Odkręć lekko nakrętkę wtryskiwacza. Czy podczas kręcenia sika paliwo?",
                question_en: "Is fuel visible at injector lines while cranking?",
                answers: [
                    { text_pl: "NIE - Sucho", text_en: "NO", solution_id: "fuel_supply_fail" },
                    { text_pl: "TAK - Paliwo tryska (z bąblami)", text_en: "YES, briefly/bubbles", solution_id: "air_lock" }
                ]
            },
            // C1B White Smoke
            "white_smoke_check": {
                question_pl: "Czy silnik próbuje 'zaskoczyć' (kaszle)?",
                question_en: "Does engine attempt to fire?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "decompression_timing" },
                    { text_pl: "NIE - Tylko kręci", text_en: "NO", solution_id: "glow_plugs_comp" }
                ]
            },

            // D. STARTS THEN STOPS
            "starts_stops_duration": {
                question_pl: "Czy ręczne pompowanie paliwa (pompką na silniku) pozwala mu pracować dłużej?",
                question_en: "Does manual fuel pumping keep it running longer?",
                answers: [
                    { text_pl: "TAK", text_en: "YES", solution_id: "fuel_starvation" },
                    { text_pl: "NIE", text_en: "NO", solution_id: "safety_shutdown" }
                ]
            },

            // E. RUNS POORLY
            "runs_poorly_neutral": {
                question_pl: "Wrzuć luz (Neutral). Czy silnik wchodzi na obroty normalnie?",
                question_en: "In neutral, does engine rev freely?",
                answers: [
                    { text_pl: "TAK - Na luzie jest OK", text_en: "YES", solution_id: "prop_fouling" },
                    { text_pl: "NIE - Dusi się też na luzie", text_en: "NO", next_node: "load_smoke_check" }
                ]
            },
            "load_smoke_check": {
                question_pl: "Jaki dym widać przy dodawaniu gazu?",
                question_en: "Smoke under load?",
                answers: [
                    { text_pl: "Czarny dym", text_en: "BLACK", solution_id: "overfuel_block" },
                    { text_pl: "Biały dym", text_en: "WHITE", solution_id: "injector_comp" },
                    { text_pl: "Brak dymu", text_en: "NONE", solution_id: "fuel_restrict_engine" }
                ]
            },

            // F. OVERHEATING
            "overheat_water": {
                question_pl: "Czy z rury wydechowej wylatuje woda?",
                question_en: "Is water exiting exhaust?",
                answers: [
                    { text_pl: "NIE - Sucho / Para", text_en: "NO", solution_id: "raw_water_fail" },
                    { text_pl: "TAK - Ale gorąca", text_en: "YES but hot", solution_id: "mixing_elbow_hot" }
                ]
            }
        }
    }
};

// Rozwiązania (Solutions) dla drzew
const treeSolutions = {
    // === GASOLINE SOLUTIONS ===
    "gas_leak_danger": {
        title_pl: "WYCIEK PALIWA - NIEBEZPIECZEŃSTWO",
        title_en: "FUEL LEAK - DANGER",
        description_pl: "Opary benzyny są wybuchowe. NIE URUCHAMIAJ SILNIKA.",
        description_en: "Gasoline vapors are explosive. DO NOT START ENGINE.",
        steps: ["STOP - Wyłącz zasilanie", "Przewietrz komorę silnika / zęzę", "Zlokalizuj i usuń wyciek"]
    },
    "gas_neutral_safety": {
        title_pl: "Blokada Rozruchu (Bieg)",
        title_en: "NEUTRAL SAFETY SWITCH",
        description_pl: "Silnik nie odpali na biegu (zabezpieczenie).",
        description_en: "Engine won't start in gear (safety).",
        steps: ["Wrzuć luz (Neutral)", "Poruszaj manetką", "Sprawdź włącznik neutrala"]
    },
    "gas_kill_switch_missing": {
        title_pl: "Brak Zrywki (Kill Switch)",
        title_en: "KILL SWITCH / LANYARD MISSING",
        description_pl: "Zapłon jest odcięty przez brak zrywki.",
        description_en: "Ignition cut off due to missing lanyard.",
        steps: ["Wepnij zrywkę", "Sprawdź czy guzik zrywki nie zaciął się"]
    },
    "gas_hydrolock_jam": {
        title_pl: "Blokada Mechaniczna / Hydrolock",
        title_en: "MECHANICAL JAM / HYDROLOCK",
        description_pl: "Silnik zablokowany (woda w cylindrze lub awaria mechaniczna).",
        description_en: "Engine locked (water in cylinder or mechanical failure).",
        steps: ["STOP - Nie szarp na siłę", "Wykręć świecę", "Pociągnij powoli by wydmuchać wodę"]
    },
    "gas_unknown_no_start": {
        title_pl: "Nieznany Problem Rozruchu",
        title_en: "UNKNOWN START ISSUE",
        description_pl: "Silnik kręci się swobodnie ale nie odpala. Przejdź do sprawdzania iskry.",
        description_en: "Engine turns freely but won't start. Check spark.",
        steps: ["Przejdź do sekcji: Kręci ale nie odpala", "Sprawdź Iskrę", "Sprawdź Paliwo"]
    },
    "gas_dead_battery": {
        title_pl: "Rozładowany Akumulator",
        title_en: "DEAD BATTERY",
        description_pl: "Za mało prądu do rozruchu.",
        description_en: "Not enough power to crank.",
        steps: ["Odpal z szarpanki (jeśli jest)", "Połącz akumulatory (Emergency)", "Naładuj akumulator"]
    },
    "gas_solenoid_fail": {
        title_pl: "Awaria Solenoidu / Rozrusznika",
        title_en: "SOLENOID / STARTER FAILURE",
        description_pl: "Słychać kliknięcie, ale rozrusznik nie kręci.",
        description_en: "Click heard, but starter won't turn.",
        steps: ["Opukaj rozrusznik", "Sprawdź kable (korozja)", "Expert: Zmostkuj solenoid"]
    },
    "gas_key_switch_fail": {
        title_pl: "Awaria Stacyjki / Neutrala",
        title_en: "KEY SWITCH / NEUTRAL SWITCH",
        description_pl: "Brak reakcji na kluczyk.",
        description_en: "No response to key.",
        steps: ["Sprawdź czy jest na luzie", "Poruszaj manetką", "Sprawdź bezpiecznik zapłonu"]
    },
    "gas_ignition_failure": {
        title_pl: "Brak Iskry (Ignition Failure)",
        title_en: "IGNITION FAILURE",
        description_pl: "Układ zapłonowy nie generuje iskry.",
        description_en: "Ignition system not generating spark.",
        steps: ["Sprawdź czy zrywka nie masuje", "Odłącz kabel gaszenia (Kill wire) od modułu", "Sprawdź cewkę i moduł CDI"]
    },
    "gas_no_fuel": {
        title_pl: "Brak Paliwa w Cylindrze",
        title_en: "NO FUEL",
        description_pl: "Sucha świeca oznacza, że paliwo nie dochodzi.",
        description_en: "Dry plug means fuel is not reaching cylinder.",
        steps: ["Sprawdź czy kranik otwarty", "Wyczyść gaźnik (dysze)", "Sprawdź czy pływak się nie zawiesił"]
    },
    "gas_flooded": {
        title_pl: "Zalany Silnik (Flooded)",
        title_en: "FLOODED ENGINE",
        description_pl: "Za dużo paliwa w cylindrze (mokra świeca).",
        description_en: "Too much fuel in cylinder (wet plug).",
        steps: ["Otwórz przepustnicę na MAX (Full Throttle)", "Kręć silnikiem by przedmuchać", "Wyczyść i osusz świecę"]
    },
    "gas_idle_circuit": {
        title_pl: "Zatkany Układ Wolnych Obrotów",
        title_en: "CLOGGED IDLE CIRCUIT",
        description_pl: "Silnik gaśnie jak tylko puścisz gaz.",
        description_en: "Engine dies as soon as you let off throttle.",
        steps: ["Wyczyść dyszę wolnych obrotów (Pilot Jet)", "Podkręć śrubę obrotów (Idle Screw)", "Używaj ssania na wolnych"]
    },
    "gas_lean_condition": {
        title_pl: "Uboga Mieszanka (Lean)",
        title_en: "LEAN CONDITION",
        description_pl: "Za dużo powietrza, za mało paliwa.",
        description_en: "Too much air, not enough fuel.",
        steps: ["Sprawdź czy nie łapie 'lewego' powietrza", "Wyczyść gaźnik", "Przymknij lekko ssanie (pół-ssanie)"]
    },
    "gas_fuel_supply_intermittent": {
        title_pl: "Przerywany Dopływ Paliwa",
        title_en: "INTERMITTENT FUEL SUPPLY",
        description_pl: "Paliwo dochodzi nieregularnie.",
        description_en: "Fuel supply is irregular.",
        steps: ["Sprawdź odpowietrzenie zbiornika", "Wymień filtr paliwa", "Sprawdź linię paliwową"]
    },
    "gas_load_issue": {
        title_pl: "Problem z Obciążeniem (Śruba)",
        title_en: "LOAD ISSUE / PROP",
        description_pl: "Silnik sprawny, ale napęd stawia opór.",
        description_en: "Engine fine, but drive train resists.",
        steps: ["Sprawdź czy coś nie wkręciło się w śrubę", "Sprawdź czy piasta śruby (hub) się nie obróciła"]
    },
    "gas_lean_timing": {
        title_pl: "Strzelanie (Lean / Timing)",
        title_en: "BACKFIRING (LEAN / TIMING)",
        description_pl: "Strzały w gaźnik lub wydech.",
        description_en: "Popping in carb or exhaust.",
        steps: ["Zbyt uboga mieszanka (wyczyść gaźnik)", "Przestawiony zapłon (rzadkie - zerwany klin koła magnesowego)"]
    },
    "gas_main_jet_flow": {
        title_pl: "Zatkany Dysza Główna",
        title_en: "CLOGGED MAIN JET",
        description_pl: "Brak mocy na wysokich obrotach.",
        description_en: "No power at high RPM.",
        steps: ["Wyczyść dyszę główną (Main Jet)", "Sprawdź filtr paliwa (za mały przepływ)", "Sprawdź pompę paliwa"]
    },
    "gas_general_rough": {
        title_pl: "Nierówna Praca",
        title_en: "ROUGH RUNNING",
        description_pl: "Silnik pracuje, ale trzęsie/przerywa.",
        description_en: "Engine runs but shakes/misses.",
        steps: ["Wymień świecę zapłonową", "Sprawdź jakość paliwa (woda?)", "Wyreguluj gaźnik"]
    },
    "gas_cooling_failure": {
        title_pl: "Awaria Chłodzenia",
        title_en: "COOLING FAILURE",
        description_pl: "Brak wody chłodzącej.",
        description_en: "No cooling water.",
        steps: ["Sprawdź wlot wody (torebka foliowa?)", "Wymień wirnik pompy (Impeller)", "Przeczyść otwór kontrolny (Tell-tale) drutem"]
    },
    "gas_overheat_other": {
        title_pl: "Przegrzewanie (Inne)",
        title_en: "OVERHEATING (OTHER)",
        description_pl: "Woda leci, ale silnik gorący.",
        description_en: "Water flows but engine hot.",
        steps: ["Uszkodzony termostat", "Zakamienione kanały wodne", "Zbyt uboga mieszanka (powoduje grzanie)"]
    },
    "gas_loose_wire_fuel": {
        title_pl: "Luźny Kabel / Paliwo",
        title_en: "LOOSE WIRE / FUEL",
        description_pl: "Losowe gaśnięcie.",
        description_en: "Random shutdown.",
        steps: ["Sprawdź wszystkie złączki elektryczne", "Sprawdź wodę w paliwie", "Sprawdź odpowietrzenie zbiornika"]
    },
    "gas_thermal_failure": {
        title_pl: "Awaria Termiczna (Cewka/Moduł)",
        title_en: "THERMAL FAILURE (COIL/CDI)",
        description_pl: "Elementy elektroniki psują się po nagrzaniu.",
        description_en: "Electronics fail when hot.",
        steps: ["Schłodź cewkę/moduł mokrą szmatą - jak odpali to masz winowajcę", "Wymień cewkę zapłonową", "Wymień moduł zapłonowy"]
    },
    "gas_coil_failure_permanent": {
        title_pl: "Trwała Awaria Zapłonu",
        title_en: "PERMANENT IGNITION FAILURE",
        description_pl: "Silnik zgasł i nie odpala.",
        description_en: "Engine died and won't restart.",
        steps: ["Sprawdź iskrę", "Wymień świecę", "Szukaj usterki w układzie zapłonowym"]
    },
    // A. NO CRANK
    "hydrolock_crit": {
        title_pl: "HYDROLOCK (Woda w cylindrze) - KRYTYCZNE",
        title_en: "HYDROLOCK / MECHANICAL FAILURE",
        description_pl: "Silnik zablokowany mechanicznie wodą. Dalsze kręcenie zniszczy korbowody.",
        description_en: "Engine locked by water. Cranking will bend connecting rods.",
        steps: ["STOP IMMEDIATELY - DO NOT CRANK", "Zamknij wlot wody", "Jeśli na morzu: Holowanie", "Expert: Wykręć wtryskiwacze by wydmuchać wodę"]
    },
    "main_power_fail": {
        title_pl: "Awaria Głównego Zasilania",
        title_en: "MAIN POWER FAILURE",
        description_pl: "Brak prądu w systemie.",
        steps: ["Sprawdź główny hebel (Battery Selector)", "Sprawdź główny bezpiecznik", "Przełącz na akumulator awaryjny (Emergency/House)"]
    },
    "neutral_safety": {
        title_pl: "Blokada Rozruchu (Bieg)",
        title_en: "NEUTRAL SAFETY SWITCH",
        description_pl: "Rozrusznik odcięty bo silnik jest na biegu.",
        steps: ["Poruszaj manetką (Wiggle lever)", "Wciśnij przycisk wysprzęglenia (Declutch button)", "Spróbuj odpalić w pozycji Neutral"]
    },
    "starter_solenoid": {
        title_pl: "Zacięty Solenoid Rozrusznika",
        title_en: "STARTER SOLENOID",
        description_pl: "Prąd dochodzi, ale automat nie wyrzuca.",
        steps: ["Opukaj rozrusznik młotkiem (Tap starter)", "Sprawdź kable przy rozruszniku", "Expert: Zmostkuj śrubokrętem (Bridge solenoid)"]
    },
    "ignition_switch": {
        title_pl: "Uszkodzona Stacyjka / Obwód",
        title_en: "IGNITION CIRCUIT / KEY SWITCH",
        description_pl: "Sygnał ze stacyjki nie dociera do rozrusznika.",
        steps: ["Sprawdź kable za stacyjką", "Sprawdź bezpiecznik zapłonu", "Użyj przycisku awaryjnego (jeśli jest)"]
    },

    // B. SLOW CRANK
    "battery_fail": {
        title_pl: "Rozładowany Akumulator / Złe Połączenie",
        title_en: "BATTERY / CONNECTION ISSUE",
        description_pl: "Spadek napięcia pod obciążeniem.",
        steps: ["Przełącz na HOUSE bank", "Wyczyść klemy (nożem/papierem)", "Złącz akumulatory (Parallel switch)"]
    },
    "mech_drag": {
        title_pl: "Opór Mechaniczny (Zatarcie?)",
        title_en: "MECHANICAL DRAG",
        description_pl: "Rozrusznik ma prąd, ale nie ma siły kręcić.",
        steps: ["Sprawdź czy alternator nie zatarty (zdejmij pasek)", "Możliwy częściowy Hydrolock - STOP", "Sprawdź olej"]
    },

    // C. CRANK NO START
    "fuel_supply_fail": {
        title_pl: "Brak Paliwa (Supply Failure)",
        title_en: "SUPPLY FAILURE",
        description_pl: "Paliwo nie dociera do pompy wtryskowej.",
        steps: ["Sprawdź zawór paliwa na zbiorniku", "Sprawdź filtr wstępny (Primary)", "Omiń filtr (Bypass) i podaj paliwo z kanistra grawitacyjnie"]
    },
    "air_lock": {
        title_pl: "Zapowietrzenie (Air Lock)",
        title_en: "AIR LOCK",
        description_pl: "Powietrze w przewodach wysokiego ciśnienia.",
        steps: ["Poluzuj nakrętki wtryskiwaczy", "Kręć aż poleci czyste paliwo bez bąbli", "Dokręć i odpal"]
    },
    "decompression_timing": {
        title_pl: "Dekompresja / Timing",
        title_en: "DECOMPRESSION / TIMING",
        description_pl: "Silnik próbuje łapać, ale nie ma kompresji.",
        steps: ["Sprawdź dźwignię dekompresatora", "Ustaw w pozycji 'Run'", "Sprawdź czy linka stopu nie jest naciągnięta"]
    },
    "glow_plugs_comp": {
        title_pl: "Świece Żarowe / Kompresja",
        title_en: "LOW COMPRESSION / COLD",
        description_pl: "Zimny silnik lub słaba kompresja.",
        steps: ["Grzej świece przez 30-60 sekund", "Kręć cyklami po 10 sekund", "Użyj 'Start Pilot' (ostateczność!)"]
    },
    "air_exhaust_block": {
        title_pl: "Zablokowany Dolot / Wydech",
        title_en: "INTAKE / EXHAUST BLOCKAGE",
        description_pl: "Silnik dusi się własnymi spalinami lub brakiem powietrza.",
        steps: ["Otwórz komorę silnika (więcej powietrza)", "Sprawdź filtr powietrza", "Sprawdź czy wąż wydechowy się nie zapadł"]
    },

    // D. STARTS STOPS
    "fuel_starvation": {
        title_pl: "Głód Paliwowy (Starvation)",
        title_en: "FUEL STARVATION",
        description_pl: "Paliwo dociera, ale za wolno.",
        steps: ["Odkręć korek wlewu paliwa (Odpowietrzenie)", "Sprawdź czy węże nie są zagięte", "Wymień filtr paliwa"]
    },
    "safety_shutdown": {
        title_pl: "Automatyczne Wyłączenie (Safety Shutdown)",
        title_en: "OVERHEAT / SAFETY SHUTDOWN",
        description_pl: "System bezpieczeństwa gasi silnik.",
        steps: ["Sprawdź poziom oleju", "Sprawdź czy jest chłodzenie", "Sprawdź czujniki ciśnienia/temperatury"]
    },

    // E. RUNS POORLY
    "prop_fouling": {
        title_pl: "Lina w Śrubie (Prop Fouling)",
        title_en: "LOAD SIDE PROBLEM",
        description_pl: "Silnik sprawny, ale coś blokuje wał.",
        steps: ["Zanurkuj i oczyść śrubę", "Wrzuć luz i sprawdź czy wibracje ustają", "Sprawdź hamulec wału"]
    },
    "overfuel_block": {
        title_pl: "Przelanie / Wydech",
        title_en: "OVERFUEL / BLOCKED EXHAUST",
        description_pl: "Za dużo paliwa lub zablokowany wylot.",
        steps: ["Sprawdź wtryskiwacze", "Sprawdź kolanko wydechowe", "Sprawdź czy śruba nie jest za duża (over-propped)"]
    },
    "injector_comp": {
        title_pl: "Wtryskiwacz / Kompresja",
        title_en: "INJECTOR / COMPRESSION",
        description_pl: "Biały dym pod obciążeniem = niespalone paliwo.",
        steps: ["Sprawdź wtryskiwacze (Lanie)", "Zmierz kompresję", "Sprawdź uszczelkę pod głowicą"]
    },
    "fuel_restrict_engine": {
        title_pl: "Ograniczenie Paliwa",
        title_en: "FUEL RESTRICTION",
        description_pl: "Brak mocy bez dymu = za mało paliwa.",
        steps: ["Wymień filtry paliwa", "Sprawdź sitko w zbiorniku", "Sprawdź pompkę zasilającą (Lift pump)"]
    },

    // F. OVERHEAT
    "raw_water_fail": {
        title_pl: "Brak Wody Zaburtowej",
        title_en: "RAW WATER FAILURE",
        is_temporary: true,
        description_pl: "Układ chłodzenia nie pobiera wody.",
        steps: ["Wyczyść filtr wody (Sea Strainer)", "Wymień wirnik pompy (Impeller)", "Awaryjnie: wiadro wody do filtra (Expert)"]
    },
    "mixing_elbow_hot": {
        title_pl: "Zatkane Kolanko Wydechowe",
        title_en: "EXHAUST / MIXING ELBOW",
        description_pl: "Woda leci, ale przepływ jest dławiony.",
        steps: ["Sprawdź temperaturę kolanka (Ręką - ostrożnie!)", "Zredukuj obroty", "Płyń do portu na wolnych obrotach"]
    },
    // === ELECTRICAL SOLUTIONS ===
    "windlass_needs_engine": {
        title_pl: "Włącz Silnik",
        title_en: "START ENGINE",
        description_pl: "Winda pobiera ogromny prąd. Musi pracować na włączonym silniku.",
        steps: ["Uruchom silnik", "Zwiększ obroty (RPM)", "Spróbuj ponownie"]
    },
    "windlass_breaker_reset": {
        title_pl: "Zresetuj Bezpiecznik Windy",
        title_en: "RESET WINDLASS BREAKER",
        description_pl: "Bezpiecznik zadziałał z przeciążenia.",
        steps: ["Znajdź bezpiecznik (duży hebel/przycisk, często w kabinie dziobowej lub przy akumulatorach).", "Wciśnij go z powrotem."]
    },
    "windlass_remote_battery": {
        title_pl: "Bateria Pilota / Solenoid",
        title_en: "REMOTE BATTERY / SOLENOID",
        description_pl: "Pilot nie wysyła sygnału lub cewka stycznika padła.",
        steps: ["Wymień baterię w pilocie.", "Spróbuj użyć przycisków nożnych (jeśli są).", "Sprawdź 'Control Box' (cykanie)."]
    },
    "windlass_low_voltage": {
        title_pl: "Niskie Napięcie",
        title_en: "LOW VOLTAGE",
        description_pl: "Winda działa wolno bo ma za mało prądu.",
        steps: ["Uruchom silnik!", "Sprawdź skorodowane kable przy windzie (duży spadek napięcia)."]
    },
    "windlass_clutch_tightened": {
        title_pl: "Sprzęgło Dokręcone",
        title_en: "CLUTCH TIGHTENED",
        description_pl: "Sprzęgło było poluzowane.",
        steps: ["Używaj wajchy windy do mocnego dokręcania sprzęgła przed użyciem."]
    },
    "windlass_stripped_gypsy": {
        title_pl: "Uszkodzona Cygańska (Gypsy)",
        title_en: "STRIPPED GYPSY / CONE",
        description_pl: "Stożki sprzęgła są zużyte.",
        steps: ["Wymaga serwisu / wymiany elementu.", "Wyciągaj kotwicę ręcznie (wspomagaj windę)."]
    },
    "winch_service_req": {
        title_pl: "Wymagany Serwis Kabestanu",
        title_en: "WINCH SERVICE REQUIRED",
        description_pl: "Zębatki lub zapadki są zatarte.",
        steps: ["Rozbierz kabestan.", "Wyczyść stary smar.", "Nasmaruj (Olej na zapadki, Smar na zębatki)."]
    },
    "winch_solenoid_fail": {
        title_pl: "Awaria Solenoidu / Stycznika",
        title_en: "SOLENOID FAILURE",
        description_pl: "Silnik jest sprawny, ale nie dostaje prądu z 'puszki'.",
        steps: ["Opukaj skrzynkę z solenoidami (czasem się wieszają).", "Sprawdź cienkie kable sterujące przy solenoidzie.", "Wymień solenoid (część zamienna)."]
    },
    "winch_internal_open": {
        title_pl: "Przerwa wewnątrz Silnika",
        title_en: "INTERNAL MOTOR OPEN",
        description_pl: "Silnik nie reaguje nawet na bezpośrednie podanie prądu.",
        steps: ["Silnik do wymiany lub przewinięcia.", "Sprawdź szczotki silnika (jeśli dostęp)."]
    },
    "winch_mechanical_jam": {
        title_pl: "Zablokowanie Mechaniczne",
        title_en: "MECHANICAL JAM",
        description_pl: "Silnik buczy, bo nie może obrócić bębna.",
        steps: ["Zdejmij obciążenie (linę).", "Spróbuj obrócić korbą.", "Rozbierz bęben i sprawdź czy coś nie wpadło w tryby."]
    },
    "winch_clutch_fixed": {
        title_pl: "Sprzęgło Dokręcone",
        title_en: "CLUTCH FIXED",
        description_pl: "Problem rozwiązany - luźne gniazdo korby.",
        steps: ["Pamiętaj, by zawsze dociskać/przekręcać gniazdo korby do końca przed użyciem elektrycznym."]
    },
    "winch_gear_disconnect": {
        title_pl: "Rozłączenie Przekładni",
        title_en: "GEAR DISCONNECT",
        description_pl: "Silnik pracuje, ale nie napędza bębna.",
        steps: ["Zerwany klin na wale silnika.", "Uszkodzona przekładnia planetarna wewnątrz.", "Wymagany serwis warsztatowy."]
    },
    "winch_stripped_gears": {
        title_pl: "Zmielone Zębatki",
        title_en: "STRIPPED GEARS",
        description_pl: "Charakterystyczny dźwięk zgrzytania.",
        steps: ["NIE UŻYWAJ WIĘCEJ - zniszczysz resztę.", "Użyj kabestanu ręcznie (korbą) lub innego.", "Wymiana zębatek."]
    },
    "winch_pendant_fail": {
        title_pl: "Awaria Pilota / Kabla",
        title_en: "REMOTE CONTROL FAIL",
        description_pl: "Winny jest sterownik, nie kabestan.",
        steps: ["Sprawdź ciągłość kabla pilota.", "Wyczyść wtyczkę pilota (często koroduje).", "Użyj przycisków na pokładzie (jeśli są)."]
    },
    "winch_voltage_drop": {
        title_pl: "Spadek Napięcia",
        title_en: "VOLTAGE DROP",
        description_pl: "Kabestan pobiera prąd, ale kable stawiają opór.",
        steps: ["Wyczyść wszystkie połączenia kabli grubych (Plus i Minus).", "Sprawdź czy kable nie są gorące (wymień przegrzane).", "Uruchom silnik by podbić napięcie."]
    },
    "winch_internal_friction": {
        title_pl: "Tarcie Wewnętrzne",
        title_en: "INTERNAL FRICTION",
        description_pl: "Stary smar stawia opór.",
        steps: ["Kabestan wymaga czyszczenia i smarowania.", "Zdejmij bęben, wymyj w benzynie, nasmaruj."]
    },
    "winch_low_battery": {
        title_pl: "Rozładowany Akumulator",
        title_en: "LOW BATTERY",
        description_pl: "Za mało prądu by utrzymać solenoid.",
        steps: ["Naładuj akumulator.", "Włącz silnik.", "Połącz banki (Parallel)."]
    },
    "winch_bad_ground": {
        title_pl: "Słaba Masa",
        title_en: "BAD GROUND",
        description_pl: "Solenoid 'cyka' bo masa ucieka pod obciążeniem.",
        steps: ["Odkręć i wyczyść kabel masowy przy silniku kabestanu.", "Sprawdź masę przy akumulatorze."]
    },
    "winch_wireless_battery": {
        title_pl: "Bateria w Pilocie",
        title_en: "REMOTE BATTERY",
        description_pl: "Pilot bezprzewodowy nie działa.",
        steps: ["Wymień baterię w pilocie.", "Sparuj pilot ponownie (zgodnie z instrukcją)."]
    },
    "winch_deck_switch_water": {
        title_pl: "Zalany Przycisk Pokładowy",
        title_en: "WET DECK SWITCH",
        description_pl: "Woda w przycisku nożnym.",
        steps: ["Rozkręć przycisk i wysusz.", "Zewrzyj kable pod przyciskiem by sprawdzić czy kabestan ruszy (Ostrożnie!)."]
    },
    "winch_button_fail": {
        title_pl: "Awaria Przycisku Kabestanu",
        title_en: "WINCH BUTTON FAIL",
        description_pl: "Przycisk nożny/ręczny skorodował.",
        steps: ["Zewrzyj kable pod przyciskiem (ostrożnie!).", "Wymień przycisk."]
    },
    "emergency_bypass_wire": {
        title_pl: "Obejście Awaryjne (Bypass)",
        title_en: "EMERGENCY BYPASS",
        is_temporary: true,
        description_pl: "Ominięcie uszkodzonego odcinka instalacji.",
        steps: ["Użyj kabla rozruchowego aby połączyć PLUS akumulatora z szyną PLUS.", "Jeśli zadziała - masz uszkodzony kabel główny lub hebel.", "Ostrożnie! Kabel nie ma bezpiecznika - nie dotykaj masy!"]
    },
    "battery_low_critical": {
        title_pl: "Akumulator Krytycznie Słaby",
        title_en: "BATTERY CRITICAL LOW",
        description_pl: "Napięcie jest, ale za małe by cokolwiek uruchomić.",
        steps: ["Wyłącz wszystkie zbędne odbiorniki.", "Połącz banki (Parallel Switch).", "Uruchom silnik (jeśli możliwe) i ładuj min. 1h."]
    },
    "panel_feeder_fail": {
        title_pl: "Awaria Zasilania Sekcji",
        title_en: "SECTION FEEDER FAIL",
        description_pl: "Padła cała sekcja (np. cała tablica DC).",
        steps: ["Sprawdź bezpiecznik główny tej sekcji (często przy akumulatorze).", "Sprawdź czy kabel zasilający tablicę nie wypiął się z tyłu."]
    },
    "fuse_replaced_ok": {
        title_pl: "Wymiana Bezpiecznika Pomogła",
        title_en: "FUSE REPLACEMENT OK",
        description_pl: "System działa na nowym bezpieczniku.",
        steps: ["Obserwuj przez 15 minut.", "Jeśli znowu spali - masz zwarcie (Short Circuit).", "Jeśli działa - był to jednorazowy skok (Old Fuse)."]
    },
    "wire_repair_basic": {
        title_pl: "Naprawa Przewodu",
        title_en: "BASIC WIRE REPAIR",
        is_temporary: true,
        description_pl: "Uszkodzenie fizyczne przewodu.",
        steps: ["Oczyść końcówki nożem do błysku.", "Skręć mocno i zaizoluj taśmą.", "Docelowo: Wymień kabel i zarób końcówki."]
    },
    "moisture_corrosion": {
        title_pl: "Wilgoć w Instalacji",
        title_en: "MOISTURE ISSUE",
        description_pl: "Woda powoduje zwarcia lub brak styku.",
        steps: ["Wydmuchaj wodę sprężonym powietrzem (lub ustami).", "Spryskaj WD-40 lub Contact Cleanerem.", "Osusz suszarką jeśli dostępna."]
    },
    "thermal_expansion_fail": {
        title_pl: "Usterka Termiczna",
        title_en: "THERMAL EXPANSION FAIL",
        description_pl: "Styk puszcza gdy metal się nagrzewa.",
        steps: ["To groźne! Oznacza iskrzenie.", "Dokręć wszystkie śruby w torze prądowym.", "Sprawdź czy kable nie są czarne od gorąca."]
    },
    "alternator_wire_fix": {
        title_pl: "Urwany Kabel Alternatora",
        title_en: "ALTERNATOR WIRE BROKEN",
        is_temporary: true,
        description_pl: "Wibracje urwały kabel wzbudzenia lub wyjścia.",
        steps: ["Zarób nową końcówkę (lub owiń drut wokół śruby).", "Zabezpiecz kabel trytytką, żeby nie wibrował."]
    },
    "regulator_failure_bypass": {
        title_pl: "Awaria Regulatora (Obejście)",
        title_en: "REGULATOR FAIL (BYPASS)",
        is_temporary: true,
        description_pl: "Regulator padł, ale alternator jest sprawny.",
        steps: ["Możesz płynąć, ale monitoruj napięcie!", "Jeśli wzrośnie powyżej 15V - wyłącz silnik lub włącz wszystkie światła żeby zbić napięcie."]
    },
    "battery_end_of_life": {
        title_pl: "Koniec Życia Akumulatora",
        title_en: "BATTERY END OF LIFE",
        description_pl: "Akumulator nie trzyma pojemności (zasiarczony).",
        steps: ["Nic nie zrobisz na morzu.", "Używaj tylko jednego banku, drugi oszczędzaj na rozruch.", "Wymiana w porcie."]
    },
    "parasitic_draw_found": {
        title_pl: "Znaleziono Złodzieja Prądu",
        title_en: "PARASITIC DRAW FOUND",
        description_pl: "Urządzenie pobiera prąd mimo wyłączenia.",
        steps: ["Wyjmij bezpiecznik tego urządzenia na stałe.", "Wkładaj bezpiecznik tylko gdy używasz urządzenia."]
    },
    "battery_self_discharge": {
        title_pl: "Samorozładowanie",
        title_en: "SELF DISCHARGE",
        description_pl: "Wewnętrzne zwarcie w akumulatorze.",
        steps: ["Akumulator jest gorący mimo braku obciążenia?", "ODŁĄCZ GO NATYCHMIAST - Ryzyko wybuchu!", "Płyń na pozostałych."]
    },
    "bilge_impeller_clog": {
        title_pl: "Zablokowany Wirnik Zęzy",
        title_en: "BILGE IMPELLER CLOGGED",
        description_pl: "Coś wpadło do pompy (włosy, śmieci).",
        steps: ["Otwórz kosz pompy.", "Wyjmij śmieci z wirnika.", "Sprawdź czy wirnik się kręci palcem."]
    },
    "bilge_switch_fail": {
        title_pl: "Awaria Włącznika/Pływaka",
        title_en: "FLOAT SWITCH FAIL",
        is_temporary: true,
        description_pl: "Pompa sprawna, automatyka padła.",
        steps: ["Zmostkuj kable włącznika na stałe (pompa będzie chodzić ciągle - musisz nią sterować ręcznie z hebla).", "Lub podłącz 'na krótko' do baterii gdy trzeba wypompować."]
    },
    "bilge_motor_burnout": {
        title_pl: "Spalona Pompa Zęzowa",
        title_en: "BILGE PUMP BURNOUT",
        description_pl: "Silnik pompy nie żyje.",
        steps: ["Użyj pompy ręcznej.", "Użyj wiadra.", "Przełóż pompę prysznicową do zęzy (jeśli kable sięgną)."]
    },
    "nav_light_fuse_switch": {
        title_pl: "Awaria Zasilania Świateł",
        title_en: "NAV LIGHTS POWER FAIL",
        description_pl: "Brak prądu na włączniku świateł.",
        steps: ["Sprawdź bezpiecznik panelu.", "Sprawdź czy masa panelu nie odpadła."]
    },
    "bulb_replacement": {
        title_pl: "Wymiana Żarówki",
        title_en: "BULB REPLACEMENT",
        description_pl: "Standardowa procedura.",
        steps: ["Odkręć klosz.", "Oczyść styki (często śniedzieją!).", "Włóż nową żarówkę.", "Posmaruj wazeliną uszczelkę."]
    },
    "corroded_socket_nav": {
        title_pl: "Skorodowane Gniazdo Żarówki",
        title_en: "CORRODED SOCKET",
        is_temporary: true,
        description_pl: "Prąd jest w kablu, ale nie przechodzi na żarówkę.",
        steps: ["Wyskrob styki nożem/papierem ściernym.", "Podegnij blaszki stykowe.", "AWARYJNIE: Przylutuj kable bezpośrednio do żarówki (jeśli masz lutownicę gazową)."]
    },
    "lightning_procedure": {
        title_pl: "Procedura po Piorunie",
        title_en: "LIGHTNING STRIKE PROTOCOL",
        description_pl: "Uderzenie pioruna mogło zniszczyć wszystko.",
        steps: ["Sprawdź czy nie ma przecieków (piorun mógł wybić dziurę w dnie!).", "Sprawdź czy działa radio VHF (wezwij pomoc jeśli nie).", "Kompas magnetyczny może kłamać!", "Użyj ręcznego GPS/telefonu do nawigacji."]
    },
    "saltwater_procedure": {
        title_pl: "Procedura po Zalaniu",
        title_en: "SALTWATER RECOVERY",
        description_pl: "Elektronika wpadła do wody / fala zalała panel.",
        steps: ["NATYCHMIAST ODŁĄCZ ZASILANIE.", "Przepłucz obficie SŁODKĄ WODĄ (wypłucz sól).", "Wymocz w spirytusie (jeśli masz).", "Susz na słońcu przez 24h min.", "Spryskaj Contact Cleanerem przed włączeniem."]
    },
    "electronics_hard_reset": {
        title_pl: "Twardy Reset Elektroniki",
        title_en: "HARD RESET",
        description_pl: "Plotter się zawiesił.",
        steps: ["Odłącz zasilanie (bezpiecznik) na 60 sekund.", "Włącz trzymając przycisk Power (czasem uruchamia tryb serwisowy).", "Sprawdź kartę mapy (czy nie wyskoczyła)."]
    },
    "electronics_internal_fail": {
        title_pl: "Awaria Wewnętrzna",
        title_en: "INTERNAL FAILURE",
        description_pl: "Urządzenie uszkodzone.",
        steps: ["Nic nie zrobisz.", "Użyj zapasowych metod nawigacji (Papierowa mapa, Telefon, Tablet)."]
    },
    "fire_hazard": {
        title_pl: "ZAGROŻENIE POŻAROWE",
        title_en: "FIRE HAZARD",
        description_pl: "Ryzyko pożaru instalacji elektrycznej.",
        steps: [
            "STOP - Wyłącz Główny Hebel (MAIN SWITCH OFF)",
            "Jeśli AC: Odłącz zasilanie lądowe / Inwerter",
            "Gaśnica w pogotowiu (klasa ABC)",
            "Odczekaj 15 minut aż ostygnie",
            "Nie włączaj ponownie bez znalezienia przyczyny"
        ]
    },
    "operator_error_battery": {
        title_pl: "Błąd Operatora - Przełącznik",
        title_en: "OPERATOR ERROR",
        description_pl: "Niewłaściwa pozycja przełącznika akumulatorów.",
        steps: ["Ustaw przełącznik na właściwy bank (1, 2 lub BOTH)", "Sprawdź czy kluczyk nie jest wyjęty"]
    },
    "battery_dead": {
        title_pl: "Rozładowany / Uszkodzony Akumulator",
        title_en: "BATTERY EMPTY / FAILED",
        description_pl: "Brak napięcia na źródle.",
        steps: ["Połącz banki (Parallel / Emergency)", "Odpal z innego źródła (Jump start)", "Naładuj akumulatory"]
    },
    "main_fuse_switch": {
        title_pl: "Główny Bezpiecznik / Hebel",
        title_en: "MAIN FUSE / MAIN SWITCH",
        description_pl: "Przerwa na głównej linii zasilania.",
        steps: ["Sprawdź główny bezpiecznik (Mega Fuse)", "Sprawdź korozję na głównym heblu", "Awaryjnie: Omiń bezpiecznik (Monitoruj temperaturę!)"]
    },
    "main_ground_failure": {
        title_pl: "Awaria Głównej Masy",
        title_en: "MAIN GROUND FAILURE",
        description_pl: "Brak połączenia z minusem akumulatora.",
        steps: ["Sprawdź główny przewód masowy", "Oczyść połączenie z blokiem silnika", "Awaryjnie: Dodatkowy kabel masowy (np. z kabla rozruchowego)"]
    },
    "unknown_major_failure": {
        title_pl: "Niezidentyfikowana Awaria Zasilania",
        title_en: "UNKNOWN POWER FAILURE",
        description_pl: "Napięcie jest na szynach, ale system nie działa.",
        steps: ["Sprawdź czy nie ma spadków napięcia pod obciążeniem", "Wezwij elektryka"]
    },
    "short_overload": {
        title_pl: "Zwarcie / Przeciążenie",
        title_en: "SHORT / OVERLOAD",
        description_pl: "Zadziałało zabezpieczenie obwodu.",
        steps: ["Wymień bezpiecznik na TAKI SAM (nie większy!)", "Odłącz zbędne odbiorniki", "Sprawdź czy kable się nie grzeją"]
    },
    "broken_feed": {
        title_pl: "Przerwa w Obwodzie",
        title_en: "BROKEN FEED",
        description_pl: "Napięcie wychodzi z bezpiecznika, ale nie dociera do urządzenia.",
        steps: ["Szukaj przerwanego przewodu", "Sprawdź złączki i konektory po drodze", "Awaryjnie: Pociągnij tymczasowy 'plus' z pobliskiego urządzenia"]
    },
    "device_failure": {
        title_pl: "Awaria Urządzenia",
        title_en: "DEVICE FAILURE",
        description_pl: "Prąd dochodzi, ale urządzenie nie działa.",
        steps: ["Sprawdź styki w samym urządzeniu", "Urządzenie do wymiany/naprawy"]
    },
    "loose_connection": {
        title_pl: "Luźne Połączenie",
        title_en: "LOOSE CONNECTION",
        description_pl: "Styk przerywa pod wpływem wibracji.",
        steps: ["Dokręć klemy akumulatora", "Sprawdź tył panelu bezpieczników", "Zaklinuj luźne wtyczki"]
    },
    "ground_problem": {
        title_pl: "Problem z Masą (Ground)",
        title_en: "GROUND PROBLEM",
        description_pl: "Wspólny problem dla wielu urządzeń sugeruje awarię wspólnej masy.",
        steps: ["Sprawdź szynę zbiorczą masy", "Oczyść punkty styku masy", "Awaryjnie: Poprowadź nową masę do szyny"]
    },
    "mechanical_failure_belt": {
        title_pl: "Zerwany / Luźny Pasek",
        title_en: "MECHANICAL FAILURE (BELT)",
        is_temporary: true,
        description_pl: "Alternator nie jest napędzany.",
        steps: ["Naciągnij pasek", "Wymień pasek", "Awaryjnie: Pasek z rajstopy/linki (na krótko)"]
    },
    "excitation_circuit": {
        title_pl: "Obwód Wzbudzenia",
        title_en: "EXCITATION CIRCUIT",
        description_pl: "Alternator nie dostaje sygnału startu.",
        steps: ["Przygazuj silnik (może się wzbudzić sam)", "Sprawdź żarówkę kontrolki ładowania", "Sprawdź cienki kabel przy alternatorze"]
    },
    "regulator_short": {
        title_pl: "Zwarcie Regulatora",
        title_en: "REGULATOR / SHORT",
        description_pl: "Alternator przegrzewa się, ryzyko pożaru.",
        steps: ["STOP CHARGING - Wyłącz silnik", "Odłącz alternator", "Płyń na akumulatorach"]
    },
    "alternator_internal_fail": {
        title_pl: "Awaria Alternatora",
        title_en: "ALTERNATOR FAILURE",
        description_pl: "Alternator kręci się, ale nie ładuje.",
        steps: ["Sprawdź szczotki (jeśli dostępne)", "Wymiana alternatora"]
    },
    "charging_ok": {
        title_pl: "Ładowanie OK",
        title_en: "CHARGING OK",
        description_pl: "Napięcie ładowania jest prawidłowe.",
        steps: ["Szukaj problemu gdzie indziej (np. stary akumulator nie trzyma prądu)"]
    },
    "shore_power_fault": {
        title_pl: "Awaria Zasilania Lądowego",
        title_en: "SHORE POWER FAULT",
        description_pl: "Brak napięcia w słupku lub kablu.",
        steps: ["Sprawdź bezpiecznik na kei", "Sprawdź inny kabel", "Sprawdź wtyczki (przypalone?)"]
    },
    "charger_failure": {
        title_pl: "Awaria Ładowarki",
        title_en: "CHARGER FAILURE",
        description_pl: "Ładowarka ma zasilanie, ale nie ładuje.",
        steps: ["Zresetuj ładowarkę (wyłącz/włącz)", "Sprawdź bezpieczniki wyjściowe na ładowarce", "Ładuj silnikiem"]
    },
    "controller_dead": {
        title_pl: "Awaria Regulatora Solarnego",
        title_en: "CONTROLLER DEAD",
        description_pl: "Regulator nie daje oznak życia.",
        steps: ["Sprawdź bezpiecznik między panelem a regulatorem", "Wymień regulator"]
    },
    "solar_input_side": {
        title_pl: "Problem po stronie Paneli",
        title_en: "SOLAR INPUT ISSUE",
        is_temporary: true,
        description_pl: "Regulator działa, ale nie ładuje.",
        steps: ["Sprawdź czy panele nie są w cieniu", "Sprawdź złącza MC4 na dachu", "Awaryjnie (Monitorowane): Podłącz panel bezpośrednio do aku (tylko w dzień!)"]
    },
    "parasitic_draw": {
        title_pl: "Pobór Pasożytniczy (Złodziej Prądu)",
        title_en: "PARASITIC DRAW",
        description_pl: "Coś zjada prąd na postoju.",
        steps: ["Wyciągaj bezpieczniki po kolei patrząc na iskrzenie/miernik", "Sprawdź: Radio, Bilge Pump, Inverter Standby", "Rozłączaj klemy na noc"]
    },
    "normal_discharge": {
        title_pl: "Normalne Zużycie",
        title_en: "NORMAL DISCHARGE",
        description_pl: "Brak ewidentnej usterki.",
        steps: ["Akumulatory mogą być stare i straciły pojemność", "Bilans energetyczny ujemny (za dużo odbiorników)"]
    },
    "instrument_ground_issue": {
        title_pl: "Wariujące Wskaźniki (Masa)",
        title_en: "INSTRUMENT GROUND ISSUE",
        description_pl: "Wskaźniki skaczą, alarmy piszczą losowo.",
        steps: ["To na 90% słaba masa", "Pociągnij osobny kabel masowy od wskaźnika do szyny", "Odizoluj 'szumiące' odbiorniki (Inverter, Lodówka)"]
    },

    // === DIESEL EXPERT SOLUTIONS ===
    "no_crank_power": {
        title_pl: "Brak zasilania rozrusznika",
        title_en: "No starter power",
        description_pl: "Najbardziej prawdopodobna przyczyna (≈75%). W warunkach marine brak kręcenia niemal zawsze oznacza problem elektryczny.",
        description_en: "Most likely cause (~75%). In marine conditions, no cranking almost always indicates an electrical issue.",
        steps: ["Sprawdź napięcie akumulatora.", "Sprawdź masę i klemy.", "Sprawdź główny wyłącznik baterii."]
    },
    "no_fuel_or_air": {
        title_pl: "Brak paliwa lub zapowietrzenie układu",
        title_en: "No fuel or air in the system",
        description_pl: "Domyślna przyczyna przy kręceniu bez zapłonu (≈80%). Przy braku pewności zawsze zakłada się problem z paliwem.",
        description_en: "Default cause when cranking without firing (~80%). When uncertain, fuel issues are assumed.",
        steps: ["Sprawdź zawory paliwa.", "Sprawdź filtr paliwa.", "Odpowietrz układ."]
    },
    "poor_combustion_conditions": {
        title_pl: "Niewłaściwe warunki spalania",
        title_en: "Poor combustion conditions",
        description_pl: "Używane jako fallback (≈65%), gdy nie da się jednoznacznie ocenić objawów.",
        description_en: "Used as a fallback (~65%) when symptoms cannot be clearly assessed.",
        steps: ["Sprawdź jakość paliwa.", "Sprawdź wtryski.", "Uwzględnij temperaturę i kompresję."]
    },
    "restricted_fuel_flow": {
        title_pl: "Ograniczony przepływ paliwa",
        title_en: "Restricted fuel flow",
        description_pl: "Najczęstsza przyczyna gaśnięcia bez danych pomiarowych (≈70%).",
        description_en: "Most common cause of stalling without measurements (~70%).",
        steps: ["Wymień filtr paliwa.", "Sprawdź przewody.", "Sprawdź odpowietrzenie zbiornika."]
    },
    "fuel_vent_or_overheat": {
        title_pl: "Odpowietrzenie zbiornika lub przegrzewanie",
        title_en: "Tank venting or overheating issue",
        description_pl: "Stosowane gdy brak danych, ale objaw zależny od czasu (≈60%).",
        description_en: "Used when time-dependent symptoms exist but data is limited (~60%).",
        steps: ["Sprawdź odpowietrzenie zbiornika.", "Sprawdź układ chłodzenia."]
    },
    "air_or_fuel_restriction": {
        title_pl: "Ograniczony dopływ powietrza lub paliwa",
        title_en: "Restricted air or fuel supply",
        description_pl: "Bezpieczne zawężenie przy braku wiedzy użytkownika (≈60%).",
        description_en: "Safe narrowing when user knowledge is limited (~60%).",
        steps: ["Sprawdź filtry.", "Sprawdź dolot."]
    },
    "turbo_or_injector_issue": {
        title_pl: "Awaria turbiny lub wtryskiwacza",
        title_en: "Turbocharger or injector failure",
        description_pl: "Mniej prawdopodobne, ale istotne przy nagłej utracie mocy (≈55%).",
        description_en: "Less likely but relevant for sudden power loss (~55%).",
        steps: ["Sprawdź doładowanie.", "Sprawdź wtryski."]
    },
    "black_smoke": {
        title_pl: "Zbyt bogata mieszanka (Czarny dym)",
        title_en: "Over-fuelling (Black smoke)",
        description_pl: "Czarny dym nawet bez pewności użytkownika (≈75%).",
        description_en: "Black smoke even without user certainty (~75%).",
        steps: ["Sprawdź dolot.", "Sprawdź wtryski."]
    },
    "white_smoke": {
        title_pl: "Niespalone paliwo (Biały dym)",
        title_en: "Unburnt fuel (White smoke)",
        description_pl: "Częste przy zimnym silniku i niepewnych obserwacjach (≈65%).",
        description_en: "Common on cold engines and uncertain observations (~65%).",
        steps: ["Sprawdź temperaturę.", "Sprawdź kompresję."]
    },
    "blue_smoke": {
        title_pl: "Spalanie oleju (Niebieski dym)",
        title_en: "Oil burning (Blue smoke)",
        description_pl: "Rzadkie, ale jednoznaczne nawet przy ograniczonej obserwacji (≈70%).",
        description_en: "Rare but clear even with limited observation (~70%).",
        steps: ["Sprawdź pierścienie.", "Sprawdź prowadnice zaworów."]
    },
    "unknown_voltage_device": {
        title_pl: "Nieznany Stan Zasilania (Prawdopodobieństwo)",
        title_en: "UNKNOWN POWER STATE (Probability)",
        description_pl: "Bez pomiaru miernikiem nie można wykluczyć awarii kabla.",
        description_en: "Without multimeter test, cable failure cannot be ruled out.",
        steps: [
            "Szansa na awarię urządzenia: 60%",
            "Szansa na przerwany kabel: 40%",
            "Zalecane: Podłącz urządzenie 'na krótko' do akumulatora, aby wykluczyć awarię instalacji."
        ]
    }
};

function mergeSpecificKnowledge(generalDB, context) {
    if (!context) return generalDB;

    console.log(`Loading specifics for context: ${context}`);
    
    const mergedIssues = { ...generalDB.issues };
    
    const merge = (specifics) => {
        Object.values(specifics.common_issues).forEach(issue => {
            issue.isSpecific = true;
            issue.probability = (issue.base_probability || 0.1) + 0.1; 
            
            if (!issue.required_symptoms) issue.required_symptoms = issue.symptoms;
            if (!issue.conflicting_symptoms) issue.conflicting_symptoms = [];
            
            mergedIssues[issue.id] = issue;
        });
    };

    // 1. Check if context is a defined Engine Type with subtypes (Data-Driven)
    const engineTypeConfig = generalDB.engine_types && generalDB.engine_types[context];

    if (engineTypeConfig && engineTypeConfig.subtypes) {
        engineTypeConfig.subtypes.forEach(subtype => {
            if (marineSpecifics[subtype]) {
                merge(marineSpecifics[subtype]);
            }
        });
    } 
    // 2. Check if context is a direct match in marineSpecifics
    else if (marineSpecifics[context]) {
        merge(marineSpecifics[context]);
    }

    return {
        ...generalDB,
        issues: mergedIssues
    };
}

</script>
    <script>
        // ====================
        // BAZA DANYCH OFFLINE
        // ====================

        // Baza podstawowa (General)
        const baseMarineDatabase = {
            // Definicje Kategorii Symptomów (Symptom Categories)
            symptom_categories: {
                behavior: { name_pl: 'Zachowanie (Behavior)', name_en: 'Behavior' },
                auditory_tactile: { name_pl: 'Słuchowe / Dotykowe', name_en: 'Auditory / Tactile' },
                visual: { name_pl: 'Wizualne (Visual)', name_en: 'Visual' },
                visual_instrument: { name_pl: 'Wskaźniki (Instruments)', name_en: 'Instruments' },
                olfactory: { name_pl: 'Zapachowe (Olfactory)', name_en: 'Olfactory' },
                other: { name_pl: 'Inne', name_en: 'Other' }
            },

            // Konfiguracja Typów Silników (Engine Types)
            engine_types: {
                inboard: { 
                    id: 'inboard', 
                    tree_id: 'diesel_core', 
                    name_pl: 'Stacjonarny (Diesel)', 
                    name_en: 'Inboard (Diesel)',
                    subtypes: ['yanmar', 'volvo']
                },
                diesel_expert: { 
                    id: 'diesel_expert', 
                    tree_id: 'diesel_engine_core', 
                    name_pl: 'Stacjonarny (Diesel - Ekspert)', 
                    name_en: 'Inboard (Diesel - Expert)',
                    subtypes: ['yanmar', 'volvo']
                },
                outboard: { 
                    id: 'outboard', 
                    tree_id: 'gasoline_core', 
                    name_pl: 'Zaburtowy (Benzyna)', 
                    name_en: 'Outboard (Gasoline)',
                    subtypes: ['yamaha', 'mercury', 'honda']
                }
            },

            // Systemy łodzi
            systems: [
                {
                    id: 'engine',
                    name_pl: 'Silnik',
                    name_en: 'Engine',
                    icon: 'fas fa-engine',
                    color: '#00B4D8',
                    diagnosis_mode: 'context_choice', // Wymaga wyboru kontekstu (inboard/outboard)
                    symptoms: [
                        // Zachowanie (Behavior)
                        'eng_cranks_no_start', 'eng_no_crank', 'eng_stalls_idle', 'eng_stalls_load',
                        // Słuchowe/Dotykowe (Auditory/Tactile)
                        'snd_click_start', 'snd_grinding', 'vib_idle', 'vib_running',
                        // Wizualne (Visual)
                        'vis_smoke_black', 'vis_smoke_blue', 'vis_smoke_white', 'vis_leak_oil', 'vis_leak_water',
                        // Wskaźniki (Instruments)
                        'ins_temp_high', 'ins_oil_low', 'ins_volt_low'
                    ]
                },
                {
                    id: 'electrical',
                    name_pl: 'Elektryka',
                    name_en: 'Electrical',
                    icon: 'fas fa-bolt',
                    color: '#FF9800',
                    diagnosis_mode: 'tree',
                    default_tree_id: 'electrical_core',
                    symptoms: ['elec_total_loss', 'elec_dim_lights', 'elec_flicker']
                },
                {
                    id: 'toilets',
                    name_pl: 'Toaleta (WC)',
                    name_en: 'Heads / Toilets',
                    icon: 'fas fa-toilet',
                    color: '#9C27B0',
                    symptoms: ['wc_blocked_pump', 'wc_wont_flush', 'wc_bad_smell', 'wc_bowl_full']
                },
                {
                    id: 'dinghy',
                    name_pl: 'Ponton / Silnik',
                    name_en: 'Dinghy / Outboard',
                    icon: 'fas fa-ship',
                    color: '#607D8B',
                    symptoms: ['ob_wont_start', 'ob_stops_run', 'ob_no_water']
                },
                /* MOVED TO ELECTRICAL
                {
                    id: 'anchor',
                    name_pl: 'Kotwica',
                    name_en: 'Anchor / Windlass',
                    icon: 'fas fa-anchor',
                    color: '#795548',
                    symptoms: ['anc_wont_up', 'anc_silent', 'anc_stuck']
                },
                */
                {
                    id: 'generator',
                    name_pl: 'Generator (Agregat)',
                    name_en: 'Generator / Genset',
                    icon: 'fas fa-bolt',
                    color: '#FFC107',
                    symptoms: ['gen_stops', 'gen_wont_start', 'gen_no_power', 'gen_blink_code']
                },
                {
                    id: 'sails',
                    name_pl: 'Żagle',
                    name_en: 'Sails',
                    icon: 'fas fa-sailboat',
                    color: '#4CAF50',
                    symptoms: []
                },
                {
                    id: 'plumbing',
                    name_pl: 'Instalacje',
                    name_en: 'Plumbing',
                    icon: 'fas fa-faucet',
                    color: '#2196F3',
                    symptoms: []
                },
                {
                    id: 'steering',
                    name_pl: 'Sterowanie',
                    name_en: 'Steering',
                    icon: 'fas fa-wheel',
                    color: '#9C27B0',
                    symptoms: []
                },
                {
                    id: 'hull',
                    name_pl: 'Kadłub',
                    name_en: 'Hull',
                    icon: 'fas fa-ship',
                    color: '#795548',
                    symptoms: []
                }
            ],

            // Symptomy
            symptoms: {
                // === TOALETA (CHARTER CLASSIC) ===
                wc_blocked_pump: {
                    id: 'wc_blocked_pump',
                    name_pl: 'Pompa zablokowana (Wajcha ani drgnie)',
                    category: 'behavior',
                    issues: ['wc_valve_shut', 'wc_clogged_paper']
                },
                wc_wont_flush: {
                    id: 'wc_wont_flush',
                    name_pl: 'Woda nie wpływa do muszli',
                    category: 'behavior',
                    issues: ['wc_seacock_in_closed', 'wc_pump_dry']
                },
                wc_bowl_full: {
                    id: 'wc_bowl_full',
                    name_pl: 'Woda nie odpływa (Muszla pełna)',
                    category: 'visual',
                    issues: ['wc_seacock_out_closed', 'wc_tank_full', 'wc_clogged_pipe']
                },

                // === PONTON / SILNIK ZABURTOWY ===
                ob_wont_start: {
                    id: 'ob_wont_start',
                    name_pl: 'Silnik nie odpala (Szarpiesz i nic)',
                    category: 'behavior',
                    issues: ['ob_kill_cord', 'ob_fuel_tap', 'ob_tank_vent', 'ob_fuel_empty']
                },
                ob_stops_run: {
                    id: 'ob_stops_run',
                    name_pl: 'Odpala i gaśnie po chwili',
                    category: 'behavior',
                    issues: ['ob_tank_vent', 'ob_fuel_tap']
                },

                // === KOTWICA ===
                anc_silent: {
                    id: 'anc_silent',
                    name_pl: 'Winda milczy (Brak reakcji)',
                    category: 'behavior',
                    issues: ['anc_breaker', 'anc_engine_off', 'anc_remote_bat']
                },
                anc_wont_up: {
                    id: 'anc_wont_up',
                    name_pl: 'Winda kręci ale nie ciągnie (Ślizga się)',
                    category: 'behavior',
                    issues: ['anc_clutch_loose', 'anc_chain_jam']
                },

                // === GENERATOR (AGREGAT) ===
                gen_stops: {
                    id: 'gen_stops',
                    name_pl: 'Gaśnie po chwili (lub pod obciążeniem)',
                    category: 'behavior',
                    issues: ['gen_overheat', 'gen_overload', 'gen_fuel_block']
                },
                gen_wont_start: {
                    id: 'gen_wont_start',
                    name_pl: 'Kręci ale nie odpala',
                    category: 'behavior',
                    issues: ['gen_fuel_pump', 'gen_glow_plugs']
                },
                gen_no_power: {
                    id: 'gen_no_power',
                    name_pl: 'Silnik pracuje, ale nie ma prądu (230V)',
                    category: 'visual_instrument',
                    issues: ['gen_breaker_trip', 'gen_capacitor']
                },
                gen_blink_code: {
                    id: 'gen_blink_code',
                    name_pl: 'Miga dioda na przycisku start',
                    category: 'visual',
                    requires_specificity: true,
                    specificity_options: [
                        { id: 'onan_3_blink', label: '3 Mignięcia (Serwis)', issues: ['gen_raw_water_loss', 'gen_overheat'] },
                        { id: 'onan_2_blink', label: '2 Mignięcia (Low Oil)', issues: ['gen_oil_low'] },
                        { id: 'kohler_loc', label: 'Kod "LOC" na ekranie', issues: ['gen_raw_water_loss'] },
                        { id: 'kohler_uu', label: 'Kod "UU" na ekranie', issues: ['gen_capacitor'] }
                    ],
                    issues: []
                },

                // === ZACHOWANIE (BEHAVIOR) ===
                eng_cranks_no_start: {
                    id: 'eng_cranks_no_start',
                    name_pl: 'Rozrusznik kręci, ale silnik nie zapala',
                    category: 'behavior',
                    issues: ['fuel_empty', 'fuel_filter', 'safety_switch']
                },
                eng_no_crank: {
                    id: 'eng_no_crank',
                    name_pl: 'Rozrusznik NIE kręci (cisza lub kliknięcie)',
                    category: 'behavior',
                    issues: ['battery_dead', 'starter_failed', 'ground_fault']
                },
                eng_stalls_idle: {
                    id: 'eng_stalls_idle',
                    name_pl: 'Gaśnie na wolnych obrotach',
                    category: 'behavior',
                    issues: ['idle_valve', 'fuel_filter', 'air_filter']
                },
                eng_stalls_load: {
                    id: 'eng_stalls_load',
                    name_pl: 'Gaśnie pod obciążeniem',
                    category: 'behavior',
                    issues: ['fuel_filter', 'propeller_fouled', 'turbo_failed']
                },

                // === SŁUCHOWE/DOTYKOWE (AUDITORY/TACTILE) ===
                snd_click_start: {
                    id: 'snd_click_start',
                    name_pl: 'Pojedyncze kliknięcie przy starcie',
                    category: 'auditory_tactile',
                    issues: ['battery_dead', 'starter_failed']
                },
                snd_grinding: {
                    id: 'snd_grinding',
                    name_pl: 'Zgrzytanie przy starcie',
                    category: 'auditory_tactile',
                    issues: ['starter_failed']
                },
                vib_idle: {
                    id: 'vib_idle',
                    name_pl: 'Wibracje na wolnych obrotach',
                    category: 'auditory_tactile',
                    issues: ['engine_mount_loose', 'injector_fault']
                },
                vib_running: {
                    id: 'vib_running',
                    name_pl: 'Wibracje podczas płynięcia',
                    category: 'auditory_tactile',
                    issues: ['propeller_fouling', 'shaft_bent', 'engine_mount_loose', 'injector_fault']
                },

                // === WIZUALNE (VISUAL) ===
                vis_smoke_black: {
                    id: 'vis_smoke_black',
                    name_pl: 'Czarny dym',
                    category: 'visual',
                    issues: ['air_filter', 'injectors_dirty', 'overload']
                },
                vis_smoke_blue: {
                    id: 'vis_smoke_blue',
                    name_pl: 'Niebieski dym',
                    category: 'visual',
                    issues: ['oil_burning', 'piston_rings']
                },
                vis_smoke_white: {
                    id: 'vis_smoke_white',
                    name_pl: 'Biały dym (para)',
                    category: 'visual',
                    issues: ['head_gasket', 'coolant_leak']
                },
                vis_leak_oil: {
                    id: 'vis_leak_oil',
                    name_pl: 'Wyciek oleju (czarna maź)',
                    category: 'visual',
                    issues: ['gasket_leak', 'filter_loose']
                },
                vis_leak_water: {
                    id: 'vis_leak_water',
                    name_pl: 'Woda w zęzie (słodka/słona)',
                    category: 'visual',
                    requires_specificity: true,
                    specificity_options: [
                        { id: 'vis_leak_fresh', label: 'Słodka woda (ze zbiornika)', issues: ['tank_leak', 'pump_leak'] },
                        { id: 'vis_leak_salt', label: 'Słona woda (z zewnątrz)', issues: ['hull_leak', 'raw_water_leak'] }
                    ],
                    issues: [] // Generic placeholder
                },

                // === WSKAŹNIKI (INSTRUMENTS) ===
                ins_temp_high: {
                    id: 'ins_temp_high',
                    name_pl: 'Wysoka temperatura (>90°C)',
                    category: 'visual_instrument',
                    issues: ['coolant_low', 'raw_water_clogged', 'impeller_failed']
                },
                ins_oil_low: {
                    id: 'ins_oil_low',
                    name_pl: 'Niskie ciśnienie oleju',
                    category: 'visual_instrument',
                    issues: ['oil_low', 'pump_failed']
                },
                ins_volt_low: {
                    id: 'ins_volt_low',
                    name_pl: 'Niskie napięcie (<12V)',
                    category: 'visual_instrument',
                    issues: ['alternator_failed', 'belt_loose']
                },

                // === ELEKTRYKA (JACHTOWA) ===
                elec_panel_switch: {
                    id: 'elec_panel_switch',
                    name_pl: 'Wyłączony obwód na panelu (Domestic/Service)',
                    probability: 0.7,
                    difficulty: 1,
                    required_symptoms: ['elec_total_loss', 'wc_wont_flush'], // Elektryczne WC
                    verification_questions: [
                        {
                            id: 'q_panel_led',
                            question_pl: 'Czy na panelu sterowania (nad stolikiem nawigacyjnym) świeci się dioda "12V" lub "Service"?',
                            question_amateur_pl: 'Czy włączyłeś główny przycisk na panelu z guzikami?',
                            answers: [
                                { text_pl: 'Ciemno, nic nie świeci', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Tak, świeci się', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Włącz obwód Service', description_pl: 'Często osobny guzik obok woltomierza.' },
                        { step: 2, title_pl: 'Sprawdź główny hebel', description_pl: 'Czerwony klucz pod siedzeniem/w kabinie rufowej.' }
                    ]
                },
                elec_total_loss: {
                    id: 'elec_total_loss',
                    name_pl: 'Główny wyłącznik prądu (Battery Switch)',
                    category: 'visual',
                    issues: ['main_breaker', 'battery_switch', 'elec_panel_switch']
                },
                elec_dim_lights: {
                    id: 'elec_dim_lights',
                    name_pl: 'Przygasające światła',
                    category: 'visual',
                    issues: ['battery_weak', 'corrosion']
                },
                elec_flicker: {
                    id: 'elec_flicker',
                    name_pl: 'Mruganie świateł',
                    category: 'visual',
                    issues: ['loose_connection']
                }
            },

            // Usterki
            issues: {
                // === TOALETA ===
                wc_valve_shut: {
                    id: 'wc_valve_shut',
                    name_pl: 'Zamknięty zawór (Wet/Dry)',
                    probability: 0.6,
                    difficulty: 1,
                    required_symptoms: ['wc_blocked_pump'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_wc_lever',
                            question_pl: 'Czy mała wajcha (Wet/Dry) jest ustawiona na "Flush" (Wypompowywanie)?',
                            answers: [
                                { text_pl: 'Nie, jest na Dry / Zamknięta', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, jest otwarta', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Przełącz na Dry/Empty', description_pl: 'Aby opróżnić muszlę, zawór musi być otwarty.' }
                    ]
                },
                wc_seacock_out_closed: {
                    id: 'wc_seacock_out_closed',
                    name_pl: 'Zamknięty zawór odpływowy (Seacock)',
                    probability: 0.4,
                    difficulty: 2,
                    required_symptoms: ['wc_bowl_full', 'wc_blocked_pump'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_seacock_pos',
                            question_pl: 'Spójrz pod zlew w łazience. Czy duży zawór jest wzdłuż rury?',
                            answers: [
                                { text_pl: 'Jest w poprzek (Zamknięty)', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest wzdłuż (Otwarty)', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Otwórz zawór', description_pl: 'Dźwignia musi być równolegle do rury.' }
                    ]
                },
                wc_tank_full: {
                    id: 'wc_tank_full',
                    name_pl: 'Pełny zbiornik na fekalia',
                    probability: 0.3,
                    difficulty: 1,
                    required_symptoms: ['wc_bowl_full', 'wc_bad_smell'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_tank_level',
                            question_pl: 'Czy wskaźnik zbiornika pokazuje FULL?',
                            answers: [
                                { text_pl: 'Tak, świeci na czerwono', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Pusto / Zielono', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Otwórz zawór zrzutowy', description_pl: 'Jeśli jesteś na pełnym morzu (>12 mil).' },
                        { step: 2, title_pl: 'Użyj pompy maceratora', description_pl: 'Jeśli jacht ją posiada.' }
                    ]
                },

                // === SILNIK ZABURTOWY (DINGHY) ===
                ob_kill_cord: {
                    id: 'ob_kill_cord',
                    name_pl: 'Zrywka bezpieczeństwa (Kill Cord)',
                    probability: 0.8, // Najczęstszy błąd
                    difficulty: 1,
                    required_symptoms: ['ob_wont_start'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_kill_cord',
                            question_pl: 'Czy czerwona zrywka jest wpięta w przycisk STOP?',
                            answers: [
                                { text_pl: 'Nie / Wisi luźno', probability_change: 0.99, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, jest wpięta', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wepnij zrywkę', description_pl: 'Musi wejść pod przycisk, aby go podnieść.' }
                    ]
                },
                ob_tank_vent: {
                    id: 'ob_tank_vent',
                    name_pl: 'Zamknięty odpowietrznik paliwa',
                    probability: 0.5,
                    difficulty: 1,
                    required_symptoms: ['ob_stops_run', 'ob_wont_start'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_vent_screw',
                            question_pl: 'Czy mała śrubka na korku paliwa jest odkręcona?',
                            answers: [
                                { text_pl: 'Jest zakręcona', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest luźna / odkręcona', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Odkręć śrubkę na korku', description_pl: 'Dzięki temu paliwo może spływać do silnika.' }
                    ]
                },
                ob_fuel_tap: {
                    id: 'ob_fuel_tap',
                    name_pl: 'Zamknięty kranik paliwa',
                    probability: 0.4,
                    difficulty: 1,
                    required_symptoms: ['ob_wont_start', 'ob_stops_run'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_fuel_tap_pos',
                            question_pl: 'Czy kranik paliwa (z boku silnika) jest pionowo/otwarty?',
                            answers: [
                                { text_pl: 'Jest poziomo (OFF)', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest pionowo (ON)', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Otwórz kranik', description_pl: 'Zazwyczaj dźwignia w dół lub wzdłuż wężyka.' }
                    ]
                },

                // === KOTWICA ===
                anc_breaker: {
                    id: 'anc_breaker',
                    name_pl: 'Wybity bezpiecznik windy',
                    probability: 0.6,
                    difficulty: 1,
                    required_symptoms: ['anc_silent'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_anchor_breaker',
                            question_pl: 'Spójrz na panel bezpieczników. Czy bezpiecznik windy (Windlass) wyskoczył?',
                            answers: [
                                { text_pl: 'Tak, dźwigienka wisi', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Wygląda OK / Świeci', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wciśnij/Włącz bezpiecznik', description_pl: 'Często duży automat obok głównego panelu.' }
                    ]
                },
                anc_engine_off: {
                    id: 'anc_engine_off',
                    name_pl: 'Silnik wyłączony (Brak prądu)',
                    probability: 0.5,
                    difficulty: 1,
                    required_symptoms: ['anc_silent'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_engine_running_anc',
                            question_pl: 'Czy główny silnik jachtu pracuje?',
                            answers: [
                                { text_pl: 'Nie, jest zgaszony', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, pracuje', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Uruchom silnik', description_pl: 'Winda pobiera dużo prądu i często działa tylko przy włączonym silniku.' }
                    ]
                },

                // === GENERATOR ===
                gen_raw_water_loss: {
                    id: 'gen_raw_water_loss',
                    name_pl: 'Brak chłodzenia (LOC / Overheat)',
                    probability: 0.6,
                    difficulty: 2,
                    required_symptoms: ['gen_stops', 'onan_3_blink', 'kohler_loc'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_gen_water_flow',
                            question_pl: 'Czy z wydechu generatora (często z boku kadłuba) leci woda?',
                            answers: [
                                { text_pl: 'Tylko powietrze / para', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Woda leci mocno', probability_change: -0.7, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wyczyść filtr wody', description_pl: 'Sprawdź Sea Strainer generatora.' },
                        { step: 2, title_pl: 'Sprawdź wirnik (Impeller)', description_pl: 'Wymień jeśli filtr był czysty.' }
                    ]
                },
                gen_breaker_trip: {
                    id: 'gen_breaker_trip',
                    name_pl: 'Wybity bezpiecznik na prądnicy',
                    probability: 0.7,
                    difficulty: 1,
                    required_symptoms: ['gen_no_power'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_gen_breaker',
                            question_pl: 'Otwórz obudowę generatora. Czy widzisz przełącznik "Main Breaker"?',
                            answers: [
                                { text_pl: 'Tak, jest w pozycji OFF/Dół', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest włączony (ON)', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Włącz bezpiecznik', description_pl: 'Znajduje się bezpośrednio na generatorze (nie na panelu).' },
                        { step: 2, title_pl: 'Zmniejsz obciążenie', description_pl: 'Wyłącz klimatyzację przed ponownym włączeniem.' }
                    ]
                },
                gen_oil_low: {
                    id: 'gen_oil_low',
                    name_pl: 'Niski poziom oleju (Oil Pressure)',
                    probability: 0.4,
                    difficulty: 1,
                    required_symptoms: ['gen_stops', 'onan_2_blink'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_gen_oil_stick',
                            question_pl: 'Sprawdź bagnet oleju. Jaki jest poziom?',
                            answers: [
                                { text_pl: 'Poniżej minimum', probability_change: 0.99, knockout: 'others', type: 'confirm' },
                                { text_pl: 'W normie', probability_change: -0.8, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Dolej oleju', description_pl: 'Typowo 15W40 (jak do silnika).' }
                    ]
                },

                // === PALIWO (FUEL) ===
                fuel_empty: {
                    id: 'fuel_empty',
                    name_pl: 'Brak paliwa / Błędny wskaźnik',
                    name_en: 'Out of fuel / Gauge error',
                    probability: 0.15,
                    difficulty: 1,
                    required_symptoms: ['eng_cranks_no_start', 'eng_stalls_idle', 'eng_stalls_load'],
                    conflicting_symptoms: ['vis_smoke_black', 'vis_smoke_blue'], 
                    verification_questions: [
                        {
                            id: 'q_fuel_gauge_verify',
                            question_pl: 'Co wskazuje wskaźnik paliwa?',
                            question_expert_pl: 'Jaki jest poziom paliwa? Czy był weryfikowany "na patyk"?',
                            answers: [
                                { text_pl: 'Rezerwa / Pusto', probability_change: 0.7, type: 'confirm' },
                                { text_pl: 'Pełny / Jest paliwo', probability_change: -0.5, type: 'reject' }
                            ],
                            answers_expert: [
                                { text_pl: 'Potwierdzony brak paliwa', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Paliwo zweryfikowane fizycznie', probability_change: -1.0, knockout: 'self', type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawdź fizycznie poziom', description_pl: 'Nie ufaj wskaźnikom elektrycznym.' },
                        { step: 2, title_pl: 'Dolej paliwa', description_pl: 'Minimum 20 litrów.' },
                        { step: 3, title_pl: 'Odpowietrz układ', description_pl: 'Kluczowe po wyczerpaniu paliwa.' }
                    ]
                },

                fuel_air_lock: {
                    id: 'fuel_air_lock',
                    name_pl: 'Zapowietrzenie układu paliwowego',
                    name_en: 'Air lock in fuel system',
                    probability: 0.25,
                    difficulty: 3,
                    required_symptoms: ['eng_cranks_no_start', 'eng_stalls_idle'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_recent_service',
                            question_pl: 'Czy wymieniano ostatnio filtry paliwa?',
                            question_expert_pl: 'Czy układ paliwowy był otwierany w ciągu ostatnich 50h?',
                            answers: [
                                { text_pl: 'Tak, niedawno', probability_change: 0.6, type: 'confirm' },
                                { text_pl: 'Nie', probability_change: -0.2, type: 'neutral' }
                            ]
                        },
                        {
                            id: 'q_bleed_screw',
                            question_pl: 'Czy po odkręceniu odpowietrznika leci samo paliwo?',
                            question_expert_pl: 'Test odpowietrznika na pompie wtryskowej: paliwo czy bąbelki?',
                            answers: [
                                { text_pl: 'Lecą bąbelki powietrza', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Czyste paliwo bez bąbli', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zlokalizuj śrubę odpowietrzającą', description_pl: 'Zazwyczaj na górze filtra lub pompie wtryskowej.' },
                        { step: 2, title_pl: 'Pompuj pompką ręczną', description_pl: 'Aż przestaną lecieć bąbelki.' }
                    ]
                },

                diesel_bug: {
                    id: 'diesel_bug',
                    name_pl: 'Skażenie paliwa ("Diesel Bug")',
                    name_en: 'Diesel Bug / Contamination',
                    probability: 0.2,
                    difficulty: 3,
                    required_symptoms: ['eng_stalls_load', 'eng_stalls_idle', 'eng_cranks_no_start'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_filter_slime',
                            question_pl: 'Spójrz na filtr wstępny (szklanka). Co widzisz?',
                            question_expert_pl: 'Inspekcja separatora wody: obecność czarnego szlamu?',
                            answers: [
                                { text_pl: 'Czarna/brązowa maź', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Czyste paliwo', probability_change: -0.8, knockout: 'self', type: 'reject' },
                                { text_pl: 'Woda na dnie', probability_change: 0.4, type: 'support' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wymień filtry', description_pl: 'Miej zapasowe!' },
                        { step: 2, title_pl: 'Wyczyść zbiornik', description_pl: 'Długoterminowo konieczne czyszczenie i biocyd.' }
                    ]
                },

                // === ELEKTRYKA / ROZRUCH (STARTING) ===
                neutral_safety_switch: {
                    id: 'neutral_safety_switch',
                    name_pl: 'Bieg nie jest w neutralu',
                    name_en: 'Gear in gear (Neutral Safety Switch)',
                    probability: 0.3,
                    difficulty: 1,
                    required_symptoms: ['eng_no_crank'],
                    conflicting_symptoms: ['eng_cranks_no_start', 'snd_grinding'],
                    verification_questions: [
                        {
                            id: 'q_gear_check',
                            question_pl: 'Czy manetka jest idealnie w pionie (luz)?',
                            question_expert_pl: 'Weryfikacja pozycji neutralnej i przycisku wysprzęglenia.',
                            answers: [
                                { text_pl: 'Nie, jest na biegu', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, jest na luzie', probability_change: -0.4, type: 'reject' }
                            ],
                            answers_expert: [
                                { text_pl: 'Była na biegu (Skorygowano)', probability_change: 1.0, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Jest w Neutral (Sprawdzone)', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wrzuć luz (Neutral)', description_pl: 'Poruszaj manetką przód-tył i ustaw pionowo.' },
                        { step: 2, title_pl: 'Sprawdź przycisk wysprzęglenia', description_pl: 'Czasem się zacina.' }
                    ]
                },

                battery_dead: {
                    id: 'battery_dead',
                    name_pl: 'Rozładowany akumulator',
                    name_en: 'Dead battery',
                    probability: 0.35,
                    difficulty: 2,
                    required_symptoms: ['eng_no_crank', 'snd_click_start', 'elec_dim_lights', 'ins_volt_low'],
                    conflicting_symptoms: ['eng_cranks_no_start'],
                    verification_questions: [
                        {
                            id: 'q_volts_load',
                            question_pl: 'Czy światła przygasają gdy próbujesz odpalić?',
                            question_expert_pl: 'Spadek napięcia (Voltage Drop) podczas próby rozruchu?',
                            answers: [
                                { text_pl: 'Tak, gasną całkowicie', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Nie przygasają', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Połącz akumulatory (BOTH)', description_pl: 'Jeśli masz przełącznik 1-2-Both.' },
                        { step: 2, title_pl: 'Sprawdź klemy', description_pl: 'Czy są dokręcone i czyste?' }
                    ]
                },

                hydrolock: {
                    id: 'hydrolock',
                    name_pl: 'Hydrolock (Woda w cylindrze)',
                    name_en: 'Hydrolock',
                    probability: 0.05,
                    difficulty: 5,
                    required_symptoms: ['eng_no_crank', 'snd_click_start'],
                    conflicting_symptoms: ['eng_cranks_no_start'],
                    verification_questions: [
                        {
                            id: 'q_engine_turn_hand',
                            question_pl: 'Czy silnik da się obrócić ręcznie (kluczem na kole pasowym)?',
                            question_expert_pl: 'Próba obrotu wałem korbowym ręcznie (Barring over).',
                            answers: [
                                { text_pl: 'Ani drgnie (Zablokowany)', probability_change: 0.9, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Tak, obraca się', probability_change: -1.0, knockout: 'self', type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'NIE PRÓBUJ KRĘCIĆ ROZRUSZNIKIEM', description_pl: 'Grozi zgięciem korbowodu.' },
                        { step: 2, title_pl: 'Zamknij wodę zaburtową', description_pl: 'Natychmiast.' },
                        { step: 3, title_pl: 'Wykręć wtryskiwacze/świece', description_pl: 'Aby wypuścić wodę przy obrocie.' }
                    ],
                    emergency_tip_pl: 'KRYTYCZNE: Jeśli podejrzewasz wodę w cylindrze, dalsze próby rozruchu zniszczą silnik.'
                },

                starter_solenoid: {
                    id: 'starter_solenoid',
                    name_pl: 'Awaria solenoidu rozrusznika',
                    name_en: 'Starter solenoid failure',
                    probability: 0.15,
                    difficulty: 3,
                    required_symptoms: ['eng_no_crank', 'snd_click_start'],
                    conflicting_symptoms: ['eng_cranks_no_start', 'elec_dim_lights'], // Dim lights sugeruje aku, nie solenoid
                    verification_questions: [
                        {
                            id: 'q_bridge_starter',
                            question_pl: 'Czy zmostkowanie rozrusznika śrubokrętem uruchamia go?',
                            question_expert_pl: 'Test "na krótko" (Bypass solenoid).',
                            answers: [
                                { text_pl: 'Tak, kręci', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Tylko iskrzy, nie kręci', probability_change: -0.3, type: 'neutral' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawdź kabel sterujący', description_pl: 'Cienki kabel idący do rozrusznika.' },
                        { step: 2, title_pl: 'Ostukaj rozrusznik', description_pl: 'Delikatnie młotkiem.' }
                    ]
                },

                // === CHŁODZENIE / WYDECH ===
                impeller_failed: {
                    id: 'impeller_failed',
                    name_pl: 'Uszkodzony wirnik pompy (Impeller)',
                    name_en: 'Impeller failure',
                    probability: 0.4,
                    difficulty: 3,
                    required_symptoms: ['ins_temp_high', 'vis_smoke_white'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_water_flow',
                            question_pl: 'Czy z wydechu leci woda chłodząca?',
                            question_expert_pl: 'Obserwacja wylotu wody (Wet exhaust flow).',
                            answers: [
                                { text_pl: 'Sucho / Tylko para', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Leci normalnie', probability_change: -0.8, knockout: 'self', type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawdź wirnik pompy', description_pl: 'Odkręć dekiel pompy wody zaburtowej.' },
                        { step: 2, title_pl: 'Poszukaj brakujących łopatek', description_pl: 'Mogą zablokować wymiennik ciepła.' }
                    ]
                },

                raw_water_clogged: {
                    id: 'raw_water_clogged',
                    name_pl: 'Zablokowany wlot wody',
                    name_en: 'Blocked raw water intake',
                    probability: 0.3,
                    difficulty: 2,
                    required_symptoms: ['ins_temp_high', 'vis_smoke_white'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_strainer',
                            question_pl: 'Czy filtr wody zaburtowej jest czysty?',
                            question_expert_pl: 'Inspekcja kosza filtra (Sea strainer).',
                            answers: [
                                { text_pl: 'Pełno wodorostów/śmieci', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Czysty', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wyczyść filtr', description_pl: 'Zakręć zawór denny przed otwarciem!' },
                        { step: 2, title_pl: 'Sprawdź "grzybek" pod dnem', description_pl: 'Może reklamówka przykleiła się do wlotu.' }
                    ]
                },

                exhaust_elbow: {
                    id: 'exhaust_elbow',
                    name_pl: 'Zatkana kolanko wydechowe',
                    name_en: 'Clogged exhaust elbow',
                    probability: 0.15,
                    difficulty: 4,
                    required_symptoms: ['ins_temp_high', 'vis_smoke_black', 'vis_smoke_white'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_elbow_temp',
                            question_pl: 'Czy kolanko wydechu (mixing elbow) jest bardzo gorące?',
                            question_expert_pl: 'Temp. kolanka wydechowego (powinno dać się dotknąć ręką).',
                            answers: [
                                { text_pl: 'Parzy, nie da się dotknąć', probability_change: 0.7, type: 'confirm' },
                                { text_pl: 'Ciepłe, ale OK', probability_change: -0.5, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zdemontuj kolanko', description_pl: 'Sprawdź drożność kanałów wodnych.' },
                        { step: 2, title_pl: 'Wyczyść kwasem lub wymień', description_pl: 'Nagary zatykają przepływ wody.' }
                    ]
                },

                // === UKŁAD NAPĘDOWY ===
                propeller_fouling: {
                    id: 'propeller_fouling',
                    name_pl: 'Lina/Sieć w śrubie',
                    name_en: 'Propeller fouling',
                    probability: 0.3,
                    difficulty: 5,
                    required_symptoms: ['eng_stalls_load', 'vib_running', 'vis_smoke_black'],
                    conflicting_symptoms: ['eng_stalls_idle'], // Na luzie zazwyczaj chodzi OK
                    verification_questions: [
                        {
                            id: 'q_neutral_rev',
                            question_pl: 'Czy na luzie (Neutral) silnik wchodzi na obroty?',
                            question_expert_pl: 'Test wysokich obrotów bez obciążenia (No load WOT test).',
                            answers: [
                                { text_pl: 'Tak, wkręca się idealnie', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Nie, dusi się też na luzie', probability_change: -0.8, type: 'reject' }
                            ]
                        },
                        {
                            id: 'q_diving',
                            question_pl: 'Czy nurkowałeś sprawdzić śrubę?',
                            answers: [
                                { text_pl: 'Tak, jest czysta', probability_change: -1.0, knockout: 'self', type: 'reject' },
                                { text_pl: 'Nie', probability_change: 0, type: 'neutral' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zanurkuj i sprawdź', description_pl: 'Tylko przy wyłączonym silniku i wyjętym kluczyku!' },
                        { step: 2, title_pl: 'Użyj noża do odcięcia liny', description_pl: 'Uważaj na uszczelniacz wału.' }
                    ]
                },

                alternator_belt: {
                    id: 'alternator_belt',
                    name_pl: 'Luźny pasek klinowy',
                    name_en: 'Loose alternator belt',
                    probability: 0.2,
                    difficulty: 1,
                    required_symptoms: ['ins_volt_low', 'ins_temp_high'], // Pasek napędza też często pompę wody
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_squeal',
                            question_pl: 'Czy słychać pisk przy dodawaniu gazu?',
                            answers: [
                                { text_pl: 'Tak, piszczy', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Cisza', probability_change: -0.3, type: 'neutral' }
                            ]
                        },
                        {
                            id: 'q_belt_deflection',
                            question_pl: 'Czy pasek ugina się więcej niż 1cm?',
                            question_expert_pl: 'Ugięcie paska pod naciskiem kciuka.',
                            answers: [
                                { text_pl: 'Tak, bardzo luźny', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Sztywny', probability_change: -0.7, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Naciągnij pasek', description_pl: 'Poluzuj śrubę alternatora i naciągnij.' },
                        { step: 2, title_pl: 'Sprawdź stan paska', description_pl: 'Jeśli sparciały lub czarny pył - wymień.' }
                    ]
                },

                // === WIBRACJE I MOCOWANIA ===
                engine_mount_loose: {
                    id: 'engine_mount_loose',
                    name_pl: 'Zerwana poduszka silnika',
                    name_en: 'Broken Engine Mount',
                    probability: 0.25,
                    difficulty: 2,
                    required_symptoms: ['vib_idle', 'vib_running'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_neutral_vib',
                            question_pl: 'Czy silnik wpada w silne wibracje na luzie (Neutral)?',
                            question_expert_pl: 'Inspekcja poduszek silnika - czy guma jest zerwana?',
                            answers: [
                                { text_pl: 'Tak, trzęsie całą łódką', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Nie, na luzie jest gładko', probability_change: -0.8, type: 'reject' }
                            ]
                        },
                        {
                            id: 'q_mount_visual',
                            question_pl: 'Otwórz klapę silnika. Czy silnik "skacze" na boki przy dodawaniu gazu?',
                            answers: [
                                { text_pl: 'Tak, rusza się mocno', probability_change: 0.8, type: 'confirm' },
                                { text_pl: 'Siedzi sztywno', probability_change: -0.4, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Zidentyfikuj zerwaną poduszkę', description_pl: 'Użyj łomu, aby unieść silnik w miejscach mocowania.' },
                        { step: 2, title_pl: 'Wymień poduszkę', description_pl: 'Konieczne podniesienie silnika.' }
                    ]
                },

                injector_fault: {
                    id: 'injector_fault',
                    name_pl: 'Awaria wtryskiwacza (Misfire)',
                    name_en: 'Injector Fault / Misfire',
                    probability: 0.2,
                    difficulty: 3,
                    required_symptoms: ['vib_idle', 'vib_running', 'vis_smoke_white', 'vis_smoke_black', 'eng_stalls_idle'],
                    conflicting_symptoms: [],
                    verification_questions: [
                        {
                            id: 'q_cyl_crack',
                            question_pl: 'Poluzuj nakrętki wtryskiwaczy po kolei (na pracującym silniku). Czy praca silnika się zmienia?',
                            question_expert_pl: 'Test "Cylinder Balance Test" (odcinanie cylindrów).',
                            answers: [
                                { text_pl: 'Przy jednym NIE MA zmiany (To ten cylinder!)', probability_change: 0.95, knockout: 'others', type: 'confirm' },
                                { text_pl: 'Przy każdym silnik przygasa (Wtryski OK)', probability_change: -0.6, type: 'reject' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Wykręć wadliwy wtryskiwacz', description_pl: 'Daj do sprawdzenia w serwisie.' },
                        { step: 2, title_pl: 'Sprawdź kompresję', description_pl: 'Brak reakcji cylindra może też oznaczać brak kompresji.' }
                    ]
                },

                shaft_bent: {
                    id: 'shaft_bent',
                    name_pl: 'Skrzywiony wał napędowy',
                    name_en: 'Bent Prop Shaft',
                    probability: 0.1,
                    difficulty: 4,
                    required_symptoms: ['vib_running'],
                    conflicting_symptoms: ['vib_idle'], // Wał nie kręci się na luzie
                    verification_questions: [
                        {
                            id: 'q_shaft_wobble',
                            question_pl: 'Spójrz na dławicę wału (w środku łodzi). Czy wał "bije" na boki?',
                            answers: [
                                { text_pl: 'Tak, widać bicie', probability_change: 0.9, type: 'confirm' },
                                { text_pl: 'Wygląda prosto', probability_change: -0.3, type: 'neutral' }
                            ]
                        }
                    ],
                    repair_steps: [
                        { step: 1, title_pl: 'Sprawdź bicie czujnikiem zegarowym', description_pl: 'Na lądzie.' },
                        { step: 2, title_pl: 'Wyprostuj lub wymień wał', description_pl: 'Wymaga wyciągnięcia wału.' }
                    ]
                }
            }
        };

        // Zmienna globalna trzymająca aktualną (połączoną) bazę
        let marineDatabase = JSON.parse(JSON.stringify(baseMarineDatabase));

        // ====================
        // STAN APLIKACJI
        // ====================

        let appState = {
            currentScreen: 'home',
            selectedSystem: null,
            selectedEngineType: 'general', // 'general', 'yanmar', 'volvo'
            selectedSymptoms: [],
            currentQuestions: [],
            currentQuestionIndex: 0,
            questionAnswers: {},
            diagnosisResults: [],
            language: 'pl',
            isOffline: !navigator.onLine,
            expertMode: false,
            amateurMode: false
        };

        // ====================
        // DIAGNOSTIC ENGINE (Separation of Logic)
        // ====================
        const DiagnosticEngine = {
            // Faza 1: Znajdowanie pasujących usterek na podstawie symptomów
            findRelevantIssues: function(selectedSymptoms, database) {
                if (!selectedSymptoms || selectedSymptoms.length === 0) return [];
                
                const selectedSet = new Set(selectedSymptoms);
                const possibleIssues = [];
                
                Object.values(database.issues).forEach(issue => {
                    // 1. Sprawdź wymagane symptomy (Symptom Support)
                    const hasSupport = issue.required_symptoms.some(reqSym => selectedSet.has(reqSym));
                    
                    // 2. Sprawdź konflikty (Conflicting Symptoms)
                    const hasConflict = issue.conflicting_symptoms.some(confSym => selectedSet.has(confSym));
                    
                    if (hasSupport && !hasConflict) {
                        possibleIssues.push(issue);
                    }
                });
                
                return possibleIssues;
            },

            // Faza 2: Obliczanie diagnozy (Bayesian-lite inference)
            calculateDiagnosis: function(selectedSymptoms, questionAnswers, questionsList, database, expertMode) {
                const selectedSet = new Set(selectedSymptoms);
                let candidates = [];
                const eliminated = [];
                
                // 1. Wstępna ocena i zbieranie kandydatów
                Object.values(database.issues).forEach(issue => {
                    const hasSupport = issue.required_symptoms.some(reqSym => selectedSet.has(reqSym));
                    const hasConflict = issue.conflicting_symptoms.some(confSym => selectedSet.has(confSym));
                    
                    if (hasConflict) {
                        eliminated.push({ issue, reason: 'Konflikt symptomów' });
                        return;
                    }
                    
                    if (hasSupport) {
                        let confidence = issue.probability;
                        let justification = [`Bazowe prawdopodobieństwo: ${Math.round(confidence * 100)}%`];
                        let isKnockedOutSelf = false;
                        let isKnockoutOthers = false; // Branch Killer
                        
                        // Analiza odpowiedzi
                        if (issue.verification_questions) {
                            issue.verification_questions.forEach(question => {
                                const key = `${issue.id}_${question.id}`;
                                if (questionAnswers.hasOwnProperty(key)) {
                                    const answerIdx = questionAnswers[key];
                                    if (answerIdx === 'unsure') {
                                        justification.push(`Odp: "Nie wiem" (Brak danych)`);
                                    } else {
                                        const answersList = (expertMode && question.answers_expert) 
                                            ? question.answers_expert 
                                            : question.answers;
                                            
                                        const answer = answersList[answerIdx];
                                        
                                        if (answer) {
                                            confidence += answer.probability_change;
                                            const sign = answer.probability_change > 0 ? '+' : '';
                                            justification.push(`Odp: "${answer.text_pl}" (${sign}${Math.round(answer.probability_change * 100)}%)`);
                                            
                                            if (answer.knockout === 'self') isKnockedOutSelf = true;
                                            if (answer.knockout === 'others') isKnockoutOthers = true;
                                        }
                                    }
                                }
                            });
                        }
                        
                        candidates.push({ 
                            issue, 
                            confidence, 
                            justification, 
                            isKnockedOutSelf, 
                            isKnockoutOthers 
                        });
                    }
                });
                
                // 2. Logika "Branch Killer" (Knockout)
                const killers = candidates.filter(c => c.isKnockoutOthers);
                
                if (killers.length > 0) {
                    candidates.forEach(c => {
                        if (!c.isKnockoutOthers) {
                            c.confidence = 0;
                            c.justification.push("Wykluczone przez inną pewną diagnozę (Branch Killer).");
                            c.isKnockedOutSelf = true; 
                        } else {
                            c.confidence = 0.99;
                            c.justification.push("POTWIERDZONE DEFINITYWNIE (Kluczowy objaw).");
                        }
                    });
                }
                
                // 3. Finalizacja wyników
                const results = [];
                
                candidates.forEach(c => {
                    if (c.isKnockedOutSelf) {
                        eliminated.push({ issue: c.issue, reason: 'Wykluczone przez odpowiedź (Knockout)' });
                    } else {
                        c.confidence = Math.max(0, Math.min(0.99, c.confidence));
                        results.push(c);
                    }
                });
                
                results.sort((a, b) => b.confidence - a.confidence);
                
                // Generowanie raportu z testów
                const testsPerformed = questionsList.map((q) => {
                     const key = `${q.issueId}_${q.id}`;
                     const ansIdx = questionAnswers[key];
                     const issue = database.issues[q.issueId];
                     const question = issue ? issue.verification_questions.find(vq => vq.id === q.id) : null;
                     let ansText = "Pominięto";
                     
                     if (question && ansIdx !== undefined) {
                         if (ansIdx === 'unsure') {
                            ansText = "Nie wiem / Nie jestem pewien";
                         } else {
                            const answersList = (expertMode && question.answers_expert) 
                                       ? question.answers_expert 
                                       : question.answers;
                            ansText = answersList[ansIdx] ? answersList[ansIdx].text_pl : "Błąd";
                         }
                     }
                     
                     return { question: q.question_pl, answer: ansText };
                });

                return {
                    primary: results.filter(r => r.confidence >= 0.6),
                    secondary: results.filter(r => r.confidence < 0.6 && r.confidence > 0.15),
                    eliminated,
                    testsPerformed
                };
            },

            // Sprawdzanie sprzeczności (Sanity Check)
            checkContradiction: function(question, answer, database) {
                // Przykład logiki sprzeczności
                // Jeśli pytanie dotyczy "dymu" a wybrano "brak dymu", ale symptom to "czarny dym"
                
                const issue = database.issues[question.issueId];
                if (issue && issue.required_symptoms) {
                    // Jeśli odpowiedź "wyklucza" usterkę, która jest silnie sugerowana przez symptomy
                    // To może być sprzeczność, ale może też być po prostu eliminacja.
                }
                
                return false; // Placeholder
            }
        };

        // ====================
        // FUNKCJE SYSTEMU
        // ====================

        function initApp() {
            renderSystems();
            renderTrees();
            setupOfflineDetection();
            loadLanguage();
            // Restore modes
            const savedExpert = localStorage.getItem('marineMechExpert');
            if (savedExpert === 'true') {
                appState.expertMode = true;
                document.getElementById('expert-mode-toggle').checked = true;
            }
            
            const savedAmateur = localStorage.getItem('marineMechAmateur');
            if (savedAmateur === 'true') {
                appState.amateurMode = true;
                document.getElementById('amateur-mode-toggle').checked = true;
            }
        }
        
        // function renderEngineSelect() removed
        // function changeEngineType(type) removed
        
        function toggleExpertMode() {
            appState.expertMode = !appState.expertMode;
            localStorage.setItem('marineMechExpert', appState.expertMode);
            
            // Expert and Amateur are mutually exclusive for UX clarity
            if (appState.expertMode && appState.amateurMode) {
                toggleAmateurMode(); // Turn off amateur
                document.getElementById('amateur-mode-toggle').checked = false;
            }
            
            if (appState.currentScreen === 'questions') renderCurrentQuestion();
        }

        function toggleAmateurMode() {
            appState.amateurMode = !appState.amateurMode;
            localStorage.setItem('marineMechAmateur', appState.amateurMode);
            
            // Expert and Amateur are mutually exclusive
            if (appState.amateurMode && appState.expertMode) {
                toggleExpertMode(); // Turn off expert
                document.getElementById('expert-mode-toggle').checked = false;
            }
            
            if (appState.currentScreen === 'questions') renderCurrentQuestion();
        }

        function renderSystems() {
            const grid = document.getElementById('systems-grid');
            grid.innerHTML = '';
            
            marineDatabase.systems.forEach(system => {
                const card = document.createElement('div');
                card.className = 'system-card';
                card.innerHTML = `
                    <div class="system-icon">
                        <i class="${system.icon}"></i>
                    </div>
                    <div class="system-name">${system.name_pl}</div>
                `;
                
                card.addEventListener('click', () => selectSystem(system));
                grid.appendChild(card);
            });
        }

        function selectSystem(system) {
            // Resetuj wszystkie karty
            document.querySelectorAll('.system-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Aktywuj wybraną kartę
            event.currentTarget.classList.add('active');
            
            appState.selectedSystem = system;
            document.getElementById('start-btn').disabled = false;
            
            // Aktualizuj tekst przycisku
            document.getElementById('start-btn').innerHTML = 
                `<i class="fas fa-play"></i> Diagnozuj: ${system.name_pl}`;
        }

        function startDiagnosis() {
            if (!appState.selectedSystem) return;
            
            // 1. Sprawdź tryb diagnostyki zdefiniowany w danych
            if (appState.selectedSystem.diagnosis_mode === 'context_choice') {
                document.getElementById('engine-choice-modal').classList.add('active');
                return;
            }

            // 2. Sprawdź czy system ma przypisane drzewo diagnostyczne
            if (appState.selectedSystem.diagnosis_mode === 'tree' && appState.selectedSystem.default_tree_id) {
                const treeId = appState.selectedSystem.default_tree_id;
                if (typeof diagnosticTrees !== 'undefined' && diagnosticTrees[treeId]) {
                    startTreeDiagnosis(treeId);
                    return;
                }
            }
            
            // 3. Fallback do standardowej listy symptomów
            proceedToSymptoms();
        }

        function selectEngineContext(type) {
            try {
                document.getElementById('engine-choice-modal').classList.remove('active');

                // NEW LOGIC: Data-driven routing based on engine_types configuration
                const engineConfig = marineDatabase.engine_types && marineDatabase.engine_types[type];
                
                if (engineConfig && engineConfig.tree_id && typeof diagnosticTrees !== 'undefined' && diagnosticTrees[engineConfig.tree_id]) {
                    startTreeDiagnosis(engineConfig.tree_id);
                    return;
                }

                // Fallback to Expert System (Probability) - Old Logic
                // Safety check for external library
                if (typeof mergeSpecificKnowledge === 'undefined') {
                    throw new Error("Błąd ładowania marine_specifics.js. Funkcja mergeSpecificKnowledge jest niedostępna.");
                }

                // Ładujemy odpowiednią bazę wiedzy
                marineDatabase = mergeSpecificKnowledge(JSON.parse(JSON.stringify(baseMarineDatabase)), type);
                
                // Ponieważ mergeSpecificKnowledge nadpisuje całą bazę, musimy odświeżyć selectedSystem
                // aby wskazywał na obiekt w NOWEJ bazie
                const newSystem = marineDatabase.systems.find(s => s.id === 'engine');
                if (!newSystem) {
                    throw new Error("Nie udało się zaktualizować kontekstu silnika (System not found).");
                }
                appState.selectedSystem = newSystem;
                
                proceedToSymptoms();
            } catch (e) {
                console.error("Critical error in selectEngineContext:", e);
                alert("Wystąpił błąd krytyczny aplikacji:\n" + e.message + "\n\nSpróbuj odświeżyć stronę.");
            }
        }

        function proceedToSymptoms() {
            // Przejdź do ekranu symptomów
            switchScreen('symptoms');
            renderSymptoms();
            
            // Aktualizuj nagłówek
            document.getElementById('current-system').textContent = 
                `System: ${appState.selectedSystem.name_pl}`;
        }

        function renderSymptoms() {
            const list = document.getElementById('symptoms-list');
            list.innerHTML = '';
            
            appState.selectedSymptoms = []; // Reset
            document.getElementById('next-to-questions-btn').disabled = true;
            document.getElementById('next-to-questions-btn').style.opacity = '0.5';
            document.getElementById('next-to-questions-btn').style.cursor = 'not-allowed';
            
            const systemSymptoms = appState.selectedSystem.symptoms;
            
            // Use categories from database
            const categoriesDB = marineDatabase.symptom_categories || {
                other: { name_pl: 'Inne', name_en: 'Other' }
            };
            
            const groupedSymptoms = {};
            
            systemSymptoms.forEach(symptomId => {
                const symptom = marineDatabase.symptoms[symptomId];
                if (!symptom) return;
                
                const category = symptom.category || 'other';
                if (!groupedSymptoms[category]) {
                    groupedSymptoms[category] = [];
                }
                groupedSymptoms[category].push(symptom);
            });
            
            // Render categories
            // We iterate over keys defined in DB to maintain order, then add any extras found
            const definedKeys = Object.keys(categoriesDB);
            const foundKeys = Object.keys(groupedSymptoms);
            const allKeys = [...new Set([...definedKeys, ...foundKeys])];

            allKeys.forEach(catKey => {
                if (groupedSymptoms[catKey] && groupedSymptoms[catKey].length > 0) {
                    // Get Category Name
                    const catDef = categoriesDB[catKey];
                    const catName = catDef ? (appState.language === 'pl' ? catDef.name_pl : catDef.name_en) : catKey;

                    // Header
                    const header = document.createElement('div');
                    header.className = 'symptom-category-header';
                    header.textContent = catName;
                    list.appendChild(header);
                    
                    // Symptoms
                    groupedSymptoms[catKey].forEach(symptom => {
                        const item = document.createElement('div');
                        item.className = 'symptom-item';
                        item.id = `symptom-item-${symptom.id}`;
                        item.innerHTML = `
                            <div class="symptom-checkbox" id="checkbox-${symptom.id}"></div>
                            <div class="symptom-text">
                                ${appState.language === 'pl' ? symptom.name_pl : (symptom.name_en || symptom.name_pl)}
                                ${symptom.requires_specificity ? '<small style="display:block; color:var(--accent-teal); font-size:12px;">(Wymaga doprecyzowania)</small>' : ''}
                            </div>
                        `;
                        
                        item.addEventListener('click', () => handleSymptomClick(symptom.id));
                        list.appendChild(item);
                    });
                }
            });
            
            updateSelectedCount();
        }

        function handleSymptomClick(symptomId) {
            const symptom = marineDatabase.symptoms[symptomId];
            
            // Jeśli symptom jest już zaznaczony, odznacz go
            if (isSymptomSelected(symptomId)) {
                toggleSymptom(symptomId);
                return;
            }
            
            // Jeśli wymaga doprecyzowania, otwórz modal
            if (symptom.requires_specificity) {
                openSpecificityModal(symptom);
            } else {
                toggleSymptom(symptomId);
            }
        }

        function isSymptomSelected(symptomId) {
            return appState.selectedSymptoms.some(s => s === symptomId || s.startsWith(symptomId + '_'));
        }

        function openSpecificityModal(symptom) {
            const modal = document.getElementById('specificity-modal');
            const optionsContainer = document.getElementById('specificity-options');
            
            optionsContainer.innerHTML = '';
            
            symptom.specificity_options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'specificity-option';
                div.textContent = option.label;
                div.onclick = () => selectSpecificSymptom(symptom.id, option.id);
                optionsContainer.appendChild(div);
            });
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('specificity-modal').classList.remove('active');
        }

        function closeGuideModal() {
            document.getElementById('guide-modal').classList.remove('active');
        }

        function selectSpecificSymptom(parentId, specificId) {
            // Zapisz jako np. "vis_leak_water:vis_leak_fresh" lub po prostu specificId jeśli unikalne
            // Tutaj użyjemy specificId jako identyfikatora w selectedSymptoms, ale musimy wiedzieć że to dziecko parentId
            
            // Dla uproszczenia, dodajmy specificId do selectedSymptoms
            // Ale uwaga: musimy mapować specificId na issues w nextToQuestions
            
            // Zmodyfikujmy toggleSymptom żeby obsługiwał to
            
            // Najpierw zamknij modal
            closeModal();
            
            // Dodaj do stanu (ręcznie, bo to specyficzny przypadek)
            if (!appState.selectedSymptoms.includes(specificId)) {
                appState.selectedSymptoms.push(specificId);
                
                // Zaznacz wizualnie rodzica
                const parentCheckbox = document.getElementById(`checkbox-${parentId}`);
                if (parentCheckbox) parentCheckbox.classList.add('checked');
            }
            
            updateSelectedCount();
            
            // Check button state
            const btn = document.getElementById('next-to-questions-btn');
            if (appState.selectedSymptoms.length > 0) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        }

        function toggleSymptom(symptomId, element) {
            // Ta funkcja teraz obsługuje tylko proste symptomy
            const checkbox = document.getElementById(`checkbox-${symptomId}`);
            const index = appState.selectedSymptoms.indexOf(symptomId);
            
            if (index === -1) {
                // Dodaj symptom
                appState.selectedSymptoms.push(symptomId);
                if (checkbox) checkbox.classList.add('checked');
            } else {
                // Usuń symptom
                appState.selectedSymptoms.splice(index, 1);
                if (checkbox) checkbox.classList.remove('checked');
                
                // Jeśli to był rodzic specyficznych opcji, musielibyśmy usunąć też dzieci
                // Ale w obecnej implementacji ID są płaskie w selectedSymptoms
            }
            
            updateSelectedCount();
            
            // Check button state
            const btn = document.getElementById('next-to-questions-btn');
            if (appState.selectedSymptoms.length > 0) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = 
                appState.selectedSymptoms.length;
        }

        function nextToQuestions() {
            if (appState.selectedSymptoms.length === 0) {
                alert('Wybierz przynajmniej jeden symptom!');
                return;
            }
            
            // USE ENGINE: Find Relevant Issues
            const possibleIssues = DiagnosticEngine.findRelevantIssues(appState.selectedSymptoms, marineDatabase);
            
            if (possibleIssues.length === 0) {
                // Fallback: Jeśli nic nie pasuje (np. dziwna kombinacja), pokaż komunikat lub wszystko
                alert("Nie znaleziono typowych usterek dla tej kombinacji symptomów. Spróbuj zmienić wybór.");
                return;
            }
            
            // Stwórz listę pytań
            appState.currentQuestions = [];
            appState.questionAnswers = {};
            appState.currentQuestionIndex = 0;
            
            // Zbierz pytania z pasujących usterek
            // Unikaj duplikatów pytań (jeśli to samo pytanie jest w kilku usterkach - tu zakładamy unikalne ID)
            possibleIssues.forEach(issue => {
                if (issue.verification_questions) {
                    issue.verification_questions.forEach(q => {
                        if (!appState.currentQuestions.find(existing => existing.id === q.id)) {
                            appState.currentQuestions.push({
                                issueId: issue.id,
                                ...q
                            });
                        }
                    });
                }
            });
            
            // Sortowanie pytań (Question Selection)
            // Na razie prosto: pytania eliminacyjne (elimination) pierwsze
            appState.currentQuestions.sort((a, b) => {
                if (a.metadata?.type === 'elimination' && b.metadata?.type !== 'elimination') return -1;
                if (a.metadata?.type !== 'elimination' && b.metadata?.type === 'elimination') return 1;
                return 0;
            });
            
            // Ogranicz liczbę pytań (Convergence Control)
            if (appState.currentQuestions.length > 7) {
                appState.currentQuestions = appState.currentQuestions.slice(0, 7);
            }
            
            switchScreen('questions');
            renderCurrentQuestion();
        }

        function renderCurrentQuestion() {
            const container = document.getElementById('question-container');
            const question = appState.currentQuestions[appState.currentQuestionIndex];
            
            if (!question) {
                finishDiagnosis();
                return;
            }
            
            const issue = marineDatabase.issues[question.issueId];
            
            document.getElementById('current-system-name').textContent = 
                `Diagnostyka: ${issue ? issue.name_pl : 'Błąd'}`;
            
            document.getElementById('current-question-counter').textContent = 
                `Pytanie ${appState.currentQuestionIndex + 1}/${appState.currentQuestions.length}`;
            
            // --- MODE SELECTION LOGIC ---
            let questionText = (appState.language === 'pl' ? question.question_pl : question.question_en);
            let answersToRender = question.answers;
            let modeBadge = '';

            if (appState.expertMode) {
                if (question.question_expert_pl) questionText = question.question_expert_pl;
                if (question.answers_expert) answersToRender = question.answers_expert;
                modeBadge = '<span class="mode-badge expert" style="background:var(--primary-dark); border:1px solid var(--accent-blue); padding:2px 6px; border-radius:4px; font-size:10px; margin-left:10px;">EXPERT</span>';
            } else if (appState.amateurMode) {
                if (question.question_amateur_pl) questionText = question.question_amateur_pl;
                if (question.answers_amateur) answersToRender = question.answers_amateur;
                modeBadge = '<span class="mode-badge amateur" style="background:var(--accent-teal); color:black; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:10px;">AMATOR</span>';
            }
            
            // --- RENDER ANSWERS ---
            let answersHtml = '';
            answersToRender.forEach((answer, index) => {
                answersHtml += `
                    <button class="answer-btn" onclick="selectAnswer(${index})" 
                            id="answer-${index}">
                        ${appState.language === 'pl' ? answer.text_pl : answer.text_en || answer.text_pl}
                    </button>
                `;
            });

            // Add "Not Sure" option
            answersHtml += `
                <button class="answer-btn" onclick="selectAnswer('unsure')" 
                        id="answer-unsure" style="border-style: dashed; color: var(--text-secondary);">
                    <i class="fas fa-question-circle"></i> ${appState.language === 'pl' ? 'Nie wiem / Nie jestem pewien' : 'Not sure / Don\'t know'}
                </button>
            `;
            
            container.innerHTML = `
                <div class="question-card fade-in">
                    <div class="question-header" style="display:flex; align-items:center; margin-bottom:15px;">
                        <span class="question-badge" style="background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px; font-size:12px;">
                            Pytanie ${appState.currentQuestionIndex + 1}/${appState.currentQuestions.length}
                        </span>
                        ${modeBadge}
                    </div>
                    
                    <div class="question-text">
                        ${appState.expertMode ? '<i class="fas fa-user-graduate" style="color:var(--accent-teal); margin-right:8px;"></i>' : ''}
                        ${appState.amateurMode ? '<i class="fas fa-life-ring" style="color:var(--accent-teal); margin-right:8px;"></i>' : ''}
                        ${questionText}
                    </div>
                    
                    <div class="answers-grid">
                        ${answersHtml}
                    </div>
                    
                    ${(question.metadata && appState.expertMode) ? `
                        <div style="margin-top: 15px; font-size: 0.8em; color: #aaa; border-top: 1px solid #444; padding-top: 10px;">
                            <strong>Expert Data:</strong><br>
                            Uncertainty: ${question.metadata.uncertainty || 'N/A'}<br>
                            Type: ${question.metadata.type || 'N/A'}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Ukryj przycisk "Następne pytanie" na początku
            document.getElementById('next-question-btn').style.display = 'none';
            
            // Jeśli już odpowiedział na to pytanie, pokaz zaznaczoną odpowiedź
            const questionId = `${question.issueId}_${question.id}`;
            if (appState.questionAnswers[questionId] !== undefined) {
                selectAnswer(appState.questionAnswers[questionId]);
            }
        }

        function selectAnswer(answerIndex) {
            // Resetuj wszystkie przyciski
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Zaznacz wybrany
            const selectedBtn = document.getElementById(`answer-${answerIndex}`);
            if (selectedBtn) selectedBtn.classList.add('selected');
            
            // Zapisz odpowiedź
            const question = appState.currentQuestions[appState.currentQuestionIndex];
            const questionId = `${question.issueId}_${question.id}`;
            
            if (answerIndex === 'unsure') {
                appState.questionAnswers[questionId] = 'unsure';
                // Nie robimy sanity check dla "nie wiem"
            } else {
                // SANITY CHECK LAYER
                const answer = (appState.expertMode && question.answers_expert) 
                    ? question.answers_expert[answerIndex] 
                    : question.answers[answerIndex];
                    
                if (DiagnosticEngine.checkContradiction(question, answer, marineDatabase)) {
                    alert("OSTRZEŻENIE: Ta odpowiedź wydaje się być sprzeczna z wybranymi wcześniej symptomami.");
                }
                
                appState.questionAnswers[questionId] = answerIndex;
            }
            
            // Pokaż przycisk "Następne pytanie"
            document.getElementById('next-question-btn').style.display = 'flex';

            // Restore Back Button for Normal Mode
            const backBtn = document.querySelector('#screen-questions .btn-secondary');
            if (backBtn) {
                backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${appState.language === 'pl' ? 'Powrót do symptomów' : 'Back to symptoms'}`;
                backBtn.onclick = goBackToSymptoms;
            }
        }

        function nextQuestion() {
            appState.currentQuestionIndex++;
            
            if (appState.currentQuestionIndex < appState.currentQuestions.length) {
                renderCurrentQuestion();
            } else {
                finishDiagnosis();
            }
        }

        function finishDiagnosis() {
            // Zbieramy symptomy dla raportu (UI Rendering logic)
            const observedSymptoms = appState.selectedSymptoms.map(id => {
                let name = id;
                const topSymptom = marineDatabase.symptoms[id];
                if (topSymptom) {
                    name = topSymptom.name_pl;
                } else {
                    Object.values(marineDatabase.symptoms).forEach(s => {
                        if (s.specificity_options) {
                            const opt = s.specificity_options.find(o => o.id === id);
                            if (opt) name = `${s.name_pl}: ${opt.label}`;
                        }
                    });
                }
                return name;
            });

            // USE ENGINE: Calculate Diagnosis
            const results = DiagnosticEngine.calculateDiagnosis(
                appState.selectedSymptoms,
                appState.questionAnswers,
                appState.currentQuestions,
                marineDatabase,
                appState.expertMode
            );
            
            appState.diagnosisResults = {
                observedSymptoms,
                ...results
            };
            
            switchScreen('results');
            renderResults();
        }

        function renderResults() {
            const container = document.getElementById('results-container');
            const data = appState.diagnosisResults;
            
            if (!data || (!data.primary.length && !data.secondary.length)) {
                container.innerHTML = `
                    <div class="results-container">
                        <div class="probability-badge" style="background: var(--error)">Błąd Diagnozy</div>
                        <div class="issue-card">
                            <h3 class="issue-title">Nie znaleziono przyczyny</h3>
                            <p>System nie był w stanie ustalić przyczyny na podstawie podanych symptomów.</p>
                            <p>Możliwe przyczyny:</p>
                            <ul>
                                <li>Błędne dane wejściowe</li>
                                <li>Usterka spoza bazy wiedzy</li>
                                <li>Konfliktujące informacje</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="startNewDiagnosis()" style="margin-top:15px">Spróbuj ponownie</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // --- 1. Observed Symptoms ---
            let html = `
                <div class="results-container">
                    <h3 style="color:var(--text-secondary); font-size:14px; text-transform:uppercase; margin-bottom:10px;">Raport Techniczny</h3>
                    
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--accent-blue); margin-bottom:10px;">1. Zaobserwowane Symptomy</h4>
                        <ul style="list-style-position: inside; color:var(--text-primary);">
                            ${data.observedSymptoms.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
            `;
            
            // --- 2. Tests Performed ---
            if (data.testsPerformed.length > 0) {
                html += `
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--accent-blue); margin-bottom:10px;">2. Wykonane Testy</h4>
                        <ul style="list-style: none; padding:0;">
                            ${data.testsPerformed.map(t => `
                                <li style="margin-bottom:8px; border-left:2px solid var(--accent-teal); padding-left:10px;">
                                    <div style="font-size:12px; color:var(--text-secondary);">${t.question}</div>
                                    <div>${t.answer}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // --- 3. Eliminated Causes ---
            if (data.eliminated.length > 0) {
                html += `
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--text-secondary); margin-bottom:10px;">Wykluczone Przyczyny</h4>
                        <ul style="list-style: none; padding:0; color:var(--text-secondary);">
                            ${data.eliminated.slice(0, 3).map(e => `<li><i class="fas fa-times" style="color:var(--error)"></i> ${e.issue.name_pl} (${e.reason})</li>`).join('')}
                            ${data.eliminated.length > 3 ? `<li>...i ${data.eliminated.length - 3} innych</li>` : ''}
                        </ul>
                    </div>
                `;
            }

            // --- 4. Primary Diagnosis ---
            if (data.primary.length > 0) {
                html += `<h4 style="color:var(--success); margin-bottom:15px; font-size:18px;">Główna Diagnoza</h4>`;
                
                data.primary.forEach((result, idx) => {
                    const prob = Math.round(result.confidence * 100);
                    html += `
                        <div class="issue-card" style="border-left: 4px solid var(--success);">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 class="issue-title" style="color:var(--success); margin:0;">${idx + 1}. ${result.issue.name_pl}</h3>
                                <span class="probability-badge" style="margin:0; background:var(--success);">${prob}% Pewności</span>
                            </div>
                            
                            <div style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <strong style="color:var(--text-secondary); font-size:12px;">UZASADNIENIE:</strong>
                                <ul style="font-size:13px; margin-top:5px; padding-left:20px;">
                                    ${result.justification.map(j => `<li>${j}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div style="margin-top:15px;">
                                <strong style="color:var(--accent-blue);">Zalecane działania naprawcze:</strong>
                                <div class="step-list" style="margin-top:10px;">
                                    ${result.issue.repair_steps ? result.issue.repair_steps.map(step => `
                                        <div class="step-item">
                                            <div class="step-number">${step.step}</div>
                                            <div>
                                                <strong>${step.title_pl}</strong><br>
                                                <span style="font-size:14px; color:var(--text-secondary);">${step.description_pl}</span>
                                            </div>
                                        </div>
                                    `).join('') : 'Brak instrukcji naprawy.'}
                                </div>
                            </div>
                            
                            ${result.issue.emergency_tip_pl ? `
                                <div style="margin-top:15px; padding:10px; background:rgba(255,152,0,0.1); border-radius:6px; border:1px solid var(--warning);">
                                    <strong style="color:var(--warning);"><i class="fas fa-exclamation-triangle"></i> Bezpieczeństwo:</strong>
                                    <p style="font-size:14px; margin-top:5px;">${result.issue.emergency_tip_pl}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:20px; text-align:center; border:1px dashed var(--warning); border-radius:8px; margin-bottom:20px;">
                        <h4 style="color:var(--warning);">Niska pewność diagnozy (<60%)</h4>
                        <p>System nie znalazł jednoznacznej przyczyny. Sprawdź sekcję "Możliwe przyczyny" poniżej lub skonsultuj się z mechanikiem.</p>
                    </div>
                `;
            }

            // --- 5. Secondary Possibilities ---
            if (data.secondary.length > 0) {
                html += `<h4 style="color:var(--text-secondary); margin:20px 0 10px 0;">Inne Możliwości</h4>`;
                data.secondary.forEach(result => {
                    const prob = Math.round(result.confidence * 100);
                    html += `
                        <div class="issue-card" style="border-left: 4px solid var(--text-secondary); opacity: 0.8;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${result.issue.name_pl}</strong>
                                <span>${prob}%</span>
                            </div>
                        </div>
                    `;
                });
            }

            // --- 6. Explicit Limitations ---
            html += `
                <div style="margin-top:30px; padding:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:12px; color:var(--text-secondary); text-align:center;">
                    <strong>OGRANICZENIA SYSTEMU:</strong><br>
                    Ta diagnoza jest generowana automatycznie na podstawie wprowadzonych danych.
                    Nie zastępuje profesjonalnej oceny mechanika.
                    System zakłada, że wprowadzone obserwacje są poprawne.
                    Nie podejmuj działań, które mogą zagrażać bezpieczeństwu załogi lub jednostki.
                </div>
            `;
            
            html += `</div>`; // Close container
            container.innerHTML = html;
        }

        function showEmergencyTips() {
            const tips = [
                "1. ZAWSZE najpierw bezpieczeństwo załogi",
                "2. Jeśli jest wyciek paliwa: wyłącz wszystko elektryczne, nie włączaj wentylatorów",
                "3. Przy przegrzaniu silnika: nie otwieraj gorącego układu chłodzenia",
                "4. Miej zawsze dostępne kamizelki ratunkowe",
                "5. Utrzymuj kontakt radiowy na kanale 16",
                "6. Jeśli silnik zawiedzie: przygotuj żagle lub kotwicę",
                "7. W ciemności używaj latarek z czerwonym filtrem"
            ];
            
            alert("WSKAZÓWKI AWARYJNE:\n\n" + tips.join("\n"));
        }

        function startNewDiagnosis() {
            // Resetuj stan
            appState.selectedSystem = null;
            appState.selectedSymptoms = [];
            appState.currentQuestions = [];
            appState.currentQuestionIndex = 0;
            appState.questionAnswers = {};
            appState.diagnosisResults = [];
            
            // Resetuj UI
            document.querySelectorAll('.system-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').innerHTML = 
                '<i class="fas fa-play"></i> Rozpocznij diagnostykę';
            
            switchScreen('home');
        }

        function switchScreen(screenName) {
            // Ukryj wszystkie ekrany
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Pokaż wybrany ekran
            document.getElementById(`screen-${screenName}`).classList.add('active');
            appState.currentScreen = screenName;
            
            // Aktualizuj pasek postępu
            const progressBars = {
                'home': 0,
                'symptoms': 33,
                'questions': 66,
                'results': 100
            };
            
            for (const [screen, progress] of Object.entries(progressBars)) {
                const bar = document.getElementById(`progress-${screen}`);
                if (bar) {
                    bar.style.width = `${progress}%`;
                }
            }
        }

        let builderValidationErrors = [];
        function openBuilderModal() {
            const modal = document.getElementById('builder-modal');
            const textarea = document.getElementById('builder-json');
            const saved = localStorage.getItem('customDiagnosticTree');
            textarea.value = saved || '';
            document.getElementById('builder-errors').innerHTML = '';
            modal.classList.add('active');
        }
        function closeBuilderModal() {
            document.getElementById('builder-modal').classList.remove('active');
        }
        function renderBuilderErrors(errors) {
            const container = document.getElementById('builder-errors');
            if (!errors || errors.length === 0) {
                container.innerHTML = `<div style="color: var(--success); font-weight: 600; margin-top: 10px;">${appState.language === 'pl' ? 'Brak błędów. Można zapisać.' : 'No errors. You can save.'}</div>`;
                return;
            }
            const items = errors.map(e => {
                const id = e.id ? `[${e.id}]` : '';
                const path = e.path ? ` | ${e.path}` : '';
                return `<li><strong>${e.type}</strong> ${id}${path}: ${e.message}</li>`;
            }).join('');
            container.innerHTML = `<div style="color: var(--error); font-weight: 600; margin: 10px 0;">${appState.language === 'pl' ? 'Wykryto błędy walidacji:' : 'Validation errors detected:'}</div><ul style="margin-left: 20px;">${items}</ul>`;
        }
        function validateBuilderJson() {
            const textarea = document.getElementById('builder-json');
            let tree;
            try {
                tree = JSON.parse(textarea.value);
            } catch (e) {
                renderBuilderErrors([{ type: 'CRITICAL', message: appState.language === 'pl' ? 'Nieprawidłowy JSON.' : 'Invalid JSON.' }]);
                builderValidationErrors = [{ type: 'CRITICAL', message: 'Invalid JSON.' }];
                return;
            }
            if (typeof validateDiagnosticTree === 'function') {
                const errors = validateDiagnosticTree(tree);
                builderValidationErrors = errors;
                renderBuilderErrors(errors);
            } else {
                renderBuilderErrors([{ type: 'CRITICAL', message: appState.language === 'pl' ? 'Brak funkcji walidatora.' : 'Validator function not available.' }]);
                builderValidationErrors = [{ type: 'CRITICAL', message: 'Validator missing.' }];
            }
        }
        function saveBuilderJson() {
            if (builderValidationErrors && builderValidationErrors.length > 0) {
                renderBuilderErrors(builderValidationErrors);
                return;
            }
            const textarea = document.getElementById('builder-json');
            let tree;
            try {
                tree = JSON.parse(textarea.value);
            } catch (e) {
                renderBuilderErrors([{ type: 'CRITICAL', message: appState.language === 'pl' ? 'Nieprawidłowy JSON.' : 'Invalid JSON.' }]);
                return;
            }
            if (typeof validateDiagnosticTree === 'function') {
                const errors = validateDiagnosticTree(tree);
                if (errors.length > 0) {
                    builderValidationErrors = errors;
                    renderBuilderErrors(errors);
                    return;
                }
            }
            localStorage.setItem('customDiagnosticTree', textarea.value);
            const okMsg = appState.language === 'pl' ? 'Zapisano poprawne drzewo.' : 'Valid tree saved.';
            document.getElementById('builder-errors').innerHTML = `<div style="color: var(--success); font-weight: 600; margin-top: 10px;">${okMsg}</div>`;
        }
        function validateDiagnosticTree(tree) {
            const errors = [];
            const MAX_DEPTH = 6;
            if (!tree || typeof tree !== 'object') {
                return [{ type: 'CRITICAL', message: 'Tree must be a non-null object.' }];
            }
            const treeId = tree.tree_id || 'unknown_tree';
            if (!tree.tree_id) errors.push({ id: treeId, type: 'METADATA', message: "Missing 'tree_id'." });
            if (!tree.metadata) {
                errors.push({ id: treeId, type: 'METADATA', message: "Missing 'metadata' object." });
            } else {
                const meta = tree.metadata;
                if (!meta.title || !meta.title.en || !meta.title.pl) {
                    errors.push({ id: treeId, type: 'LOCALIZATION', message: 'Title must have en and pl.' });
                }
                if (!meta.version) errors.push({ id: treeId, type: 'METADATA', message: "Missing 'version'." });
                if (!meta.engine_type) errors.push({ id: treeId, type: 'METADATA', message: "Missing 'engine_type'." });
            }
            const nodes = tree.nodes || {};
            const solutions = tree.solutions || {};
            if (Object.keys(nodes).length === 0) {
                errors.push({ id: treeId, type: 'STRUCTURE', message: 'Tree has no nodes.' });
            }
            for (const [nodeId, node] of Object.entries(nodes)) {
                if (!node.question || !node.question.en || !node.question.pl) {
                    errors.push({ id: nodeId, type: 'LOCALIZATION', message: 'Missing en or pl question.' });
                }
                if (node.context) {
                    if (!node.context.en || !node.context.pl) {
                        errors.push({ id: nodeId, type: 'LOCALIZATION', message: 'Context missing en or pl.' });
                    }
                }
                const answers = Array.isArray(node.answers) ? node.answers : [];
                if (answers.length === 0) {
                    errors.push({ id: nodeId, type: 'STRUCTURE', message: 'Must have at least one answer.' });
                }
                let hasCantCheck = false;
                answers.forEach((ans, idx) => {
                    const ansRef = `ANSWER [${idx}]`;
                    if (ans.type === 'cant_check') hasCantCheck = true;
                    if (!ans.text || !ans.text.en || !ans.text.pl) {
                        errors.push({ id: nodeId, path: ansRef, type: 'LOCALIZATION', message: 'Missing en or pl text.' });
                    }
                    if (ans.probability !== undefined) {
                        if (typeof ans.probability !== 'number' || ans.probability < 0 || ans.probability > 1) {
                            errors.push({ id: nodeId, path: ansRef, type: 'VALIDATION', message: 'Probability must be 0.0-1.0.' });
                        }
                    }
                    if (ans.next) {
                        const t = ans.next.type;
                        const id = ans.next.id;
                        if (t === 'node') {
                            if (!nodes[id]) {
                                errors.push({ id: nodeId, path: ansRef, type: 'REFERENCE', message: `References missing node '${id}'.` });
                            }
                        } else if (t === 'solution') {
                            if (!solutions[id]) {
                                errors.push({ id: nodeId, path: ansRef, type: 'REFERENCE', message: `References missing solution '${id}'.` });
                            }
                        } else {
                            errors.push({ id: nodeId, path: ansRef, type: 'VALIDATION', message: "Invalid target type." });
                        }
                    } else {
                        errors.push({ id: nodeId, path: ansRef, type: 'STRUCTURE', message: "Missing 'next' target." });
                    }
                });
                if (!hasCantCheck) {
                    errors.push({ id: nodeId, type: 'STRUCTURE', message: "Missing 'cant_check' answer." });
                }
            }
            for (const [solId, sol] of Object.entries(solutions)) {
                if (!sol.title || !sol.title.en || !sol.title.pl) {
                    errors.push({ id: solId, type: 'LOCALIZATION', message: 'Missing en or pl title.' });
                }
                if (!sol.description || !sol.description.en || !sol.description.pl) {
                    errors.push({ id: solId, type: 'LOCALIZATION', message: 'Missing en or pl description.' });
                }
                if (!Array.isArray(sol.steps) || sol.steps.length === 0) {
                    errors.push({ id: solId, type: 'STRUCTURE', message: "Missing 'steps'." });
                } else {
                    sol.steps.forEach((step, idx) => {
                        if (!step.en || !step.pl) {
                            errors.push({ id: solId, path: `STEP [${idx}]`, type: 'LOCALIZATION', message: 'Missing en or pl step.' });
                        }
                    });
                }
            }
            const startNodeId = tree.start_node || (Object.keys(nodes).length > 0 ? Object.keys(nodes)[0] : null);
            if (startNodeId && nodes[startNodeId]) {
                const flowErrors = [];
                function traverse(nodeId, path, depth) {
                    if (depth > MAX_DEPTH) {
                        flowErrors.push({ id: nodeId, type: 'FLOW', path: path.join(' -> '), message: `Max depth (${MAX_DEPTH}) exceeded.` });
                        return;
                    }
                    if (path.includes(nodeId)) {
                        flowErrors.push({ id: nodeId, type: 'FLOW', path: path.join(' -> '), message: 'Infinite loop detected.' });
                        return;
                    }
                    const node = nodes[nodeId];
                    if (!node) return;
                    const currentPath = [...path, nodeId];
                    (node.answers || []).forEach(ans => {
                        if (ans.next && ans.next.type === 'node') {
                            traverse(ans.next.id, currentPath, depth + 1);
                        }
                    });
                }
                traverse(startNodeId, [], 1);
                const seen = new Set();
                flowErrors.forEach(err => {
                    const key = JSON.stringify(err);
                    if (!seen.has(key)) {
                        seen.add(key);
                        errors.push(err);
                    }
                });
            } else if (Object.keys(nodes).length > 0) {
                errors.push({ id: treeId, type: 'STRUCTURE', message: 'Could not determine start node.' });
            }
            return errors;
        }
        function goBackToSystems() {
            switchScreen('home');
        }

        function goBackToSymptoms() {
            switchScreen('symptoms');
        }

        function setupOfflineDetection() {
            function updateOnlineStatus() {
                appState.isOffline = !navigator.onLine;
                if (appState.isOffline) {
                    document.body.classList.add('offline');
                } else {
                    document.body.classList.remove('offline');
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        function loadLanguage() {
            // Można dodać zapis/odczyt preferencji językowych
            const savedLang = localStorage.getItem('marineMechLang');
            if (savedLang) {
                appState.language = savedLang;
            } else {
                // Automatyczne wykrywanie
                appState.language = navigator.language.startsWith('pl') ? 'pl' : 'en';
            }
        }

        function toggleLanguage() {
            appState.language = appState.language === 'pl' ? 'en' : 'pl';
            localStorage.setItem('marineMechLang', appState.language);
            
            // Przeładuj aktualny ekran
            switch(appState.currentScreen) {
                case 'home':
                    renderSystems();
                    renderTrees();
                    break;
                case 'symptoms':
                    renderSymptoms();
                    break;
                case 'questions':
                    if (appState.diagnosisMode === 'tree') {
                        renderTreeNode(appState.currentTreeNodeId);
                    } else {
                        renderCurrentQuestion();
                    }
                    break;
                case 'results':
                    if (appState.diagnosisMode === 'tree') {
                        // Re-render solution logic if needed
                    } else {
                        renderResults();
                    }
                    break;
            }
        }

        // ====================
        // TREE DIAGNOSTICS ENGINE
        // ====================

        function renderTrees() {
            const list = document.getElementById('trees-list');
            if (!list) return;
            list.innerHTML = '';

            if (typeof diagnosticTrees === 'undefined') return;

            Object.values(diagnosticTrees).forEach(tree => {
                const btn = document.createElement('div');
                btn.style.cssText = `
                    padding: 15px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    transition: all 0.2s;
                `;
                btn.innerHTML = `
                    <i class="fas fa-network-wired" style="margin-right: 15px; color: var(--accent-teal);"></i>
                    <div>
                        <div style="font-weight: 600;">${appState.language === 'pl' ? tree.title_pl : tree.title_en}</div>
                    </div>
                `;
                btn.onclick = () => startTreeDiagnosis(tree.id);
                btn.onmouseover = () => { btn.style.borderColor = 'var(--accent-blue)'; btn.style.background = 'rgba(255, 255, 255, 0.1)'; };
                btn.onmouseout = () => { btn.style.borderColor = 'rgba(255, 255, 255, 0.1)'; btn.style.background = 'rgba(255, 255, 255, 0.05)'; };
                
                list.appendChild(btn);
            });
        }

        function startTreeDiagnosis(treeId) {
            const tree = diagnosticTrees[treeId];
            if (!tree) return;

            appState.diagnosisMode = 'tree';
            appState.currentTree = tree;
            appState.currentTreeNodeId = tree.start_node;
            appState.treeHistory = []; // Stack for back button

            switchScreen('questions');
            renderTreeNode(tree.start_node);
        }

        function renderTreeNode(nodeId) {
            const node = appState.currentTree.nodes[nodeId];
            if (!node) {
                console.error("Node not found:", nodeId);
                alert(appState.language === 'pl' ? `Błąd: Nie znaleziono węzła ${nodeId}` : `Error: Node ${nodeId} not found`);
                startNewDiagnosis();
                return;
            }

            // Update UI
            document.getElementById('current-system-name').textContent = 
                appState.language === 'pl' ? (appState.currentTree.metadata?.title?.pl || appState.currentTree.title_pl) : (appState.currentTree.metadata?.title?.en || appState.currentTree.title_en);
            
            document.getElementById('current-question-counter').textContent = 
                appState.language === 'pl' ? 'Krok diagnostyczny' : 'Diagnostic Step';

            const container = document.getElementById('question-container');
            
            // Question Text (Standard or Production format)
            const qText = appState.language === 'pl' ? (node.question?.pl || node.question_pl) : (node.question?.en || node.question_en);
            
            // Answers
            let answersHtml = '';
            (node.answers || []).forEach((ans, idx) => {
                const ansText = appState.language === 'pl' ? (ans.text?.pl || ans.text_pl) : (ans.text?.en || ans.text_en);
                const btnClass = ans.type === 'cant_check' ? 'style="background: rgba(255, 193, 7, 0.15); border-color: var(--warning); color: var(--warning);"' : '';
                
                answersHtml += `
                    <button class="answer-btn" ${btnClass} onclick="handleTreeAnswer('${nodeId}', ${idx})">
                        ${ansText}
                    </button>
                `;
            });

            // Legacy Cant Check Button support
            if (node.cant_check && !node.answers.some(a => a.type === 'cant_check')) {
                const cantLabel = appState.language === 'pl' ? 
                    (node.cant_check.label_pl || "Nie wiem / Nie mogę sprawdzić") : 
                    (node.cant_check.label_en || "Don't know / Can't check");
                
                answersHtml += `
                    <button class="answer-btn" onclick="handleCantCheck('${nodeId}')" style="background: rgba(255, 193, 7, 0.15); border-color: var(--warning); color: var(--warning);">
                        <i class="fas fa-question-circle"></i> ${cantLabel}
                    </button>
                `;
            }

            container.innerHTML = `
                <div class="question-card fade-in">
                    ${node.image ? `<img src="${node.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--accent-blue);">` : ''}
                    <div class="question-text">${qText}</div>
                    ${(node.note?.en || node.note?.pl) ? `<div style="font-size: 0.85em; opacity: 0.7; margin-bottom: 15px; font-style: italic;">
                        <i class="fas fa-info-circle"></i> ${appState.language === 'pl' ? (node.note.pl || node.note.en) : (node.note.en || node.note.pl)}
                    </div>` : ''}
                    <div class="answers-grid">
                        ${answersHtml}
                    </div>
                </div>
            `;

            // Hide "Next Question" button as trees are immediate
            document.getElementById('next-question-btn').style.display = 'none';

            // Update Back Button
            const backBtn = document.querySelector('#screen-questions .btn-secondary');
            if (backBtn) {
                backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${appState.language === 'pl' ? 'Wstecz' : 'Back'}`;
                backBtn.onclick = () => {
                    if (appState.treeHistory.length > 0) {
                        const prevNode = appState.treeHistory.pop();
                        // Pop again because current node is not in history yet (pushed on answer), 
                        // actually history tracks PATH. 
                        // Let's change logic: history push happens on ANSWER.
                        // So popping gives us the node we came FROM.
                        // But wait, if I am at Node B (came from A), history is [A].
                        // Pop -> A. Render A.
                        // Correct.
                        appState.currentTreeNodeId = prevNode;
                        renderTreeNode(prevNode);
                    } else {
                        // Exit tree
                        startNewDiagnosis();
                    }
                };
            }
        }

        function handleTreeAnswer(nodeId, answerIdx) {
            const node = appState.currentTree.nodes[nodeId];
            const answer = node.answers[answerIdx];

            if (!answer) {
                console.error("Answer missing for index:", answerIdx);
                return;
            }

            // Push to history
            appState.treeHistory.push(nodeId);

            // Handle "next" object (Production format) or direct ID (Legacy format)
            if (answer.next) {
                const { type, id } = answer.next;
                if (type === 'node') {
                    appState.currentTreeNodeId = id;
                    renderTreeNode(id);
                } else if (type === 'solution') {
                    showTreeSolution(id);
                }
            } else if (answer.solution_id) {
                showTreeSolution(answer.solution_id);
            } else if (answer.next_node) {
                appState.currentTreeNodeId = answer.next_node;
                renderTreeNode(answer.next_node);
            } else {
                console.error("Dead end in tree at node:", nodeId);
                alert(appState.language === 'pl' ? "Błąd: Ślepy zaułek w drzewie." : "Error: Dead end in tree.");
            }
        }

        function showTreeSolution(solutionId) {
            const sol = (appState.currentTree.solutions && appState.currentTree.solutions[solutionId]) || treeSolutions[solutionId];
            if (!sol) {
                console.error("Solution missing:", solutionId);
                alert(appState.language === 'pl' ? "Błąd: Brak rozwiązania " + solutionId : "Error: Solution missing " + solutionId);
                return;
            }

            const container = document.getElementById('question-container');
            
            const title = appState.language === 'pl' ? (sol.title?.pl || sol.title_pl) : (sol.title?.en || sol.title_en);
            const desc = appState.language === 'pl' ? (sol.description?.pl || sol.description_pl) : (sol.description?.en || sol.description_en);
            
            let badgeHtml = '';
            if (sol.is_temporary) {
                const badgeText = appState.language === 'pl' ? 'ROZWIĄZANIE TYMCZASOWE' : 'TEMPORARY FIX';
                badgeHtml = `<div style="background: var(--warning); color: #000; padding: 4px 12px; border-radius: 4px; display: inline-block; font-weight: bold; font-size: 12px; margin-bottom: 8px;">
                    <i class="fas fa-exclamation-triangle"></i> ${badgeText}
                </div>`;
            }
            
            const steps = Array.isArray(sol.steps) ? sol.steps : [];
            const stepsHtml = steps.map((step, i) => {
                const stepText = typeof step === 'string' ? step : (appState.language === 'pl' ? step.pl : step.en);
                return `
                    <div class="step-item" style="margin-bottom: 12px; display: flex; gap: 15px;">
                        <div class="step-number" style="background: var(--accent-blue); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">${i+1}</div>
                        <div style="align-self: center;">${stepText}</div>
                    </div>
                `;
            }).join('');
            
            let html = `
                <div class="results-container fade-in" style="padding: 20px;">
                    <div class="issue-card" style="border-left: 4px solid var(--success); background: rgba(255, 255, 255, 0.08); padding: 20px; border-radius: 8px;">
                        ${badgeHtml}
                        ${sol.image ? `<img src="${sol.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--success);">` : ''}
                        <h2 class="issue-title" style="color: var(--success); font-size: 24px; margin-bottom: 10px;">${title}</h2>
                        <p style="font-size: 16px; margin-bottom: 20px; opacity: 0.9;">${desc}</p>
                        
                        <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                            <strong style="color: var(--accent-blue); display: block; margin-bottom: 15px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">
                                ${appState.language === 'pl' ? 'PROCEDURA NAPRAWCZA:' : 'REPAIR PROCEDURE:'}
                            </strong>
                            <div class="step-list">
                                ${stepsHtml}
                            </div>
                        </div>

                        ${(sol.expert_note?.en || sol.expert_note?.pl) ? `
                            <div style="margin-top: 20px; padding: 15px; background: rgba(0, 188, 212, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-blue);">
                                <small style="display: block; color: var(--accent-blue); margin-bottom: 5px; font-weight: bold; text-transform: uppercase; font-size: 10px;">Expert Note:</small>
                                <div style="font-size: 14px; font-style: italic; opacity: 0.8;">
                                    ${appState.language === 'pl' ? (sol.expert_note.pl || sol.expert_note.en) : (sol.expert_note.en || sol.expert_note.pl)}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="text-align: center; margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="startTreeDiagnosis('${appState.currentTree.tree_id || appState.currentTree.id}')">
                            <i class="fas fa-redo"></i> ${appState.language === 'pl' ? 'Zacznij od nowa' : 'Restart Diagnosis'}
                        </button>
                        <button class="btn btn-secondary" onclick="startNewDiagnosis()">
                            <i class="fas fa-home"></i> ${appState.language === 'pl' ? 'Ekran Główny' : 'Home'}
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ====================
        // BUILDER LOGIC
        // ====================

        function openBuilderModal() {
            const modal = document.getElementById('builder-modal');
            modal.classList.add('active');
            populateBuilderSelector();
        }

        function closeBuilderModal() {
            document.getElementById('builder-modal').classList.remove('active');
        }

        function populateBuilderSelector() {
            const selector = document.getElementById('builder-tree-selector');
            const currentValue = selector.value;
            
            selector.innerHTML = '<option value="">-- New Tree / Manual Entry --</option>';
            
            // 1. Add Production Trees (from diagnosticTrees constant)
            Object.keys(diagnosticTrees).forEach(id => {
                const tree = diagnosticTrees[id];
                const option = document.createElement('option');
                option.value = `prod:${id}`;
                option.textContent = `[PROD] ${tree.title_en || id}`;
                selector.appendChild(option);
            });

            // 2. Add Saved Trees (from localStorage)
            const savedTreesJson = localStorage.getItem('customDiagnosticTrees');
            if (savedTreesJson) {
                try {
                    const savedTrees = JSON.parse(savedTreesJson);
                    Object.keys(savedTrees).forEach(id => {
                        const option = document.createElement('option');
                        option.value = `local:${id}`;
                        option.textContent = `[SAVED] ${savedTrees[id].metadata?.title?.en || id}`;
                        selector.appendChild(option);
                    });
                } catch (e) {
                    console.error("Failed to parse saved trees", e);
                }
            }
            
            selector.value = currentValue;
        }

        function loadTreeToEditor() {
            const selector = document.getElementById('builder-tree-selector');
            const editor = document.getElementById('builder-json');
            const val = selector.value;

            if (!val) {
                editor.value = '';
                validateBuilderJson();
                return;
            }

            const [type, id] = val.split(':');
            let treeToLoad = null;

            if (type === 'prod') {
                treeToLoad = diagnosticTrees[id];
            } else if (type === 'local') {
                const savedTrees = JSON.parse(localStorage.getItem('customDiagnosticTrees') || '{}');
                treeToLoad = savedTrees[id];
            }

            if (treeToLoad) {
                editor.value = JSON.stringify(treeToLoad, null, 4);
                validateBuilderJson();
            }
        }

        function validateBuilderJson() {
            const editor = document.getElementById('builder-json');
            const errorContainer = document.getElementById('builder-errors');
            const saveBtn = document.getElementById('builder-save-btn');
            const jsonText = editor.value.trim();

            if (!jsonText) {
                errorContainer.innerHTML = '<div style="color: var(--text-secondary);">Enter JSON to begin...</div>';
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
                return;
            }

            try {
                const tree = JSON.parse(jsonText);
                
                // Use the imported validator if available
                if (typeof validateDiagnosticTree === 'function') {
                    const results = validateDiagnosticTree(tree);
                    
                    if (results.length === 0) {
                        errorContainer.innerHTML = '<div style="color: var(--success); font-weight: bold;"><i class="fas fa-check-circle"></i> Tree is valid!</div>';
                        saveBtn.disabled = false;
                        saveBtn.style.opacity = '1';
                    } else {
                        const errors = results.filter(r => r.severity !== 'CONTENT_WARNING');
                        const warnings = results.filter(r => r.severity === 'CONTENT_WARNING');
                        
                        let html = '';
                        
                        if (errors.length > 0) {
                            html += `<div style="color: var(--error); font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-times-circle"></i> ${errors.length} Errors:
                            </div>`;
                            errors.forEach(err => {
                                html += `<div style="background: rgba(207, 102, 121, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--error);">
                                    <strong>${err.type}:</strong> ${err.message}<br>
                                    <small style="opacity: 0.7;">ID: ${err.id}</small>
                                </div>`;
                            });
                        }

                        if (warnings.length > 0) {
                            html += `<div style="color: var(--warning); font-weight: bold; margin: 10px 0;">
                                <i class="fas fa-exclamation-triangle"></i> ${warnings.length} Warnings:
                            </div>`;
                            warnings.forEach(warn => {
                                html += `<div style="background: rgba(255, 152, 0, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--warning);">
                                    <strong>${warn.type}:</strong> ${warn.message}
                                </div>`;
                            });
                        }

                        errorContainer.innerHTML = html;
                        
                        // Disable save only on errors, not warnings
                        if (errors.length > 0) {
                            saveBtn.disabled = true;
                            saveBtn.style.opacity = '0.5';
                        } else {
                            saveBtn.disabled = false;
                            saveBtn.style.opacity = '1';
                        }
                    }
                } else {
                    errorContainer.innerHTML = '<div style="color: var(--warning);">Validator not found. Basic JSON check passed.</div>';
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                }
            } catch (e) {
                errorContainer.innerHTML = `<div style="color: var(--error); font-weight: bold;">
                    <i class="fas fa-bug"></i> Invalid JSON Syntax:
                </div>
                <div style="background: rgba(207, 102, 121, 0.1); padding: 10px; border-radius: 4px; margin-top: 10px; font-family: monospace;">
                    ${e.message}
                </div>`;
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
        }

        function saveBuilderJson() {
            const editor = document.getElementById('builder-json');
            const jsonText = editor.value.trim();
            
            try {
                const tree = JSON.parse(jsonText);
                const treeId = tree.id || tree.tree_id;

                if (!treeId) {
                    alert("Tree must have an 'id' or 'tree_id' field.");
                    return;
                }

                // Save to localStorage
                const savedTrees = JSON.parse(localStorage.getItem('customDiagnosticTrees') || '{}');
                savedTrees[treeId] = tree;
                localStorage.setItem('customDiagnosticTrees', JSON.stringify(savedTrees));

                // Refresh selector
                populateBuilderSelector();
                
                alert(`Tree "${treeId}" saved to browser storage!`);
                
                // Optional: Automatically import/use this tree in the app
                // For now, just close modal
                closeBuilderModal();
            } catch (e) {
                alert("Failed to save: " + e.message);
            }
        }

        function exportBuilderJson() {
            const editor = document.getElementById('builder-json');
            const jsonText = editor.value.trim();
            
            if (!jsonText) {
                alert("Editor is empty. Nothing to export.");
                return;
            }

            try {
                const tree = JSON.parse(jsonText);
                const treeId = tree.id || tree.tree_id || "diagnostic_tree";
                const blob = new Blob([JSON.stringify(tree, null, 4)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${treeId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                alert("Invalid JSON. Please fix errors before exporting.");
            }
        }

        function triggerImport() {
            document.getElementById('builder-import-input').click();
        }

        function importBuilderJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const editor = document.getElementById('builder-json');
                editor.value = content;
                
                // Clear the selector since we're manually editing now
                document.getElementById('builder-tree-selector').value = "";
                
                // Trigger validation
                validateBuilderJson();
                
                // Reset input
                event.target.value = "";
            };
            reader.readAsText(file);
        }

        // ====================
        // INICJALIZACJA
        // ====================

        // Zapisz jako PWA (Progressive Web App)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Dodaj do ekranu głównego
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            // Można pokazać przycisk "Zainstaluj"
        });

        // Start aplikacji
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            // Auto-validate all trees on load
            if (typeof validateDiagnosticTree === 'function') {
                Object.values(diagnosticTrees).forEach(tree => {
                    const errors = validateDiagnosticTree(tree);
                    if (errors.length > 0) {
                        console.warn(`Validation failed for tree: ${tree.id || 'unknown'}`, errors);
                    } else {
                        console.log(`Validation passed for tree: ${tree.id || 'unknown'}`);
                    }
                });
            }
        });
    </script>
    <div id="builder-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px; width: 95%; height: 90vh; display: flex; flex-direction: column;">
            <h3 class="modal-title">Interactive Tree Editor</h3>
            
            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
                <div style="flex: 1;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Select Tree to Edit:</label>
                    <select id="builder-tree-selector" onchange="loadTreeToEditor()" style="width: 100%; background: rgba(0,0,0,0.3); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 4px; padding: 8px;">
                        <option value="">-- New Tree / Manual Entry --</option>
                    </select>
                </div>
                <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 20px;">
                    <i class="fas fa-info-circle"></i> 
                    <a href="SCHEMA.md" target="_blank" style="color: var(--accent-teal); text-decoration: underline;">Schema Rules</a>
                </div>
            </div>

            <div style="display: flex; gap: 20px; flex: 1; min-height: 0;">
                <div style="flex: 2; display: flex; flex-direction: column;">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">JSON Editor (Real-time Validation):</label>
                    <textarea id="builder-json" oninput="validateBuilderJson()" placeholder='{"tree_id": "...", "metadata": {...}, "nodes": {...}, "solutions": {...}}' style="flex: 1; background: rgba(0,0,0,0.3); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 13px; resize: none;"></textarea>
                </div>
                
                <div style="flex: 1; display: flex; flex-direction: column; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Validation Results:</label>
                    <div id="builder-errors" style="flex: 1; overflow-y: auto; font-size: 13px;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" id="builder-save-btn" onclick="saveBuilderJson()" style="flex: 2; background: var(--accent-teal);">
                    <i class="fas fa-save"></i> Save to Browser
                </button>
                <button class="btn btn-secondary" onclick="exportBuilderJson()" style="flex: 1;">
                    <i class="fas fa-download"></i> Export
                </button>
                <button class="btn btn-secondary" onclick="triggerImport()" style="flex: 1;">
                    <i class="fas fa-upload"></i> Import
                </button>
                <input type="file" id="builder-import-input" onchange="importBuilderJson(event)" style="display: none;" accept=".json">
                <button class="btn btn-secondary" onclick="closeBuilderModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    <!-- Guide Modal -->
    <div id="guide-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="guide-title" class="modal-title">Poradnik</h3>
            <div id="guide-body" style="text-align: left; margin: 20px 0; font-size: 15px; line-height: 1.6;"></div>
            <button class="btn btn-secondary" onclick="closeGuideModal()" style="width: 100%;">
                Rozumiem, wracam do pytania
            </button>
        </div>
    </div>
</body>
</html>